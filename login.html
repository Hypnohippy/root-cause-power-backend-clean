<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Root Health Â· Log in</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --panel: #020617;
        --panel-soft: #0b1120;
        --accent: #22c55e;
        --accent-2: #0ea5e9;
        --border: rgba(148, 163, 184, 0.5);
        --text: #e5e7eb;
        --muted: #9ca3af;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #0b1120 0, #000 55%, #020617 100%);
        color: var(--text);
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
      }

      .shell {
        width: 100%;
        max-width: 420px;
        background: radial-gradient(circle at top, #020617, #000);
        border-radius: 1.2rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.85);
        padding: 1.75rem 1.5rem 1.5rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-bottom: 1rem;
      }

      .brand-icon {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e 55%, #16a34a);
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
      }

      .brand-text {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
      }

      .brand-text span:first-child {
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #a7f3d0;
      }

      .brand-text span:last-child {
        font-size: 0.8rem;
        color: var(--muted);
      }

      h1 {
        margin: 0 0 0.4rem;
        font-size: 1.35rem;
      }

      .subtitle {
        margin: 0 0 1.1rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .mode-switch {
        display: inline-flex;
        padding: 0.18rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.7);
        margin-bottom: 1.1rem;
      }

      .mode-pill {
        flex: 1;
        padding: 0.3rem 0.9rem;
        border-radius: 999px;
        font-size: 0.8rem;
        border: none;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .mode-pill.active {
        background: linear-gradient(to right, #22c55e, #0ea5e9);
        color: #020617;
        font-weight: 600;
        box-shadow: 0 10px 25px rgba(34, 197, 94, 0.6);
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
      }

      label {
        font-size: 0.78rem;
        color: var(--muted);
        display: block;
        margin-bottom: 0.2rem;
      }

      .field {
        margin-bottom: 0.45rem;
      }

      input[type="email"],
      input[type="password"] {
        width: 100%;
        border-radius: 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.7);
        padding: 0.55rem 0.7rem;
        font-size: 0.9rem;
        background: rgba(15, 23, 42, 0.95);
        color: var(--text);
        outline: none;
      }

      input[type="email"]:focus,
      input[type="password"]:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      }

      .hint {
        font-size: 0.72rem;
        color: var(--muted);
        margin-top: 0.1rem;
      }

      .error-box,
      .status-box {
        margin-top: 0.3rem;
        border-radius: 0.6rem;
        padding: 0.45rem 0.55rem;
        font-size: 0.76rem;
        display: none;
      }

      .error-box.active {
        display: block;
        background: rgba(248, 113, 113, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.7);
        color: #fecaca;
      }

      .status-box.active {
        display: block;
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.7);
        color: #bbf7d0;
      }

      .submit-btn {
        margin-top: 0.6rem;
        width: 100%;
        border-radius: 0.75rem;
        border: none;
        padding: 0.65rem 0.75rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(to right, #22c55e, #0ea5e9);
        color: #020617;
        box-shadow: 0 14px 35px rgba(34, 197, 94, 0.7);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      .footer {
        margin-top: 1.2rem;
        font-size: 0.75rem;
        color: var(--muted);
        text-align: center;
        opacity: 0.78;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="brand">
        <div class="brand-icon"></div>
        <div class="brand-text">
          <span>Root Health</span>
          <span>Work with root causes over time</span>
        </div>
      </div>

      <h1>Welcome back</h1>
      <p class="subtitle">
        Log in or create your Root Health account to continue your recovery journey.
      </p>

      <div class="mode-switch" id="mode-switch" data-mode="login">
        <button type="button" class="mode-pill active" data-mode="login">
          Log in
        </button>
        <button type="button" class="mode-pill" data-mode="signup">
          Create account
        </button>
      </div>

      <form id="auth-form">
        <div class="field">
          <label for="email">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            autocomplete="email"
            required
            placeholder="you@example.com"
          />
        </div>

        <div class="field">
          <label for="password">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            minlength="6"
            autocomplete="current-password"
            required
            placeholder="At least 6 characters"
          />
          <p class="hint">
            For security, don&apos;t reuse a password from elsewhere.
          </p>
        </div>

        <div id="error-box" class="error-box"></div>
        <div id="status-box" class="status-box"></div>

        <button id="submit-btn" class="submit-btn" type="submit">
          <span id="submit-label">Log in</span>
          <span>â†’</span>
        </button>
      </form>

      <div class="footer">
        Your data is encrypted at rest and in transit. Root Health can&apos;t see your
        password.
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // ðŸ” Supabase client (browser)
      const supabaseUrl = "https://bechmxbywqhsauhctewo.supabase.co";
      const supabaseAnonKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlY2hteGJ5d3Foc2F1aGN0ZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODE0OTcsImV4cCI6MjA3OTA1NzQ5N30.kE3AfgQLI4WWq7je8_0noTvjpObVuW9hPMRUwwxRiFo";

      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      // Elements
      const modeSwitch = document.getElementById("mode-switch");
      const modeButtons = modeSwitch.querySelectorAll(".mode-pill");
      const authForm = document.getElementById("auth-form");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const errorBox = document.getElementById("error-box");
      const statusBox = document.getElementById("status-box");
      const submitBtn = document.getElementById("submit-btn");
      const submitLabel = document.getElementById("submit-label");

      // Figure out where to go after login
      const params = new URLSearchParams(window.location.search);
      const goto = params.get("goto"); // "rootapp", "glass", or null

      function redirectAfterAuth() {
        let target = "/glass/";
        if (goto === "rootapp") {
          target = "/index.html";
        } else if (goto === "glass") {
          target = "/glass/";
        }
        window.location.href = target;
      }

      function getMode() {
        return modeSwitch.dataset.mode === "signup" ? "signup" : "login";
      }

      function setMode(mode) {
        modeSwitch.dataset.mode = mode;
        modeButtons.forEach((btn) => {
          if (btn.dataset.mode === mode) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
        errorBox.classList.remove("active");
        statusBox.classList.remove("active");
        if (mode === "login") {
          submitLabel.textContent = "Log in";
        } else {
          submitLabel.textContent = "Create account";
        }
      }

      modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setMode(btn.dataset.mode);
        });
      });

      async function handleAuth(event) {
        event.preventDefault();
        errorBox.classList.remove("active");
        statusBox.classList.remove("active");

        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
          errorBox.textContent = "Please enter both email and password.";
          errorBox.classList.add("active");
          return;
        }

        submitBtn.disabled = true;

        const mode = getMode();

        try {
          if (mode === "login") {
            const { error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;

            // âœ… Remember email for credit system
            try {
              localStorage.setItem("syncEmail", email);
            } catch (e) {
              console.warn("Could not store syncEmail", e);
            }

            statusBox.textContent = "Logged in. Loading your journeyâ€¦";
            statusBox.classList.add("active");

            redirectAfterAuth();
          } else {
            const { error } = await supabase.auth.signUp({
              email,
              password,
            });

            if (error) {
              if (
                error.message &&
                error.message.toLowerCase().includes("exists")
              ) {
                setMode("login");
                errorBox.textContent =
                  "That email is already registered. Please log in instead.";
                errorBox.classList.add("active");
              } else {
                throw error;
              }
            } else {
              // âœ… Remember email on sign-up as well
              try {
                localStorage.setItem("syncEmail", email);
              } catch (e) {
                console.warn("Could not store syncEmail", e);
              }

              statusBox.textContent =
                "Account created. Loading your first stepâ€¦";
              statusBox.classList.add("active");

              redirectAfterAuth();
            }
          }
        } catch (err) {
          console.error("Auth error", err);
          errorBox.textContent =
            err?.message ||
            "Something went wrong while authenticating. Please try again.";
          errorBox.classList.add("active");
        } finally {
          submitBtn.disabled = false;
        }
      }

      authForm.addEventListener("submit", handleAuth);
    </script>
  </body>
</html>
