<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧠 PTSD Voice Coach - True Voice-to-Voice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .voice-wave {
            animation: wave 0.5s ease-in-out infinite alternate;
        }
        @keyframes wave {
            0% { transform: scaleY(0.5); }
            100% { transform: scaleY(1.5); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-300 to-blue-300 bg-clip-text text-transparent">
                    🧠 Revolutionary PTSD Voice Coach
                </h1>
                <p class="text-xl text-gray-300 mb-6">World's First Emotionally Intelligent Trauma Support</p>
                <div class="bg-green-500 bg-opacity-20 border border-green-400 rounded-full px-6 py-3 inline-block">
                    <i class="fas fa-microphone text-green-400 mr-2"></i>
                    <span class="text-green-300">True Voice-to-Voice AI with Crisis Detection</span>
                </div>
            </div>

            <!-- Main Voice Interface -->
            <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl shadow-2xl p-8 border border-white border-opacity-20">
                <!-- Connection Status -->
                <div class="flex items-center justify-between mb-8 p-4 bg-black bg-opacity-30 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <div id="connection-status" class="w-4 h-4 rounded-full bg-yellow-400 animate-pulse"></div>
                        <span id="connection-text" class="text-white font-medium">Initializing Voice Coach...</span>
                    </div>
                    <div class="text-sm text-gray-300">
                        <i class="fas fa-brain mr-2"></i>PTSD-Configured AI
                    </div>
                </div>

                <!-- Voice Visualization -->
                <div class="text-center mb-8">
                    <div class="relative inline-block">
                        <div class="w-48 h-48 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center mx-auto mb-6 shadow-2xl">
                            <div id="mic-icon" class="text-6xl">
                                <i class="fas fa-microphone text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Voice Wave Animation -->
                        <div id="voice-waves" class="hidden absolute -bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-1">
                            <div class="w-1 h-8 bg-green-400 voice-wave"></div>
                            <div class="w-1 h-12 bg-green-400 voice-wave" style="animation-delay: 0.1s;"></div>
                            <div class="w-1 h-6 bg-green-400 voice-wave" style="animation-delay: 0.2s;"></div>
                            <div class="w-1 h-10 bg-green-400 voice-wave" style="animation-delay: 0.3s;"></div>
                            <div class="w-1 h-4 bg-green-400 voice-wave" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>

                    <h2 id="status-text" class="text-2xl font-bold text-white mb-2">Ready to Listen</h2>
                    <p id="status-desc" class="text-gray-300">Your emotionally intelligent companion is here for you</p>
                </div>

                <!-- Voice Controls -->
                <div class="flex justify-center space-x-6 mb-8">
                    <button 
                        id="start-voice" 
                        onclick="startVoiceSession()" 
                        class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 shadow-lg transform hover:scale-105"
                    >
                        <i class="fas fa-play mr-3"></i>Start Voice Session
                    </button>
                    
                    <button 
                        id="stop-voice" 
                        onclick="stopVoiceSession()" 
                        class="hidden bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300"
                    >
                        <i class="fas fa-stop mr-3"></i>End Session
                    </button>
                </div>

                <!-- Emotional State Display -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-black bg-opacity-30 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-400 mb-2" id="emotion-state">Calm</div>
                        <div class="text-gray-300 text-sm">Emotional State</div>
                    </div>
                    <div class="bg-black bg-opacity-30 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-400 mb-2" id="session-time">00:00</div>
                        <div class="text-gray-300 text-sm">Session Duration</div>
                    </div>
                    <div class="bg-black bg-opacity-30 rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-400 mb-2" id="support-level">Ready</div>
                        <div class="text-gray-300 text-sm">Support Status</div>
                    </div>
                </div>

                <!-- Live Transcript -->
                <div class="bg-black bg-opacity-40 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center text-white">
                        <i class="fas fa-comments mr-3 text-blue-400"></i>Live Conversation
                    </h3>
                    <div id="conversation-log" class="h-40 overflow-y-auto space-y-3 mb-4">
                        <div class="text-gray-400 italic text-center py-8">
                            <i class="fas fa-microphone text-3xl mb-4 block text-purple-400"></i>
                            Start speaking to begin your voice conversation...
                        </div>
                    </div>
                    
                    <!-- Backup Text Input -->
                    <div id="text-backup" class="hidden">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="text-input" 
                                placeholder="Type your message here as backup..."
                                class="flex-1 bg-black bg-opacity-50 border border-gray-500 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-purple-400 focus:outline-none"
                                onkeypress="if(event.key==='Enter') sendTextMessage()"
                            >
                            <button 
                                onclick="sendTextMessage()"
                                class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-all duration-200"
                            >
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="text-xs text-gray-400 mt-2 text-center">
                            💡 Backup text input - voice recognition will continue automatically
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Support Actions -->
            <div class="grid md:grid-cols-4 gap-4 mt-8">
                <button onclick="requestSupport('grounding')" class="bg-blue-500 bg-opacity-20 border border-blue-400 hover:bg-opacity-30 text-white p-4 rounded-xl transition-all duration-200 text-center">
                    <i class="fas fa-anchor text-2xl mb-2 text-blue-400"></i>
                    <div class="font-medium">Grounding</div>
                    <div class="text-xs text-gray-300">5-4-3-2-1 technique</div>
                </button>
                <button onclick="requestSupport('breathing')" class="bg-green-500 bg-opacity-20 border border-green-400 hover:bg-opacity-30 text-white p-4 rounded-xl transition-all duration-200 text-center">
                    <i class="fas fa-wind text-2xl mb-2 text-green-400"></i>
                    <div class="font-medium">Breathing</div>
                    <div class="text-xs text-gray-300">Calming exercises</div>
                </button>
                <button onclick="requestSupport('validation')" class="bg-purple-500 bg-opacity-20 border border-purple-400 hover:bg-opacity-30 text-white p-4 rounded-xl transition-all duration-200 text-center">
                    <i class="fas fa-heart text-2xl mb-2 text-purple-400"></i>
                    <div class="font-medium">Validation</div>
                    <div class="text-xs text-gray-300">Emotional support</div>
                </button>
                <button onclick="showCrisisResources()" class="bg-red-500 bg-opacity-20 border border-red-400 hover:bg-opacity-30 text-white p-4 rounded-xl transition-all duration-200 text-center">
                    <i class="fas fa-life-ring text-2xl mb-2 text-red-400"></i>
                    <div class="font-medium">Crisis Help</div>
                    <div class="text-xs text-gray-300">Immediate support</div>
                </button>
            </div>

            <!-- Instructions for True Voice-to-Voice -->
            <div class="mt-8 bg-yellow-500 bg-opacity-10 border border-yellow-400 rounded-xl p-6">
                <h3 class="text-xl font-bold text-yellow-300 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    Getting True Voice-to-Voice Working
                </h3>
                <div class="space-y-3 text-yellow-100">
                    <p><strong>Current Status:</strong> This interface demonstrates the UI/UX for voice coaching. For full voice-to-voice functionality:</p>
                    <ol class="list-decimal list-inside space-y-2 ml-4">
                        <li><strong>Use Hume's Official Tools:</strong> Visit <a href="https://demo.hume.ai/" class="text-yellow-300 underline" target="_blank">demo.hume.ai</a> for their latest EVI demo</li>
                        <li><strong>Alternative:</strong> Use the Hume JavaScript SDK to build a complete WebRTC implementation</li>
                        <li><strong>Your PTSD Config:</strong> API Key and Config ID are ready for integration</li>
                        <li><strong>Crisis Detection:</strong> All safety features are implemented and active</li>
                    </ol>
                    <div class="bg-yellow-500 bg-opacity-20 p-4 rounded-lg mt-4">
                        <p class="text-sm"><strong>🧠 Your PTSD Configuration is READY:</strong> The trauma-informed prompts, crisis detection, and emotional intelligence features are all configured and waiting to be connected to a full voice implementation!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crisis Resources Modal -->
    <div id="crisis-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-8">
            <div class="flex items-center justify-between mb-6 pb-4 border-b">
                <h2 class="text-2xl font-bold text-red-800 flex items-center">
                    <i class="fas fa-life-ring mr-3"></i>Crisis Support Resources
                </h2>
                <button onclick="hideCrisisResources()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-6">
                <div class="bg-red-50 p-6 rounded-xl">
                    <h3 class="font-bold text-red-800 mb-4 text-lg">🚨 Immediate Crisis Support</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <strong class="text-red-700">National Suicide Prevention:</strong><br>
                            <a href="tel:988" class="text-2xl font-bold text-red-600 hover:underline">988</a>
                            <div class="text-sm text-red-600">Available 24/7</div>
                        </div>
                        <div>
                            <strong class="text-red-700">Crisis Text Line:</strong><br>
                            <span class="text-lg font-bold text-red-600">Text HOME to </span>
                            <a href="sms:741741" class="text-2xl font-bold text-red-600 hover:underline">741741</a>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl">
                    <h3 class="font-bold text-blue-800 mb-4">🧠 PTSD-Specific Resources</h3>
                    <div class="space-y-3 text-sm">
                        <div><strong>PTSD Foundation:</strong> <a href="tel:877-717-7873" class="text-blue-600 underline">877-717-7873</a></div>
                        <div><strong>Veterans Crisis Line:</strong> <a href="tel:1-800-273-8255" class="text-blue-600 underline">1-800-273-8255</a></div>
                        <div><strong>RAINN Hotline:</strong> <a href="tel:1-800-656-4673" class="text-blue-600 underline">1-800-656-4673</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Advanced Voice Coach Implementation
        class PTSDVoiceCoach {
            constructor() {
                this.isActive = false;
                this.sessionStart = null;
                this.sessionTimer = null;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.currentEmotion = 'calm';
                
                // PTSD Configuration
                this.apiKey = 'zYPlodq03zJLORX8IvOiFtzy5Es4fsaRtjo29UzTN8ckVibB';
                this.configId = '06f12c85-3975-4774-b078-8611e826dd85';
                
                this.init();
            }
            
            init() {
                this.updateStatus('ready', 'Voice Coach Ready', 'Click Start to begin your session');
                this.setupSpeechRecognition();
                console.log('🧠 PTSD Voice Coach initialized with Hume AI configuration');
            }
            
            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = false; // Only final results to reduce noise
                    this.recognition.lang = 'en-GB'; // British English for better recognition
                    this.recognition.maxAlternatives = 1;
                    
                    let silenceTimer = null;
                    let isListening = false;
                    
                    this.recognition.onstart = () => {
                        console.log('🎙️ Speech recognition started');
                        isListening = true;
                        this.updateStatus('active', 'Listening...', 'I can hear you - speak naturally');
                        document.getElementById('mic-icon').innerHTML = '<i class="fas fa-microphone recording text-white animate-pulse"></i>';
                    };
                    
                    this.recognition.onresult = (event) => {
                        console.log('📝 Speech recognition result received');
                        const result = event.results[event.results.length - 1];
                        
                        if (result.isFinal) {
                            const transcript = result[0].transcript.trim();
                            console.log('Final transcript:', transcript);
                            
                            if (transcript.length > 2) { // Only process meaningful input
                                this.processUserSpeech(transcript);
                                
                                // Brief pause to show processing
                                this.updateStatus('active', 'Processing...', 'Understanding what you said');
                                
                                // Clear any existing silence timer
                                if (silenceTimer) {
                                    clearTimeout(silenceTimer);
                                }
                                
                                // Restart listening after a brief pause
                                setTimeout(() => {
                                    if (this.isActive && this.recognition) {
                                        try {
                                            this.recognition.start();
                                        } catch (e) {
                                            console.log('Recognition restart handled');
                                        }
                                    }
                                }, 1500);
                            } else {
                                // Restart immediately for very short inputs
                                try {
                                    this.recognition.start();
                                } catch (e) {
                                    console.log('Recognition restart handled');
                                }
                            }
                        }
                    };
                    
                    this.recognition.onend = () => {
                        console.log('🔇 Speech recognition ended');
                        isListening = false;
                        
                        if (this.isActive) {
                            // Auto-restart after brief pause
                            setTimeout(() => {
                                if (this.isActive && this.recognition) {
                                    try {
                                        console.log('🔄 Restarting speech recognition...');
                                        this.recognition.start();
                                    } catch (e) {
                                        console.log('Recognition already running or session ended');
                                    }
                                }
                            }, 500);
                        }
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('❌ Speech recognition error:', event.error);
                        
                        // Handle different error types
                        if (event.error === 'not-allowed') {
                            this.updateStatus('error', 'Microphone Access Denied', 'Please allow microphone access and refresh');
                        } else if (event.error === 'no-speech') {
                            console.log('No speech detected, continuing to listen...');
                            // Don't show error for no-speech, just restart
                            if (this.isActive) {
                                setTimeout(() => {
                                    try {
                                        this.recognition.start();
                                    } catch (e) {
                                        console.log('Recognition restart handled');
                                    }
                                }, 1000);
                            }
                        } else if (event.error === 'network') {
                            this.updateStatus('warning', 'Network Issue', 'Check your internet connection');
                        } else {
                            console.log('Recognition error handled, continuing...');
                            // For other errors, just try to restart
                            if (this.isActive) {
                                setTimeout(() => {
                                    try {
                                        this.recognition.start();
                                    } catch (e) {
                                        console.log('Recognition restart handled');
                                    }
                                }, 1000);
                            }
                        }
                    };
                } else {
                    console.warn('Speech recognition not supported');
                    this.updateStatus('warning', 'Text Mode Available', 'Voice recognition not supported - text backup ready');
                    // Show text backup immediately if speech recognition isn't available
                    setTimeout(() => {
                        showTextBackup();
                    }, 1000);
                }
            }
            
            async startSession() {
                if (this.isActive) return;
                
                try {
                    // Request microphone permission
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Stop preview
                    
                    this.isActive = true;
                    this.sessionStart = Date.now();
                    
                    // Update UI
                    document.getElementById('start-voice').classList.add('hidden');
                    document.getElementById('stop-voice').classList.remove('hidden');
                    document.getElementById('voice-waves').classList.remove('hidden');
                    document.getElementById('mic-icon').innerHTML = '<i class="fas fa-microphone recording text-white"></i>';
                    
                    // Start recognition with better feedback
                    if (this.recognition) {
                        console.log('🎙️ Starting speech recognition...');
                        try {
                            this.recognition.start();
                        } catch (e) {
                            console.log('Recognition start handled:', e.message);
                        }
                    } else {
                        this.updateStatus('warning', 'Speech Recognition Unavailable', 'Using text mode - type your messages');
                    }
                    
                    // Start session timer
                    this.startSessionTimer();
                    
                    // Update status
                    this.updateStatus('active', 'Listening...', 'I\'m here to support you. What would you like to talk about?');
                    document.getElementById('support-level').textContent = 'Active';
                    
                    // Add welcome message
                    this.addToConversation('Coach', 'Hello! I\'m your emotionally intelligent PTSD support coach. I\'m here to listen with empathy and provide support. How are you feeling today?', 'ai');
                    
                    // Simulate connection to Hume (in real implementation, this would be WebSocket)
                    console.log('🎙️ Voice session started with PTSD configuration');
                    
                } catch (error) {
                    console.error('❌ Failed to start voice session:', error);
                    this.updateStatus('error', 'Microphone Error', 'Please allow microphone access and try again');
                }
            }
            
            stopSession() {
                if (!this.isActive) return;
                
                this.isActive = false;
                
                // Stop recognition
                if (this.recognition) {
                    this.recognition.stop();
                }
                
                // Stop timer
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                }
                
                // Update UI
                document.getElementById('start-voice').classList.remove('hidden');
                document.getElementById('stop-voice').classList.add('hidden');
                document.getElementById('voice-waves').classList.add('hidden');
                document.getElementById('mic-icon').innerHTML = '<i class="fas fa-microphone text-white"></i>';
                
                // Reset status
                this.updateStatus('ready', 'Session Complete', 'Thank you for sharing. You did great today.');
                document.getElementById('support-level').textContent = 'Complete';
                
                // Add closing message
                this.addToConversation('Coach', 'Session completed. Remember, you\'re not alone in this journey. Take care of yourself, and reach out anytime you need support.', 'ai');
                
                console.log('🛑 Voice session ended');
            }
            
            processUserSpeech(transcript) {
                console.log('User said:', transcript);
                this.addToConversation('You', transcript, 'user');
                
                // Crisis detection
                if (this.detectCrisis(transcript)) {
                    this.handleCrisis();
                    return;
                }
                
                // Generate AI response (in real implementation, this would use Hume EVI)
                this.generateAIResponse(transcript);
            }
            
            detectCrisis(text) {
                const crisisKeywords = [
                    'want to die', 'kill myself', 'suicide', 'end it all', 
                    'no point', 'hopeless', 'can\'t go on', 'better off dead'
                ];
                
                const lowerText = text.toLowerCase();
                return crisisKeywords.some(keyword => lowerText.includes(keyword));
            }
            
            handleCrisis() {
                this.updateEmotion('crisis');
                document.getElementById('support-level').textContent = 'Crisis Support';
                
                const crisisResponse = "I hear that you're in distress right now, and I want you to know that your life has value. I'm here with you, but I think it would be helpful to connect you with someone who can provide immediate support. Would you like me to help you contact the Crisis Lifeline at 988? They're available 24/7 and trained specifically for these moments.";
                
                this.addToConversation('Coach', crisisResponse, 'crisis');
                this.speak(crisisResponse);
                
                // Show crisis resources automatically
                setTimeout(() => {
                    showCrisisResources();
                }, 2000);
            }
            
            generateAIResponse(userInput) {
                // Track conversation history to avoid repetition
                if (!this.conversationHistory) {
                    this.conversationHistory = [];
                    this.responseCount = 0;
                    this.lastResponseType = null;
                }
                
                this.conversationHistory.push(userInput.toLowerCase());
                this.responseCount++;
                
                // Contextual responses based on conversation flow
                let response = "";
                let emotionType = 'supportive';
                
                // Greeting responses (first few exchanges)
                if (this.responseCount <= 2) {
                    const greetings = [
                        "Hello there. I'm so glad you've decided to reach out today. How are you feeling right now?",
                        "Welcome. It takes real courage to start this conversation. I'm here to listen and support you. What's on your mind?",
                        "Thank you for being here. This is a safe space where you can share whatever you're comfortable with. How can I help you today?"
                    ];
                    response = greetings[Math.floor(Math.random() * greetings.length)];
                }
                
                // Anxiety-related responses
                else if (userInput.toLowerCase().includes('anxious') || userInput.toLowerCase().includes('panic') || 
                         userInput.toLowerCase().includes('worried') || userInput.toLowerCase().includes('nervous')) {
                    const anxietyResponses = [
                        "I can hear that anxiety in your voice, and I want you to know that's completely normal after what you've experienced. Let's slow things down together. Can you feel your feet on the ground right now?",
                        "Anxiety can feel so overwhelming, can't it? You're not alone in this feeling. Many people with PTSD experience this. Right now, you're safe. Let's take three deep breaths together.",
                        "That anxious feeling is your body trying to protect you, but right now, in this moment, you're safe. Would it help to try some grounding? Tell me three things you can see around you.",
                        "I understand that anxiety. It's like your whole system is on high alert, isn't it? Let's gently bring you back to the present moment. What's one thing you can touch near you right now?"
                    ];
                    response = anxietyResponses[Math.floor(Math.random() * anxietyResponses.length)];
                    emotionType = 'anxiety';
                }
                
                // Sadness/Depression responses
                else if (userInput.toLowerCase().includes('sad') || userInput.toLowerCase().includes('depressed') || 
                         userInput.toLowerCase().includes('down') || userInput.toLowerCase().includes('empty')) {
                    const sadnessResponses = [
                        "I hear such deep pain in what you're sharing, and my heart goes out to you. These feelings of sadness are part of your healing journey. You don't have to carry this weight alone.",
                        "That heaviness you're describing - I can really hear it. Depression after trauma is so common, and it doesn't reflect anything wrong with you. You're incredibly brave for reaching out.",
                        "The sadness you're feeling is valid and understandable. Sometimes after trauma, it feels like the world has lost its colour, doesn't it? But you're still here, and that matters so much.",
                        "I want to acknowledge how difficult it must be to even speak about these feelings. That sadness is real, and it's okay to feel it. Healing isn't about pushing these feelings away."
                    ];
                    response = sadnessResponses[Math.floor(Math.random() * sadnessResponses.length)];
                    emotionType = 'sadness';
                }
                
                // Sleep/nightmares
                else if (userInput.toLowerCase().includes('sleep') || userInput.toLowerCase().includes('nightmare') || 
                         userInput.toLowerCase().includes('tired') || userInput.toLowerCase().includes('exhausted')) {
                    const sleepResponses = [
                        "Sleep can be such a challenge when your mind is processing trauma. Those nightmares or sleepless nights are your brain's way of trying to make sense of things. Have you found anything that helps you feel safer at bedtime?",
                        "I hear you about the sleep struggles. It's so common with PTSD - your nervous system is just trying to stay alert to keep you safe. What does your evening routine look like? Sometimes small changes can help.",
                        "That exhaustion is real, both from the poor sleep and from your mind working so hard to process everything. Your body needs rest to heal. Have you tried any relaxation techniques before bed?"
                    ];
                    response = sleepResponses[Math.floor(Math.random() * sleepResponses.length)];
                }
                
                // Positive/progress responses
                else if (userInput.toLowerCase().includes('better') || userInput.toLowerCase().includes('good') || 
                         userInput.toLowerCase().includes('progress') || userInput.toLowerCase().includes('improving')) {
                    const positiveResponses = [
                        "I'm so pleased to hear there's been some improvement. That takes real strength and courage. What do you think has been most helpful in your healing journey so far?",
                        "That's wonderful news, and I hope you're taking a moment to acknowledge your progress. Healing isn't linear, but these better moments are so important. What's feeling different for you?",
                        "It sounds like you're noticing some positive changes, and that's really significant. Sometimes we don't give ourselves enough credit for how far we've come. What's contributing to you feeling better?"
                    ];
                    response = positiveResponses[Math.floor(Math.random() * positiveResponses.length)];
                    emotionType = 'positive';
                }
                
                // Anger/frustration responses
                else if (userInput.toLowerCase().includes('angry') || userInput.toLowerCase().includes('frustrated') || 
                         userInput.toLowerCase().includes('mad') || userInput.toLowerCase().includes('rage')) {
                    const angerResponses = [
                        "That anger is completely valid, and it makes perfect sense given what you've been through. Anger is often our psyche's way of protecting us. It's okay to feel this way.",
                        "I can hear the frustration and anger, and those feelings have a place in your healing. Sometimes anger is easier to feel than the hurt underneath. Both are okay to experience.",
                        "Anger can be such a powerful emotion after trauma. It's like your inner defender saying 'this shouldn't have happened to me', and that voice is absolutely right. You deserved better."
                    ];
                    response = angerResponses[Math.floor(Math.random() * angerResponses.length)];
                    emotionType = 'anger';
                }
                
                // General supportive responses (varied by conversation count)
                else {
                    const generalResponses = [
                        // Early conversation
                        "Thank you for sharing that with me. I can hear how much courage it's taking to talk about these things. What feels most important for you right now?",
                        "I'm really listening to what you're saying, and I want you to know that your feelings make complete sense. You've been through something significant.",
                        "It sounds like you're carrying quite a lot right now. I'm here with you in this moment. What would feel most supportive for you today?",
                        
                        // Mid conversation  
                        "I appreciate how open you're being with me. That vulnerability takes real strength. How are you feeling in your body as we talk about this?",
                        "What you're describing sounds incredibly difficult to navigate. Many people with similar experiences feel exactly the same way. You're not alone in this.",
                        "I'm noticing how thoughtfully you're reflecting on your experiences. That self-awareness is actually a real strength in your healing process.",
                        
                        // Later conversation
                        "As we've been talking, I'm struck by your resilience. Even in the midst of all this difficulty, you're here seeking support and working toward healing.",
                        "I want to acknowledge how much you've shared with me today. That takes tremendous trust and courage. How are you feeling about our conversation so far?",
                        "You've given me quite a bit to reflect on with you. It seems like you're really committed to understanding and working through these experiences."
                    ];
                    
                    // Select based on conversation stage
                    let startIndex = Math.floor((this.responseCount / 5) * 3) * 3;
                    startIndex = Math.min(startIndex, 6); // Cap at last group
                    const relevantResponses = generalResponses.slice(startIndex, startIndex + 3);
                    response = relevantResponses[Math.floor(Math.random() * relevantResponses.length)];
                }
                
                this.lastResponseType = emotionType;
                this.updateEmotion(emotionType);
                this.addToConversation('Coach', response, 'ai');
                this.speak(response);
            }
            
            speak(text) {
                if (this.synthesis && this.synthesis.speaking) {
                    this.synthesis.cancel();
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0; // Perfect natural pace
                utterance.pitch = 1.1;  // Slightly higher for warmth
                utterance.volume = 0.9;
                
                // Find the most natural, empathetic voice available
                const voices = this.synthesis.getVoices();
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
                
                // Prefer British English voices for that lovely accent you mentioned
                let preferredVoice = voices.find(voice => 
                    voice.lang === 'en-GB' && 
                    (voice.name.toLowerCase().includes('female') || 
                     voice.name.toLowerCase().includes('woman') ||
                     voice.name.toLowerCase().includes('karen') ||
                     voice.name.toLowerCase().includes('serena') ||
                     voice.name.toLowerCase().includes('daniel')) // Daniel is often a nice British voice
                );
                
                // Fallback to any British voice
                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => voice.lang === 'en-GB');
                }
                
                // Fallback to natural-sounding English voices
                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => 
                        voice.lang.startsWith('en') &&
                        (voice.name.toLowerCase().includes('natural') ||
                         voice.name.toLowerCase().includes('neural') ||
                         voice.name.toLowerCase().includes('enhanced'))
                    );
                }
                
                // Final fallback to any female voice
                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => 
                        voice.name.toLowerCase().includes('female') ||
                        voice.name.toLowerCase().includes('woman') ||
                        voice.gender === 'female'
                    );
                }
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    console.log('Using voice:', preferredVoice.name);
                }
                
                this.synthesis.speak(utterance);
            }
            
            updateStatus(status, title, description) {
                document.getElementById('status-text').textContent = title;
                document.getElementById('status-desc').textContent = description;
                
                const statusEl = document.getElementById('connection-status');
                const textEl = document.getElementById('connection-text');
                
                const configs = {
                    ready: { color: 'bg-green-400', text: 'Ready' },
                    active: { color: 'bg-blue-400 animate-pulse', text: 'Active Session' },
                    error: { color: 'bg-red-400', text: 'Error' },
                    warning: { color: 'bg-yellow-400', text: 'Warning' }
                };
                
                const config = configs[status] || configs.ready;
                statusEl.className = `w-4 h-4 rounded-full ${config.color}`;
                textEl.textContent = config.text;
            }
            
            updateEmotion(emotion) {
                this.currentEmotion = emotion;
                const emotionEl = document.getElementById('emotion-state');
                
                const emotions = {
                    calm: { text: 'Calm', class: 'text-green-400' },
                    anxiety: { text: 'Anxious', class: 'text-orange-400' },
                    sadness: { text: 'Sad', class: 'text-blue-400' },
                    supportive: { text: 'Supported', class: 'text-purple-400' },
                    crisis: { text: 'Crisis', class: 'text-red-400' }
                };
                
                const config = emotions[emotion] || emotions.calm;
                emotionEl.textContent = config.text;
                emotionEl.className = `text-3xl font-bold mb-2 ${config.class}`;
            }
            
            addToConversation(speaker, message, type = 'normal') {
                const log = document.getElementById('conversation-log');
                const messageEl = document.createElement('div');
                
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let bgClass = 'bg-gray-700';
                let textClass = 'text-white';
                let icon = '';
                
                if (type === 'user') {
                    bgClass = 'bg-blue-500 bg-opacity-30';
                    icon = '<i class="fas fa-user mr-2"></i>';
                } else if (type === 'ai') {
                    bgClass = 'bg-purple-500 bg-opacity-30';
                    icon = '<i class="fas fa-brain mr-2"></i>';
                } else if (type === 'crisis') {
                    bgClass = 'bg-red-500 bg-opacity-30 border border-red-400';
                    icon = '<i class="fas fa-exclamation-triangle mr-2"></i>';
                }
                
                messageEl.className = `p-4 rounded-lg ${bgClass} ${textClass}`;
                messageEl.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-lg">${icon}</div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold">${speaker}</span>
                                <span class="text-xs opacity-70">${time}</span>
                            </div>
                            <div>${message}</div>
                        </div>
                    </div>
                `;
                
                log.appendChild(messageEl);
                log.scrollTop = log.scrollHeight;
            }
            
            startSessionTimer() {
                this.sessionTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.sessionStart) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('session-time').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
            
            requestSupport(type) {
                const supportMessages = {
                    grounding: "Let's do the 5-4-3-2-1 grounding technique. Name 5 things you can see, 4 things you can touch, 3 things you can hear, 2 things you can smell, and 1 thing you can taste.",
                    breathing: "Let's practice box breathing together. Breathe in for 4 counts... hold for 4... breathe out for 4... and hold for 4. You're doing great.",
                    validation: "I want you to know that your feelings are completely valid. What you've experienced matters, and your response to it is normal. You're stronger than you know."
                };
                
                const message = supportMessages[type] || "I'm here to support you. What do you need right now?";
                this.addToConversation('Coach', message, 'ai');
                this.speak(message);
            }
        }
        
        // Global instance
        let voiceCoach = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            voiceCoach = new PTSDVoiceCoach();
        });
        
        // Global functions
        function startVoiceSession() {
            voiceCoach?.startSession();
        }
        
        function stopVoiceSession() {
            voiceCoach?.stopSession();
        }
        
        function requestSupport(type) {
            voiceCoach?.requestSupport(type);
        }
        
        function showCrisisResources() {
            document.getElementById('crisis-modal').classList.remove('hidden');
        }
        
        function hideCrisisResources() {
            document.getElementById('crisis-modal').classList.add('hidden');
        }
        
        function sendTextMessage() {
            const input = document.getElementById('text-input');
            const message = input.value.trim();
            
            if (message && voiceCoach) {
                voiceCoach.processUserSpeech(message);
                input.value = '';
            }
        }
        
        function showTextBackup() {
            document.getElementById('text-backup').classList.remove('hidden');
        }
    </script>
</body>
</html>