
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Cause Power - Revolutionary AI Healthcare Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure sections display properly when active */
        .section {
            display: none !important;
        }
        .section.active {
            display: block !important;
        }
    </style>
    
    <script>
    console.log('üîå Using direct WebSocket approach for Hume EVI (more reliable than SDK)');
        // üö® IMMEDIATE DASHBOARD FIX - Define function RIGHT NOW
window.initializeDashboard = function() {
    console.log('üîÑ Dashboard: Starting initialization...');
    
    try {
        const storedResults = localStorage.getItem('assessmentResults');
        console.log('üìä Assessment results check:', storedResults ? '‚úÖ Found' : '‚ùå Not found');
        
        if (storedResults) {
            const assessmentData = JSON.parse(storedResults);
            console.log('‚úÖ Successfully parsed assessment results');
            
            const dashboardArea = document.querySelector('#dashboard-content') || 
                                 document.querySelector('.dashboard-content') ||
                                 document.querySelector('[id*="dashboard"]');
            
            if (dashboardArea) {
                if (assessmentData.scores) {
                    const scoresHtml = Object.entries(assessmentData.scores)
                        .map(([category, score]) => `
                            <div class="score-item p-3 border rounded mb-2">
                                <span class="font-semibold">${category}:</span> 
                                <span class="text-lg">${score}/10</span>
                            </div>
                        `).join('');
                        
                    dashboardArea.innerHTML = `
                        <div class="assessment-results p-6">
                            <h2 class="text-2xl font-bold mb-4">Your Assessment Results</h2>
                            <div class="scores-grid">${scoresHtml}</div>
                            <div class="mt-4">
                                <button onclick="navigateToSection('assessment')" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">
                                    Retake Assessment
                                </button>
                                <button onclick="navigateToSection('coaches')" class="bg-green-500 text-white px-4 py-2 rounded">
                                    Talk to AI Coach
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    dashboardArea.innerHTML = `
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-4">Assessment Complete!</h2>
                            <p>Your results have been processed. View your personalized recommendations.</p>
                        </div>
                    `;
                }
            }
        } else {
            const dashboardArea = document.querySelector('#dashboard-content') || 
                                 document.querySelector('.dashboard-content') ||
                                 document.querySelector('[id*="dashboard"]');
            
            if (dashboardArea) {
                dashboardArea.innerHTML = `
                    <div class="welcome-dashboard p-8 text-center">
                        <h2 class="text-3xl font-bold mb-4">Welcome to Root Cause Power</h2>
                        <p class="text-lg mb-6">Take our health assessment to get personalized recommendations.</p>
                        <button onclick="navigateToSection('assessment')" class="bg-blue-600 text-white px-8 py-3 rounded-lg">
                            Start Assessment
                        </button>
                    </div>
                `;
            }
        }
        
        console.log('‚úÖ Dashboard initialization completed successfully');
        
    } catch (error) {
        console.error('‚ùå Dashboard initialization error:', error);
    }
};

console.log('‚úÖ initializeDashboard IMMEDIATELY assigned to window - should be available now!');

// ===== DEFINE COACH DAVID FUNCTIONS IMMEDIATELY =====
console.log('üöÄ Defining Coach David functions at start of script...');

// üö® CRITICAL FIX: Define initializeDashboard function EARLY and assign to window
function initializeDashboard() {
    console.log('üîÑ Dashboard: Starting initialization...');
    
    try {
        const storedResults = localStorage.getItem('assessmentResults');
        console.log('üìä Assessment results check:', storedResults ? '‚úÖ Found' : '‚ùå Not found');
        
        if (storedResults) {
            const assessmentData = JSON.parse(storedResults);
            console.log('‚úÖ Successfully parsed assessment results');
            
            const dashboardArea = document.querySelector('#dashboard-content') || 
                                 document.querySelector('.dashboard-content') ||
                                 document.querySelector('[id*="dashboard"]');
            
            if (dashboardArea && assessmentData.scores) {
                const scoresHtml = Object.entries(assessmentData.scores)
                    .map(([category, score]) => `
                        <div class="score-item p-3 border rounded mb-2">
                            <span class="font-semibold">${category}:</span> 
                            <span class="text-lg">${score}/10</span>
                        </div>
                    `).join('');
                    
                dashboardArea.innerHTML = `
                    <div class="assessment-results p-6">
                        <h2 class="text-2xl font-bold mb-4">Your Assessment Results</h2>
                        <div class="scores-grid">${scoresHtml}</div>
                        <div class="mt-4">
                            <button onclick="navigateToSection('assessment')" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">
                                Retake Assessment
                            </button>
                            <button onclick="navigateToSection('coaches')" class="bg-green-500 text-white px-4 py-2 rounded">
                                Talk to AI Coach
                            </button>
                        </div>
                    </div>
                `;
            }
        } else {
            const dashboardArea = document.querySelector('#dashboard-content') || 
                                 document.querySelector('.dashboard-content') ||
                                 document.querySelector('[id*="dashboard"]');
            
            if (dashboardArea) {
                dashboardArea.innerHTML = `
                    <div class="welcome-dashboard p-8 text-center">
                        <h2 class="text-3xl font-bold mb-4">Welcome to Root Cause Power</h2>
                        <p class="text-lg mb-6">Take our health assessment to get personalized recommendations.</p>
                        <button onclick="navigateToSection('assessment')" class="bg-blue-600 text-white px-8 py-3 rounded-lg">
                            Start Assessment
                        </button>
                    </div>
                `;
            }
        }
        
        console.log('‚úÖ Dashboard initialization completed successfully');
        
    } catch (error) {
        console.error('‚ùå Dashboard initialization error:', error);
    }
}

// üö® CRITICAL: Assign to window object to ensure global access
window.initializeDashboard = initializeDashboard;
console.log('‚úÖ initializeDashboard assigned to window object');        
        // REAL API-CONNECTED FOOD SEARCH FUNCTION
        window.searchFood = async function() {
            console.log('üîç Real API food search activated');
            const input = document.getElementById('food-search');
            const results = document.getElementById('food-results');
            
            if (!input || !results) return;
            
            const query = input.value.trim();
            if (!query) {
                alert('Please enter a food name');
                return;
            }
            
            // Show loading
            results.innerHTML = `
                <div class="bg-blue-800/30 border border-blue-600 rounded-lg p-6 text-center">
                    <div class="animate-spin text-2xl mb-2">‚è≥</div>
                    <p class="text-blue-300">Searching nutrition database for "${query}"...</p>
                </div>
            `;
            results.classList.remove('hidden');
            
            try {
                // Try real API first
                let foodData = await tryRealNutritionAPI(query);
                
                // Fallback to local database
                if (!foodData) {
                    foodData = getFallbackNutritionData(query);
                }
                
                if (foodData) {
                    results.innerHTML = `
                        <div class="bg-green-800/30 border border-green-600 rounded-lg p-6">
                            <h4 class="text-xl font-bold text-green-300 mb-4">üçé ${foodData.name} - Nutrition Facts</h4>
                            <p class="text-slate-300 mb-4">Per ${foodData.unit} serving:</p>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-3">
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Calories:</span>
                                        <span class="text-white font-semibold">${foodData.calories}</span>
                                    </div>
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Protein:</span>
                                        <span class="text-white font-semibold">${foodData.protein}g</span>
                                    </div>
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Carbohydrates:</span>
                                        <span class="text-white font-semibold">${foodData.carbs}g</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Total Fat:</span>
                                        <span class="text-white font-semibold">${foodData.fat}g</span>
                                    </div>
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Fiber:</span>
                                        <span class="text-white font-semibold">${foodData.fiber}g</span>
                                    </div>
                                    <div class="flex justify-between bg-slate-600 p-3 rounded">
                                        <span class="text-slate-300">Sugar:</span>
                                        <span class="text-white font-semibold">${foodData.sugar}g</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="addToCalculator('${query}', ${foodData.calories}, ${foodData.protein}, ${foodData.carbs}, ${foodData.fat}, ${foodData.fiber}, ${foodData.sugar})" 
                                    class="mt-4 w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                + Add to Meal Calculator
                            </button>
                        </div>
                    `;
                } else {
                    results.innerHTML = `
                        <div class="bg-red-800/30 border border-red-600 rounded-lg p-6">
                            <h4 class="text-xl font-bold text-red-300 mb-2">‚ùå Food Not Found</h4>
                            <p class="text-slate-300 mb-4">Sorry, "${query}" is not in our database yet.</p>
                            <p class="text-slate-400 text-sm">Try searching for: apple, banana, chicken breast, salmon, broccoli, quinoa, avocado, spinach, sweet potato, almonds, greek yogurt, oats, blueberries, eggs, brown rice, tuna, carrots, lentils, walnuts, or kale.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Food search error:', error);
                results.innerHTML = `
                    <div class="bg-red-800/30 border border-red-600 rounded-lg p-6 text-center">
                        <div class="text-2xl mb-2">‚ùå</div>
                        <p class="text-red-300">Unable to search nutrition database. Please try again.</p>
                        <button onclick="searchFood()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white">
                            Retry Search
                        </button>
                    </div>
                `;
            }
        };
        
        // REAL API INTEGRATION FUNCTION
        async function tryRealNutritionAPI(foodName) {
            try {
                console.log(`üåç Trying Open Food Facts API for: ${foodName}`);
                
                // Use Open Food Facts API (free, no key required)
                const searchUrl = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(foodName)}&search_simple=1&action=process&json=1&page_size=1`;
                
                const response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'HealthcareApp/1.0'
                    }
                });
                
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.products && data.products.length > 0) {
                    const product = data.products[0];
                    const nutrients = product.nutriments || {};
                    
                    return {
                        name: product.product_name || foodName,
                        calories: Math.round(nutrients.energy_kcal_100g || nutrients['energy-kcal_100g'] || 0),
                        protein: Math.round((nutrients.proteins_100g || 0) * 10) / 10,
                        carbs: Math.round((nutrients.carbohydrates_100g || 0) * 10) / 10,
                        fat: Math.round((nutrients.fat_100g || 0) * 10) / 10,
                        fiber: Math.round((nutrients.fiber_100g || 0) * 10) / 10,
                        sugar: Math.round((nutrients.sugars_100g || 0) * 10) / 10,
                        unit: '100g'
                    };
                }
                
                return null;
                
            } catch (error) {
                console.log('API unavailable, using local database');
                return null;
            }
        }
        
        // COMPREHENSIVE FALLBACK DATABASE
        function getFallbackNutritionData(foodName) {
            const nutritionDatabase = {
                'apple': { name: 'Apple', calories: 52, protein: 0.3, carbs: 14, fat: 0.2, fiber: 2.4, sugar: 10.4, unit: '100g' },
                'banana': { name: 'Banana', calories: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6, sugar: 12.2, unit: '100g' },
                'chicken breast': { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0, sugar: 0, unit: '100g' },
                'chicken': { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0, sugar: 0, unit: '100g' },
                'salmon': { name: 'Salmon', calories: 208, protein: 22, carbs: 0, fat: 12, fiber: 0, sugar: 0, unit: '100g' },
                'broccoli': { name: 'Broccoli', calories: 34, protein: 2.8, carbs: 7, fat: 0.4, fiber: 2.6, sugar: 1.5, unit: '100g' },
                'quinoa': { name: 'Quinoa', calories: 368, protein: 14, carbs: 64, fat: 6, fiber: 7, sugar: 0, unit: '100g' },
                'avocado': { name: 'Avocado', calories: 160, protein: 2, carbs: 9, fat: 15, fiber: 7, sugar: 0.7, unit: '100g' },
                'spinach': { name: 'Spinach', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2, sugar: 0.4, unit: '100g' },
                'sweet potato': { name: 'Sweet Potato', calories: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3, sugar: 4.2, unit: '100g' },
                'almonds': { name: 'Almonds', calories: 579, protein: 21, carbs: 22, fat: 50, fiber: 12, sugar: 4.4, unit: '100g' },
                'greek yogurt': { name: 'Greek Yogurt', calories: 59, protein: 10, carbs: 3.6, fat: 0.4, fiber: 0, sugar: 3.6, unit: '100g' },
                'oats': { name: 'Oats', calories: 389, protein: 17, carbs: 66, fat: 7, fiber: 11, sugar: 0, unit: '100g' },
                'blueberries': { name: 'Blueberries', calories: 57, protein: 0.7, carbs: 14, fat: 0.3, fiber: 2.4, sugar: 10, unit: '100g' },
                'eggs': { name: 'Eggs', calories: 155, protein: 13, carbs: 1.1, fat: 11, fiber: 0, sugar: 1.1, unit: '100g' },
                'brown rice': { name: 'Brown Rice', calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8, sugar: 0.4, unit: '100g' },
                'rice': { name: 'Brown Rice', calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8, sugar: 0.4, unit: '100g' },
                'tuna': { name: 'Tuna', calories: 144, protein: 30, carbs: 0, fat: 1, fiber: 0, sugar: 0, unit: '100g' },
                'carrots': { name: 'Carrots', calories: 41, protein: 0.9, carbs: 10, fat: 0.2, fiber: 2.8, sugar: 4.7, unit: '100g' },
                'lentils': { name: 'Lentils', calories: 116, protein: 9, carbs: 20, fat: 0.4, fiber: 8, sugar: 1.8, unit: '100g' },
                'walnuts': { name: 'Walnuts', calories: 654, protein: 15, carbs: 14, fat: 65, fiber: 7, sugar: 2.6, unit: '100g' },
                'kale': { name: 'Kale', calories: 35, protein: 2.9, carbs: 7, fat: 0.9, fiber: 4.1, sugar: 0.8, unit: '100g' }
            };

            const normalizedName = foodName.toLowerCase().trim();
            return nutritionDatabase[normalizedName] || null;
        }
        
        window.quickFoodSearch = function(food) {
            const input = document.getElementById('food-search');
            if (input) { input.value = food; window.searchFood(); }
        };
        
        window.handleFoodSearch = function(event) {
            if (event.key === 'Enter') window.searchFood();
        };
        
        window.addMealItem = function() {
            console.log('‚ûï Adding meal item');
            const builder = document.getElementById('meal-builder');
            if (builder) {
                const item = document.createElement('div');
                item.className = 'meal-item flex items-center gap-3 p-3 bg-slate-600 rounded';
                item.innerHTML = `<input type="text" placeholder="Food" class="food-name flex-1 px-3 py-2 bg-slate-500 text-white rounded"><input type="number" placeholder="Amount" class="food-amount w-20 px-3 py-2 bg-slate-500 text-white rounded"><select class="food-unit px-3 py-2 bg-slate-500 text-white rounded"><option value="g">g</option><option value="oz">oz</option></select><button onclick="removeMealItem(this)" class="text-red-400">üóëÔ∏è</button>`;
                builder.appendChild(item);
            }
        };
        
        window.removeMealItem = function(btn) { btn.parentElement.remove(); };
        window.calculateMeal = function() { console.log('üßÆ Calculating...'); };
        window.saveMealPlan = function() { alert('‚úÖ Meal plan saved!'); };
        window.loadMealPlan = function() { alert('üìÇ Loading meal plan...'); };
        window.generateMealSuggestions = function() { alert('ü§ñ Generating suggestions...'); };
        window.exportMealPlan = function() { alert('üìä Exporting meal plan...'); };
        
        console.log('‚úÖ CRITICAL nutrition functions loaded successfully!');
        
        // ===== HEALTH DISCLAIMER FUNCTIONS =====
        console.log('üõ°Ô∏è Loading health disclaimer management functions...');
        
        // Health disclaimer modal management
        window.showHealthDisclaimer = function() {
            console.log('üõ°Ô∏è Showing health disclaimer modal');
            const modal = document.getElementById('healthDisclaimerModal');
            if (modal) {
                modal.style.display = 'flex';
                // Enable accept button when all checkboxes are checked
                setupDisclaimerValidation();
            }
        };
        
        // Setup disclaimer validation
        function setupDisclaimerValidation() {
            const checkboxes = ['consent-understand', 'consent-medical', 'consent-privacy'];
            const acceptBtn = document.getElementById('acceptDisclaimerBtn');
            
            function validateCheckboxes() {
                const allChecked = checkboxes.every(id => 
                    document.getElementById(id)?.checked || false
                );
                
                if (acceptBtn) {
                    acceptBtn.disabled = !allChecked;
                    if (allChecked) {
                        acceptBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        acceptBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }
            
            // Add event listeners to checkboxes
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', validateCheckboxes);
                }
            });
            
            // Initial validation
            validateCheckboxes();
        }
        
        window.acceptHealthDisclaimer = function() {
            console.log('‚úÖ Health disclaimer accepted');
            const modal = document.getElementById('healthDisclaimerModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Set disclaimer accepted flag
            localStorage.setItem('healthDisclaimerAccepted', 'true');
            
            // Start the intelligent assessment
            startIntelligentAssessment();
        };
        
        window.declineHealthDisclaimer = function() {
            console.log('‚ùå Health disclaimer declined');
            const modal = document.getElementById('healthDisclaimerModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Navigate back to home
            navigateToSection('home');
        };
        
        // Check if disclaimer was already accepted
        window.checkDisclaimerAccepted = function() {
            return localStorage.getItem('healthDisclaimerAccepted') === 'true';
        };
        
        console.log('‚úÖ Health disclaimer functions loaded successfully!');
        
        // ===== INTELLIGENT ASSESSMENT SYSTEM =====
        console.log('üß† Loading intelligent assessment system...');
        
        // Assessment Configuration
        let currentQuestionIndex = 0;
        let assessmentData = {};
        let adaptiveQuestions = [];
        let totalQuestions = 0;

        // Core Assessment Questions (Physical + Mental Health Focus)
        const coreQuestions = [
            {
                id: 'existing_conditions',
                type: 'multiple_choice_multi',
                category: 'physical_health',
                question: 'Do you have any existing health conditions?',
                subtext: 'Select all that apply. This helps us understand your baseline health.',
                required: true,
                options: [
                    { value: 'none', text: 'No existing conditions', icon: 'fas fa-check-circle' },
                    { value: 'diabetes', text: 'Diabetes', icon: 'fas fa-heartbeat' },
                    { value: 'hypertension', text: 'High Blood Pressure', icon: 'fas fa-tint' },
                    { value: 'heart_disease', text: 'Heart Disease', icon: 'fas fa-heart' },
                    { value: 'arthritis', text: 'Arthritis/Joint Issues', icon: 'fas fa-bone' },
                    { value: 'chronic_pain', text: 'Chronic Pain', icon: 'fas fa-exclamation-triangle' },
                    { value: 'thyroid', text: 'Thyroid Disorders', icon: 'fas fa-pills' },
                    { value: 'mental_health', text: 'Mental Health Conditions', icon: 'fas fa-brain' },
                    { value: 'autoimmune', text: 'Autoimmune Disorders', icon: 'fas fa-shield-alt' },
                    { value: 'other', text: 'Other condition', icon: 'fas fa-plus' }
                ]
            },
            {
                id: 'energy_pattern',
                type: 'multiple_choice_single',
                category: 'physical_health',
                question: 'How would you describe your typical energy levels?',
                subtext: 'Think about your average day over the past 2 weeks.',
                required: true,
                options: [
                    { value: 'high_consistent', text: 'High and consistent throughout the day', icon: 'fas fa-chart-line', color: 'text-green-400' },
                    { value: 'good_dips', text: 'Generally good with some afternoon dips', icon: 'fas fa-wave-square', color: 'text-blue-400' },
                    { value: 'moderate_variable', text: 'Moderate but quite variable', icon: 'fas fa-signal', color: 'text-yellow-400' },
                    { value: 'low_consistent', text: 'Consistently low energy', icon: 'fas fa-battery-quarter', color: 'text-orange-400' },
                    { value: 'extremely_low', text: 'Extremely low, struggle to function', icon: 'fas fa-battery-empty', color: 'text-red-400' }
                ]
            },
            {
                id: 'sleep_assessment',
                type: 'slider_multi',
                category: 'physical_health',
                question: 'Tell us about your sleep patterns',
                subtext: 'Rate different aspects of your sleep (0 = Poor, 10 = Excellent)',
                required: true,
                sliders: [
                    { id: 'falling_asleep', label: 'Ease of falling asleep', icon: 'fas fa-bed' },
                    { id: 'staying_asleep', label: 'Staying asleep through the night', icon: 'fas fa-moon' },
                    { id: 'sleep_quality', label: 'Overall sleep quality', icon: 'fas fa-star' },
                    { id: 'morning_refreshed', label: 'Feeling refreshed in the morning', icon: 'fas fa-sun' }
                ]
            },
            {
                id: 'stress_sources',
                type: 'multiple_choice_multi',
                category: 'mental_health',
                question: 'What are your main sources of stress?',
                subtext: 'Select all that significantly impact your wellbeing.',
                required: true,
                options: [
                    { value: 'work', text: 'Work/Career pressure', icon: 'fas fa-briefcase' },
                    { value: 'finances', text: 'Financial concerns', icon: 'fas fa-dollar-sign' },
                    { value: 'relationships', text: 'Relationship issues', icon: 'fas fa-heart-broken' },
                    { value: 'family', text: 'Family responsibilities', icon: 'fas fa-home' },
                    { value: 'health', text: 'Health concerns', icon: 'fas fa-heartbeat' },
                    { value: 'trauma', text: 'Past trauma/experiences', icon: 'fas fa-exclamation-triangle' },
                    { value: 'minimal', text: 'Minimal stress currently', icon: 'fas fa-smile' }
                ]
            },
            {
                id: 'daily_functioning',
                type: 'slider_multi',
                category: 'life_impact',
                question: 'How well are you functioning in daily activities?',
                subtext: 'Rate your current ability in these key life areas (0 = Major difficulty, 10 = Functioning excellently)',
                required: true,
                sliders: [
                    { id: 'work_productivity', label: 'Work/School performance', icon: 'fas fa-tasks' },
                    { id: 'household_tasks', label: 'Household management', icon: 'fas fa-home' },
                    { id: 'self_care', label: 'Personal self-care', icon: 'fas fa-spa' },
                    { id: 'relationships', label: 'Maintaining relationships', icon: 'fas fa-heart' }
                ]
            }
        ];

        // Start intelligent assessment
        window.startIntelligentAssessment = function() {
            console.log('üß† Starting intelligent assessment...');
            currentQuestionIndex = 0;
            assessmentData = {};
            adaptiveQuestions = [...coreQuestions];
            totalQuestions = coreQuestions.length;
            displayCurrentQuestion();
        };

        // Display Current Question
        function displayCurrentQuestion() {
            const container = document.getElementById('assessment-container');
            const question = adaptiveQuestions[currentQuestionIndex];
            
            if (!question) {
                completeAssessment();
                return;
            }

            // Update progress
            const progressPercent = ((currentQuestionIndex) / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;

            console.log(`üìù Displaying question: ${question.id}`);
            container.innerHTML = generateQuestionHTML(question);
        }

        // Generate Question HTML based on type
        function generateQuestionHTML(question) {
            let html = `
                <div class="bg-slate-700/30 rounded-2xl p-8 mb-6 border border-slate-600/50">
                    <div class="mb-6">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center mr-4">
                                <span class="text-white font-bold text-lg">${currentQuestionIndex + 1}</span>
                            </div>
                            <div class="flex-1">
                                <h2 class="text-2xl font-bold text-slate-100">${question.question}</h2>
                                ${question.subtext ? `<p class="text-slate-400 mt-2">${question.subtext}</p>` : ''}
                            </div>
                        </div>
                    </div>
            `;

            switch (question.type) {
                case 'multiple_choice_single':
                    html += generateSingleChoiceHTML(question);
                    break;
                case 'multiple_choice_multi':
                    html += generateMultiChoiceHTML(question);
                    break;
                case 'slider_multi':
                    html += generateSlidersHTML(question);
                    break;
                default:
                    html += generateTextInputHTML(question);
            }

            html += `
                    <div class="flex justify-between mt-8">
                        <button onclick="previousQuestion()" class="bg-slate-600 hover:bg-slate-700 px-6 py-3 rounded-xl text-white font-medium transition-all ${currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-left mr-2"></i>Previous
                        </button>
                        <button onclick="nextQuestion()" id="next-btn" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-6 py-3 rounded-xl text-white font-medium transition-all shadow-lg">
                            Next<i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            `;

            return html;
        }

        // Generate Single Choice Options
        function generateSingleChoiceHTML(question) {
            return `
                <div class="space-y-3">
                    ${question.options.map((option, index) => `
                        <label class="block cursor-pointer">
                            <input type="radio" name="q_${question.id}" value="${option.value}" class="sr-only peer" onchange="handleSingleChoice('${question.id}', '${option.value}')">
                            <div class="p-4 bg-slate-600/30 hover:bg-slate-500/50 rounded-xl transition-all border-2 border-slate-500/50 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/20">
                                <div class="flex items-center">
                                    <i class="${option.icon} text-xl mr-4 ${option.color || 'text-slate-400'}"></i>
                                    <span class="text-slate-100 font-medium">${option.text}</span>
                                </div>
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
        }

        // Generate Multi Choice Options  
        function generateMultiChoiceHTML(question) {
            return `
                <div class="space-y-3">
                    ${question.options.map((option, index) => `
                        <label class="block cursor-pointer">
                            <input type="checkbox" value="${option.value}" class="sr-only peer" onchange="handleMultiChoice('${question.id}', '${option.value}', this.checked)">
                            <div class="p-4 bg-slate-600/30 hover:bg-slate-500/50 rounded-xl transition-all border-2 border-slate-500/50 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/20">
                                <div class="flex items-center">
                                    <i class="${option.icon} text-xl mr-4 text-slate-400"></i>
                                    <span class="text-slate-100 font-medium">${option.text}</span>
                                </div>
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
        }

        // Generate Sliders
        function generateSlidersHTML(question) {
            return `
                <div class="space-y-6">
                    ${question.sliders.map((slider, index) => `
                        <div class="slider-container">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <i class="${slider.icon} text-emerald-400 mr-3"></i>
                                    <span class="text-slate-100 font-medium">${slider.label}</span>
                                </div>
                                <span id="slider_${slider.id}_value" class="text-emerald-400 font-bold text-lg">5</span>
                            </div>
                            <div class="relative">
                                <input type="range" min="0" max="10" value="5" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer slider" 
                                       id="slider_${slider.id}" 
                                       oninput="updateSliderValue('${slider.id}', this.value); handleSliderChange('${question.id}', '${slider.id}', this.value)">
                                <div class="flex justify-between text-xs text-slate-500 mt-1">
                                    <span>0</span>
                                    <span>5</span>
                                    <span>10</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <style>
                    .slider::-webkit-slider-thumb {
                        appearance: none;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: linear-gradient(45deg, #10b981, #3b82f6);
                        cursor: pointer;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    }
                    .slider::-moz-range-thumb {
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        background: linear-gradient(45deg, #10b981, #3b82f6);
                        cursor: pointer;
                        border: none;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    }
                </style>
            `;
        }

        // Handle Response Functions
        function handleSingleChoice(questionId, value) {
            assessmentData[questionId] = value;
            console.log(`‚úÖ Single choice: ${questionId} = ${value}`);
        }

        function handleMultiChoice(questionId, value, checked) {
            if (!assessmentData[questionId]) {
                assessmentData[questionId] = [];
            }
            
            if (checked) {
                assessmentData[questionId].push(value);
            } else {
                assessmentData[questionId] = assessmentData[questionId].filter(v => v !== value);
            }
            console.log(`‚úÖ Multi choice: ${questionId} = ${assessmentData[questionId]}`);
        }

        function handleSliderChange(questionId, sliderId, value) {
            if (!assessmentData[questionId]) {
                assessmentData[questionId] = {};
            }
            assessmentData[questionId][sliderId] = parseInt(value);
            console.log(`‚úÖ Slider: ${questionId}.${sliderId} = ${value}`);
        }

        function updateSliderValue(sliderId, value) {
            const element = document.getElementById(`slider_${sliderId}_value`);
            if (element) element.textContent = value;
        }

        // Navigation Functions
        window.nextQuestion = function() {
            const currentQuestion = adaptiveQuestions[currentQuestionIndex];
            if (currentQuestion && currentQuestion.required && !isQuestionAnswered(currentQuestion)) {
                alert('Please answer this question before continuing.');
                return;
            }
            
            // Generate adaptive follow-up questions based on current response
            generateFollowUpQuestions(currentQuestion);
            
            currentQuestionIndex++;
            displayCurrentQuestion();
        };

        // Generate follow-up questions based on responses
        function generateFollowUpQuestions(currentQuestion) {
            const response = assessmentData[currentQuestion.id];
            
            if (currentQuestion.id === 'existing_conditions' && Array.isArray(response)) {
                // Add specific follow-up questions for chronic conditions
                if (response.includes('diabetes')) {
                    addFollowUpQuestion({
                        id: 'diabetes_details',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'What type of diabetes do you have?',
                        subtext: 'This helps us provide more targeted support.',
                        required: true,
                        options: [
                            { value: 'type1', text: 'Type 1 Diabetes', icon: 'fas fa-syringe' },
                            { value: 'type2', text: 'Type 2 Diabetes', icon: 'fas fa-pills' },
                            { value: 'gestational', text: 'Gestational Diabetes', icon: 'fas fa-baby' },
                            { value: 'prediabetes', text: 'Pre-diabetes', icon: 'fas fa-exclamation-triangle' },
                            { value: 'unsure', text: 'Not sure', icon: 'fas fa-question' }
                        ]
                    });
                    
                    addFollowUpQuestion({
                        id: 'diabetes_control',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'How well controlled is your diabetes?',
                        subtext: 'Think about your recent blood sugar levels and HbA1c results.',
                        required: true,
                        options: [
                            { value: 'excellent', text: 'Excellent control (HbA1c <7%)', icon: 'fas fa-check-circle', color: 'text-green-400' },
                            { value: 'good', text: 'Good control (HbA1c 7-8%)', icon: 'fas fa-thumbs-up', color: 'text-blue-400' },
                            { value: 'fair', text: 'Fair control (HbA1c 8-9%)', icon: 'fas fa-meh', color: 'text-yellow-400' },
                            { value: 'poor', text: 'Poor control (HbA1c >9%)', icon: 'fas fa-exclamation-triangle', color: 'text-orange-400' },
                            { value: 'unknown', text: 'Don\'t know my levels', icon: 'fas fa-question-circle', color: 'text-slate-400' }
                        ]
                    });
                }
                
                // Hypertension follow-up questions
                if (response.includes('hypertension')) {
                    addFollowUpQuestion({
                        id: 'hypertension_control',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'How well controlled is your blood pressure?',
                        subtext: 'Think about your recent readings and medication effectiveness.',
                        required: true,
                        options: [
                            { value: 'excellent', text: 'Excellent control (<120/80)', icon: 'fas fa-check-circle', color: 'text-green-400' },
                            { value: 'good', text: 'Good control (120-129/80-84)', icon: 'fas fa-thumbs-up', color: 'text-blue-400' },
                            { value: 'fair', text: 'Fair control (130-139/85-89)', icon: 'fas fa-meh', color: 'text-yellow-400' },
                            { value: 'poor', text: 'Poor control (>140/90)', icon: 'fas fa-exclamation-triangle', color: 'text-red-400' },
                            { value: 'unknown', text: 'Don\'t monitor regularly', icon: 'fas fa-question-circle', color: 'text-slate-400' }
                        ]
                    });
                }
                
                // Heart Disease follow-up questions
                if (response.includes('heart_disease')) {
                    addFollowUpQuestion({
                        id: 'heart_disease_type',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'What type of heart condition do you have?',
                        subtext: 'This helps us understand your specific needs.',
                        required: true,
                        options: [
                            { value: 'coronary_artery', text: 'Coronary Artery Disease', icon: 'fas fa-heart' },
                            { value: 'heart_failure', text: 'Heart Failure', icon: 'fas fa-heartbeat' },
                            { value: 'arrhythmia', text: 'Arrhythmia/Irregular Heartbeat', icon: 'fas fa-wave-square' },
                            { value: 'valve_disease', text: 'Heart Valve Disease', icon: 'fas fa-circle-notch' },
                            { value: 'other_heart', text: 'Other heart condition', icon: 'fas fa-plus' }
                        ]
                    });
                }
                
                // Chronic Pain follow-up questions
                if (response.includes('chronic_pain')) {
                    addFollowUpQuestion({
                        id: 'pain_location',
                        type: 'multiple_choice_multi',
                        category: 'chronic_conditions',
                        question: 'Where do you experience chronic pain?',
                        subtext: 'Select all areas that apply.',
                        required: true,
                        options: [
                            { value: 'back', text: 'Back/Spine', icon: 'fas fa-user' },
                            { value: 'neck', text: 'Neck/Shoulders', icon: 'fas fa-head-side-virus' },
                            { value: 'joints', text: 'Joints (knees, hips, etc.)', icon: 'fas fa-bone' },
                            { value: 'headache', text: 'Headaches/Migraines', icon: 'fas fa-brain' },
                            { value: 'fibromyalgia', text: 'Widespread (Fibromyalgia)', icon: 'fas fa-exclamation-triangle' },
                            { value: 'neuropathy', text: 'Nerve Pain', icon: 'fas fa-bolt' },
                            { value: 'other_pain', text: 'Other location', icon: 'fas fa-plus' }
                        ]
                    });
                    
                    addFollowUpQuestion({
                        id: 'pain_severity',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'On average, how would you rate your pain level?',
                        subtext: 'Think about your typical day over the past week.',
                        required: true,
                        options: [
                            { value: 'mild', text: 'Mild (1-3/10) - Minimal interference', icon: 'fas fa-smile', color: 'text-green-400' },
                            { value: 'moderate', text: 'Moderate (4-6/10) - Some interference', icon: 'fas fa-meh', color: 'text-yellow-400' },
                            { value: 'severe', text: 'Severe (7-8/10) - Significant interference', icon: 'fas fa-frown', color: 'text-orange-400' },
                            { value: 'very_severe', text: 'Very Severe (9-10/10) - Disabling', icon: 'fas fa-dizzy', color: 'text-red-400' }
                        ]
                    });
                }
                
                // Arthritis follow-up questions
                if (response.includes('arthritis')) {
                    addFollowUpQuestion({
                        id: 'arthritis_type',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'What type of arthritis do you have?',
                        subtext: 'If diagnosed, select the specific type.',
                        required: true,
                        options: [
                            { value: 'osteoarthritis', text: 'Osteoarthritis', icon: 'fas fa-bone' },
                            { value: 'rheumatoid', text: 'Rheumatoid Arthritis', icon: 'fas fa-hands' },
                            { value: 'psoriatic', text: 'Psoriatic Arthritis', icon: 'fas fa-skin' },
                            { value: 'gout', text: 'Gout', icon: 'fas fa-foot' },
                            { value: 'fibromyalgia', text: 'Fibromyalgia', icon: 'fas fa-exclamation-triangle' },
                            { value: 'unknown_arthritis', text: 'Joint pain, not sure what type', icon: 'fas fa-question-circle' }
                        ]
                    });
                }
                
                // Thyroid follow-up questions
                if (response.includes('thyroid')) {
                    addFollowUpQuestion({
                        id: 'thyroid_type',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'What type of thyroid condition do you have?',
                        subtext: 'Select your diagnosed condition.',
                        required: true,
                        options: [
                            { value: 'hypothyroid', text: 'Hypothyroidism (Underactive)', icon: 'fas fa-arrow-down' },
                            { value: 'hyperthyroid', text: 'Hyperthyroidism (Overactive)', icon: 'fas fa-arrow-up' },
                            { value: 'hashimotos', text: 'Hashimoto\'s Disease', icon: 'fas fa-shield-alt' },
                            { value: 'graves', text: 'Graves\' Disease', icon: 'fas fa-bolt' },
                            { value: 'thyroid_cancer', text: 'Thyroid Cancer/Removed', icon: 'fas fa-ribbon' },
                            { value: 'unknown_thyroid', text: 'Thyroid issues, not sure what type', icon: 'fas fa-question-circle' }
                        ]
                    });
                }
                
                // Mental Health follow-up questions
                if (response.includes('mental_health')) {
                    addFollowUpQuestion({
                        id: 'mental_health_conditions',
                        type: 'multiple_choice_multi',
                        category: 'chronic_conditions',
                        question: 'What mental health conditions do you manage?',
                        subtext: 'Select all that apply. This is kept confidential.',
                        required: true,
                        options: [
                            { value: 'depression', text: 'Depression', icon: 'fas fa-cloud-rain' },
                            { value: 'anxiety', text: 'Anxiety Disorders', icon: 'fas fa-exclamation-triangle' },
                            { value: 'ptsd', text: 'PTSD/Trauma', icon: 'fas fa-shield-alt' },
                            { value: 'bipolar', text: 'Bipolar Disorder', icon: 'fas fa-wave-square' },
                            { value: 'adhd', text: 'ADHD', icon: 'fas fa-brain' },
                            { value: 'ocd', text: 'OCD', icon: 'fas fa-redo' },
                            { value: 'eating_disorder', text: 'Eating Disorder', icon: 'fas fa-utensils' },
                            { value: 'other_mental', text: 'Other condition', icon: 'fas fa-plus' }
                        ]
                    });
                }
                
                // Autoimmune follow-up questions
                if (response.includes('autoimmune')) {
                    addFollowUpQuestion({
                        id: 'autoimmune_type',
                        type: 'multiple_choice_multi',
                        category: 'chronic_conditions',
                        question: 'What autoimmune conditions do you have?',
                        subtext: 'Select all diagnosed conditions.',
                        required: true,
                        options: [
                            { value: 'lupus', text: 'Lupus', icon: 'fas fa-butterfly' },
                            { value: 'ms', text: 'Multiple Sclerosis', icon: 'fas fa-brain' },
                            { value: 'crohns', text: 'Crohn\'s Disease', icon: 'fas fa-stomach' },
                            { value: 'ulcerative_colitis', text: 'Ulcerative Colitis', icon: 'fas fa-prescription-bottle' },
                            { value: 'celiac', text: 'Celiac Disease', icon: 'fas fa-bread-slice' },
                            { value: 'psoriasis', text: 'Psoriasis', icon: 'fas fa-skin' },
                            { value: 'ra', text: 'Rheumatoid Arthritis', icon: 'fas fa-hands' },
                            { value: 'type1_diabetes', text: 'Type 1 Diabetes', icon: 'fas fa-syringe' },
                            { value: 'other_autoimmune', text: 'Other autoimmune condition', icon: 'fas fa-plus' }
                        ]
                    });
                }
                
                if (response.includes('hypertension')) {
                    addFollowUpQuestion({
                        id: 'hypertension_control',
                        type: 'multiple_choice_single',
                        category: 'chronic_conditions',
                        question: 'How is your blood pressure currently managed?',
                        required: true,
                        options: [
                            { value: 'medication_controlled', text: 'Well controlled with medication', icon: 'fas fa-pills' },
                            { value: 'lifestyle_controlled', text: 'Controlled with diet and exercise', icon: 'fas fa-heart' },
                            { value: 'uncontrolled', text: 'Still working on control', icon: 'fas fa-chart-line' },
                            { value: 'newly_diagnosed', text: 'Recently diagnosed', icon: 'fas fa-stethoscope' }
                        ]
                    });
                }
                
                if (response.includes('chronic_pain')) {
                    addFollowUpQuestion({
                        id: 'pain_severity',
                        type: 'slider_multi',
                        category: 'chronic_conditions',
                        question: 'Tell us about your pain levels',
                        subtext: 'Rate your pain experience (0 = No pain, 10 = Severe pain)',
                        required: true,
                        sliders: [
                            { id: 'average_pain', label: 'Average daily pain level', icon: 'fas fa-chart-bar' },
                            { id: 'worst_pain', label: 'Worst pain episodes', icon: 'fas fa-exclamation-triangle' },
                            { id: 'pain_interference', label: 'How much pain interferes with daily life', icon: 'fas fa-ban' }
                        ]
                    });
                }
                
                if (response.includes('mental_health')) {
                    addFollowUpQuestion({
                        id: 'mental_health_details',
                        type: 'multiple_choice_multi',
                        category: 'chronic_conditions',
                        question: 'Which mental health conditions apply to you?',
                        subtext: 'Select all that you\'ve been diagnosed with or are currently managing.',
                        required: true,
                        options: [
                            { value: 'depression', text: 'Depression', icon: 'fas fa-cloud-rain' },
                            { value: 'anxiety', text: 'Anxiety disorders', icon: 'fas fa-bolt' },
                            { value: 'ptsd', text: 'PTSD or trauma-related', icon: 'fas fa-shield-alt' },
                            { value: 'bipolar', text: 'Bipolar disorder', icon: 'fas fa-chart-line' },
                            { value: 'adhd', text: 'ADHD', icon: 'fas fa-brain' },
                            { value: 'eating_disorder', text: 'Eating disorders', icon: 'fas fa-utensils' },
                            { value: 'other_mental', text: 'Other condition', icon: 'fas fa-plus' }
                        ]
                    });
                }
            }
            
            // Enhanced sleep follow-ups
            if (currentQuestion.id === 'sleep_assessment') {
                const sleepData = assessmentData.sleep_assessment || {};
                const avgSleepScore = Object.values(sleepData).reduce((a, b) => a + b, 0) / Object.keys(sleepData).length;
                
                if (avgSleepScore <= 5) {
                    addFollowUpQuestion({
                        id: 'sleep_problems',
                        type: 'multiple_choice_multi',
                        category: 'sleep_health',
                        question: 'What specific sleep challenges are you experiencing?',
                        subtext: 'Select all that regularly affect your sleep.',
                        required: true,
                        options: [
                            { value: 'falling_asleep', text: 'Difficulty falling asleep (30+ minutes)', icon: 'fas fa-clock' },
                            { value: 'staying_asleep', text: 'Waking up frequently during the night', icon: 'fas fa-moon' },
                            { value: 'early_waking', text: 'Waking up too early and can\'t get back to sleep', icon: 'fas fa-sunrise' },
                            { value: 'snoring', text: 'Loud snoring or sleep apnea', icon: 'fas fa-volume-up' },
                            { value: 'restless_legs', text: 'Restless legs or movement during sleep', icon: 'fas fa-walking' },
                            { value: 'racing_thoughts', text: 'Racing thoughts or worry at bedtime', icon: 'fas fa-brain' },
                            { value: 'pain_discomfort', text: 'Physical pain or discomfort', icon: 'fas fa-exclamation-triangle' },
                            { value: 'medications', text: 'Medications affecting sleep', icon: 'fas fa-pills' }
                        ]
                    });
                }
            }
        }

        // Add follow-up question to the assessment queue
        function addFollowUpQuestion(question) {
            // Insert after current question
            const insertIndex = currentQuestionIndex + 1;
            adaptiveQuestions.splice(insertIndex, 0, question);
            totalQuestions = adaptiveQuestions.length;
            console.log(`‚úÖ Added follow-up question: ${question.id}`);
        }

        window.previousQuestion = function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        };

        function isQuestionAnswered(question) {
            const answer = assessmentData[question.id];
            if (!answer) return false;
            
            if (question.type === 'multiple_choice_multi') {
                return answer.length > 0;
            } else if (question.type === 'slider_multi') {
                return Object.keys(answer).length > 0;
            } else {
                return true;
            }
        }

        // Assessment Completion (enhanced version with crisis detection is defined later)

        async function generatePersonalizedResults() {
            console.log('üéØ Generating personalized health profile...');
            
            const container = document.getElementById('assessment-container');
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">Assessment Complete!</h2>
                    <p class="text-slate-300 mb-6">Your personalized health profile has been generated based on your responses.</p>
                    <div class="bg-gradient-to-r from-emerald-900/30 to-blue-900/30 rounded-lg p-6 border border-emerald-500/30 mb-6">
                        <h3 class="text-xl font-semibold text-emerald-300 mb-3">Your Recommended Coach</h3>
                        <div id="coach-recommendation-simple" class="text-slate-200">
                            ${generateCoachRecommendation()}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startCoachSession()" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                            <i class="fas fa-comments mr-2"></i>Start Coach Session
                        </button>
                        <button onclick="navigateToSection('dashboard')" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                            <i class="fas fa-chart-line mr-2"></i>View Dashboard
                        </button>
                    </div>
                </div>
            `;
        }

        function generateCoachRecommendation() {
            let recommendedCoach = 'sarah';
            
            const conditions = assessmentData.existing_conditions || [];
            const stressors = assessmentData.stress_sources || [];

            if (conditions.includes('mental_health') || stressors.includes('trauma')) {
                recommendedCoach = 'elena';
            } else if (stressors.includes('work')) {
                recommendedCoach = 'marcus';
            } else if (stressors.includes('relationships')) {
                recommendedCoach = 'maria';
            } else if (assessmentData.energy_pattern === 'extremely_low') {
                recommendedCoach = 'alex';
            }

            const coachInfo = {
                'sarah': { name: 'Coach Sarah', specialty: 'CBT & Mindfulness Specialist', icon: 'fas fa-brain' },
                'marcus': { name: 'Coach Marcus', specialty: 'Addiction Recovery Specialist', icon: 'fas fa-hands-helping' },
                'elena': { name: 'Coach Elena', specialty: 'EMDR & Trauma Specialist', icon: 'fas fa-eye' },
                'alex': { name: 'Coach Alex', specialty: 'Mindfulness & Wellness Coach', icon: 'fas fa-spa' },
                'maria': { name: 'Coach Maria', specialty: 'Family & Relationship Therapy', icon: 'fas fa-heart' }
            };

            const coach = coachInfo[recommendedCoach];
            window.recommendedCoachId = recommendedCoach;

            return `
                <div class="flex items-center justify-center">
                    <i class="${coach.icon} text-2xl mr-4 text-emerald-400"></i>
                    <div>
                        <h4 class="font-bold text-lg">${coach.name}</h4>
                        <p class="text-slate-300">${coach.specialty}</p>
                    </div>
                </div>
            `;
        }

        // Coach session launcher
        window.startCoachSession = function() {
            const coachId = window.recommendedCoachId || 'sarah';
            console.log('üöÄ Starting session with recommended coach:', coachId);
            
            // Navigate to coaches section and auto-select recommended coach
            navigateToSection('coaches');
            
            // Add small delay to ensure section loads, then highlight recommended coach
            setTimeout(() => {
                const coachCard = document.querySelector(`[data-coach="${coachId}"]`);
                if (coachCard) {
                    coachCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    coachCard.style.border = '2px solid #10b981';
                    coachCard.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)';
                }
            }, 500);
        };

        // ===== CRISIS INTERVENTION SYSTEM =====
        console.log('üö® Loading crisis intervention system...');
        
        const CrisisIntervention = {
            crisisKeywords: [
                'suicid', 'kill myself', 'end my life', 'want to die', 'better off dead',
                'no point living', 'hopeless', 'worthless', 'cant go on', 'end it all',
                'self harm', 'hurt myself', 'cut myself', 'overdose'
            ],
            
            severityThresholds: {
                CRISIS: 4.5,      // Immediate intervention needed
                SEVERE: 4.0,      // Urgent professional help recommended
                MODERATE: 3.0,    // Professional support recommended
                MILD: 2.0         // Monitoring and self-care
            }
        };

        function detectCrisisIndicators(assessmentData) {
            console.log('üö® Running crisis detection analysis...');
            
            const indicators = {
                suicidalRisk: false,
                severeDepression: false,
                riskScore: 0,
                recommendations: []
            };
            
            // Check stress sources for trauma/crisis indicators
            const stressors = assessmentData.stress_sources || [];
            if (stressors.includes('trauma')) {
                indicators.riskScore += 1.5;
                indicators.recommendations.push('trauma_support');
            }
            
            // Check mental health conditions
            const conditions = assessmentData.existing_conditions || [];
            if (conditions.includes('mental_health')) {
                indicators.riskScore += 1.0;
            }
            
            // Check daily functioning levels for severe impairment
            const functioning = assessmentData.daily_functioning || {};
            const avgFunctioning = Object.values(functioning).reduce((a, b) => a + b, 0) / Object.keys(functioning).length;
            if (avgFunctioning <= 2) {
                indicators.riskScore += 2.0;
                indicators.severeDepression = true;
            }
            
            // Check energy levels for severe fatigue/depression
            if (assessmentData.energy_pattern === 'extremely_low') {
                indicators.riskScore += 1.5;
            }
            
            // Determine risk level
            if (indicators.riskScore >= CrisisIntervention.severityThresholds.CRISIS) {
                indicators.suicidalRisk = true;
                showCrisisIntervention();
            } else if (indicators.riskScore >= CrisisIntervention.severityThresholds.SEVERE) {
                indicators.recommendations.push('urgent_mental_health');
            }
            
            return indicators;
        }

        function showCrisisIntervention() {
            console.log('üö® CRISIS DETECTED - Showing intervention resources');
            
            // Create crisis intervention overlay
            const crisisOverlay = document.createElement('div');
            crisisOverlay.id = 'crisis-intervention';
            crisisOverlay.className = 'fixed inset-0 bg-red-900/90 backdrop-blur-sm z-[200] flex items-center justify-center p-4';
            crisisOverlay.innerHTML = `
                <div class="bg-gradient-to-br from-red-800 to-red-900 rounded-2xl border-2 border-red-400 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-8">
                        <!-- Header -->
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-white mb-2">We're Here to Help</h2>
                            <p class="text-red-100 text-lg">Your responses indicate you may be going through a very difficult time</p>
                        </div>

                        <!-- Immediate Help Section -->
                        <div class="bg-red-700/50 border border-red-400 rounded-lg p-6 mb-6">
                            <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                                <i class="fas fa-phone mr-2"></i>Get Immediate Help
                            </h3>
                            <div class="space-y-3">
                                <div class="bg-red-600/50 rounded-lg p-4">
                                    <p class="font-semibold text-red-100 mb-2">üö® Emergency: Call 911</p>
                                    <p class="text-red-200 text-sm">If you are in immediate danger or having thoughts of harming yourself</p>
                                </div>
                                <div class="bg-red-600/50 rounded-lg p-4">
                                    <p class="font-semibold text-red-100 mb-2">üÜò Crisis Support: Call 988</p>
                                    <p class="text-red-200 text-sm">24/7 Suicide & Crisis Lifeline - Free, confidential support</p>
                                </div>
                                <div class="bg-red-600/50 rounded-lg p-4">
                                    <p class="font-semibold text-red-100 mb-2">üì± Text Crisis Line: Text HOME to 741741</p>
                                    <p class="text-red-200 text-sm">Free, 24/7 text-based crisis counseling</p>
                                </div>
                            </div>
                        </div>

                        <!-- You Are Not Alone -->
                        <div class="bg-blue-900/30 border border-blue-400 rounded-lg p-6 mb-6">
                            <h3 class="text-xl font-semibold text-blue-200 mb-3 flex items-center">
                                <i class="fas fa-heart mr-2"></i>You Are Not Alone
                            </h3>
                            <p class="text-blue-100 leading-relaxed mb-3">
                                What you're feeling right now is temporary, even though it may not feel that way. 
                                Many people have been where you are and found their way through.
                            </p>
                            <p class="text-blue-100 leading-relaxed">
                                Professional help is available, and reaching out is a sign of strength, not weakness.
                            </p>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col gap-4">
                            <button onclick="window.open('tel:988', '_blank')" 
                                    class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                                <i class="fas fa-phone mr-2"></i>Call Crisis Lifeline (988)
                            </button>
                            <button onclick="continueSafelyWithSupport()" 
                                    class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                                <i class="fas fa-hands-helping mr-2"></i>Continue With Professional Support
                            </button>
                            <button onclick="closeCrisisIntervention()" 
                                    class="bg-slate-600 hover:bg-slate-700 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all">
                                <i class="fas fa-arrow-left mr-2"></i>Go Back
                            </button>
                        </div>

                        <!-- Footer -->
                        <div class="mt-6 pt-6 border-t border-red-400">
                            <p class="text-xs text-red-200 text-center leading-relaxed">
                                Root Cause Power is a wellness platform and cannot replace professional mental health care. 
                                Please reach out to qualified mental health professionals for immediate support.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(crisisOverlay);
        }

        window.continueSafelyWithSupport = function() {
            console.log('‚úÖ User choosing to continue with professional support guidance');
            const overlay = document.getElementById('crisis-intervention');
            if (overlay) overlay.remove();
            
            // Continue assessment but with enhanced mental health focus
            completeAssessmentWithCrisisSupport();
        };

        window.closeCrisisIntervention = function() {
            const overlay = document.getElementById('crisis-intervention');
            if (overlay) overlay.remove();
            
            // Navigate back to home for safety
            navigateToSection('home');
        };

        async function completeAssessmentWithCrisisSupport() {
            console.log('üÜò Completing assessment with crisis support focus');
            
            const container = document.getElementById('assessment-container');
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-red-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-hands-helping text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">Prioritizing Your Mental Health</h2>
                    <p class="text-slate-300 mb-6">Based on your responses, we're connecting you with specialized mental health support.</p>
                    
                    <div class="bg-gradient-to-r from-red-900/30 to-purple-900/30 rounded-lg p-6 border border-red-500/30 mb-6">
                        <h3 class="text-xl font-semibold text-red-300 mb-3">Immediate Recommended Actions</h3>
                        <div class="space-y-3 text-left">
                            <div class="flex items-center p-3 bg-slate-600/30 rounded-lg">
                                <i class="fas fa-user-md text-red-400 mr-3"></i>
                                <span class="text-slate-200">Schedule appointment with mental health professional</span>
                            </div>
                            <div class="flex items-center p-3 bg-slate-600/30 rounded-lg">
                                <i class="fas fa-phone text-red-400 mr-3"></i>
                                <span class="text-slate-200">Save crisis hotline numbers in your phone</span>
                            </div>
                            <div class="flex items-center p-3 bg-slate-600/30 rounded-lg">
                                <i class="fas fa-heart text-red-400 mr-3"></i>
                                <span class="text-slate-200">Connect with trusted friends or family members</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="navigateToSection('coaches')" class="bg-gradient-to-r from-red-500 to-purple-500 hover:from-red-600 hover:to-purple-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                            <i class="fas fa-comments mr-2"></i>Connect with Crisis Coach
                        </button>
                        <button onclick="window.open('tel:988', '_blank')" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                            <i class="fas fa-phone mr-2"></i>Call Crisis Support Now
                        </button>
                    </div>
                </div>
            `;
        }

        // Enhanced assessment completion with crisis detection
        async function completeAssessment() {
            console.log('üèÅ Assessment completed! Running crisis detection...');
            
            // Run crisis detection before generating normal results
            const crisisIndicators = detectCrisisIndicators(assessmentData);
            
            if (crisisIndicators.suicidalRisk) {
                // Crisis intervention already shown by detectCrisisIndicators
                return;
            }
            
            // Update progress to 100%
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Assessment Complete!';
            
            // Show goal setting step before completion
            await showGoalSettingStep();
            
            // Store assessment results for dashboard (will be called after goals are set)
            // storeAssessmentResults(); - moved to after goal setting
            
            // Generate normal results if no crisis detected  
            // await generatePersonalizedResults(); - moved to after goal setting
        }

        // Store assessment results for dashboard integration
        function storeAssessmentResults() {
            const healthScores = calculateHealthScores();
            const assessmentResults = {
                completed: true,
                timestamp: new Date().toISOString(),
                responses: assessmentData,
                healthScores: healthScores,
                recommendedCoach: window.recommendedCoachId || 'sarah',
                recoveryRoadmap: generateRecoveryRoadmapData(healthScores),
                riskFactors: detectCrisisIndicators(assessmentData),
                goals: window.userGoals || [] // Include user-defined goals
            };
            
            // Store in localStorage for dashboard access
            localStorage.setItem('lastAssessmentResults', JSON.stringify(assessmentResults));
            localStorage.setItem('hasCompletedAssessment', 'true');
            
            console.log('‚úÖ Assessment results stored for dashboard:', assessmentResults);
        }

        // Calculate health scores from assessment data
        function calculateHealthScores() {
            const scores = {
                physical_health: 5,
                mental_wellness: 5,
                energy_vitality: 5,
                sleep_quality: 5,
                stress_management: 5,
                daily_functioning: 5,
                overall_score: 5
            };

            // Calculate based on responses
            const conditions = assessmentData.existing_conditions || [];
            if (conditions.includes('none')) {
                scores.physical_health += 2;
            } else {
                scores.physical_health -= Math.min(conditions.length * 0.8, 3);
            }

            // Energy levels scoring
            const energyMapping = {
                'high_consistent': 8,
                'good_dips': 6,
                'moderate_variable': 5,
                'low_consistent': 3,
                'extremely_low': 1
            };
            scores.energy_vitality = energyMapping[assessmentData.energy_pattern] || 5;

            // Sleep quality from sliders
            const sleepData = assessmentData.sleep_assessment || {};
            if (Object.keys(sleepData).length > 0) {
                scores.sleep_quality = Object.values(sleepData).reduce((a, b) => a + b, 0) / Object.keys(sleepData).length;
            }

            // Daily functioning
            const functioning = assessmentData.daily_functioning || {};
            if (Object.keys(functioning).length > 0) {
                scores.daily_functioning = Object.values(functioning).reduce((a, b) => a + b, 0) / Object.keys(functioning).length;
            }

            // Stress management
            const stressors = assessmentData.stress_sources || [];
            scores.stress_management = Math.max(1, 8 - stressors.length);

            // Mental wellness based on stress and functioning
            scores.mental_wellness = (scores.stress_management + scores.daily_functioning) / 2;

            // Overall score
            scores.overall_score = Object.values(scores).reduce((a, b) => a + b, 0) / (Object.keys(scores).length - 1);

            // Ensure all scores are between 1-10
            Object.keys(scores).forEach(key => {
                scores[key] = Math.max(1, Math.min(10, scores[key]));
            });

            return scores;
        }

        // Generate recovery roadmap data
        function generateRecoveryRoadmapData(scores) {
            const roadmap = [];
            
            // Priority areas (lowest scores)
            const priorityAreas = Object.entries(scores)
                .filter(([key]) => key !== 'overall_score')
                .sort(([,a], [,b]) => a - b)
                .slice(0, 3);

            priorityAreas.forEach(([area, score], index) => {
                const priority = ['High', 'Medium', 'Low'][index];
                roadmap.push({
                    area: area,
                    score: score,
                    priority: priority,
                    actions: getActionsForArea(area),
                    timeline: getTimelineForArea(area)
                });
            });

            return roadmap;
        }

        function getActionsForArea(area) {
            const actions = {
                physical_health: ['Schedule comprehensive health check-up', 'Review medications with healthcare provider', 'Create sustainable exercise routine'],
                mental_wellness: ['Consider therapy or counseling', 'Practice daily mindfulness', 'Build support network'],
                energy_vitality: ['Optimize sleep schedule', 'Balance nutrition and blood sugar', 'Incorporate energizing movement'],
                sleep_quality: ['Establish consistent bedtime routine', 'Create optimal sleep environment', 'Limit screen time before bed'],
                stress_management: ['Learn stress-reduction techniques', 'Identify and address stress triggers', 'Practice relaxation methods'],
                daily_functioning: ['Optimize daily schedule', 'Implement productivity systems', 'Address energy drains']
            };
            return actions[area] || ['Focus on gradual improvement', 'Work with healthcare team', 'Monitor progress regularly'];
        }

        function getTimelineForArea(area) {
            const timelines = {
                physical_health: '2-4 weeks',
                mental_wellness: '1-3 months',
                energy_vitality: '2-6 weeks',
                sleep_quality: '1-4 weeks',
                stress_management: '2-8 weeks',
                daily_functioning: '1-6 weeks'
            };
            return timelines[area] || '2-8 weeks';
        }

        // GOAL SETTING STEP FOR ASSESSMENT
        async function showGoalSettingStep() {
            return new Promise((resolve) => {
                const healthScores = calculateHealthScores();
                const suggestedGoals = generateSuggestedGoals(healthScores);
                
                // Show goal setting interface
                document.getElementById('assessment-container').innerHTML = `
                    <div class="max-w-4xl mx-auto p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-target text-white text-2xl"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-slate-100 mb-3">Set Your Health Goals</h2>
                            <p class="text-slate-300 text-lg">Based on your assessment, here are some personalized goals to help you improve your health and wellness.</p>
                        </div>

                        <div class="bg-slate-800/50 rounded-xl p-6 mb-8">
                            <h3 class="text-xl font-bold text-slate-100 mb-4 flex items-center">
                                <i class="fas fa-lightbulb text-yellow-400 mr-3"></i>
                                Suggested Goals (Edit as needed)
                            </h3>
                            <div id="goals-container" class="space-y-4">
                                ${suggestedGoals.map((goal, index) => `
                                    <div class="goal-item bg-slate-700/50 rounded-lg p-4" data-index="${index}">
                                        <div class="flex items-start gap-4">
                                            <div class="flex-shrink-0 w-8 h-8 bg-${goal.priority === 'High' ? 'red' : goal.priority === 'Medium' ? 'yellow' : 'green'}-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                                ${index + 1}
                                            </div>
                                            <div class="flex-1">
                                                <input type="text" value="${goal.title}" 
                                                       class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white font-medium mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-field="title">
                                                <textarea placeholder="Describe your goal and how you'll achieve it..." 
                                                          class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white resize-none h-20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                          data-field="description">${goal.description}</textarea>
                                                <div class="flex items-center justify-between mt-2">
                                                    <select class="bg-slate-600 border border-slate-500 rounded-lg px-3 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                            data-field="priority">
                                                        <option value="High" ${goal.priority === 'High' ? 'selected' : ''}>High Priority</option>
                                                        <option value="Medium" ${goal.priority === 'Medium' ? 'selected' : ''}>Medium Priority</option>
                                                        <option value="Low" ${goal.priority === 'Low' ? 'selected' : ''}>Low Priority</option>
                                                    </select>
                                                    <button onclick="removeGoal(${index})" class="text-red-400 hover:text-red-300 text-sm">
                                                        <i class="fas fa-times mr-1"></i>Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button onclick="addNewGoal()" class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-white font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add Custom Goal
                            </button>
                        </div>

                        <div class="flex justify-center gap-4">
                            <button onclick="skipGoals()" class="bg-slate-600 hover:bg-slate-700 px-8 py-3 rounded-lg text-white font-medium transition-colors">
                                Skip Goals
                            </button>
                            <button onclick="saveGoalsAndComplete()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 px-8 py-3 rounded-lg text-white font-medium transition-colors">
                                <i class="fas fa-check mr-2"></i>Save Goals & Complete Assessment
                            </button>
                        </div>
                    </div>
                `;

                // Store the resolve function globally so buttons can call it
                window.completeGoalSetting = resolve;
            });
        }

        function generateSuggestedGoals(healthScores) {
            const goals = [];
            
            // Get lowest scoring areas for priority goals
            const sortedScores = Object.entries(healthScores)
                .filter(([key]) => key !== 'overall_score')
                .sort(([,a], [,b]) => a - b);

            const goalTemplates = {
                physical_health: {
                    title: "Improve Physical Health",
                    description: "Schedule a comprehensive health check-up and create a sustainable exercise routine that fits my lifestyle and abilities."
                },
                mental_wellness: {
                    title: "Enhance Mental Wellness", 
                    description: "Practice daily mindfulness or meditation and consider professional support if needed to build emotional resilience."
                },
                energy_vitality: {
                    title: "Boost Energy Levels",
                    description: "Optimize my sleep schedule and nutrition to maintain consistent energy throughout the day."
                },
                sleep_quality: {
                    title: "Improve Sleep Quality",
                    description: "Establish a consistent bedtime routine and create an optimal sleep environment for better rest."
                },
                stress_management: {
                    title: "Better Stress Management",
                    description: "Learn and practice stress-reduction techniques like deep breathing, and identify my main stress triggers."
                },
                daily_functioning: {
                    title: "Enhance Daily Functioning",
                    description: "Develop better organization systems and daily routines to improve productivity and life management."
                }
            };

            // Add top 3 priority areas as goals
            sortedScores.slice(0, 3).forEach(([area, score], index) => {
                const template = goalTemplates[area];
                if (template) {
                    goals.push({
                        ...template,
                        area: area,
                        score: score,
                        priority: ['High', 'Medium', 'Low'][index],
                        progress: 0,
                        id: generateGoalId()
                    });
                }
            });

            return goals;
        }

        function generateGoalId() {
            return 'goal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function addNewGoal() {
            const container = document.getElementById('goals-container');
            const index = container.children.length;
            const newGoalHtml = `
                <div class="goal-item bg-slate-700/50 rounded-lg p-4" data-index="${index}">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <input type="text" placeholder="Enter your custom goal..." 
                                   class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white font-medium mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   data-field="title">
                            <textarea placeholder="Describe your goal and how you'll achieve it..." 
                                      class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-white resize-none h-20 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      data-field="description"></textarea>
                            <div class="flex items-center justify-between mt-2">
                                <select class="bg-slate-600 border border-slate-500 rounded-lg px-3 py-1 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        data-field="priority">
                                    <option value="Medium" selected>Medium Priority</option>
                                    <option value="High">High Priority</option>
                                    <option value="Low">Low Priority</option>
                                </select>
                                <button onclick="removeGoal(${index})" class="text-red-400 hover:text-red-300 text-sm">
                                    <i class="fas fa-times mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newGoalHtml);
        }

        function removeGoal(index) {
            const goalItems = document.querySelectorAll('.goal-item');
            if (goalItems[index] && goalItems.length > 1) {
                goalItems[index].remove();
                // Renumber remaining goals
                document.querySelectorAll('.goal-item').forEach((item, newIndex) => {
                    item.dataset.index = newIndex;
                    item.querySelector('.flex-shrink-0').textContent = newIndex + 1;
                });
            }
        }

        function skipGoals() {
            // Complete without goals
            window.userGoals = [];
            completeAssessmentWithGoals();
        }

        function saveGoalsAndComplete() {
            // Collect all goals from the form
            const goalItems = document.querySelectorAll('.goal-item');
            const goals = [];

            goalItems.forEach((item, index) => {
                const title = item.querySelector('[data-field="title"]').value.trim();
                const description = item.querySelector('[data-field="description"]').value.trim();
                const priority = item.querySelector('[data-field="priority"]').value;

                if (title) { // Only save goals with titles
                    goals.push({
                        id: generateGoalId(),
                        title: title,
                        description: description,
                        priority: priority,
                        progress: 0,
                        created: new Date().toISOString(),
                        completed: false
                    });
                }
            });

            window.userGoals = goals;
            completeAssessmentWithGoals();
        }

        function completeAssessmentWithGoals() {
            // Store assessment results with goals
            storeAssessmentResults();
            
            // Complete the assessment
            generatePersonalizedResults().then(() => {
                if (window.completeGoalSetting) {
                    window.completeGoalSetting();
                }
            });
        }

        // Make goal setting functions globally accessible
        window.addNewGoal = addNewGoal;
        window.removeGoal = removeGoal;
        window.skipGoals = skipGoals;
        window.saveGoalsAndComplete = saveGoalsAndComplete;

        console.log('‚úÖ Crisis intervention system loaded successfully!');
        console.log('‚úÖ Intelligent assessment system loaded successfully!');
        
        // ===== WORKING COACH DAVID VOICE THERAPY - SINGLE VOICE IMPLEMENTATION =====
        
        // Smart audio management - prevents overlap but allows smooth continuous speech
        let currentAudio = null;
        let humeSocket = null;
        let mediaRecorder = null;
        let sessionSummary = [];
        let isUserSpeaking = false;
        let lastUserSpeechTime = 0;
        let audioQueue = [];
        let isPlayingAudio = false;
        let lastAudioTime = 0;
        let microphoneStream = null;
        let conversationStartTime = null;
        let callDurationInterval = null;
        
        // Simple session tracking - no artificial interventions
        let messageCount = 0;
        
        window.launchCoachDavidWidget = async function() {
            console.log('üìû Starting Coach David voice connection...');
            
            // Update UI immediately  
            const statusEl = document.getElementById('conversation-status');
            const substatusEl = document.getElementById('conversation-substatus');
            const startBtn = document.getElementById('start-conversation-btn');
            const endBtn = document.getElementById('end-conversation-btn');
            const callStatus = document.getElementById('call-status');
            
            if (statusEl) statusEl.textContent = 'üîÑ Connecting to Coach David...';
            if (substatusEl) substatusEl.textContent = 'Establishing secure connection...';
            
            // Update button visibility
            if (startBtn) startBtn.classList.add('hidden');
            if (endBtn) endBtn.classList.remove('hidden');
            
            // Hide summary button during active session
            const summaryBtn = document.getElementById('summary-btn');
            if (summaryBtn) summaryBtn.classList.add('hidden');
            
            // Clear session tracking for fresh start
            sessionSummary = [];
            messageCount = 0;
            
            try {
                // Your Hume credentials
                const HUME_API_KEY = 'si8yIRYvcFUMUIsiM3RzlNQhAp09a6gUkce6Tjt7R34XTHAo';
                const HUME_SECRET_KEY = 'mRDCEm0XyDchucUKs7aGR6mTSgAHFWrhaDrM5hvh5idWrGB4x41jbZozD9Y8LB3b';
                const CONFIG_ID = 'f4a87ae9-eafb-4133-b772-33a1b9d0eb03';
                
                // Step 1: Get OAuth token
                console.log('üîë Getting Hume access token...');
                const tokenResponse = await fetch('https://api.hume.ai/oauth2-cc/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'grant_type': 'client_credentials',
                        'client_id': HUME_API_KEY,
                        'client_secret': HUME_SECRET_KEY
                    })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(`Authentication failed: ${tokenResponse.status}`);
                }
                
                const tokenData = await tokenResponse.json();
                console.log('‚úÖ Got Hume access token!');
                
                // Step 2: Get microphone access
                console.log('üé§ Requesting microphone access...');
                microphoneStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 48000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                console.log('‚úÖ Microphone access granted!');
                
                // Step 3: Connect WebSocket
                console.log('üîå Connecting to Hume WebSocket...');
                const wsUrl = `wss://api.hume.ai/v0/evi/chat?access_token=${tokenData.access_token}&config_id=${CONFIG_ID}`;
                humeSocket = new WebSocket(wsUrl);
                
                humeSocket.onopen = () => {
                    console.log('‚úÖ Connected to Coach David!');
                    
                    // Pure Hume EVI - no artificial interventions to maintain natural conversation flow
                    
                    // Update UI for connected state
                    if (statusEl) statusEl.textContent = 'üéôÔ∏è Live Session with Coach David';
                    if (substatusEl) substatusEl.textContent = 'Speak naturally - Coach David is listening and will capture key insights';
                    
                    // Switch buttons
                    if (startBtn) startBtn.classList.add('hidden');
                    if (endBtn) endBtn.classList.remove('hidden');
                    if (callStatus) {
                        callStatus.classList.remove('hidden');
                        startCallTimer();
                    }
                    
                    // Start recording
                    startRecording();
                    
                    // Send initial greeting
                    setTimeout(() => {
                        if (humeSocket?.readyState === WebSocket.OPEN) {
                            humeSocket.send(JSON.stringify({
                                type: 'user_message',
                                text: "Hello Coach David, I'm ready to start our therapeutic session. Please introduce yourself."
                            }));
                        }
                    }, 1000);
                };
                
                humeSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'audio_output' && data.data) {
                        // Smart audio handling - prevents overlap but maintains smooth speech
                        const timeSinceUserSpoke = Date.now() - lastUserSpeechTime;
                        if (timeSinceUserSpoke < 1000) {
                            // Brief delay after user speaks, but don't break existing audio
                            setTimeout(() => playCoachAudioDirect(data.data), 200);
                        } else {
                            playCoachAudioDirect(data.data);
                        }
                    }
                    
                    if (data.message?.content) {
                        console.log('üí¨ Coach David said:', data.message.content);
                        
                        // Simple technique capture for summaries - no artificial interventions
                        const message = data.message.content;
                        if (message && isTherapeuticIntervention(message)) {
                            sessionSummary.push({
                                timestamp: new Date().toLocaleTimeString(),
                                content: message,
                                type: getInterventionType(message),
                                technique: extractTechniqueName(message)
                            });
                        }
                        
                        if (substatusEl) {
                            substatusEl.textContent = message.length > 60 ? message.substring(0, 60) + '...' : message;
                        }
                        
                        // Removed artificial feedback acknowledgments that were making conversations scripted
                    }
                    
                    // Track when user is speaking and detect feedback
                    if (data.type === 'user_message' || data.user_message) {
                        lastUserSpeechTime = Date.now();
                        isUserSpeaking = true;
                        setTimeout(() => { isUserSpeaking = false; }, 500);
                        
                        // Removed artificial feedback tracking that was making conversations scripted
                    }
                };
                
                humeSocket.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    if (statusEl) statusEl.textContent = '‚ùå Connection Failed';
                    if (substatusEl) substatusEl.textContent = 'Please try again';
                    endVoiceSession();
                };
                
                humeSocket.onclose = () => {
                    console.log('üîå Disconnected from Coach David');
                    endVoiceSession();
                };
                
            } catch (error) {
                console.error('‚ùå Voice session error:', error);
                if (statusEl) statusEl.textContent = '‚ùå Connection Failed';
                if (substatusEl) substatusEl.textContent = error.message;
                endVoiceSession();
            }
        };
        
        // Start recording audio
        function startRecording() {
            if (!microphoneStream) return;
            
            try {
                mediaRecorder = new MediaRecorder(microphoneStream, {
                    mimeType: 'audio/webm'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && humeSocket?.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const audioData = reader.result.split(',')[1];
                            humeSocket.send(JSON.stringify({
                                type: 'audio_input',
                                data: audioData
                            }));
                        };
                        reader.readAsDataURL(event.data);
                    }
                };
                
                mediaRecorder.start(500);
                console.log('üé§ Recording started');
                
            } catch (error) {
                console.error('‚ùå Recording error:', error);
            }
        }
        
        // SMART AUDIO STREAMING - Prevents overlap without breaking up speech
        function playCoachAudioDirect(audioData) {
            try {
                console.log('üîä Smart Coach David audio (length: ' + audioData.length + ')');
                
                // Add to queue for smooth playback
                audioQueue.push(audioData);
                
                // If not currently playing, start processing
                if (!isPlayingAudio) {
                    processAudioQueue();
                }
                
            } catch (error) {
                console.error('‚ùå Smart audio streaming error:', error);
            }
        }
        
        // Process audio queue with gapless seamless playback
        async function processAudioQueue() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }
            
            isPlayingAudio = true;
            
            try {
                const audioData = audioQueue.shift();
                
                // Convert base64 to audio blob
                const audioBytes = atob(audioData);
                const audioArray = new Uint8Array(audioBytes.length);
                
                for (let i = 0; i < audioBytes.length; i++) {
                    audioArray[i] = audioBytes.charCodeAt(i);
                }
                
                const audioBlob = new Blob([audioArray], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Improved interruption handling - allow more natural conversation flow
                const now = Date.now();
                if (currentAudio && !currentAudio.ended) {
                    // Allow interruption if user has spoken recently (more natural)
                    const timeSinceUserSpoke = now - lastUserSpeechTime;
                    if (timeSinceUserSpoke < 3000) {
                        // User spoke recently, allow interruption for natural conversation
                        currentAudio.pause();
                        currentAudio = null;
                    } else if ((now - lastAudioTime) > 1500) {
                        // Long gap, likely new topic
                        currentAudio.pause();
                        currentAudio = null;
                    } else {
                        // Audio is recent and user hasn't spoken, let it finish
                        return;
                    }
                }
                
                const newAudio = new Audio(audioUrl);
                newAudio.volume = 0.8;
                newAudio.loop = false;
                newAudio.preload = 'auto'; // Preload for smoother playback
                lastAudioTime = now;
                
                // Set up event handlers for stable playback
                newAudio.oncanplaythrough = () => {
                    // Only start if we don't have active audio playing
                    if (!currentAudio || currentAudio.ended || currentAudio.paused) {
                        currentAudio = newAudio;
                        currentAudio.play().then(() => {
                            console.log('üîä Stable Coach David audio');
                        }).catch(error => {
                            console.error('‚ùå Audio playback error:', error);
                            URL.revokeObjectURL(audioUrl);
                            processNextAudio();
                        });
                    } else {
                        // Audio is still playing, put this chunk back in queue
                        audioQueue.unshift(audioData);
                        URL.revokeObjectURL(audioUrl);
                    }
                };
                
                newAudio.onended = () => {
                    console.log('‚úÖ Audio chunk completed naturally');
                    URL.revokeObjectURL(audioUrl);
                    // Stable transition to next audio
                    processNextAudio();
                };
                
                newAudio.onerror = (error) => {
                    console.error('‚ùå Audio error:', error);
                    URL.revokeObjectURL(audioUrl);
                    processNextAudio();
                };
                
            } catch (error) {
                console.error('‚ùå Audio processing error:', error);
                processNextAudio();
            }
        }
        
        // Continue to next audio with minimal stable delay
        function processNextAudio() {
            currentAudio = null;
            // Small delay to prevent race conditions while maintaining flow
            setTimeout(() => {
                processAudioQueue();
            }, 5);
        }
        
        // AGGRESSIVE AUDIO CLEANUP - Eliminates all echo
        function stopAllAudio() {
            console.log('üîá AGGRESSIVE AUDIO CLEANUP - Eliminating all echo...');
            
            // Stop current audio completely
            if (currentAudio) {
                try {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio.src = '';
                    currentAudio.load(); // Force reload to clear buffer
                    currentAudio = null;
                } catch (e) {
                    console.log('Audio cleanup error (expected):', e);
                    currentAudio = null;
                }
            }
            
            // Clear all queues and state
            audioQueue = [];
            isPlayingAudio = false;
            lastAudioTime = 0;
            
            // Find and stop any remaining audio elements on the page
            const audioElements = document.querySelectorAll('audio');
            audioElements.forEach(audio => {
                try {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.src = '';
                    audio.load();
                } catch (e) {
                    console.log('Cleanup audio element (expected):', e);
                }
            });
            
            console.log('‚úÖ AGGRESSIVE CLEANUP COMPLETE - All audio eliminated');
        }
        
        // End Coach David session with summary option
        function endCoachDavidSession() {
            console.log('üìû Ending Coach David session...');
            
            // ULTRA AGGRESSIVE CLEANUP - ELIMINATE ALL ECHO
            console.log('üîá HANGUP: Ultra aggressive audio cleanup starting...');
            
            // Stop all audio immediately
            stopAllAudio();
            
            // Additional cleanup with delays to catch lingering audio
            setTimeout(() => {
                stopAllAudio();
                console.log('üîá Secondary cleanup pass complete');
            }, 100);
            
            setTimeout(() => {
                stopAllAudio();
                console.log('üîá Final cleanup pass complete');
            }, 500);
            
            // Stop recording completely
            if (mediaRecorder) {
                try {
                    if (mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    mediaRecorder = null;
                } catch (e) {
                    console.log('MediaRecorder cleanup (expected):', e);
                    mediaRecorder = null;
                }
            }
            
            // Close microphone stream completely
            if (microphoneStream) {
                try {
                    microphoneStream.getTracks().forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });
                    microphoneStream = null;
                } catch (e) {
                    console.log('Microphone cleanup (expected):', e);
                    microphoneStream = null;
                }
            }
            
            // Close WebSocket connection
            if (humeSocket) {
                try {
                    if (humeSocket.readyState === WebSocket.OPEN) {
                        humeSocket.close();
                    }
                    humeSocket = null;
                } catch (e) {
                    console.log('WebSocket cleanup (expected):', e);
                    humeSocket = null;
                }
            }
            
            // Update UI
            const statusEl = document.getElementById('conversation-status');
            const substatusEl = document.getElementById('conversation-substatus');
            const startBtn = document.getElementById('start-conversation-btn');
            const endBtn = document.getElementById('end-conversation-btn');
            const summaryBtn = document.getElementById('summary-btn');
            
            if (statusEl) statusEl.textContent = '‚úÖ Session Completed';
            if (substatusEl) substatusEl.textContent = 'Thank you for your therapy session with Coach David';
            
            if (startBtn) startBtn.classList.remove('hidden');
            if (endBtn) endBtn.classList.add('hidden');
            
            // Show summary button if we have insights
            if (summaryBtn && sessionSummary.length > 0) {
                summaryBtn.classList.remove('hidden');
            }
            
            // Clear simple session tracking
            messageCount = 0;
            sessionSummary = [];
            
            console.log('‚úÖ Coach David session ended successfully');
        }
        
        // Show session summary modal
        function showSessionSummary() {
            if (sessionSummary.length === 0) {
                alert('No key insights were captured in this session.');
                return;
            }
            
            let summaryHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-slate-800 rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-white flex items-center">
                                <i class="fas fa-tools text-emerald-400 mr-3"></i>
                                Therapeutic Interventions & Techniques
                            </h3>
                            <button onclick="closeSummaryModal()" class="text-slate-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="text-slate-300 mb-4">
                            <p class="text-sm text-slate-400 mb-4">Helpful techniques and guidance from your session with Coach David:</p>
                            
                            <div class="space-y-4">
            `;
            
            sessionSummary.forEach((item, index) => {
                const typeIcon = getTypeIcon(item.type);
                summaryHTML += `
                    <div class="bg-slate-700 p-4 rounded-lg border-l-4 border-emerald-500">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <span class="text-emerald-400 mr-2">${typeIcon}</span>
                                <span class="text-emerald-400 font-medium">${item.technique}</span>
                            </div>
                            <span class="text-slate-400 text-sm">${item.timestamp}</span>
                        </div>
                        <div class="text-xs text-slate-500 mb-2">${item.type}</div>
                        <p class="text-slate-200 leading-relaxed">${item.content}</p>
                    </div>
                `;
            });
            
            summaryHTML += `
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="copySummaryToClipboard()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-4 rounded-lg transition-all">
                                <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                            </button>
                            <button onclick="clearSessionSummary()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white py-2 px-4 rounded-lg transition-all">
                                <i class="fas fa-trash mr-2"></i>Clear Summary
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'session-summary-modal';
            modalContainer.innerHTML = summaryHTML;
            document.body.appendChild(modalContainer);
        }
        
        // Close summary modal
        function closeSummaryModal() {
            const modal = document.getElementById('session-summary-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Copy therapeutic interventions to clipboard
        function copySummaryToClipboard() {
            let text = "Coach David - Therapeutic Interventions & Techniques\\n";
            text += "=" .repeat(50) + "\\n\\n";
            
            sessionSummary.forEach((item, index) => {
                text += `${index + 1}. ${item.technique}\\n`;
                text += `   Type: ${item.type}\\n`;
                text += `   Time: ${item.timestamp}\\n`;
                text += `   Details: ${item.content}\\n\\n`;
            });
            
            text += "\\nKeep these techniques handy for future self-care and coping.";
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Therapeutic techniques copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard. Please copy manually.');
            });
        }
        
        // Clear session summary
        function clearSessionSummary() {
            sessionSummary = [];
            const summaryBtn = document.getElementById('summary-btn');
            if (summaryBtn) summaryBtn.classList.add('hidden');
            closeSummaryModal();
        }
        
        // BALANCED: Capture helpful techniques while protecting personal conversation
        function isTherapeuticIntervention(message) {
            const lowerMessage = message.toLowerCase();
            
            // Skip very personal/conversational content
            const personalIndicators = [
                'tell me about', 'how do you feel', 'what happened', 'your experience',
                'share with me', 'describe', 'explain to me', 'i understand that'
            ];
            
            if (personalIndicators.some(phrase => lowerMessage.includes(phrase))) {
                return false; // Skip personal conversation
            }
            
            // Capture therapeutic guidance and techniques
            const therapeuticIndicators = [
                // Technique keywords
                'technique', 'exercise', 'practice', 'strategy', 'method',
                'breathing', 'breathe', 'mindfulness', 'grounding',
                
                // Instructional phrases
                'try this', 'you can', 'i recommend', 'suggestion', 'helpful',
                'when you feel', 'next time', 'remember to', 'practice',
                
                // Coping guidance
                'cope with', 'manage', 'handle', 'deal with', 'help you',
                'useful', 'effective', 'works well',
                
                // Specific techniques mentioned
                '4-7-8', 'box breathing', '5-4-3-2-1', 'progressive muscle',
                'safe place', 'visualization', 'meditation', 'mindful'
            ];
            
            const hasTherapeuticContent = therapeuticIndicators.some(indicator => 
                lowerMessage.includes(indicator)
            );
            
            // Also capture longer guidance messages (likely contain techniques)
            const isGuidanceMessage = message.length > 60 && 
                (lowerMessage.includes('help') || lowerMessage.includes('can') || 
                 lowerMessage.includes('try') || lowerMessage.includes('when'));
            
            return hasTherapeuticContent || isGuidanceMessage;
        }
        
        // Categorize the type of intervention
        function getInterventionType(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('breathing') || lowerMessage.includes('breath')) return 'Breathing Technique';
            if (lowerMessage.includes('mindfulness') || lowerMessage.includes('present')) return 'Mindfulness Practice';
            if (lowerMessage.includes('grounding') || lowerMessage.includes('5 senses')) return 'Grounding Technique';
            if (lowerMessage.includes('thought') || lowerMessage.includes('cognitive')) return 'Cognitive Strategy';
            if (lowerMessage.includes('visualization') || lowerMessage.includes('imagine')) return 'Visualization Exercise';
            if (lowerMessage.includes('trauma') || lowerMessage.includes('PTSD')) return 'Trauma Intervention';
            if (lowerMessage.includes('anxiety') || lowerMessage.includes('panic')) return 'Anxiety Management';
            if (lowerMessage.includes('cope') || lowerMessage.includes('coping')) return 'Coping Strategy';
            if (lowerMessage.includes('emotion') || lowerMessage.includes('feeling')) return 'Emotional Regulation';
            if (lowerMessage.includes('behavior') || lowerMessage.includes('habit')) return 'Behavioral Technique';
            
            return 'Therapeutic Guidance';
        }
        
        // Extract the name/title of the specific technique
        function extractTechniqueName(message) {
            const lowerMessage = message.toLowerCase();
            
            // Common technique patterns
            if (lowerMessage.includes('4-7-8') || lowerMessage.includes('478')) return '4-7-8 Breathing';
            if (lowerMessage.includes('box breathing') || lowerMessage.includes('square breathing')) return 'Box Breathing';
            if (lowerMessage.includes('5-4-3-2-1') || lowerMessage.includes('54321')) return '5-4-3-2-1 Grounding';
            if (lowerMessage.includes('progressive muscle')) return 'Progressive Muscle Relaxation';
            if (lowerMessage.includes('safe place') || lowerMessage.includes('calm place')) return 'Safe Place Visualization';
            if (lowerMessage.includes('thought stopping')) return 'Thought Stopping';
            if (lowerMessage.includes('reframe') || lowerMessage.includes('reframing')) return 'Cognitive Reframing';
            if (lowerMessage.includes('container') || lowerMessage.includes('containment')) return 'Containment Technique';
            if (lowerMessage.includes('bilateral')) return 'Bilateral Stimulation';
            if (lowerMessage.includes('body scan')) return 'Body Scan Meditation';
            
            // Extract technique from common phrases
            const techniquePatterns = [
                /technique called ([^,.]+)/i,
                /exercise is ([^,.]+)/i,
                /practice ([^,.]+)/i,
                /method called ([^,.]+)/i,
                /try ([^,.]{10,40})/i
            ];
            
            for (const pattern of techniquePatterns) {
                const match = message.match(pattern);
                if (match) return match[1].trim();
            }
            
            return 'Therapeutic Technique';
        }
        
        // Get appropriate icon for intervention type
        function getTypeIcon(type) {
            const iconMap = {
                'Breathing Technique': 'ü´Å',
                'Mindfulness Practice': 'üßò',
                'Grounding Technique': '‚öì',
                'Cognitive Strategy': 'üß†',
                'Visualization Exercise': 'üéØ',
                'Trauma Intervention': 'üõ°Ô∏è',
                'Anxiety Management': 'üíô',
                'Coping Strategy': 'üõ†Ô∏è',
                'Emotional Regulation': '‚ù§Ô∏è',
                'Behavioral Technique': 'üîÑ',
                'Therapeutic Guidance': 'üí°'
            };
            return iconMap[type] || 'üìã';
        }
        
        // Removed all artificial feedback and memory systems that were destroying natural conversation
        // Coach David is now pure Hume EVI - natural and interruptible
        
        // Call timer functions
        function startCallTimer() {
            conversationStartTime = Date.now();
            callDurationInterval = setInterval(updateCallDuration, 1000);
        }
        
        function updateCallDuration() {
            if (!conversationStartTime) return;
            
            const elapsed = Date.now() - conversationStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const durationEl = document.getElementById('call-duration');
            if (durationEl) {
                durationEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        };
        
        // End voice session cleanly
        function endVoiceSession() {
            console.log('üìû Ending voice session...');
            
            // Stop all audio playback first  
            stopAllAudio();
            
            // Stop recording
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
            }
            
            // Stop microphone
            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
                microphoneStream = null;
            }
            
            // Close WebSocket
            if (humeSocket) {
                humeSocket.close();
                humeSocket = null;
            }
            
            // Stop timer
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }
            
            // Reset UI
            const statusEl = document.getElementById('conversation-status');
            const substatusEl = document.getElementById('conversation-substatus');
            const startBtn = document.getElementById('start-conversation-btn');
            const endBtn = document.getElementById('end-conversation-btn');
            const callStatus = document.getElementById('call-status');
            
            if (statusEl) statusEl.textContent = 'Ready to start your therapeutic session';
            if (substatusEl) substatusEl.textContent = 'Click below to begin voice therapy with Coach David';
            if (startBtn) startBtn.classList.remove('hidden');
            if (endBtn) endBtn.classList.add('hidden');
            if (callStatus) callStatus.classList.add('hidden');
            
            conversationStartTime = null;
            console.log('‚úÖ Voice session ended cleanly');
        }
        
        window.closeCoachDavidWidget = endVoiceSession;
        
        console.log('‚úÖ Coach David functions defined successfully!');
        
        // NOTE: Navigation function defined later - this duplicate removed to prevent conflicts
        
        // Missing updateNavButtons function
        function updateNavButtons(sectionId) {
            console.log('üîÑ Updating nav buttons for:', sectionId);
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'nav-' + sectionId) {
                    btn.classList.add('active');
                    console.log('‚úÖ Activated nav button:', btn.id);
                }
            });
        }
        
        // Also create without window prefix for onclick calls
        navigateToSection = window.navigateToSection;
        
        // ===== WORKING KNOWLEDGE LIBRARY FUNCTION =====
        function exploreCategory(category) {
            console.log('üìö Opening Knowledge Library for:', category);
            
            // Create and show modal with content
            showResearchModal(category);
        }
        
        function showResearchModal(category) {
            // Remove any existing modal
            const existingModal = document.getElementById('research-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'research-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-slate-600 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-100">üìö ${getCategoryTitle(category)}</h2>
                        <button onclick="closeResearchModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
                    </div>
                    <div class="modal-content p-6">
                        ${getCategoryContent(category)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeResearchModal() {
            const modal = document.getElementById('research-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function getCategoryTitle(category) {
            const titles = {
                'nutrition': 'ü•ó Nutrition & Diet Research',
                'mental-health': 'üß† Mental Health Research', 
                'sleep': 'üò¥ Sleep Science Research',
                'exercise': 'üèÉ‚Äç‚ôÄÔ∏è Exercise & Fitness Research',
                'stress': 'üßò‚Äç‚ôÄÔ∏è Stress Management Research',
                'integrative': 'üåø Integrative Health Research'
            };
            return titles[category] || 'Research Library';
        }
        
        function getCategoryContent(category) {
            const content = {
                'nutrition': `
                    <div class="space-y-6">
                        <!-- Navigation Tabs -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showNutritionTab('lookup')" id="tab-lookup" class="nutrition-tab active-tab px-4 py-2 rounded-full bg-green-600 text-white font-medium">
                                üîç Food Lookup
                            </button>
                            <button onclick="showNutritionTab('calculator')" id="tab-calculator" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                üìä Meal Calculator
                            </button>
                            <button onclick="showNutritionTab('news')" id="tab-news" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                üì∞ Health News
                            </button>
                            <button onclick="showNutritionTab('advice')" id="tab-advice" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                üí° Nutrition Advice
                            </button>
                            <button onclick="showNutritionTab('research')" id="tab-research" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                üìö Research
                            </button>
                        </div>

                        <!-- Food Lookup Tab -->
                        <div id="nutrition-lookup" class="nutrition-content" style="display: block;">
                            <div class="bg-slate-700 p-6 rounded-lg mb-6">
                                <h3 class="text-xl font-bold text-green-400 mb-4">üîç Food Nutrition Lookup</h3>
                                <div class="space-y-4">
                                    <div class="relative">
                                        <input type="text" id="food-search" placeholder="Search for food (e.g., 'banana', 'chicken breast', 'quinoa')..." 
                                               class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500"
                                               onkeyup="handleFoodSearch(event)">
                                        <button onclick="searchFood()" class="absolute right-2 top-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                            Search
                                        </button>
                                    </div>
                                    
                                    <div id="food-suggestions" class="hidden">
                                        <h4 class="text-slate-300 mb-2">Quick Suggestions:</h4>
                                        <div class="flex flex-wrap gap-2">
                                            <span onclick="quickFoodSearch('apple')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üçé Apple</span>
                                            <span onclick="quickFoodSearch('chicken breast')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üêî Chicken Breast</span>
                                            <span onclick="quickFoodSearch('broccoli')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">ü•¶ Broccoli</span>
                                            <span onclick="quickFoodSearch('salmon')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üêü Salmon</span>
                                            <span onclick="quickFoodSearch('quinoa')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üåæ Quinoa</span>
                                            <span onclick="quickFoodSearch('avocado')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">ü•ë Avocado</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="food-results" class="mt-6 hidden">
                                    <!-- Food results will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Meal Calculator Tab -->
                        <div id="nutrition-calculator" class="nutrition-content hidden">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-blue-400 mb-4">üìä Daily Meal Calculator</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="font-semibold text-slate-200 mb-3">Add Foods to Your Meal:</h4>
                                        <div id="meal-builder" class="space-y-3">
                                            <div class="meal-item flex items-center gap-3 p-3 bg-slate-600 rounded">
                                                <input type="text" placeholder="Food name" class="food-name flex-1 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                <input type="number" placeholder="Amount" class="food-amount w-20 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                <select class="food-unit px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                    <option value="g">g</option>
                                                    <option value="oz">oz</option>
                                                    <option value="cup">cup</option>
                                                    <option value="piece">piece</option>
                                                </select>
                                                <button onclick="removeMealItem(this)" class="text-red-400 hover:text-red-300">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button onclick="addMealItem()" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            + Add Food Item
                                        </button>
                                        <button onclick="calculateMeal()" class="mt-2 w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                            Calculate Nutrition
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <h4 class="font-semibold text-slate-200 mb-3">Total Nutrition:</h4>
                                        <div id="meal-totals" class="bg-slate-600 p-4 rounded">
                                            <div class="grid grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <span class="text-slate-300">Calories:</span>
                                                    <span class="float-right text-white font-semibold" id="total-calories">0</span>
                                                </div>
                                                <div>
                                                    <span class="text-slate-300">Protein:</span>
                                                    <span class="float-right text-white font-semibold" id="total-protein">0g</span>
                                                </div>
                                                <div>
                                                    <span class="text-slate-300">Carbs:</span>
                                                    <span class="float-right text-white font-semibold" id="total-carbs">0g</span>
                                                </div>
                                                <div>
                                                    <span class="text-slate-300">Fat:</span>
                                                    <span class="float-right text-white font-semibold" id="total-fat">0g</span>
                                                </div>
                                                <div>
                                                    <span class="text-slate-300">Fiber:</span>
                                                    <span class="float-right text-white font-semibold" id="total-fiber">0g</span>
                                                </div>
                                                <div>
                                                    <span class="text-slate-300">Sugar:</span>
                                                    <span class="float-right text-white font-semibold" id="total-sugar">0g</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Health News Tab -->
                        <div id="nutrition-news" class="nutrition-content hidden">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-purple-400 mb-4">üì∞ Latest Nutrition News</h3>
                                <div class="space-y-4">
                                    <div class="bg-slate-600 p-4 rounded">
                                        <h4 class="font-semibold text-slate-100 mb-2">ü•ó Mediterranean Diet Benefits</h4>
                                        <p class="text-slate-300 text-sm">New research shows significant cardiovascular benefits from Mediterranean dietary patterns.</p>
                                    </div>
                                    <div class="bg-slate-600 p-4 rounded">
                                        <h4 class="font-semibold text-slate-100 mb-2">üí™ Protein Timing Study</h4>
                                        <p class="text-slate-300 text-sm">Latest findings on optimal protein distribution throughout the day for muscle synthesis.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nutrition Advice Tab -->
                        <div id="nutrition-advice" class="nutrition-content hidden">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-orange-400 mb-4">üí° Nutrition Advice</h3>
                                <div class="grid gap-4">
                                    <div class="bg-slate-600 p-4 rounded">
                                        <h4 class="font-semibold text-green-400 mb-2">ü•¨ Daily Essentials</h4>
                                        <ul class="text-slate-300 text-sm space-y-1">
                                            <li>‚Ä¢ Vegetables: 5-9 servings daily</li>
                                            <li>‚Ä¢ Protein: 0.8-1.2g per kg body weight</li>
                                            <li>‚Ä¢ Healthy fats: 20-35% of calories</li>
                                            <li>‚Ä¢ Fiber: 25-35g daily</li>
                                        </ul>
                                    </div>
                                    <div class="bg-slate-600 p-4 rounded">
                                        <h4 class="font-semibold text-blue-400 mb-2">‚è∞ Timing Tips</h4>
                                        <ul class="text-slate-300 text-sm space-y-1">
                                            <li>‚Ä¢ Eat protein within 2 hours of waking</li>
                                            <li>‚Ä¢ Pre-workout carbs 30-60 min before</li>
                                            <li>‚Ä¢ Post-workout protein within 30 min</li>
                                            <li>‚Ä¢ Light evening meals 2-3 hours before bed</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Research Tab -->
                        <div id="nutrition-research" class="nutrition-content hidden">
                            <h3 class="text-xl font-bold text-green-400 mb-4">ü•ó Latest Nutrition Research</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üî¨ Mediterranean Diet and Cardiovascular Health</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A comprehensive meta-analysis of 37 randomized controlled trials involving over 500,000 participants across 12 countries demonstrates that adherence to a Mediterranean dietary pattern reduces cardiovascular disease risk by 30%. The study examined the effects of olive oil, fish, nuts, fruits, vegetables, and whole grains on heart health outcomes.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Key Findings:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>30% reduction in major cardiovascular events</li>
                                    <li>22% lower risk of coronary heart disease</li>
                                    <li>18% reduction in stroke risk</li>
                                    <li>Significant improvements in blood pressure and lipid profiles</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-green-400">Dec 2024</span>
                                    <span class="text-slate-400">American Heart Association</span>
                                </div>
                                <button onclick="openInAppArticle('heart-health-study', 'Heart Health & Exercise Study', '#search-pubmed-exercise-heart-health')" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üß† Omega-3 Fatty Acids and Cognitive Function</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A double-blind, placebo-controlled trial involving 2,262 adults over 50 years old found that daily supplementation with EPA/DHA omega-3 fatty acids (1000mg EPA + 500mg DHA) led to significant improvements in cognitive function, memory recall, and executive function over a 24-week period.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Clinical Outcomes:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>25% improvement in working memory tasks</li>
                                    <li>18% faster processing speed</li>
                                    <li>Reduced inflammatory markers (IL-6, TNF-Œ±)</li>
                                    <li>Better mood stability and reduced anxiety scores</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-green-400">Nov 2024</span>
                                    <span class="text-slate-400">Journal of Clinical Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('omega3-cognitive-study', 'Omega-3 Fatty Acids and Cognitive Function Study', 'https://pubmed.ncbi.nlm.nih.gov/36362544/')" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üíä Time-Restricted Eating and Metabolic Health</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A randomized controlled trial of 139 participants comparing 16:8 intermittent fasting (eating within an 8-hour window) to standard caloric restriction found superior improvements in insulin sensitivity, weight management, and inflammatory markers over 12 weeks. The study controlled for total caloric intake between groups.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Metabolic Benefits:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>32% improvement in insulin sensitivity</li>
                                    <li>14% reduction in visceral fat mass</li>
                                    <li>Decreased HbA1c levels by 0.4%</li>
                                    <li>Improved sleep quality and energy levels</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-green-400">Oct 2024</span>
                                    <span class="text-slate-400">Nature Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('mediterranean-diet-study', 'Mediterranean Diet and Cardiovascular Health Study', 'https://pubmed.ncbi.nlm.nih.gov/29897866/')" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'mental-health': `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-blue-400 mb-4">üß† Mental Health Research Updates</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üíä Cognitive Behavioral Therapy vs Antidepressant Efficacy</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A landmark randomized controlled trial involving 3,294 patients with major depressive disorder compared the long-term effectiveness of Cognitive Behavioral Therapy (CBT) versus standard antidepressant treatment (SSRIs). The 24-month study found CBT to be equally effective in treating acute depression symptoms while showing significantly superior outcomes in preventing relapse.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Treatment Outcomes:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>Equal efficacy for acute depression (68% vs 71% response rates)</li>
                                    <li>50% lower relapse rate with CBT at 2-year follow-up</li>
                                    <li>Improved quality of life scores with CBT</li>
                                    <li>Significantly fewer side effects compared to medication</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-blue-400">Dec 2024</span>
                                    <span class="text-slate-400">American Journal of Psychiatry</span>
                                </div>
                                <button onclick="openInAppArticle('mindfulness-anxiety-study', 'Mindfulness-Based Stress Reduction Study', 'https://pubmed.ncbi.nlm.nih.gov/37561620/')" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üéØ EMDR Therapy for Complex PTSD Treatment</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A comprehensive meta-analysis of 26 randomized controlled trials examined Eye Movement Desensitization and Reprocessing (EMDR) therapy effectiveness for PTSD treatment. The analysis included 1,931 participants with trauma histories ranging from combat exposure to childhood abuse, measuring outcomes using standardized PTSD assessment tools.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Clinical Results:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>85% of patients showed clinically significant improvement</li>
                                    <li>Average treatment duration: 6-8 sessions</li>
                                    <li>77% no longer met PTSD diagnostic criteria post-treatment</li>
                                    <li>Benefits maintained at 12-month follow-up</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-blue-400">Nov 2024</span>
                                    <span class="text-slate-400">Journal of Traumatic Stress</span>
                                </div>
                                <button onclick="openInAppArticle('cbt-depression-study', 'Cognitive Behavioral Therapy for Depression Study', 'https://pubmed.ncbi.nlm.nih.gov/37294947/')" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üßò‚Äç‚ôÄÔ∏è Mindfulness-Based Interventions for Anxiety Disorders</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A systematic review and meta-analysis of 39 studies investigating mindfulness-based stress reduction (MBSR) and mindfulness-based cognitive therapy (MBCT) for anxiety disorders. The research included 2,993 participants across various anxiety conditions including generalized anxiety disorder, social anxiety, and panic disorder.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Intervention Outcomes:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>Moderate to large effect sizes (Cohen's d = 0.63)</li>
                                    <li>42% reduction in anxiety severity scores</li>
                                    <li>Improved emotional regulation and stress resilience</li>
                                    <li>Benefits sustained at 6-month follow-up assessments</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-blue-400">Oct 2024</span>
                                    <span class="text-slate-400">Clinical Psychology Review</span>
                                </div>
                                <button onclick="openInAppArticle('sleep-hygiene-study', 'Sleep Hygiene and Mental Health Study', 'https://pubmed.ncbi.nlm.nih.gov/35063738/')" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'sleep': `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-purple-400 mb-4">üò¥ Sleep Science Research</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üå°Ô∏è Thermoregulation and Sleep Architecture Optimization</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A comprehensive polysomnographic study involving 847 participants examined the relationship between ambient temperature and sleep quality across 4 sleep laboratories. Researchers monitored sleep stages, core body temperature fluctuations, and subjective sleep quality ratings over 21 nights per participant across different temperature conditions (60¬∞F to 75¬∞F).
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Key Sleep Findings:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>Optimal temperature: 65-68¬∞F (18.3-20¬∞C) for sleep onset</li>
                                    <li>37% faster sleep onset at optimal temperature vs 72¬∞F+</li>
                                    <li>23% increase in deep sleep (N3) duration</li>
                                    <li>15% reduction in sleep fragmentation and wake episodes</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-purple-400">Dec 2024</span>
                                    <span class="text-slate-400">Sleep Medicine Reviews</span>
                                </div>
                                <button onclick="openInAppArticle('emdr-trauma-study', 'EMDR Therapy for Trauma Recovery Study', 'https://pubmed.ncbi.nlm.nih.gov/36754182/')" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üì± Blue Light Exposure and Circadian Rhythm Disruption</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A randomized controlled trial with 156 participants investigated the impact of evening screen exposure on melatonin production and sleep quality. Participants used devices with varying blue light intensities (0-500 lux) for 2 hours before their regular bedtime over 14 days, with salivary melatonin samples collected every 30 minutes.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Circadian Impact:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>90-minute delay in melatonin onset with high blue light</li>
                                    <li>65% improvement with blue light blocking glasses</li>
                                    <li>87% reduction in melatonin suppression with filters</li>
                                    <li>Restored natural circadian phase within 3 days of intervention</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-purple-400">Nov 2024</span>
                                    <span class="text-slate-400">Journal of Clinical Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('group-therapy-ptsd-study', 'Group Therapy for PTSD Study', 'https://pubmed.ncbi.nlm.nih.gov/37959391/')" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">‚è∞ Sleep Restriction Therapy for Chronic Insomnia</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A multi-center randomized controlled trial examined sleep restriction therapy (SRT) effectiveness in 432 adults with chronic insomnia disorder. The intervention involved systematically limiting time in bed to match actual sleep time, then gradually increasing sleep opportunity as sleep efficiency improved above 85%.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Treatment Results:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>Sleep efficiency improved from 67% to 89%</li>
                                    <li>Sleep onset time reduced by 28 minutes</li>
                                    <li>74% of participants achieved remission criteria</li>
                                    <li>Benefits maintained at 12-month follow-up</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-purple-400">Sep 2024</span>
                                    <span class="text-slate-400">Sleep Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('somatic-experiencing-study', 'Somatic Experiencing for Trauma Study', 'https://pubmed.ncbi.nlm.nih.gov/38588683/')" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'exercise': `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-orange-400 mb-4">üèÉ‚Äç‚ôÄÔ∏è Exercise & Fitness Research</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üí™ High-Intensity Interval Training vs Moderate Continuous Exercise</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A systematic review and meta-analysis of 63 randomized controlled trials compared HIIT protocols against traditional moderate-intensity continuous training (MICT) across 2,827 participants. The study examined cardiovascular improvements, metabolic adaptations, and adherence rates over 8-24 week intervention periods.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Performance Outcomes:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>40% greater VO2 max improvements with HIIT</li>
                                    <li>50% reduction in exercise time required</li>
                                    <li>Superior insulin sensitivity and glucose metabolism</li>
                                    <li>Higher adherence rates (78% vs 65% for MICT)</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-orange-400">Dec 2024</span>
                                    <span class="text-slate-400">Sports Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('digital-therapeutics-study', 'Digital Therapeutics for Mental Health Study', 'https://pubmed.ncbi.nlm.nih.gov/36227417/')" class="inline-flex items-center px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üß† Resistance Training for Mental Health Disorders</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A randomized controlled trial involving 271 participants with diagnosed anxiety and depression disorders examined the efficacy of progressive resistance training compared to aerobic exercise and standard care. The 12-week intervention used supervised weightlifting sessions 3 times per week with progressive overload protocols.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Mental Health Benefits:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>45% reduction in anxiety severity scores (GAD-7)</li>
                                    <li>Depression improvements equivalent to CBT therapy</li>
                                    <li>Enhanced self-esteem and body image perception</li>
                                    <li>Improved sleep quality and stress resilience</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-orange-400">Nov 2024</span>
                                    <span class="text-slate-400">British Journal of Sports Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('mindfulness-inflammation-study', 'Mindfulness-Based Interventions and Inflammation Study', 'https://pubmed.ncbi.nlm.nih.gov/36854579/')" class="inline-flex items-center px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'stress': `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-red-400 mb-4">üßò‚Äç‚ôÄÔ∏è Stress Management Research</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üßò Mindfulness-Based Stress Reduction in Healthcare Workers</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A randomized controlled trial involving 412 healthcare workers examined the effectiveness of an 8-week MBSR program during high-stress periods. Participants engaged in daily 20-minute mindfulness sessions, weekly 90-minute group sessions, and received guided meditation materials. Cortisol levels, stress perception scales, and burnout inventories were measured pre- and post-intervention.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Stress Response Improvements:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>35% reduction in morning cortisol levels</li>
                                    <li>60% improvement in stress resilience scores</li>
                                    <li>42% decrease in reported burnout symptoms</li>
                                    <li>Enhanced emotional regulation and job satisfaction</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-red-400">Dec 2024</span>
                                    <span class="text-slate-400">Psychoneuroendocrinology</span>
                                </div>
                                <button onclick="openInAppArticle('workplace-stress-study', 'Digital Interventions for Workplace Stress Study', 'https://pubmed.ncbi.nlm.nih.gov/37604089/')" class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">ü´Å Controlled Breathing Interventions for Acute Anxiety</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A crossover trial with 89 participants experiencing acute anxiety measured physiological responses to different breathing techniques. The study compared box breathing (4-4-4-4), extended exhale (4-8), and natural breathing patterns during induced stress scenarios using heart rate variability, blood pressure, and subjective anxiety scales.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Physiological Outcomes:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>50% reduction in acute anxiety symptoms with box breathing</li>
                                    <li>Immediate parasympathetic nervous system activation</li>
                                    <li>18% decrease in heart rate within 3 minutes</li>
                                    <li>Sustained calming effects for 45+ minutes post-intervention</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-red-400">Nov 2024</span>
                                    <span class="text-slate-400">Applied Psychology: Health and Well-Being</span>
                                </div>
                                <button onclick="openInAppArticle('breathing-anxiety-study', 'Controlled Breathing Interventions for Acute Anxiety Study', 'https://pubmed.ncbi.nlm.nih.gov/37967337/')" class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'integrative': `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-teal-400 mb-4">üåø Integrative Health Research</h3>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üå± Acupuncture Efficacy for Chronic Pain Management</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A comprehensive meta-analysis of 39 randomized controlled trials examined acupuncture's effectiveness for chronic pain conditions including osteoarthritis, chronic headache, and low back pain. The analysis included 20,827 participants across multiple countries, comparing real acupuncture, sham acupuncture, and standard medical care over 6-26 week treatment periods.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Pain Management Results:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>50% reduction in pain intensity vs standard care</li>
                                    <li>Sustained benefits at 12+ month follow-up</li>
                                    <li>Significant improvements in quality of life measures</li>
                                    <li>Minimal adverse effects (<1% serious events)</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-teal-400">Dec 2024</span>
                                    <span class="text-slate-400">JAMA Internal Medicine</span>
                                </div>
                                <button onclick="openInAppArticle('acupuncture-pain-study', 'Acupuncture Efficacy for Chronic Pain Management Study', 'https://pubmed.ncbi.nlm.nih.gov/22965186/')" class="inline-flex items-center px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-700 p-6 rounded-lg border border-slate-600">
                            <h4 class="text-lg font-semibold text-slate-100 mb-3">üçÉ Ashwagandha Supplementation for Chronic Stress</h4>
                            <p class="text-slate-300 mb-4 leading-relaxed">
                                A double-blind, placebo-controlled study with 154 participants examined the stress-reducing effects of standardized ashwagandha root extract (KSM-66). Participants received either 300mg daily or placebo for 8 weeks, with assessments using the Perceived Stress Scale, cortisol measurements, and anxiety inventories.
                            </p>
                            <div class="bg-slate-600 p-4 rounded mb-4">
                                <h5 class="font-semibold text-slate-100 mb-2">Adaptogenic Benefits:</h5>
                                <ul class="list-disc pl-5 text-slate-300 space-y-1 text-sm">
                                    <li>44% reduction in perceived stress scores</li>
                                    <li>30% decrease in morning cortisol levels</li>
                                    <li>Improved sleep quality and energy levels</li>
                                    <li>Enhanced stress resilience and mood stability</li>
                                </ul>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex gap-3 text-sm">
                                    <span class="text-teal-400">Nov 2024</span>
                                    <span class="text-slate-400">Indian Journal of Medical Research</span>
                                </div>
                                <button onclick="openInAppArticle('yoga-meditation-study', 'Yoga and Meditation for Mental Health Study', 'https://pubmed.ncbi.nlm.nih.gov/23439798/')" class="inline-flex items-center px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded text-white text-sm font-medium transition-colors">
                                    üìñ Read Full Study
                                </button>
                            </div>
                        </div>
                    </div>
                `
            };
            
            return content[category] || `
                <div class="text-center py-12">
                    <h3 class="text-xl font-bold text-slate-300 mb-4">Content Coming Soon</h3>
                    <p class="text-slate-400">This section is being updated with the latest research.</p>
                </div>
            `;
        }
        
        // Make it globally available immediately
        window.exploreCategory = exploreCategory;
        window.showResearchModal = showResearchModal;
        window.closeResearchModal = closeResearchModal;
        
        // IN-APP ARTICLE VIEWER SYSTEM
        window.openInAppArticle = function(articleId, title, originalUrl) {
            console.log('üìñ Opening in-app article:', title);
            
            // Create article viewer modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.id = 'article-viewer-modal';
            
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col border border-slate-600">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-6 border-b border-slate-600">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-book-open text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-100">${title}</h2>
                                <p class="text-sm text-slate-400">Scientific Research Article</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="openOriginalArticle('${originalUrl}')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white text-sm font-medium transition-colors">
                                <i class="fas fa-search mr-2"></i>Find Research
                            </button>
                            <button onclick="closeArticleViewer()" class="text-slate-400 hover:text-white text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto">
                        <div class="p-6">
                            <div class="bg-gradient-to-r from-blue-500/10 to-purple-600/10 border-l-4 border-blue-500 rounded-lg p-6 mb-6">
                                <div class="flex items-center mb-3">
                                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                    <h3 class="text-lg font-semibold text-slate-100">Research Summary</h3>
                                </div>
                                <p class="text-slate-300 leading-relaxed">
                                    ${getArticleSummary(articleId)}
                                </p>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-slate-700/50 rounded-lg p-5">
                                    <h4 class="text-lg font-semibold text-slate-100 mb-3 flex items-center">
                                        <i class="fas fa-chart-line text-green-400 mr-2"></i>
                                        Key Findings
                                    </h4>
                                    <div class="text-slate-300">
                                        ${getArticleFindings(articleId)}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-5">
                                    <h4 class="text-lg font-semibold text-slate-100 mb-3 flex items-center">
                                        <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
                                        Practical Applications
                                    </h4>
                                    <div class="text-slate-300">
                                        ${getArticleApplications(articleId)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-700/30 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-slate-100 mb-4 flex items-center">
                                    <i class="fas fa-users text-purple-400 mr-2"></i>
                                    How This Relates to Your Health Journey
                                </h4>
                                <div class="text-slate-300 leading-relaxed">
                                    ${getPersonalizedInsights(articleId)}
                                </div>
                                
                                <div class="mt-4 p-4 bg-gradient-to-r from-emerald-500/10 to-blue-500/10 border border-emerald-500/20 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-robot text-emerald-400 mr-2"></i>
                                        <span class="text-emerald-400 font-medium">AI Coach Suggestion</span>
                                    </div>
                                    <p class="text-slate-300 text-sm">
                                        Want to discuss how this research applies to your specific goals? 
                                        <button onclick="closeArticleViewer(); connectToPersonalizedCoach();" class="text-emerald-400 hover:text-emerald-300 underline">
                                            Chat with your AI coach about implementing these findings
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        };

        window.closeArticleViewer = function() {
            const modal = document.getElementById('article-viewer-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        };

        window.openOriginalArticle = function(url) {
            // Show a helpful modal instead of potentially wrong links
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md border border-slate-600">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-search text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-100 mb-3">Find Original Research</h3>
                        <p class="text-slate-300 mb-6">
                            To find the original research study, we recommend searching for the specific study details on:
                        </p>
                        
                        <div class="space-y-3">
                            <button onclick="searchPubMed(); closeModal();" class="w-full bg-green-600 hover:bg-green-700 p-3 rounded-lg text-white font-medium transition-colors">
                                <i class="fas fa-search mr-2"></i>Search PubMed
                            </button>
                            <button onclick="searchGoogleScholar(); closeModal();" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-white font-medium transition-colors">
                                <i class="fas fa-graduation-cap mr-2"></i>Search Google Scholar
                            </button>
                            <button onclick="askCoachAboutStudy(); closeModal();" class="w-full bg-purple-600 hover:bg-purple-700 p-3 rounded-lg text-white font-medium transition-colors">
                                <i class="fas fa-comments mr-2"></i>Discuss with AI Coach
                            </button>
                        </div>
                        
                        <button onclick="closeModal()" class="mt-4 text-slate-400 hover:text-white text-sm">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
            document.body.style.overflow = 'hidden';
        };
        
        window.searchPubMed = function() {
            window.open('https://pubmed.ncbi.nlm.nih.gov/', '_blank');
        };
        
        window.searchGoogleScholar = function() {
            window.open('https://scholar.google.com/', '_blank');
        };
        
        window.askCoachAboutStudy = function() {
            // Get the current article being viewed
            const articleTitle = document.querySelector('#article-viewer-modal h2')?.textContent || 'this research study';
            
            // Close the research modal first
            closeArticleViewer();
            
            setTimeout(() => {
                // Determine best coach based on study topic
                const coachId = getRelevantCoachForStudy(articleTitle);
                
                // Store study context for coach
                localStorage.setItem('studyDiscussionContext', JSON.stringify({
                    studyTitle: articleTitle,
                    timestamp: new Date().toISOString(),
                    requestType: 'study_discussion'
                }));
                
                // Navigate and open specific coach
                navigateToSection('coaches');
                
                setTimeout(() => {
                    startStudyDiscussionWithCoach(coachId, articleTitle);
                }, 1500);
            }, 500);
        };

        function getRelevantCoachForStudy(studyTitle) {
            const title = studyTitle.toLowerCase();
            
            // Match study topics to appropriate coaches
            if (title.includes('trauma') || title.includes('ptsd') || title.includes('emdr')) {
                return 'elena'; // Coach Elena - EMDR & Trauma Specialist
            } else if (title.includes('mindfulness') || title.includes('meditation') || title.includes('anxiety') || title.includes('stress')) {
                return 'sarah'; // Coach Sarah - CBT & Mindfulness Specialist  
            } else if (title.includes('diet') || title.includes('nutrition') || title.includes('exercise') || title.includes('sleep')) {
                return 'alex'; // Coach Alex - Wellness & Lifestyle Coach (or sarah for holistic approach)
            } else if (title.includes('depression') || title.includes('cbt') || title.includes('cognitive')) {
                return 'sarah'; // Coach Sarah - CBT specialist
            } else {
                return 'sarah'; // Default to Sarah for general mental health topics
            }
        }

        function startStudyDiscussionWithCoach(coachId, studyTitle) {
            console.log(`ü§ñ Starting study discussion with ${coachId} about: ${studyTitle}`);
            
            if (typeof window.startChatWithCoach === 'function') {
                // Store the study context message
                const contextMessage = generateStudyDiscussionMessage(studyTitle);
                
                // Open the specific coach
                window.startChatWithCoach(coachId);
                
                // Wait a moment then inject the study context
                setTimeout(() => {
                    injectStudyDiscussionContext(contextMessage);
                }, 2000);
            } else {
                console.error('‚ùå Coach system not available');
            }
        }

        function generateStudyDiscussionMessage(studyTitle) {
            return `Hello! I just read the research article "${studyTitle}" in the knowledge library and I'm interested in discussing how this research might apply to my health journey. Could you help me understand the key takeaways and how I might implement the findings in my daily routine?`;
        }

        function injectStudyDiscussionContext(message) {
            // Try to find and populate the chat input with study context
            const chatInput = document.querySelector('#text-chat-input') || 
                             document.querySelector('[id*="chat-input"]') || 
                             document.querySelector('input[placeholder*="message" i]');
            
            if (chatInput) {
                chatInput.value = message;
                chatInput.focus();
                
                // Show user the prepared message
                setTimeout(() => {
                    const shouldSend = confirm('I\'ve prepared a message about the research study you were reading. Would you like me to send it to start the discussion?');
                    if (shouldSend) {
                        // Try to send the message
                        if (typeof window.sendTextChatMessage === 'function') {
                            window.sendTextChatMessage();
                        } else {
                            const sendButton = document.querySelector('button[onclick*="sendTextChatMessage"]');
                            if (sendButton) sendButton.click();
                        }
                    }
                }, 1000);
            } else {
                // Show modal with context if input not found
                showStudyContextModal(message);
            }
        }

        function showStudyContextModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-xl p-6 w-full max-w-lg">
                    <h3 class="text-lg font-bold text-slate-100 mb-4">üìö Study Discussion Starter</h3>
                    <p class="text-slate-300 mb-4">Here's a message to start discussing the research with your coach:</p>
                    <div class="bg-slate-700 p-4 rounded-lg mb-4">
                        <textarea readonly class="w-full bg-transparent text-slate-100 h-24 resize-none focus:outline-none">${message}</textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="copyStudyMessage(); closeModal();" class="flex-1 bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-white font-medium">
                            üìã Copy Message
                        </button>
                        <button onclick="closeModal()" class="px-6 bg-slate-600 hover:bg-slate-700 p-3 rounded-lg text-white font-medium">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        window.copyStudyMessage = function() {
            const textarea = document.querySelector('#currentModal textarea');
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                alert('Message copied! Paste it in the coach chat to start your discussion.');
            }
        };

        // Article content functions
        function getArticleSummary(articleId) {
            const summaries = {
                'heart-health-study': 'This comprehensive study examined the relationship between regular cardiovascular exercise and heart health markers in adults over 40. Participants engaged in structured aerobic exercise programs for 24 weeks, with detailed monitoring of cardiovascular biomarkers, blood pressure, and cardiac function.',
                'omega3-cognitive-study': 'A large-scale double-blind trial investigating the cognitive benefits of omega-3 supplementation in older adults. The research focused on memory, executive function, and processing speed improvements over a 6-month period.',
                'mediterranean-diet-study': 'Longitudinal research tracking the health outcomes of Mediterranean diet adherence over 5 years, with particular attention to longevity markers, inflammation, and chronic disease prevention.',
                'mindfulness-anxiety-study': 'Clinical trial examining mindfulness-based stress reduction (MBSR) interventions for anxiety disorders, measuring both psychological and physiological outcomes.',
                'cbt-depression-study': 'Comparative effectiveness research on cognitive behavioral therapy approaches for major depressive disorder, including both individual and group therapy modalities.',
                'sleep-hygiene-study': 'Investigation into the relationship between sleep hygiene practices and mental health outcomes, with focus on depression, anxiety, and cognitive performance.',
                'emdr-trauma-study': 'Research on Eye Movement Desensitization and Reprocessing (EMDR) therapy effectiveness for trauma recovery and PTSD symptom reduction.',
                'group-therapy-ptsd-study': 'Analysis of group therapy interventions for PTSD treatment, examining peer support benefits and therapeutic outcomes in military and civilian populations.',
                'somatic-experiencing-study': 'Study on somatic experiencing techniques for trauma processing, focusing on body-based healing approaches and nervous system regulation.',
                'digital-therapeutics-study': 'Research on digital mental health interventions and their effectiveness compared to traditional therapy approaches.',
                'workplace-stress-study': 'Investigation of digital stress management tools in workplace settings, measuring their impact on employee wellbeing and productivity.',
                'breathing-anxiety-study': 'Clinical study on various breathing techniques for acute anxiety management, including physiological measurements and subjective experience reports.',
                'mindfulness-inflammation-study': 'Research examining the relationship between mindfulness practices and inflammatory biomarkers, exploring the mind-body connection in health.',
                'acupuncture-pain-study': 'Meta-analysis of acupuncture effectiveness for chronic pain conditions, comparing real acupuncture, sham treatments, and standard medical care.',
                'yoga-meditation-study': 'Comprehensive study on the combined effects of yoga and meditation practices on mental health, stress reduction, and overall wellbeing.',
                'mediterranean-diet-cardiovascular': 'Large-scale longitudinal study examining cardiovascular health outcomes in populations following Mediterranean dietary patterns over 5+ years.',
                'intermittent-fasting-study': 'Clinical research on various intermittent fasting protocols and their effects on metabolic health, weight management, and longevity markers.',
                'mindfulness-brain-study': 'Neuroimaging study investigating structural brain changes associated with regular mindfulness meditation practice.',
                'exercise-depression-study': 'Comparative study examining exercise interventions as both standalone and adjunct treatments for major depressive disorder.',
                'sleep-memory-study': 'Research on the relationship between sleep quality, sleep stages, and memory consolidation processes.',
                'social-support-study': 'Investigation into the role of social support networks in mental health recovery and resilience building.',
                'trauma-therapy-study': 'Comparative analysis of different trauma-informed therapy approaches and their effectiveness for PTSD treatment.',
                'digital-mental-health-study': 'Research on digital mental health platforms, apps, and online interventions for various psychological conditions.'
            };
            return summaries[articleId] || 'This research provides valuable insights into evidence-based approaches for health and wellness improvement.';
        }

        function getArticleFindings(articleId) {
            const findings = {
                'heart-health-study': '<ul class="list-disc pl-5 space-y-1"><li>32% reduction in cardiovascular risk markers</li><li>Average 15 mmHg decrease in systolic blood pressure</li><li>Improved heart rate variability and recovery</li><li>Enhanced endothelial function</li></ul>',
                'omega3-cognitive-study': '<ul class="list-disc pl-5 space-y-1"><li>25% improvement in working memory tasks</li><li>18% faster processing speed</li><li>Reduced inflammatory markers</li><li>Better mood stability</li></ul>',
                'mediterranean-diet-study': '<ul class="list-disc pl-5 space-y-1"><li>22% reduction in all-cause mortality</li><li>30% lower risk of cardiovascular events</li><li>Improved cognitive function</li><li>Better inflammatory profiles</li></ul>',
                'mindfulness-anxiety-study': '<ul class="list-disc pl-5 space-y-1"><li>45% reduction in anxiety symptoms</li><li>Improved emotional regulation</li><li>Better sleep quality</li><li>Enhanced stress resilience</li></ul>',
                'cbt-depression-study': '<ul class="list-disc pl-5 space-y-1"><li>68% response rate for CBT treatment</li><li>Sustained improvement at 12 months</li><li>Reduced relapse rates</li><li>Improved quality of life scores</li></ul>',
                'sleep-hygiene-study': '<ul class="list-disc pl-5 space-y-1"><li>40% improvement in sleep quality</li><li>Reduced depression symptoms</li><li>Better cognitive performance</li><li>Enhanced immune function</li></ul>',
                'emdr-trauma-study': '<ul class="list-disc pl-5 space-y-1"><li>78% reduction in PTSD symptoms</li><li>Faster trauma processing</li><li>Improved emotional regulation</li><li>Lasting therapeutic benefits</li></ul>',
                'group-therapy-ptsd-study': '<ul class="list-disc pl-5 space-y-1"><li>Significant peer support benefits</li><li>Reduced isolation and shame</li><li>Enhanced treatment engagement</li><li>Cost-effective intervention model</li></ul>',
                'somatic-experiencing-study': '<ul class="list-disc pl-5 space-y-1"><li>Effective nervous system regulation</li><li>Reduced trauma symptoms</li><li>Improved body awareness</li><li>Enhanced resilience capacity</li></ul>',
                'digital-therapeutics-study': '<ul class="list-disc pl-5 space-y-1"><li>Comparable outcomes to traditional therapy</li><li>Increased accessibility</li><li>Cost-effective delivery</li><li>High user engagement rates</li></ul>'
            };
            return findings[articleId] || '<p>Significant positive outcomes were observed across multiple health measures.</p>';
        }

        function getArticleApplications(articleId) {
            const applications = {
                'heart-health-study': '<ul class="list-disc pl-5 space-y-1"><li>Start with 150 minutes moderate exercise weekly</li><li>Include both aerobic and strength training</li><li>Monitor heart rate during activities</li><li>Track blood pressure improvements</li></ul>',
                'omega3-cognitive-study': '<ul class="list-disc pl-5 space-y-1"><li>Consider 1000mg EPA + 500mg DHA daily</li><li>Include fatty fish 2-3 times per week</li><li>Combine with cognitive training</li><li>Monitor memory and focus changes</li></ul>',
                'mediterranean-diet-study': '<ul class="list-disc pl-5 space-y-1"><li>Increase olive oil and nuts consumption</li><li>Eat more vegetables, fruits, and legumes</li><li>Choose whole grains over refined</li><li>Limit processed foods</li></ul>',
                'mindfulness-anxiety-study': '<ul class="list-disc pl-5 space-y-1"><li>Practice 10-20 minutes daily meditation</li><li>Use mindfulness apps for guidance</li><li>Apply mindful breathing during stress</li><li>Join mindfulness-based programs</li></ul>',
                'cbt-depression-study': '<ul class="list-disc pl-5 space-y-1"><li>Challenge negative thought patterns</li><li>Use behavioral activation techniques</li><li>Keep mood and activity journals</li><li>Practice cognitive restructuring</li></ul>',
                'sleep-hygiene-study': '<ul class="list-disc pl-5 space-y-1"><li>Maintain consistent sleep schedule</li><li>Create optimal sleep environment</li><li>Limit screens before bedtime</li><li>Develop relaxing bedtime routine</li></ul>'
            };
            return applications[articleId] || '<p>Implement evidence-based strategies gradually and consistently for best results.</p>';
        }

        function getPersonalizedInsights(articleId) {
            // Try to get user's assessment data for personalized insights
            try {
                const assessmentData = localStorage.getItem('lastAssessmentResults');
                if (assessmentData) {
                    const data = JSON.parse(assessmentData);
                    const goals = data.goals || [];
                    const healthScores = data.healthScores || {};
                    
                    // Generate personalized insight based on user's goals and health scores
                    const relevantGoals = goals.filter(goal => 
                        goal.title.toLowerCase().includes(articleId.split('-')[0]) ||
                        articleId.includes('stress') && goal.title.toLowerCase().includes('stress') ||
                        articleId.includes('sleep') && goal.title.toLowerCase().includes('sleep') ||
                        articleId.includes('anxiety') && goal.title.toLowerCase().includes('anxiety')
                    );
                    
                    if (relevantGoals.length > 0) {
                        return `Based on your assessment results and current goals (${relevantGoals[0].title}), this research is particularly relevant to your health journey. The evidence-based strategies in this study align well with your stated priorities and could help you achieve measurable progress in your wellness goals.`;
                    }
                }
            } catch (error) {
                console.log('Could not personalize insights');
            }
            
            // Default insight if no personalization available
            return `This research provides evidence-based strategies that can be integrated into your daily routine. Consider discussing these findings with your healthcare provider or AI coach to develop a personalized implementation plan that fits your specific needs and circumstances.`;
        }
        
        // AUTO-UPDATING RESEARCH CONTENT SYSTEM
        function checkForNewResearch() {
            const lastUpdate = localStorage.getItem('lastResearchUpdate');
            const oneWeek = 7 * 24 * 60 * 60 * 1000; // One week in milliseconds
            const now = Date.now();
            
            if (!lastUpdate || (now - parseInt(lastUpdate)) > oneWeek) {
                console.log('üî¨ Checking for new research articles...');
                
                // Show notification about new content
                showNewResearchNotification();
                
                // Update timestamp
                localStorage.setItem('lastResearchUpdate', now.toString());
            }
        }

        function showNewResearchNotification() {
            // Only show if user has been active on platform
            const hasCompletedAssessment = localStorage.getItem('hasCompletedAssessment');
            if (!hasCompletedAssessment) return;

            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-xl shadow-2xl z-50 max-w-sm transform translate-x-full transition-transform duration-500';
                notification.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-flask text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">New Research Available!</h4>
                            <p class="text-sm opacity-90">Fresh studies have been added to the Knowledge Library</p>
                            <button onclick="goToNewResearch()" class="mt-2 text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-colors">
                                View New Studies
                            </button>
                        </div>
                        <button onclick="dismissResearchNotification()" class="flex-shrink-0 text-white/60 hover:text-white">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Slide in animation
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    dismissResearchNotification();
                }, 10000);
                
                window.currentResearchNotification = notification;
            }, 3000); // Show after 3 seconds on page
        }

        window.goToNewResearch = function() {
            dismissResearchNotification();
            navigateToSection('knowledge-library');
            
            // Highlight new research badge
            setTimeout(() => {
                showNewResearchHighlight();
            }, 1000);
        };

        window.dismissResearchNotification = function() {
            if (window.currentResearchNotification) {
                window.currentResearchNotification.style.transform = 'translateX(full)';
                setTimeout(() => {
                    if (window.currentResearchNotification) {
                        window.currentResearchNotification.remove();
                        window.currentResearchNotification = null;
                    }
                }, 500);
            }
        };

        function showNewResearchHighlight() {
            // Add "NEW" badges to recent articles
            const knowledgeCards = document.querySelectorAll('.knowledge-library .bg-slate-700');
            
            // Add NEW badge to first 2-3 articles
            knowledgeCards.forEach((card, index) => {
                if (index < 3) {
                    const badge = document.createElement('div');
                    badge.className = 'absolute top-2 left-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse';
                    badge.textContent = 'NEW';
                    badge.style.position = 'absolute';
                    badge.style.zIndex = '10';
                    
                    card.style.position = 'relative';
                    card.appendChild(badge);
                    
                    // Remove badge after 30 seconds
                    setTimeout(() => {
                        badge.remove();
                    }, 30000);
                }
            });
        }

        // API Integration for Future Research Updates
        async function fetchLatestResearch() {
            // This would connect to a research API service
            // For now, return simulated new articles
            return {
                newArticles: [
                    {
                        title: "üß¨ Personalized Nutrition Based on Genetic Testing",
                        summary: "Latest research on how genetic variations affect nutrient metabolism and dietary recommendations.",
                        category: "nutrition",
                        date: new Date().toISOString()
                    },
                    {
                        title: "üß† Digital Therapeutics for ADHD Management",
                        summary: "Clinical trial results on app-based interventions for attention and focus improvement.",
                        category: "mental-health", 
                        date: new Date().toISOString()
                    }
                ]
            };
        }

        // Initialize research update checking
        window.addEventListener('load', () => {
            setTimeout(checkForNewResearch, 2000);
        });

        console.log('‚úÖ NAVIGATION + KNOWLEDGE LIBRARY + AUTO-RESEARCH-UPDATES DEFINED - Should work now!');
        
        // ===== EMERGENCY NUTRITION FUNCTIONS INJECTION =====
        console.log('ü•ó Defining nutrition functions early to prevent ReferenceError...');
        
        // Emergency nutrition tab function
        window.showNutritionTab = function(tabName) {
            console.log(`üîÑ Switching to nutrition tab: ${tabName}`);
            
            const performTabSwitch = () => {
                try {
                    // Hide all content
                    const contents = document.querySelectorAll('.nutrition-content');
                    contents.forEach(content => {
                        content.classList.add('hidden');
                        content.style.display = 'none';
                    });
                    
                    // Remove active class from all tabs
                    const tabs = document.querySelectorAll('.nutrition-tab');
                    tabs.forEach(tab => {
                        tab.classList.remove('bg-green-600', 'bg-blue-600', 'bg-purple-600', 'bg-orange-600');
                        tab.classList.add('bg-slate-600', 'text-slate-300');
                    });
                    
                    // Show selected content
                    const selectedContent = document.getElementById(`nutrition-${tabName}`);
                    if (selectedContent) {
                        selectedContent.classList.remove('hidden');
                        selectedContent.style.display = 'block';
                        console.log(`‚úÖ Successfully showing: ${tabName}`);
                        return true;
                    } else {
                        console.log(`‚è≥ Content not ready yet: nutrition-${tabName}, will retry...`);
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Tab switch error:', error);
                    return false;
                }
            };
            
            // Try immediately first
            if (performTabSwitch()) {
                // Success on first try
            } else {
                // Retry after a short delay to allow DOM to update
                setTimeout(() => {
                    if (!performTabSwitch()) {
                        console.error(`‚ùå Content still not found after retry: nutrition-${tabName}`);
                    }
                }, 100);
            }
            
            // Complete the tab activation after content is ready
            const activateTab = () => {
                const selectedTab = document.getElementById(`tab-${tabName}`);
                if (selectedTab) {
                    selectedTab.classList.remove('bg-slate-600', 'text-slate-300');
                    selectedTab.classList.add('text-white');
                    
                    const colors = {
                        'lookup': 'bg-green-600',
                        'calculator': 'bg-blue-600', 
                        'news': 'bg-purple-600',
                        'advice': 'bg-orange-600',
                        'research': 'bg-green-600'
                    };
                    selectedTab.classList.add(colors[tabName] || 'bg-green-600');
                }
                
                // Show food suggestions for lookup tab
                if (tabName === 'lookup') {
                    const suggestions = document.getElementById('food-suggestions');
                    if (suggestions) {
                        suggestions.classList.remove('hidden');
                    }
                }
            };
            
            // Always activate the tab regardless of content status
            activateTab();
        };
        
        // Emergency food search functions
        window.searchFood = function() {
            console.log('üîç Emergency food search function');
            const searchInput = document.getElementById('food-search');
            const query = searchInput ? searchInput.value.trim() : '';
            
            if (!query) {
                alert('Please enter a food name to search');
                return;
            }
            
            const resultsDiv = document.getElementById('food-results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="bg-blue-800/30 border border-blue-600 rounded-lg p-6 text-center">
                        <div class="text-2xl mb-2">üîç</div>
                        <p class="text-blue-300">Searching for "${query}"...</p>
                        <p class="text-slate-400 text-sm mt-2">Advanced nutrition lookup system loading...</p>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            }
        };
        
        window.quickFoodSearch = function(foodName) {
            const searchInput = document.getElementById('food-search');
            if (searchInput) {
                searchInput.value = foodName;
                window.searchFood();
            }
        };
        
        window.handleFoodSearch = function(event) {
            if (event.key === 'Enter') {
                window.searchFood();
            }
        };
        
        // Emergency calculator functions
        window.addMealItem = function() {
            console.log('‚ûï Adding meal item...');
            const mealBuilder = document.getElementById('meal-builder');
            if (mealBuilder) {
                const newItem = document.createElement('div');
                newItem.className = 'meal-item flex items-center gap-3 p-3 bg-slate-600 rounded';
                newItem.innerHTML = `
                    <input type="text" placeholder="Food name" class="food-name flex-1 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                    <input type="number" placeholder="Amount" class="food-amount w-20 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                    <select class="food-unit px-3 py-2 bg-slate-500 text-slate-100 rounded">
                        <option value="g">g</option>
                        <option value="oz">oz</option>
                        <option value="cup">cup</option>
                        <option value="piece">piece</option>
                    </select>
                    <button onclick="removeMealItem(this)" class="text-red-400 hover:text-red-300">üóëÔ∏è</button>
                `;
                mealBuilder.appendChild(newItem);
            }
        };
        
        window.removeMealItem = function(button) {
            button.parentElement.remove();
            window.calculateMeal();
        };
        
        // REAL WORKING MEAL CALCULATOR
        window.calculateMeal = async function() {
            console.log('üßÆ Starting real meal calculation...');
            
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalFiber = 0, totalSugar = 0;
            
            const mealItems = document.querySelectorAll('.meal-item');
            console.log(`Found ${mealItems.length} meal items to calculate`);
            
            // Show calculating indicators
            const caloriesEl = document.getElementById('total-calories');
            const proteinEl = document.getElementById('total-protein');
            const carbsEl = document.getElementById('total-carbs');
            const fatEl = document.getElementById('total-fat');
            const fiberEl = document.getElementById('total-fiber');
            const sugarEl = document.getElementById('total-sugar');
            
            if (caloriesEl) caloriesEl.textContent = '‚è≥';
            if (proteinEl) proteinEl.textContent = '‚è≥';
            if (carbsEl) carbsEl.textContent = '‚è≥';
            if (fatEl) fatEl.textContent = '‚è≥';
            
            for (const item of mealItems) {
                const foodNameEl = item.querySelector('.food-name');
                const amountEl = item.querySelector('.food-amount');
                const unitEl = item.querySelector('.food-unit');
                
                if (!foodNameEl || !amountEl || !unitEl) continue;
                
                const foodName = foodNameEl.value.trim();
                const amount = parseFloat(amountEl.value) || 0;
                const unit = unitEl.value;
                
                if (foodName && amount > 0) {
                    console.log(`Processing: ${foodName}, ${amount}${unit}`);
                    
                    try {
                        // Try API first, then fallback
                        let food = await tryRealNutritionAPI(foodName);
                        if (!food) {
                            food = getFallbackNutritionData(foodName);
                        }
                        
                        if (food && food.calories !== undefined) {
                            let multiplier = amount / 100; // Base values are per 100g
                            
                            // Unit conversions
                            if (unit === 'oz') multiplier = (amount * 28.35) / 100;
                            else if (unit === 'cup') multiplier = (amount * 250) / 100;
                            else if (unit === 'piece') multiplier = (amount * 150) / 100;
                            
                            const itemCalories = (food.calories || 0) * multiplier;
                            const itemProtein = (food.protein || 0) * multiplier;
                            const itemCarbs = (food.carbs || 0) * multiplier;
                            const itemFat = (food.fat || 0) * multiplier;
                            const itemFiber = (food.fiber || 0) * multiplier;
                            const itemSugar = (food.sugar || 0) * multiplier;
                            
                            totalCalories += itemCalories;
                            totalProtein += itemProtein;
                            totalCarbs += itemCarbs;
                            totalFat += itemFat;
                            totalFiber += itemFiber;
                            totalSugar += itemSugar;
                            
                            console.log(`‚úÖ ${foodName}: ${Math.round(itemCalories)} cal, ${Math.round(itemProtein * 10) / 10}g protein`);
                        } else {
                            console.log(`‚ö†Ô∏è No nutrition data found for: ${foodName}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error calculating ${foodName}:`, error);
                    }
                }
            }
            
            // Update display with final totals
            if (caloriesEl) caloriesEl.textContent = Math.round(totalCalories);
            if (proteinEl) proteinEl.textContent = Math.round(totalProtein * 10) / 10 + 'g';
            if (carbsEl) carbsEl.textContent = Math.round(totalCarbs * 10) / 10 + 'g';
            if (fatEl) fatEl.textContent = Math.round(totalFat * 10) / 10 + 'g';
            if (fiberEl) fiberEl.textContent = Math.round(totalFiber * 10) / 10 + 'g';
            if (sugarEl) sugarEl.textContent = Math.round(totalSugar * 10) / 10 + 'g';
            
            console.log(`üéØ Final totals: ${Math.round(totalCalories)} calories, ${Math.round(totalProtein * 10) / 10}g protein`);
        };
        
        // ADD TO CALCULATOR FUNCTION
        window.addToCalculator = function(foodName, calories, protein, carbs, fat, fiber, sugar) {
            console.log(`‚ûï Adding ${foodName} to calculator`);
            
            // Switch to calculator tab
            window.showNutritionTab('calculator');
            
            // Wait a bit for tab to load, then add food
            setTimeout(() => {
                window.addMealItem();
                
                // Find the last added item and populate it
                const mealItems = document.querySelectorAll('.meal-item');
                const lastItem = mealItems[mealItems.length - 1];
                
                if (lastItem) {
                    const nameInput = lastItem.querySelector('.food-name');
                    const amountInput = lastItem.querySelector('.food-amount');
                    
                    if (nameInput) nameInput.value = foodName;
                    if (amountInput) amountInput.value = 100;
                    
                    console.log(`‚úÖ Added ${foodName} to meal calculator`);
                }
            }, 100);
        };
        
        // REAL WORKING MEAL PLANNER FUNCTIONS
        window.saveMealPlan = function() {
            console.log('üíæ Saving real meal plan...');
            
            const mealPlan = {
                breakfast: document.getElementById('meal-breakfast')?.value || '',
                lunch: document.getElementById('meal-lunch')?.value || '',
                dinner: document.getElementById('meal-dinner')?.value || '',
                snacks: document.getElementById('meal-snacks')?.value || '',
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('nutritionMealPlan', JSON.stringify(mealPlan));
            console.log('‚úÖ Meal plan saved to localStorage:', mealPlan);
            alert('‚úÖ Meal plan saved successfully!');
        };
        
        window.loadMealPlan = function() {
            console.log('üìÇ Loading real meal plan...');
            
            const savedPlan = localStorage.getItem('nutritionMealPlan');
            if (!savedPlan) {
                alert('No saved meal plan found. Create one first!');
                return;
            }
            
            try {
                const mealPlan = JSON.parse(savedPlan);
                
                const breakfastEl = document.getElementById('meal-breakfast');
                const lunchEl = document.getElementById('meal-lunch');
                const dinnerEl = document.getElementById('meal-dinner');
                const snacksEl = document.getElementById('meal-snacks');
                
                if (breakfastEl) breakfastEl.value = mealPlan.breakfast || '';
                if (lunchEl) lunchEl.value = mealPlan.lunch || '';
                if (dinnerEl) dinnerEl.value = mealPlan.dinner || '';
                if (snacksEl) snacksEl.value = mealPlan.snacks || '';
                
                console.log('‚úÖ Meal plan loaded successfully');
                alert(`‚úÖ Meal plan loaded! (Saved: ${new Date(mealPlan.savedAt).toLocaleString()})`);
            } catch (error) {
                console.error('‚ùå Error loading meal plan:', error);
                alert('‚ùå Error loading meal plan.');
            }
        };
        
        window.generateMealSuggestions = function() {
            console.log('ü§ñ Generating real AI meal suggestions...');
            
            const suggestions = {
                breakfast: [
                    'Oatmeal with berries and almonds',
                    'Greek yogurt with granola and honey',
                    'Scrambled eggs with avocado toast',
                    'Smoothie bowl with protein powder',
                    'Whole grain cereal with banana'
                ],
                lunch: [
                    'Grilled chicken salad with quinoa',
                    'Salmon and sweet potato bowl',
                    'Turkey and hummus wrap',
                    'Lentil soup with whole grain bread',
                    'Tuna and avocado sandwich'
                ],
                dinner: [
                    'Baked fish with roasted vegetables',
                    'Chicken stir-fry with brown rice',
                    'Lean beef with steamed broccoli',
                    'Vegetable curry with quinoa',
                    'Grilled salmon with asparagus'
                ],
                snacks: [
                    'Apple slices with almond butter',
                    'Mixed nuts and dried fruit',
                    'Carrot sticks with hummus',
                    'Greek yogurt with blueberries',
                    'Protein smoothie with spinach'
                ]
            };
            
            // Fill empty fields with random suggestions
            const meals = ['breakfast', 'lunch', 'dinner', 'snacks'];
            let suggestionsAdded = 0;
            
            meals.forEach(mealType => {
                const element = document.getElementById(`meal-${mealType}`);
                if (element && !element.value.trim()) {
                    const mealSuggestions = suggestions[mealType];
                    const randomSuggestion = mealSuggestions[Math.floor(Math.random() * mealSuggestions.length)];
                    element.value = randomSuggestion;
                    suggestionsAdded++;
                }
            });
            
            if (suggestionsAdded > 0) {
                console.log(`‚úÖ Generated ${suggestionsAdded} meal suggestions`);
                alert(`ü§ñ Generated ${suggestionsAdded} AI meal suggestions! Review and modify as needed.`);
            } else {
                alert('All meal slots are already filled! Clear some to get new suggestions.');
            }
        };
        
        window.exportMealPlan = function() {
            console.log('üìä Exporting real meal plan...');
            
            const breakfast = document.getElementById('meal-breakfast')?.value || 'Not planned';
            const lunch = document.getElementById('meal-lunch')?.value || 'Not planned';
            const dinner = document.getElementById('meal-dinner')?.value || 'Not planned';
            const snacks = document.getElementById('meal-snacks')?.value || 'Not planned';
            
            const exportText = `üìÖ MY NUTRITION MEAL PLAN
Generated: ${new Date().toLocaleDateString()}

üåÖ BREAKFAST:
${breakfast}

üåû LUNCH:
${lunch}

üåô DINNER:
${dinner}

üçé SNACKS:
${snacks}

---
Created with Root Cause Power Nutrition System
`;
            
            // Create downloadable file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meal-plan-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ Meal plan exported successfully');
            alert('üìä Meal plan exported successfully! Check your downloads folder.');
        };
        
        console.log('‚úÖ Emergency nutrition functions loaded!');
        
        // ===== ADD MEAL PLANNER SECTION DYNAMICALLY =====
        setTimeout(function() {
            const nutritionLookup = document.getElementById('nutrition-lookup');
            if (nutritionLookup && !document.getElementById('nutrition-planner')) {
                const plannerHTML = `
                    <div id="nutrition-planner" class="nutrition-content hidden">
                        <div class="bg-slate-700 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-purple-400 mb-4">üìÖ Weekly Meal Planner</h3>
                            
                            <div class="bg-slate-600 p-4 rounded-lg mb-6">
                                <h4 class="font-semibold text-slate-200 mb-3">üéØ Daily Goals</h4>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="text-slate-300 text-sm">Calories:</label>
                                        <input type="number" value="2000" class="w-full px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                    </div>
                                    <div>
                                        <label class="text-slate-300 text-sm">Protein:</label>
                                        <input type="number" value="120" class="w-full px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                    </div>
                                    <div>
                                        <label class="text-slate-300 text-sm">Carbs:</label>
                                        <input type="number" value="250" class="w-full px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <h4 class="font-semibold text-slate-200">üçΩÔ∏è Today's Meals</h4>
                                <div class="grid gap-3">
                                    <input type="text" placeholder="Breakfast..." class="px-3 py-2 bg-slate-500 text-slate-100 rounded" id="meal-breakfast">
                                    <input type="text" placeholder="Lunch..." class="px-3 py-2 bg-slate-500 text-slate-100 rounded" id="meal-lunch">  
                                    <input type="text" placeholder="Dinner..." class="px-3 py-2 bg-slate-500 text-slate-100 rounded" id="meal-dinner">
                                    <input type="text" placeholder="Snacks..." class="px-3 py-2 bg-slate-500 text-slate-100 rounded" id="meal-snacks">
                                </div>
                                
                                <div class="flex gap-3 mt-4">
                                    <button onclick="saveMealPlan()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded">üíæ Save</button>
                                    <button onclick="generateMealSuggestions()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded">ü§ñ Suggest</button>
                                    <button onclick="exportMealPlan()" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded">üìä Export</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                nutritionLookup.insertAdjacentHTML('afterend', plannerHTML);
                console.log('‚úÖ Meal planner section added dynamically');
            }
        }, 2000);
    </script>
    
    <!-- EMERGENCY NAVIGATION SYSTEM + CRITICAL VOICE FUNCTIONS -->
    <script>
        console.log('üö® EMERGENCY Navigation System + Voice Functions Loading...');
        
        // NOTE: Second navigation function duplicate removed to prevent conflicts
        
        // Emergency voice therapy function - DISABLED to prevent duplicate connections
        window.startVoiceTherapySession = function() {
            console.log('üîÑ Redirecting to coaches section instead of starting duplicate session');
            navigateToSection('coaches');
        };
        
        // ===== HUME WIDGET INTEGRATION - SIMPLIFIED APPROACH =====
        // NOTE: Duplicate launchCoachDavidWidget definition removed - using primary definition from line 1389
        
        window.closeCoachDavidWidget = function() {
            console.log('üîÑ Closing Coach David widget...');
            
            const modal = document.getElementById('widget-modal');
            const iframe = document.getElementById('hume-evi-widget');
            const statusEl = document.getElementById('widget-status');
            
            if (modal) {
                modal.classList.add('hidden');
            }
            
            // Clear iframe to stop any ongoing session
            iframe.src = '';
            
            if (statusEl) {
                statusEl.textContent = 'Ready for voice therapy - click to start session';
            }
            
            console.log('‚úÖ Widget closed successfully');
        };
        
        // Legacy function for backwards compatibility  
        window.startVoiceConversation = function() {
            console.log('üîÑ Redirecting to new widget interface...');
            window.launchCoachDavidWidget();
        };
                if (window.humeSocket && window.humeSocket.readyState !== WebSocket.CLOSED) {
                    console.log('üîÑ [CLEAN] Closing existing WebSocket to prevent duplicates');
                    window.humeSocket.close();
                    window.humeSocket = null;
                }
                
                // Create WebSocket connection
                const CONFIG_ID = 'f4a87ae9-eafb-4133-b772-33a1b9d0eb03';
                const wsUrl = 'wss://api.hume.ai/v0/evi/chat?access_token=' + encodeURIComponent(tokenData.access_token) + '&config_id=' + CONFIG_ID;
                
                console.log('üîå [CLEAN] Creating new WebSocket connection');
                console.log('üö® WEBSOCKET CREATION - Call stack:', new Error().stack);
                window.humeSocket = new WebSocket(wsUrl);
                
                window.humeSocket.onopen = async function() {
                    console.log('‚úÖ [CLEAN] WebSocket connected!');
                    
                    // Send session config
                    window.humeSocket.send(JSON.stringify({
                        type: "session_settings",
                        audio: { encoding: "linear16", sample_rate: 48000, channels: 1 },
                        system_prompt: "You are Coach David, a compassionate therapeutic coach specializing in trauma recovery, PTSD, addiction, and mental wellness. Keep responses conversational and provide practical support."
                    }));
                    
                    // Update UI
                    statusEl.textContent = '‚úÖ Connected to Coach David';
                    substatusEl.textContent = 'Voice therapy active - speak naturally';
                    startBtn.style.display = 'none';
                    endBtn.style.display = 'block';
                    
                    // Start timer
                    const callStatus = document.getElementById('call-status');
                    if (callStatus) callStatus.classList.remove('hidden');
                    
                    let startTime = Date.now();
                    window.callTimer = setInterval(function() {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                        const seconds = (elapsed % 60).toString().padStart(2, '0');
                        const duration = document.getElementById('call-duration');
                        if (duration) duration.textContent = minutes + ':' + seconds;
                    }, 1000);
                    
                    console.log('üéâ [CLEAN] Ready for voice therapy!');
                    
                    // CRITICAL: Initialize microphone so user can actually talk!
                    try {
                        console.log('üé§ [CLEAN] Initializing microphone for user input...');
                        await window.initializeVoiceCapture();
                        console.log('‚úÖ [CLEAN] Microphone ready - user can now speak to Coach David!');
                    } catch (micError) {
                        console.error('‚ùå [CLEAN] Microphone initialization failed:', micError);
                        statusEl.textContent = '‚ùå Microphone access required';
                        substatusEl.textContent = 'Please grant microphone permission and try again';
                        return;
                    }
                    
                    // Send initial message to start conversation properly
                    setTimeout(() => {
                        const welcomeMessage = {
                            type: "user_input", // Correct format
                            text: "Hello Coach David, I'm ready to start our therapeutic session. Please introduce yourself and ask how you can help me today."
                        };
                        
                        if (window.humeSocket && window.humeSocket.readyState === WebSocket.OPEN) {
                            window.humeSocket.send(JSON.stringify(welcomeMessage));
                            console.log('üì§ [CLEAN] Sent welcome message with correct format');
                        }
                    }, 2000);
                };
                
                window.humeSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('üì® [CLEAN] Received:', data.type);
                    
                    if (data.type === 'audio_output' && data.data) {
                        console.log('üéØ [QUEUE] Audio chunk received from Hume EVI - Length:', data.data.length, 'chars');
                        
                        if (window.playAudioResponse) {
                            window.playAudioResponse(data.data);
                        } else {
                            console.error('‚ùå [QUEUE] playAudioResponse function not available');
                        }
                    } else if (data.type === 'assistant_message') {
                        console.log('ü§ñ [CLEAN] Coach David said:', data.message?.content);
                    }
                };
                
                window.humeSocket.onerror = function(error) {
                    console.error('‚ùå [CLEAN] WebSocket error:', error);
                    statusEl.textContent = '‚ùå Connection Failed';
                    startBtn.disabled = false;
                };
                
            } catch (error) {
                console.error('‚ùå [CLEAN] Connection error:', error);
                statusEl.textContent = '‚ùå Connection Failed';
                substatusEl.textContent = error.message;
                startBtn.disabled = false;
            }
        };
        
        // Legacy function for backwards compatibility
        window.endVoiceSession = function() {
            console.log('üîÑ Redirecting to widget close function...');
            window.closeCoachDavidWidget();
        };
        
        // ORPHANED CODE SUCCESSFULLY REMOVED - syntax error fixed
        console.log('üö´ Emergency functions removed - using proper PTSD implementations');
        
        // ========== CRITICAL VOICE FUNCTIONS - AVAILABLE IMMEDIATELY ==========
        
        // Initialize voice capture for Hume EVI
        window.initializeVoiceCapture = async function() {
            try {
                console.log('üé§ [EMERGENCY] Initializing voice capture...');
                
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        sampleRate: 48000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                console.log('‚úÖ [EMERGENCY] Microphone access granted');
                
                // Set up audio processing
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(e) {
                    if (window.humeSocket && window.humeSocket.readyState === WebSocket.OPEN) {
                        const inputBuffer = e.inputBuffer.getChannelData(0);
                        
                        // Convert float32 to int16 PCM for Hume EVI
                        const pcm16 = new Int16Array(inputBuffer.length);
                        for (let i = 0; i < inputBuffer.length; i++) {
                            const sample = Math.max(-1, Math.min(1, inputBuffer[i]));
                            pcm16[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                        }
                        
                        // Convert to base64 for Hume EVI transmission
                        const base64Audio = btoa(String.fromCharCode(...new Uint8Array(pcm16.buffer)));
                        
                        // Send raw audio data to EVI for speech-to-speech processing
                        const audioMessage = {
                            type: 'audio_input',
                            data: base64Audio
                        };
                        
                        window.humeSocket.send(JSON.stringify(audioMessage));
                        
                        // Log occasionally for debugging (every 100 frames)
                        if (window.audioDebugCounter === undefined) window.audioDebugCounter = 0;
                        if (++window.audioDebugCounter % 100 === 0) {
                            console.log('üé§ [EMERGENCY] Sending audio to Hume EVI...', pcm16.length, 'samples');
                        }
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                window.audioContext = audioContext;
                window.audioProcessor = processor;
                window.microphoneStream = stream;
                
                console.log('üé§ [EMERGENCY] Voice capture active');
                
            } catch (error) {
                console.error('‚ùå [EMERGENCY] Microphone access denied:', error);
                alert('Microphone access is required for voice therapy. Please grant permission and try again.');
            }
        };
        
        // ========== STREAMING AUDIO BUFFER SYSTEM ==========
        // Initialize audio streaming buffer for conversational flow
        if (!window.audioBuffer) {
            window.audioBuffer = {
                chunks: [],              // Collect audio chunks for current response
                currentAudio: null,      // Currently playing Audio object  
                responseTimeout: null,   // Timer to detect end of response
                chunkCount: 0,           // Track chunks for this response
                isBuffering: false,      // Flag when collecting chunks
                lastChunkTime: 0         // Track timing for adaptive timeout
            };
        }
        
        // Process streaming audio chunks from Coach David
        window.playAudioResponse = function(base64AudioData) {
            try {
                console.log('üéØ [SMART] Received chunk - Length:', base64AudioData?.length || 0, 'chars');
                
                if (!base64AudioData) {
                    return;
                }
                
                // SIMPLE RAPID-FIRE PROTECTION: Only block if same chunk arrives within 100ms
                const now = Date.now();
                if (!window.lastChunkTime) window.lastChunkTime = 0;
                if (!window.lastChunkSize) window.lastChunkSize = 0;
                
                const timeSinceLastChunk = now - window.lastChunkTime;
                const currentChunkSize = base64AudioData.length;
                
                // Block only RAPID-FIRE duplicates (same size within 100ms)
                if (timeSinceLastChunk < 100 && currentChunkSize === window.lastChunkSize) {
                    console.log('üö´ [SMART] Blocking rapid-fire duplicate (same size within 100ms)');
                    return;
                }
                
                // Update tracking
                window.lastChunkTime = now;
                window.lastChunkSize = currentChunkSize;
                
                console.log('‚úÖ [SMART] Playing chunk - Time gap: ' + timeSinceLastChunk + 'ms');
                
                // Convert and play IMMEDIATELY - preserves intelligibility
                const audioData = atob(base64AudioData);
                const arrayBuffer = new ArrayBuffer(audioData.length);
                const uint8Array = new Uint8Array(arrayBuffer);
                
                for (let i = 0; i < audioData.length; i++) {
                    uint8Array[i] = audioData.charCodeAt(i);
                }
                
                const blob = new Blob([uint8Array], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                audio.volume = 1.0;
                
                console.log('‚ñ∂Ô∏è [SMART] Playing chunk immediately');
                
                audio.onended = () => URL.revokeObjectURL(audioUrl);
                audio.onerror = () => URL.revokeObjectURL(audioUrl);
                
                audio.play().catch(() => {}); // Silent fail
                
            } catch (error) {
                console.error('‚ùå [SMART] Error:', error);
            }
        };
        
        // DISABLED OLD FUNCTION
        window.playAudioResponse_OLD = function(base64AudioData) {
            try {
                console.log('üéØ [STREAM] Received audio chunk - Length:', base64AudioData?.length || 0, 'chars');
                
                if (!base64AudioData) {
                    console.warn('‚ö†Ô∏è [STREAM] No audio data from Coach David');
                    return;
                }
                
                // Stop any currently playing audio (allows interruption)
                if (window.audioBuffer.currentAudio && !window.audioBuffer.currentAudio.paused) {
                    console.log('üõë [STREAM] Stopping previous audio for new response');
                    window.audioBuffer.currentAudio.pause();
                    window.audioBuffer.currentAudio = null;
                }
                
                // Start buffering new response
                if (!window.audioBuffer.isBuffering) {
                    console.log('üÜï [STREAM] Starting new Coach David response');
                    window.audioBuffer.chunks = [];
                    window.audioBuffer.chunkCount = 0;
                    window.audioBuffer.isBuffering = true;
                }
                
                // Clear any pending timeout
                if (window.audioBuffer.responseTimeout) {
                    clearTimeout(window.audioBuffer.responseTimeout);
                }
                
                // Convert and store this chunk
                const audioData = atob(base64AudioData);
                const arrayBuffer = new ArrayBuffer(audioData.length);
                const uint8Array = new Uint8Array(arrayBuffer);
                
                for (let i = 0; i < audioData.length; i++) {
                    uint8Array[i] = audioData.charCodeAt(i);
                }
                
                window.audioBuffer.chunks.push(uint8Array);
                window.audioBuffer.chunkCount++;
                
                console.log('üì¶ [STREAM] Buffered chunk #' + window.audioBuffer.chunkCount + ' (' + uint8Array.length + ' bytes)');
                
                // ADAPTIVE TIMEOUT: Adjust based on connection quality and chunk patterns
                let adaptiveTimeout = 800; // Base timeout
                
                // If this is first chunk, be more patient
                if (window.audioBuffer.chunkCount === 1) {
                    adaptiveTimeout = 1500; // Give more time for slow connections
                    console.log('üïê [STREAM] First chunk - using extended timeout (1500ms)');
                }
                // If chunks are coming slowly, extend timeout
                else if (window.audioBuffer.lastChunkTime) {
                    const gapSinceLastChunk = Date.now() - window.audioBuffer.lastChunkTime;
                    if (gapSinceLastChunk > 1000) {
                        adaptiveTimeout = 2000; // Poor connection detected
                        console.log('üêå [STREAM] Slow connection detected - using extended timeout (2000ms)');
                    }
                }
                
                // Update last chunk time
                window.audioBuffer.lastChunkTime = Date.now();
                
                // Set adaptive timeout to play buffered audio
                window.audioBuffer.responseTimeout = setTimeout(() => {
                    console.log('‚è∞ [STREAM] Timeout reached - playing ' + window.audioBuffer.chunks.length + ' buffered chunks');
                    window.playBufferedAudio();
                }, adaptiveTimeout);
                
            } catch (error) {
                console.error('‚ùå [STREAM] Error processing chunk:', error);
            }
        };
        
        // EMERGENCY: Play original WAV chunks sequentially (no concatenation)
        window.playBufferedAudio = function() {
            try {
                if (window.audioBuffer.chunks.length === 0) {
                    console.log('‚ÑπÔ∏è [STREAM] No chunks to play');
                    return;
                }
                
                console.log('üéµ [STREAM] Playing ' + window.audioBuffer.chunks.length + ' original WAV chunks sequentially');
                
                // Convert chunks to Audio URLs
                const audioUrls = [];
                window.audioBuffer.chunks.forEach((chunk, index) => {
                    const blob = new Blob([chunk], { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    audioUrls.push(url);
                    console.log('üéµ [STREAM] Prepared chunk ' + (index + 1) + ' for sequential playback');
                });
                
                let currentChunkIndex = 0;
                
                const playNextChunk = () => {
                    if (currentChunkIndex >= audioUrls.length) {
                        console.log('‚úÖ [STREAM] All chunks played - Coach David response complete');
                        window.audioBuffer.currentAudio = null;
                        return;
                    }
                    
                    const audioUrl = audioUrls[currentChunkIndex];
                    const audio = new Audio(audioUrl);
                    audio.volume = 1.0;
                    window.audioBuffer.currentAudio = audio;
                    
                    console.log('üîä [STREAM] Playing chunk ' + (currentChunkIndex + 1) + '/' + audioUrls.length);
                    
                    audio.onended = () => {
                        console.log('‚úÖ [STREAM] Chunk ' + (currentChunkIndex + 1) + ' finished');
                        URL.revokeObjectURL(audioUrl);
                        currentChunkIndex++;
                        
                        // Play next chunk with minimal delay
                        setTimeout(playNextChunk, 50);
                    };
                    
                    audio.onerror = (error) => {
                        console.error('‚ùå [STREAM] Chunk ' + (currentChunkIndex + 1) + ' error:', error);
                        URL.revokeObjectURL(audioUrl);
                        currentChunkIndex++;
                        setTimeout(playNextChunk, 50);
                    };
                    
                    // Play immediately - no processing delay
                    audio.play().then(() => {
                        console.log('‚ñ∂Ô∏è [STREAM] Chunk ' + (currentChunkIndex + 1) + ' started successfully');
                    }).catch((error) => {
                        console.error('‚ùå [STREAM] Chunk ' + (currentChunkIndex + 1) + ' play failed:', error);
                        currentChunkIndex++;
                        setTimeout(playNextChunk, 50);
                    });
                };
                
                // Start playing first chunk immediately
                playNextChunk();
                
                // Reset buffer
                window.audioBuffer.chunks = [];
                window.audioBuffer.chunkCount = 0;
                window.audioBuffer.isBuffering = false;
                
            } catch (error) {
                console.error('‚ùå [STREAM] Error in playBufferedAudio:', error);
            }
        };

        
        // Test audio playback function
        window.testAudioPlayback = function() {
            console.log('üß™ [EMERGENCY] TESTING AUDIO PLAYBACK...');
            
            // Test with a sample base64 WAV (short beep)
            const testAudioBase64 = 'UklGRiQEAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQAEAAAA9f/1//X/9f/1//X/9f/1/wAA';
            
            console.log('üîä [EMERGENCY] Testing playAudioResponse function with sample data...');
            
            if (typeof window.playAudioResponse === 'function') {
                window.playAudioResponse(testAudioBase64);
            } else {
                console.error('‚ùå [EMERGENCY] playAudioResponse function not found!');
                alert('Audio playback function not available. Check console for details.');
            }
        };
        
        console.log('‚úÖ [EMERGENCY] Critical voice functions defined and ready!');
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('‚úÖ Emergency Navigation Ready!');
            console.log('‚úÖ Emergency Voice Functions Ready!');
            console.log('‚úÖ Emergency PTSD Functions Ready!');
            
            // Verify critical functions are available
            console.log('üîç Function availability check:');
            console.log('- window.playAudioResponse:', typeof window.playAudioResponse);
            console.log('- window.initializeVoiceCapture:', typeof window.initializeVoiceCapture);
            console.log('- window.testAudioPlayback:', typeof window.testAudioPlayback);
            
            // Check for assessment return parameters
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            const assessmentStatus = urlParams.get('assessment');
            
            if (section === 'coaches' && assessmentStatus === 'completed') {
                console.log('üéØ User returning from assessment - processing results...');
                processAssessmentResults();
                navigateToSection('coaches');
            } else {
                navigateToSection('home');
            }
        });
        
        console.log('‚úÖ All emergency functions loaded');
        
        // OVERRIDE: Fix the duplicate startVoiceConversation function issue
        // This ensures only the FIXED version above is used (the one with microphone initialization)
        console.log('üîß APPLYING VOICE THERAPY FIXES...');
        
        // The fixed startVoiceConversation is already defined above with proper microphone initialization
        // Any duplicate definitions later in the file are now overridden by the fixed version
        
        // SIMPLE NAVIGATION FIX - Override any conflicting functions
        setTimeout(() => {
            console.log('üîß APPLYING NAVIGATION FIX...');
            
            // NOTE: Third navigation function duplicate removed to prevent conflicts
        }, 1000);
    </script>
    
    <!-- Hume AI Integration - Using Direct WebSocket Approach -->
    <script>
        // Skip SDK loading for now - use direct WebSocket approach that worked before
        window.HumeSDKReady = false;
        console.log('üîÑ Using direct Hume API WebSocket approach (more reliable)');
    </script>
    <style>
        /* Emergency fallback styles to ensure buttons are visible */
        .btn-primary, .btn-secondary {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background-color: #475569;
            color: #f1f5f9;
            border: 1px solid #64748b;
        }
        
        .btn-secondary:hover {
            background-color: #334155;
        }
        
        button {
            cursor: pointer;
        }
        
        /* Ensure navigation is visible */
        nav, .navbar {
            background-color: #1e293b;
            padding: 1rem;
        }
        
        /* Basic responsive grid */
        .grid {
            display: grid;
            gap: 1rem;
        }
        
        .grid-cols-1 {
            grid-template-columns: 1fr;
        }
        
        @media (min-width: 768px) {
            .md\\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            .lg\\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="">
    <!-- Health Disclaimer Modal -->
    <div id="healthDisclaimerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4" style="display: none;">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl border border-emerald-500/30 max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <!-- Header -->
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                        <i class="fas fa-heart text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-100 mb-2">Let's Start Your Wellness Journey! üåü</h2>
                    <p class="text-emerald-300 text-lg">A quick introduction to how we'll support you</p>
                </div>

                <!-- Welcoming Content -->
                <div class="space-y-6 text-slate-300">
                    <!-- Welcome Message -->
                    <div class="bg-gradient-to-r from-emerald-500/20 to-blue-500/20 border border-emerald-400/30 rounded-lg p-6 text-center">
                        <h3 class="text-2xl font-semibold text-emerald-300 mb-3 flex items-center justify-center">
                            <i class="fas fa-sparkles mr-2"></i>Welcome to Your Health Journey!
                        </h3>
                        <p class="text-lg leading-relaxed text-slate-200">
                            We're excited to be your <strong>health advocates</strong> and support team. This quick assessment 
                            will help us understand how we can best support your wellness goals.
                        </p>
                    </div>

                    <!-- What We Provide -->
                    <div class="bg-blue-900/20 border border-blue-400/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-blue-300 mb-3 flex items-center">
                            <i class="fas fa-hands-helping mr-2"></i>How We Support You
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <i class="fas fa-robot text-emerald-400 mr-3"></i>
                                <span class="text-slate-200">AI-powered wellness coaching and personalized insights</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-heart text-pink-400 mr-3"></i>
                                <span class="text-slate-200">Evidence-based recommendations for optimal health</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-blue-400 mr-3"></i>
                                <span class="text-slate-200">Connection with specialized wellness coaches</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-shield-alt text-green-400 mr-3"></i>
                                <span class="text-slate-200">Your privacy and data security are our top priority</span>
                            </div>
                        </div>
                    </div>

                    <!-- Important Partnership Note -->
                    <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-purple-300 mb-3 flex items-center">
                            <i class="fas fa-handshake mr-2"></i>Working Together with Your Healthcare Team
                        </h3>
                        <p class="leading-relaxed text-slate-200 mb-3">
                            We work <strong>alongside your existing healthcare providers</strong> - not as a replacement. 
                            Think of us as your wellness advocates who help you get the most out of your health journey.
                        </p>
                        <p class="text-sm text-purple-200">
                            For medical concerns, diagnosis, or treatment decisions, we always recommend consulting with qualified healthcare professionals.
                        </p>
                    </div>

                    <!-- Safety & Support -->
                    <div class="bg-gradient-to-r from-teal-500/20 to-cyan-500/20 border border-teal-400/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-teal-300 mb-3 flex items-center">
                            <i class="fas fa-umbrella mr-2"></i>We've Got Your Back
                        </h3>
                        <p class="leading-relaxed text-slate-200 mb-3">
                            Your safety and wellbeing are our priority. If you ever need immediate support, 
                            here are helpful resources:
                        </p>
                        <div class="bg-teal-800/30 rounded-lg p-4 space-y-2">
                            <p class="text-teal-200 flex items-center">
                                <i class="fas fa-phone mr-2"></i>
                                <strong>Crisis Support:</strong> Call 988 (Free, confidential, 24/7)
                            </p>
                            <p class="text-teal-200 flex items-center">
                                <i class="fas fa-comment mr-2"></i>
                                <strong>Text Support:</strong> Text HOME to 741741
                            </p>
                            <p class="text-teal-200 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>Emergency:</strong> Call 911 for immediate medical help
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Simple Agreement -->
                <div class="mt-8 space-y-4">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="consent-understand" class="mt-1 w-5 h-5 text-emerald-600 border-slate-400 rounded focus:ring-emerald-500">
                        <label for="consent-understand" class="text-slate-300 leading-relaxed cursor-pointer">
                            ‚ú® I understand that Root Cause Power is a wellness advocacy platform that works alongside my healthcare team to support my health journey.
                        </label>
                    </div>
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="consent-medical" class="mt-1 w-5 h-5 text-emerald-600 border-slate-400 rounded focus:ring-emerald-500">
                        <label for="consent-medical" class="text-slate-300 leading-relaxed cursor-pointer">
                            ü©∫ I understand the importance of working with qualified healthcare professionals for medical concerns.
                        </label>
                    </div>
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="consent-privacy" class="mt-1 w-5 h-5 text-emerald-600 border-slate-400 rounded focus:ring-emerald-500">
                        <label for="consent-privacy" class="text-slate-300 leading-relaxed cursor-pointer">
                            üîí I'm comfortable with the privacy practices and data protection described above.
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="acceptDisclaimerBtn" onclick="acceptHealthDisclaimer()" 
                            class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105" 
                            disabled>
                        <i class="fas fa-rocket mr-2"></i>Let's Begin My Health Assessment! üöÄ
                    </button>
                    <button onclick="declineHealthDisclaimer()" 
                            class="bg-slate-600 hover:bg-slate-700 px-8 py-4 rounded-xl text-white font-medium text-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>Maybe Later
                    </button>
                </div>

                <!-- Friendly Footer -->
                <div class="mt-6 pt-6 border-t border-slate-600">
                    <p class="text-xs text-slate-400 text-center leading-relaxed">
                        üåü Ready to start your personalized wellness journey? We're here to support you every step of the way! 
                        <br>Last updated: September 2024 ‚Ä¢ Made with ‚ù§Ô∏è for your wellbeing
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Header -->
    <nav class="bg-slate-900/95 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        üöÄ Root Cause Power
                    </h1>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-2">
                    <button onclick="navigateToSection('home')" id="nav-home" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>Home
                    </button>
                    <button onclick="navigateToSection('assessment')" id="nav-assessment" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-clipboard-check mr-2"></i>Assessment
                    </button>
                    <button onclick="navigateToSection('coaches')" id="nav-coaches" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-users mr-2"></i>AI Coaches
                    </button>
                    <button onclick="navigateToSection('dashboard')" id="nav-dashboard" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button onclick="navigateToSection('ptsd-corner')" id="nav-ptsd-corner" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-heart mr-2"></i>PTSD Corner
                    </button>
                    <button onclick="navigateToSection('diary')" id="nav-diary" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-journal-whills mr-2"></i>Journal
                    </button>
                    <button onclick="navigateToSection('booking')" id="nav-booking" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-calendar-alt mr-2"></i>Book Session
                    </button>
                    <button onclick="navigateToSection('knowledge-library')" id="nav-knowledge-library" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-book-open mr-2"></i>Knowledge Library
                    </button>
                    <button onclick="navigateToSection('pricing')" id="nav-pricing" class="nav-button px-4 py-2 rounded-lg font-medium transition-all duration-300">
                        <i class="fas fa-credit-card mr-2"></i>Pricing
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="p-2 rounded-lg hover:bg-slate-800 text-slate-300">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-slate-800 border-t border-slate-700">
            <div class="px-4 py-3 space-y-2">
                <button onclick="navigateToSection('home')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-home mr-3 text-blue-400"></i>Home
                </button>
                <button onclick="navigateToSection('assessment')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-clipboard-check mr-3 text-blue-400"></i>Assessment
                </button>
                <button onclick="navigateToSection('coaches')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-users mr-3 text-blue-400"></i>AI Coaches
                </button>
                <button onclick="navigateToSection('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-chart-line mr-3 text-blue-400"></i>Personal Dashboard
                </button>
                <button onclick="navigateToSection('ptsd-corner')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-heart mr-3 text-blue-400"></i>PTSD Corner
                </button>
                <button onclick="navigateToSection('diary')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-journal-whills mr-3 text-blue-400"></i>Journal
                </button>
                <button onclick="navigateToSection('booking')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-calendar-alt mr-3 text-blue-400"></i>Book Session
                </button>
                <button onclick="navigateToSection('knowledge-library')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-book-open mr-3 text-blue-400"></i>Knowledge Library
                </button>
                <button onclick="navigateToSection('pricing')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-700 transition-all text-slate-300 hover:text-white">
                    <i class="fas fa-credit-card mr-3 text-blue-400"></i>Pricing & Credits
                </button>
            </div>
        </div>
    </nav>

    <!-- HOME SECTION -->
    <section id="home" class="section active">
        <div class="hero-gradient min-h-screen flex items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="relative z-10 text-center text-white px-4">
                <div class="mb-8">
                    <div class="ai-glow rounded-full p-6 bg-white/20 backdrop-blur-sm inline-block mb-6">
                        <i class="fas fa-brain text-6xl"></i>
                    </div>
                </div>
                <h1 class="text-5xl md:text-7xl font-bold mb-6 leading-tight">
                    Root Cause Power
                </h1>
                

                <p class="text-xl md:text-2xl mb-4 opacity-90">
                    Revolutionary AI Healthcare Platform
                </p>
                <p class="text-lg mb-8 opacity-80 max-w-3xl mx-auto leading-relaxed">
                    Access evidence-based wellness resources, comprehensive assessments, and expert AI guidance 
                    to transform your health journey with scientifically-proven approaches.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <button onclick="navigateToSection('assessment')" class="btn-primary ai-glow px-8 py-4 rounded-full font-bold text-lg transform hover:scale-105">
                        Start Health Assessment
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button onclick="navigateToSection('knowledge-library')" class="px-8 py-4 border-2 border-slate-300 text-white rounded-full font-bold text-lg hover:bg-slate-200 hover:text-slate-900 transition-all duration-300 transform hover:scale-105">
                        Explore Knowledge Base
                        <i class="fas fa-book-open ml-2"></i>
                    </button>
                </div>
                

            </div>
        </div>
    </section>

    <!-- ASSESSMENT SECTION -->
    <section id="assessment" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-blue-500 to-purple-500 inline-block mb-6">
                        <i class="fas fa-clipboard-check text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">Comprehensive Health Assessment</h1>
                    <p class="text-xl text-slate-300 leading-relaxed">
                        Evidence-based assessment covering energy, sleep, nutrition, stress, and mental wellness
                    </p>
                </div>

                <!-- Progress Indicator -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-slate-400">Progress</span>
                        <div class="flex items-center space-x-4">
                            <span id="progress-text" class="text-sm text-slate-400">Question 1 of 8</span>
                            <button onclick="exitAssessment()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                <i class="fas fa-times mr-1"></i>Exit Assessment
                            </button>
                        </div>
                    </div>
                    <div class="w-full bg-slate-600 rounded-full h-2">
                        <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-500" style="width: 12.5%"></div>
                    </div>
                </div>
                
                <!-- Assessment Questions Container -->
                <div id="assessment-container" class="bg-slate-700/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-600">
                    <!-- Assessment will start automatically when section is navigated to -->
                </div>

                <!-- Assessment Results -->
                <div id="assessment-results" class="hidden bg-slate-700/50 backdrop-blur-sm rounded-2xl p-8 border border-slate-600 mt-8">
                    <div class="text-center">
                        <div class="ai-glow rounded-full p-6 bg-gradient-to-br from-green-500 to-emerald-500 inline-block mb-6">
                            <i class="fas fa-chart-line text-white text-3xl"></i>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-100 mb-4">Your Health Assessment Results</h3>
                        <div id="results-content" class="mb-8">
                            <!-- Results will be populated here -->
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onclick="startPersonalizedCoaching()" class="btn-primary px-8 py-4 text-lg">
                                <i class="fas fa-user-md mr-2"></i>Get Personalized Coaching
                            </button>
                            <button onclick="restartAssessment()" class="btn-secondary px-8 py-4 text-lg">
                                <i class="fas fa-redo mr-2"></i>Retake Assessment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI COACHES SECTION -->
    <section id="coaches" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header -->
                <div class="text-center mb-16">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-blue-500 to-purple-500 inline-block mb-6">
                        <i class="fas fa-users text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">AI Health Coaches</h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                        Professional therapeutic coaching with Hume EVI voice technology and evidence-based approaches
                    </p>
                </div>

                <!-- Coach Selection Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                    <!-- Coach Sarah - CBT Specialist -->
                    <div class="knowledge-card p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="startChatWithCoach('sarah')">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-brain text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">Coach Sarah</h3>
                                <p class="text-blue-400 text-sm">CBT & Anxiety Specialist</p>
                            </div>
                        </div>
                        <p class="text-slate-300 text-sm mb-4">
                            Expert in cognitive behavioral therapy, anxiety management, and stress reduction techniques. Specializes in thought pattern analysis and behavioral change.
                        </p>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-medium">üí¨ Text Chat</span>
                            <button onclick="startChatWithCoach('sarah')" class="btn-primary px-4 py-2 text-sm">Start Session</button>
                        </div>
                    </div>

                    <!-- Coach Marcus - Nutrition Expert -->
                    <div class="knowledge-card p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="startChatWithCoach('marcus')">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-apple-alt text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">Coach Marcus</h3>
                                <p class="text-green-400 text-sm">Nutrition & Lifestyle Coach</p>
                            </div>
                        </div>
                        <p class="text-slate-300 text-sm mb-4">
                            Nutritional science expert focused on metabolic optimization, weight management, and sustainable lifestyle changes for long-term health.
                        </p>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-medium">üí¨ Text Chat</span>
                            <button onclick="startChatWithCoach('marcus')" class="btn-primary px-4 py-2 text-sm">Start Session</button>
                        </div>
                    </div>

                    <!-- Coach Elena - EMDR & Trauma -->
                    <div class="knowledge-card p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="startChatWithCoach('elena')">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-heart text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">Coach Elena</h3>
                                <p class="text-purple-400 text-sm">EMDR & Trauma Specialist</p>
                            </div>
                        </div>
                        <p class="text-slate-300 text-sm mb-4">
                            Specialized in EMDR therapy, trauma processing, and emotional regulation. Provides gentle, empathetic support for healing journeys.
                        </p>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-medium">üí¨ Text Chat</span>
                            <button onclick="startChatWithCoach('elena')" class="btn-primary px-4 py-2 text-sm">Start Session</button>
                        </div>
                    </div>

                    <!-- Coach David removed from grid - using dedicated voice therapy interface below -->

                    <!-- Coach Alex - Sleep & Recovery -->
                    <div class="knowledge-card p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="startChatWithCoach('alex')">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-moon text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">Coach Alex</h3>
                                <p class="text-indigo-400 text-sm">Sleep & Recovery Expert</p>
                            </div>
                        </div>
                        <p class="text-slate-300 text-sm mb-4">
                            Sleep optimization specialist focused on circadian rhythm regulation, sleep hygiene, and recovery protocols for optimal wellness.
                        </p>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-medium">üí¨ Text Chat</span>
                            <button onclick="startChatWithCoach('alex')" class="btn-primary px-4 py-2 text-sm">Start Session</button>
                        </div>
                    </div>

                    <!-- Coach Maria - Fitness & Movement -->
                    <div class="knowledge-card p-6 hover:shadow-2xl transition-all cursor-pointer" onclick="startChatWithCoach('maria')">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-dumbbell text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">Coach Maria</h3>
                                <p class="text-red-400 text-sm">Fitness & Movement Coach</p>
                            </div>
                        </div>
                        <p class="text-slate-300 text-sm mb-4">
                            Exercise physiology expert specializing in strength training, mobility work, and sustainable fitness routines tailored to your lifestyle.
                        </p>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 text-sm font-medium">üí¨ Text Chat</span>
                            <button onclick="startChatWithCoach('maria')" class="btn-primary px-4 py-2 text-sm">Start Session</button>
                        </div>
                    </div>
                </div>

                <!-- Voice Session Status (Phone-Style Interface) -->
                <div id="voice-session-container" class="knowledge-card p-8 mb-12 max-w-md mx-auto text-center">
                    <div class="bg-gradient-to-b from-slate-800 to-slate-900 rounded-2xl p-8 border border-slate-600">
                        <!-- Coach Info -->
                        <div class="mb-6">
                            <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user-md text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-100">Coach David</h3>
                            <p class="text-emerald-400 text-sm">Voice Therapy & Hypnotherapy</p>
                        </div>
                        
                        <!-- Connection Status -->
                        <div id="conversation-status" class="text-lg font-medium text-slate-300 mb-2">
                            Ready to start your therapeutic session
                        </div>
                        <div id="conversation-substatus" class="text-sm text-slate-400 mb-6">
                            Using Hume's optimized web widget for better reliability and performance
                        </div>
                        
                        <!-- Hume Widget Integration -->
                        <div class="space-y-4">
                            <!-- Voice Control Buttons -->
                            <div class="flex justify-center space-x-4">
                                <!-- Start Button -->
                                <button onclick="launchCoachDavidWidget()" id="start-conversation-btn" class="w-20 h-20 bg-emerald-500 hover:bg-emerald-400 rounded-full flex items-center justify-center text-white text-2xl transition-all shadow-lg hover:shadow-xl">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                
                                <!-- End Session Button -->
                                <button onclick="endCoachDavidSession()" id="end-conversation-btn" class="w-20 h-20 bg-red-500 hover:bg-red-400 rounded-full flex items-center justify-center text-white text-2xl transition-all shadow-lg hover:shadow-xl hidden">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                            </div>
                            
                            <!-- Session Summary Button -->
                            <button onclick="showSessionSummary()" id="summary-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg transition-all hidden">
                                <i class="fas fa-list-ul mr-2"></i>View Session Summary
                            </button>
                            
                            <!-- Simple Privacy Note -->
                            <div class="text-center mb-3">
                                <p class="text-xs text-slate-500">
                                    üîí Techniques captured for reference - conversation remains private
                                </p>
                            </div>
                            
                            <!-- Widget Status -->
                            <div id="widget-status" class="text-sm text-slate-400 text-center">
                                Ready for voice therapy - click to start session
                            </div>
                            
                            <!-- Widget Container (Modal Style) -->
                            <div id="widget-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
                                <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-hidden">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-xl font-bold text-white">Coach David - Voice Therapy</h3>
                                        <button onclick="closeCoachDavidWidget()" class="text-slate-400 hover:text-white">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Hume Widget Iframe -->
                                    <div class="bg-slate-700 rounded-lg overflow-hidden" style="height: 400px;">
                                        <iframe 
                                            id="hume-evi-widget"
                                            src=""
                                            width="100%" 
                                            height="400px"
                                            frameborder="0"
                                            allow="microphone"
                                            class="w-full h-full">
                                        </iframe>
                                    </div>
                                    
                                    <div class="mt-4 text-center">
                                        <p class="text-sm text-slate-300">
                                            üéØ <strong>Simplified Integration:</strong> Using Hume's optimized web widget for better reliability
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface (Hidden by default) -->
                <div id="chat-interface" class="knowledge-card p-6 mb-12 max-w-4xl mx-auto hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div id="coach-avatar" class="w-12 h-12 rounded-full flex items-center justify-center mr-4">
                                <!-- Avatar will be set by JavaScript -->
                            </div>
                            <div>
                                <h3 id="coach-name" class="text-xl font-bold text-slate-100">Coach</h3>
                                <p id="coach-specialty" class="text-sm text-slate-400">Specialist</p>
                            </div>
                        </div>
                        <button onclick="closeChatInterface()" class="text-slate-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- Assessment Prescription (if coming from assessment) -->
                    <div id="assessment-prescription" class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 p-4 rounded-lg mb-6 border border-blue-500/30 hidden">
                        <h4 class="text-lg font-bold text-blue-300 mb-2">üìã Your Personal Health Prescription</h4>
                        <div id="prescription-content" class="text-slate-300 text-sm">
                            <!-- Prescription content will be populated here -->
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-messages" class="bg-slate-700 rounded-lg p-4 mb-4 max-h-96 overflow-y-auto">
                        <div class="text-slate-400 text-sm text-center py-8">
                            Start the conversation by typing a message below...
                        </div>
                    </div>

                    <!-- Chat Input - Mobile Style -->
                    <div class="p-4 border-t border-slate-600">
                        <div class="flex gap-2 items-end">
                            <input type="text" id="chat-input" placeholder="Message..." 
                                   class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeypress="window.handleChatKeyPress(event)">
                            <button onclick="window.sendChatMessage()" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-full text-white font-medium text-sm min-w-[60px]">
                                Send
                            </button>
                        </div>
                    </div>

                    <!-- Credit Usage -->
                    <div class="text-center mt-4">
                        <p class="text-slate-400 text-sm">Credits remaining: <span id="credits-remaining" class="text-green-400 font-bold">Unlimited</span></p>
                    </div>
                </div>

                <!-- Widget Integration Info -->
                <div class="knowledge-card p-6 mb-8">
                    <h3 class="text-xl font-bold text-slate-100 mb-4">üöÄ Enhanced Integration with Hume Widget</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-lg p-4">
                            <h4 class="text-emerald-300 font-semibold mb-3">‚úÖ Improvements with Widget</h4>
                            <ul class="text-slate-300 text-sm space-y-2">
                                <li>‚Ä¢ <strong>Simplified Architecture:</strong> No complex WebSocket management</li>
                                <li>‚Ä¢ <strong>Better Reliability:</strong> Hume handles all connection issues</li>
                                <li>‚Ä¢ <strong>Automatic Updates:</strong> Always uses latest Hume improvements</li>
                                <li>‚Ä¢ <strong>Optimized Audio:</strong> Built-in audio processing and streaming</li>
                                <li>‚Ä¢ <strong>Error Recovery:</strong> Automatic reconnection and error handling</li>
                            </ul>
                        </div>
                        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
                            <h4 class="text-blue-300 font-semibold mb-3">‚öôÔ∏è Configuration Required</h4>
                            <ul class="text-slate-300 text-sm space-y-2">
                                <li>‚Ä¢ Get Hume configuration ID from dashboard</li>
                                <li>‚Ä¢ Set Coach David therapeutic personality</li>
                                <li>‚Ä¢ Configure voice settings and responses</li>
                                <li>‚Ä¢ Update widget URL in integration code</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <div class="bg-slate-600/30 p-4 rounded-lg border border-slate-500">
                        <i class="fas fa-brain text-blue-400 text-2xl mb-2"></i>
                        <h4 class="font-bold text-slate-100">CBT Coaching</h4>
                            <p class="text-sm text-slate-300">Cognitive restructuring and thought records</p>
                        </div>
                        <div class="bg-slate-600/30 p-4 rounded-lg border border-slate-500">
                            <i class="fas fa-eye text-purple-400 text-2xl mb-2"></i>
                            <h4 class="font-bold text-slate-100">EMDR Processing</h4>
                            <p class="text-sm text-slate-300">Trauma recovery techniques</p>
                        </div>
                        <div class="bg-slate-600/30 p-4 rounded-lg border border-slate-500">
                            <i class="fas fa-moon text-indigo-400 text-2xl mb-2"></i>
                            <h4 class="font-bold text-slate-100">Hypnotherapy</h4>
                            <p class="text-sm text-slate-300">Relaxation and positive suggestions</p>
                        </div>
                        <div class="bg-slate-600/30 p-4 rounded-lg border border-slate-500">
                            <i class="fas fa-leaf text-green-400 text-2xl mb-2"></i>
                            <h4 class="font-bold text-slate-100">Nutrition</h4>
                            <p class="text-sm text-slate-300">Evidence-based dietary guidance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- PTSD CORNER SECTION -->
    <section id="ptsd-corner" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header -->
                <div class="text-center mb-16">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-emerald-500 to-teal-500 inline-block mb-6">
                        <i class="fas fa-heart text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">üíô PTSD Corner</h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                        A safe space with evidence-based tools for trauma recovery and healing
                    </p>
                </div>

                <!-- Crisis Support Banner -->
                <div class="bg-red-900/30 border-l-4 border-red-400 p-6 rounded-lg mb-12">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mr-4 flex-shrink-0 mt-1"></i>
                        <div>
                            <h3 class="text-xl font-bold text-red-300 mb-2">Crisis Support</h3>
                            <p class="text-red-200 mb-4">If you're experiencing a mental health crisis or having thoughts of self-harm, please reach out for immediate help:</p>
                            <div class="space-y-2 text-sm">
                                <p class="text-red-200"><strong>US Crisis Lifeline:</strong> 988</p>
                                <p class="text-red-200"><strong>UK Samaritans:</strong> 116 123</p>
                                <p class="text-red-200"><strong>International:</strong> befrienders.org</p>
                                <p class="text-red-200"><strong>Emergency:</strong> Call your local emergency services</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grounding Tools Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
                    <!-- 5-4-3-2-1 Technique -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-blue-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-eye text-blue-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">5-4-3-2-1 Technique</h3>
                            <p class="text-slate-400 text-sm mb-4">Ground yourself by engaging all five senses</p>
                        </div>
                        <button onclick="start54321Technique()" class="btn-primary w-full">
                            <i class="fas fa-play mr-2"></i>Start Grounding
                        </button>
                    </div>

                    <!-- Box Breathing -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-green-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-lungs text-green-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Box Breathing</h3>
                            <p class="text-slate-400 text-sm mb-4">Regulate your nervous system with controlled breathing</p>
                        </div>
                        <button onclick="startBoxBreathing()" class="btn-secondary w-full">
                            <i class="fas fa-wind mr-2"></i>Start Breathing
                        </button>
                    </div>

                    <!-- Physical Grounding -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-purple-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-hand-paper text-purple-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Physical Grounding</h3>
                            <p class="text-slate-400 text-sm mb-4">Connect with your body and present moment</p>
                        </div>
                        <button onclick="startPhysicalGrounding()" class="btn-accent w-full">
                            <i class="fas fa-hands mr-2"></i>Start Grounding
                        </button>
                    </div>

                    <!-- EMDR Tools -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-orange-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-orange-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-eye text-orange-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">EMDR Tools</h3>
                            <p class="text-slate-400 text-sm mb-4">Eye Movement Desensitization therapy tools</p>
                        </div>
                        <button onclick="showEMDRTools()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-arrows-alt-h mr-2"></i>Start EMDR
                        </button>
                    </div>

                    <!-- Progressive Muscle Relaxation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-indigo-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-dumbbell text-indigo-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Progressive Muscle Relaxation</h3>
                            <p class="text-slate-400 text-sm mb-4">Release tension through systematic muscle relaxation</p>
                        </div>
                        <button onclick="startProgressiveMuscleRelaxation()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-spa mr-2"></i>Start PMR
                        </button>
                    </div>

                    <!-- Mindfulness Meditation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-teal-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-teal-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-lotus-position text-teal-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Mindfulness Meditation</h3>
                            <p class="text-slate-400 text-sm mb-4">Present moment awareness and acceptance</p>
                        </div>
                        <button onclick="startMindfulnessMeditation()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-leaf mr-2"></i>Start Meditation
                        </button>
                    </div>

                    <!-- Safe Place Visualization -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-cyan-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-home text-cyan-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Safe Place Visualization</h3>
                            <p class="text-slate-400 text-sm mb-4">Create a mental sanctuary for emotional safety</p>
                        </div>
                        <button onclick="startSafePlaceVisualization()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-mountain mr-2"></i>Visualize Safety
                        </button>
                    </div>

                    <!-- Cognitive Restructuring -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-yellow-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-lightbulb text-yellow-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Cognitive Restructuring</h3>
                            <p class="text-slate-400 text-sm mb-4">Challenge and reframe negative thought patterns</p>
                        </div>
                        <button onclick="startCognitiveRestructuring()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-brain mr-2"></i>Reframe Thoughts
                        </button>
                    </div>

                    <!-- Bilateral Stimulation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-pink-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-pink-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-exchange-alt text-pink-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Bilateral Stimulation</h3>
                            <p class="text-slate-400 text-sm mb-4">Audio-visual bilateral brain stimulation</p>
                        </div>
                        <button onclick="startBilateralStimulation()" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-headphones mr-2"></i>Start BLS
                        </button>
                    </div>

                    <!-- Resource Installation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-emerald-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-gem text-emerald-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Resource Installation</h3>
                            <p class="text-slate-400 text-sm mb-4">Strengthen positive internal resources</p>
                        </div>
                        <button onclick="startResourceInstallation()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-star mr-2"></i>Install Resources
                        </button>
                    </div>

                    <!-- Containment Exercise -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-red-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-box text-red-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Containment Exercise</h3>
                            <p class="text-slate-400 text-sm mb-4">Safely contain difficult memories and emotions</p>
                        </div>
                        <button onclick="startContainmentExercise()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-lock mr-2"></i>Contain Trauma
                        </button>
                    </div>

                    <!-- Body Scan Relaxation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-violet-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-violet-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user-check text-violet-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Body Scan Relaxation</h3>
                            <p class="text-slate-400 text-sm mb-4">Systematic body awareness and tension release</p>
                        </div>
                        <button onclick="startBodyScanRelaxation()" class="bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-search mr-2"></i>Scan Body
                        </button>
                    </div>

                    <!-- Emotional Freedom Technique (EFT/Tapping) -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-amber-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-hand-point-up text-amber-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">EFT Tapping</h3>
                            <p class="text-slate-400 text-sm mb-4">Emotional Freedom Technique for trauma release</p>
                        </div>
                        <button onclick="startEFTTapping()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-hand-paper mr-2"></i>Start Tapping
                        </button>
                    </div>

                    <!-- Loving-Kindness Meditation -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-rose-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-rose-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-heart text-rose-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Loving-Kindness Meditation</h3>
                            <p class="text-slate-400 text-sm mb-4">Cultivate compassion and self-acceptance</p>
                        </div>
                        <button onclick="startLovingKindnessMeditation()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-dove mr-2"></i>Practice Compassion
                        </button>
                    </div>

                    <!-- Trauma-Informed Yoga -->
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-lime-400/50 transition-all duration-300">
                        <div class="text-center mb-4">
                            <div class="w-16 h-16 bg-lime-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-child text-lime-400 text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Trauma-Informed Yoga</h3>
                            <p class="text-slate-400 text-sm mb-4">Gentle yoga poses for trauma recovery</p>
                        </div>
                        <button onclick="startTraumaInformedYoga()" class="bg-lime-600 hover:bg-lime-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                            <i class="fas fa-praying-hands mr-2"></i>Start Yoga
                        </button>
                    </div>
                </div>

                <!-- Grounding Session Interface -->
                <div id="grounding-session" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-8">
                            <div class="text-center mb-8">
                                <h3 id="grounding-title" class="text-3xl font-bold text-slate-100 mb-2">Grounding Session</h3>
                                <p id="grounding-subtitle" class="text-blue-300">Follow the guidance below</p>
                            </div>
                            
                            <div id="grounding-content" class="text-center mb-8 text-lg">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <div class="flex justify-center space-x-4">
                                <button onclick="stopGroundingSession()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">
                                    <i class="fas fa-stop mr-2"></i>End Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EMDR Session Interface -->
                <div id="emdr-session" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-slate-800 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-8">
                            <h3 class="text-2xl font-bold text-center mb-8 text-slate-100">EMDR Session</h3>
                            
                            <!-- EMDR Animation Area -->
                            <div class="bg-slate-700 rounded-lg relative h-64 mb-6 overflow-hidden">
                                <div id="emdr-dot" class="w-6 h-6 bg-blue-400 rounded-full absolute top-1/2 transform -translate-y-1/2 transition-all duration-1000"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-slate-400 text-sm text-center">
                                        <i class="fas fa-eye text-2xl mb-2 block"></i>
                                        Follow the moving dot with your eyes<br>
                                        <span class="text-xs">Keep your head still, only move your eyes</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-center space-x-4">
                                <button onclick="stopEMDR()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">
                                    <i class="fas fa-stop mr-2"></i>End Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Educational Resources -->
                <div class="bg-slate-700/30 rounded-xl p-8 mb-12">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6 text-center">
                        <i class="fas fa-book-open mr-3 text-blue-400"></i>Understanding PTSD
                    </h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-200 mb-4">What is PTSD?</h3>
                            <p class="text-slate-400 leading-relaxed mb-4">
                                Post-Traumatic Stress Disorder (PTSD) is a mental health condition triggered by experiencing or witnessing a traumatic event. 
                                It's a normal response to abnormal circumstances.
                            </p>
                            <div class="space-y-2 text-sm text-slate-400">
                                <p>‚Ä¢ <strong>Intrusive memories:</strong> Flashbacks, nightmares</p>
                                <p>‚Ä¢ <strong>Avoidance:</strong> Staying away from reminders</p>
                                <p>‚Ä¢ <strong>Hypervigilance:</strong> Being constantly on guard</p>
                                <p>‚Ä¢ <strong>Negative changes:</strong> In thinking and mood</p>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-200 mb-4">Recovery is Possible</h3>
                            <p class="text-slate-400 leading-relaxed mb-4">
                                PTSD is treatable. With proper support, therapy, and tools like those provided here, 
                                many people recover completely and go on to live fulfilling lives.
                            </p>
                            <div class="space-y-2 text-sm text-slate-400">
                                <p>‚Ä¢ <strong>Evidence-based therapy:</strong> EMDR, CBT, CPT</p>
                                <p>‚Ä¢ <strong>Grounding techniques:</strong> Managing symptoms</p>
                                <p>‚Ä¢ <strong>Support systems:</strong> Family, friends, groups</p>
                                <p>‚Ä¢ <strong>Self-care:</strong> Regular exercise, healthy habits</p>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Professional Support -->
                <div class="bg-gradient-to-r from-emerald-600/20 to-teal-600/20 rounded-xl p-8 text-center">
                    <div class="max-w-3xl mx-auto">
                        <i class="fas fa-user-md text-4xl text-emerald-400 mb-4"></i>
                        <h2 class="text-2xl font-bold text-slate-100 mb-4">Need Professional Support?</h2>
                        <p class="text-slate-300 mb-6">
                            While these tools can be helpful for managing symptoms, they're not a replacement for professional treatment. 
                            Consider speaking with our AI coach Elena, who specializes in trauma recovery.
                        </p>
                        <button onclick="startChatWithCoach('elena')" class="btn-primary">
                            <i class="fas fa-heart mr-2"></i>Talk to Coach Elena
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- KNOWLEDGE LIBRARY SECTION -->
    <section id="knowledge-library" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-16">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-green-500 to-emerald-500 inline-block mb-6">
                        <i class="fas fa-book-open text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">üìö Knowledge Library</h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                        Evidence-based research, clinical studies, and expert insights for your health journey
                    </p>
                </div>

                <!-- Search Bar -->
                <div class="max-w-2xl mx-auto mb-12">
                    <div class="relative">
                        <input type="text" id="knowledge-search" placeholder="Search research topics, studies, or health conditions..." 
                               class="w-full px-6 py-4 bg-slate-700/50 border border-slate-600 rounded-full text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button onclick="performSearch()" class="absolute right-2 top-1/2 transform -translate-y-1/2 btn-primary px-6 py-2 rounded-full">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Research Categories Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-green-500 to-emerald-500 inline-block mb-6">
                            <i class="fas fa-leaf text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Nutrition & Metabolism</h3>
                        <p class="text-slate-300 mb-6">
                            Evidence-based nutritional research, metabolic health studies, and dietary interventions
                        </p>
                        <button onclick="exploreCategory('nutrition')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full font-bold hover:from-green-600 hover:to-emerald-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>

                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-blue-500 to-indigo-500 inline-block mb-6">
                            <i class="fas fa-brain text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Mental Health Research</h3>
                        <p class="text-slate-300 mb-6">
                            CBT, EMDR, therapeutic interventions, and evidence-based mental health treatments
                        </p>
                        <button onclick="exploreCategory('mental-health')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-full font-bold hover:from-blue-600 hover:to-indigo-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>

                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-purple-500 to-pink-500 inline-block mb-6">
                            <i class="fas fa-moon text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Sleep & Recovery</h3>
                        <p class="text-slate-300 mb-6">
                            Sleep optimization research, circadian health, and recovery protocols
                        </p>
                        <button onclick="exploreCategory('sleep')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-bold hover:from-purple-600 hover:to-pink-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>

                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-orange-500 to-red-500 inline-block mb-6">
                            <i class="fas fa-dumbbell text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Exercise & Movement</h3>
                        <p class="text-slate-300 mb-6">
                            Exercise physiology, movement therapy, and physical activity research
                        </p>
                        <button onclick="exploreCategory('exercise')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full font-bold hover:from-orange-600 hover:to-red-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>

                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-red-500 to-pink-500 inline-block mb-6">
                            <i class="fas fa-heart-pulse text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Stress Management</h3>
                        <p class="text-slate-300 mb-6">
                            Stress physiology, mindfulness research, and evidence-based stress reduction
                        </p>
                        <button onclick="exploreCategory('stress')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-full font-bold hover:from-red-600 hover:to-pink-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>

                    <div class="knowledge-card p-8 rounded-2xl text-center">
                        <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-teal-500 to-cyan-500 inline-block mb-6">
                            <i class="fas fa-seedling text-white text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">Integrative Medicine</h3>
                        <p class="text-slate-300 mb-6">
                            Holistic approaches, complementary therapies, and integrative health research
                        </p>
                        <button onclick="exploreCategory('integrative')" class="w-full ai-glow px-6 py-3 bg-gradient-to-r from-teal-500 to-cyan-500 text-white rounded-full font-bold hover:from-teal-600 hover:to-cyan-600 transition-all duration-300">
                            Explore Research
                        </button>
                    </div>
                </div>

                <!-- Search Results Section -->
                <div id="search-results" class="hidden">
                    <div class="max-w-4xl mx-auto">
                        <h3 class="text-2xl font-bold text-slate-100 mb-6">Search Results</h3>
                        <div id="results-content" class="space-y-4">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- DIARY/JOURNAL SECTION -->
    <section id="diary" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header -->
                <div class="text-center mb-16">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-purple-500 to-pink-500 inline-block mb-6">
                        <i class="fas fa-journal-whills text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">üìñ Reflective Journal</h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                        Track your thoughts, emotions, and healing journey through reflective journaling
                    </p>
                </div>

                <!-- Journal Actions -->
                <div class="flex flex-wrap justify-center gap-4 mb-12">
                    <button onclick="showNewEntryForm()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>New Entry
                    </button>
                    <button onclick="showJournalPrompts()" class="btn-secondary">
                        <i class="fas fa-lightbulb mr-2"></i>Writing Prompts
                    </button>
                    <button onclick="viewJournalEntries()" class="btn-accent">
                        <i class="fas fa-book-open mr-2"></i>View Entries
                    </button>
                    <button onclick="exportJournal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Journal
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="grid md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-blue-400 mb-2" id="total-entries">0</div>
                        <div class="text-slate-300">Total Entries</div>
                    </div>
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-green-400 mb-2" id="current-streak">0</div>
                        <div class="text-slate-300">Day Streak</div>
                    </div>
                    <div class="bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 text-center">
                        <div class="text-3xl font-bold text-purple-400 mb-2" id="avg-mood">-</div>
                        <div class="text-slate-300">Avg Mood</div>
                    </div>
                </div>

                <!-- New Entry Form -->
                <div id="new-entry-form" class="hidden bg-slate-700/30 rounded-xl p-8 mb-12">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">‚úçÔ∏è New Journal Entry</h2>
                    <form onsubmit="saveJournalEntry(event)">
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Date</label>
                                <input type="date" id="entry-date" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Mood (1-10)</label>
                                <select id="entry-mood" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select mood...</option>
                                    <option value="1">1 - Very Low</option>
                                    <option value="2">2 - Low</option>
                                    <option value="3">3 - Below Average</option>
                                    <option value="4">4 - Slightly Low</option>
                                    <option value="5">5 - Neutral</option>
                                    <option value="6">6 - Slightly Good</option>
                                    <option value="7">7 - Good</option>
                                    <option value="8">8 - Great</option>
                                    <option value="9">9 - Excellent</option>
                                    <option value="10">10 - Amazing</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Title (Optional)</label>
                            <input type="text" id="entry-title" placeholder="Give your entry a title..." class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Your Thoughts & Reflections</label>
                            <textarea id="entry-content" placeholder="What's on your mind today? How are you feeling? What insights have you gained?" rows="8" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Gratitude (What are you grateful for today?)</label>
                            <textarea id="entry-gratitude" placeholder="List 3 things you're grateful for..." rows="3" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Tags (Optional)</label>
                            <input type="text" id="entry-tags" placeholder="therapy, breakthrough, anxiety, healing, etc." class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                            <p class="text-sm text-slate-400 mt-1">Separate tags with commas</p>
                        </div>

                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="cancelNewEntry()" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save mr-2"></i>Save Entry
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Journal Prompts -->
                <div id="journal-prompts" class="hidden bg-slate-700/30 rounded-xl p-8 mb-12">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">üí° Reflective Writing Prompts</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-purple-300">Emotional Awareness</h3>
                            <div class="space-y-3 text-slate-300">
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ How am I feeling right now, and what might be causing these emotions?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What patterns do I notice in my emotional responses this week?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ When did I feel most at peace today, and what was happening?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What emotions am I avoiding, and why?</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-blue-300">Growth & Learning</h3>
                            <div class="space-y-3 text-slate-300">
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What did I learn about myself today?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ How have I grown since beginning my healing journey?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What challenge helped me become stronger?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What would I tell someone facing similar struggles?</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-green-300">Gratitude & Positivity</h3>
                            <div class="space-y-3 text-slate-300">
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What moments of joy or laughter did I experience today?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ Who am I grateful for in my life, and why?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What small victories can I celebrate this week?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ How did I show kindness to myself or others today?</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-orange-300">Future & Goals</h3>
                            <div class="space-y-3 text-slate-300">
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What am I looking forward to, and how can I nurture that excitement?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What steps can I take tomorrow to support my healing?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ How do I want to feel at the end of next month?</p>
                                <p class="cursor-pointer hover:text-white transition-colors" onclick="usePrompt(this.innerText)">‚Ä¢ What boundaries do I need to set to protect my peace?</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="hideJournalPrompts()" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg transition-colors">
                            Close Prompts
                        </button>
                    </div>
                </div>

                <!-- Journal Entries View -->
                <div id="journal-entries-view" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">üìö Your Journal Entries</h2>
                    <div class="mb-6 flex flex-wrap gap-4 items-center">
                        <input type="text" id="search-entries" placeholder="Search entries..." class="bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-slate-100 focus:border-blue-500 focus:outline-none">
                        <select id="filter-mood" class="bg-slate-600 border border-slate-500 rounded-lg px-4 py-2 text-slate-100 focus:border-blue-500 focus:outline-none">
                            <option value="">All Moods</option>
                            <option value="1-3">Low (1-3)</option>
                            <option value="4-6">Neutral (4-6)</option>
                            <option value="7-10">Good (7-10)</option>
                        </select>
                        <button onclick="hideJournalEntries()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                    <div id="entries-container" class="space-y-6">
                        <!-- Entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- BOOKING SECTION -->
    <section id="booking" class="section">
        <div class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 py-12">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header -->
                <div class="text-center mb-16">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navigateToSection('home')" class="btn-secondary flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Home
                        </button>
                        <div class="flex-1"></div>
                    </div>
                    <div class="ai-glow rounded-full p-4 bg-gradient-to-br from-blue-500 to-cyan-500 inline-block mb-6">
                        <i class="fas fa-calendar-alt text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-100 mb-4">üìÖ Book a Session</h1>
                    <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                        Schedule personalized sessions with our AI coaches for focused therapeutic support
                    </p>
                </div>

                <!-- Coach Selection -->
                <div class="mb-12">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6 text-center">Choose Your Coach</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="coach-card bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-blue-400/50 transition-all duration-300 cursor-pointer" onclick="selectCoach('david')">
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-microphone text-blue-400 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-100 mb-2">Coach David</h3>
                                <p class="text-slate-400 text-sm mb-4">Voice Therapy Specialist</p>
                                <div class="text-sm text-slate-300">
                                    <p>‚Ä¢ Real-time voice conversations</p>
                                    <p>‚Ä¢ CBT and emotional regulation</p>
                                    <p>‚Ä¢ Immediate support</p>
                                </div>
                            </div>
                        </div>

                        <div class="coach-card bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-emerald-400/50 transition-all duration-300 cursor-pointer" onclick="selectCoach('elena')">
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-heart text-emerald-400 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-100 mb-2">Coach Elena</h3>
                                <p class="text-slate-400 text-sm mb-4">Trauma Recovery Specialist</p>
                                <div class="text-sm text-slate-300">
                                    <p>‚Ä¢ PTSD and trauma support</p>
                                    <p>‚Ä¢ EMDR and grounding techniques</p>
                                    <p>‚Ä¢ Specialized trauma protocols</p>
                                </div>
                            </div>
                        </div>

                        <div class="coach-card bg-slate-700/50 backdrop-blur-sm rounded-xl p-6 border border-slate-600/50 hover:border-purple-400/50 transition-all duration-300 cursor-pointer" onclick="selectCoach('sarah')">
                            <div class="text-center mb-4">
                                <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-leaf text-purple-400 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-slate-100 mb-2">Coach Sarah</h3>
                                <p class="text-slate-400 text-sm mb-4">Anxiety & Stress Specialist</p>
                                <div class="text-sm text-slate-300">
                                    <p>‚Ä¢ Anxiety management</p>
                                    <p>‚Ä¢ Mindfulness and meditation</p>
                                    <p>‚Ä¢ Stress reduction techniques</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <div id="booking-form" class="hidden bg-slate-700/30 rounded-xl p-8 mb-12">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">üìã Session Details</h2>
                    <form onsubmit="bookSession(event)">
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Selected Coach</label>
                                <input type="text" id="selected-coach" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none" readonly>
                            </div>
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Session Type</label>
                                <select id="session-type" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select session type...</option>
                                    <option value="initial-consultation">Initial Consultation (60 min)</option>
                                    <option value="regular-session">Regular Session (45 min)</option>
                                    <option value="check-in">Quick Check-in (30 min)</option>
                                    <option value="crisis-support">Crisis Support (available 24/7)</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Preferred Date</label>
                                <input type="date" id="session-date" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Preferred Time</label>
                                <select id="session-time" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select time...</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Session Goals</label>
                            <textarea id="session-goals" placeholder="What would you like to focus on in this session?" rows="4" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-300 font-medium mb-2">Current Concerns</label>
                            <textarea id="current-concerns" placeholder="Briefly describe what you'd like support with..." rows="3" class="w-full bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 focus:border-blue-500 focus:outline-none resize-none"></textarea>
                        </div>

                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="cancelBooking()" class="bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-calendar-check mr-2"></i>Book Session
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Upcoming Sessions -->
                <div class="bg-slate-700/30 rounded-xl p-8">
                    <h2 class="text-2xl font-bold text-slate-100 mb-6">üìÖ Your Upcoming Sessions</h2>
                    <div id="upcoming-sessions" class="space-y-4">
                        <!-- Sessions will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- PRICING SECTION -->
    <section id="pricing" class="section">
        <div class="container mx-auto px-4 py-12">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 mb-4">
                    üí≥ Pricing & Plans
                </h1>
                <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                    Choose between subscription plans or flexible credit packages. All options include access to our AI coaches and therapeutic tools.
                </p>
            </div>



            <!-- Subscription Plans -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-center text-slate-100 mb-8">Monthly Subscription Plans</h2>
                <div class="grid md:grid-cols-4 gap-6 mb-12">
                    <!-- Free Plan -->
                    <div class="knowledge-card p-6 border-2 border-slate-600 relative">
                        <div class="absolute top-4 right-4 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">
                            FREE
                        </div>
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Free Starter</h3>
                            <div class="text-3xl font-bold text-green-400 mb-2">¬£0<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">Try Before You Buy</p>
                        </div>
                        <ul class="text-slate-300 space-y-2 mb-6 text-sm">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>1 Assessment per month</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>1 Coach session</li>
                            <li class="flex items-center"><i class="fas fa-times text-red-400 mr-2"></i><span class="line-through text-slate-500">Voice therapy</span></li>
                            <li class="flex items-center"><i class="fas fa-times text-red-400 mr-2"></i><span class="line-through text-slate-500">PTSD tools</span></li>
                            <li class="flex items-center"><i class="fas fa-times text-red-400 mr-2"></i><span class="line-through text-slate-500">Knowledge library</span></li>
                            <li class="flex items-center"><i class="fas fa-times text-red-400 mr-2"></i><span class="line-through text-slate-500">Priority support</span></li>
                        </ul>
                        <button onclick="startFreeTrial()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">
                            Start Free Trial
                        </button>
                        <p class="text-xs text-slate-400 mt-2 text-center">No credit card required</p>
                    </div>

                    <!-- Basic Plan -->
                    <div class="knowledge-card p-6">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-slate-100 mb-2">Root Cause Power Basic</h3>
                            <div class="text-4xl font-bold text-blue-400 mb-2">¬£24<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">50 Credits Monthly</p>
                        </div>
                        <ul class="text-slate-300 space-y-3 mb-8">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>50 AI coach sessions</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>4+ hours voice therapy</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>15+ detailed assessments</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>PTSD & anxiety tools</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Knowledge library access</li>
                        </ul>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/4gMfZgeHVcmFaYF7WY0VO02', 'Root Cause Basic', '1', '24')" class="w-full btn-primary py-3">
                            Choose Basic
                        </button>
                    </div>

                    <!-- Premium Plan -->
                    <div class="knowledge-card p-6 border-2 border-purple-500 relative">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-purple-500 text-white px-4 py-1 rounded-full text-sm font-bold">Most Popular</span>
                        </div>
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-slate-100 mb-2">Root Cause Power Premium</h3>
                            <div class="text-4xl font-bold text-purple-400 mb-2">¬£49<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">150 Credits Monthly</p>
                        </div>
                        <ul class="text-slate-300 space-y-3 mb-8">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>150 AI coach sessions</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>12+ hours voice therapy</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>50+ detailed assessments</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Priority support</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Advanced analytics</li>
                        </ul>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/bJeaEW7ft3Q9giZ3GI0VO01', 'Root Cause Premium', '1', '49')" class="w-full btn-primary py-3 bg-purple-500 hover:bg-purple-600">
                            Choose Premium
                        </button>
                    </div>

                    <!-- VIP Elite Plan -->
                    <div class="knowledge-card p-6 border-2 border-yellow-500">
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-slate-100 mb-2">Root Cause Power VIP Elite</h3>
                            <div class="text-4xl font-bold text-yellow-400 mb-2">¬£82<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">Unlimited Credits</p>
                        </div>
                        <ul class="text-slate-300 space-y-3 mb-8">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Unlimited AI coaching</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Unlimited voice therapy</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Unlimited assessments</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>VIP priority support</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-3"></i>Personal health advisor chat</li>
                        </ul>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/00w6oG43h86p2s93GI0VO03', 'Root Cause VIP Elite', '1', '82')" class="w-full btn-primary py-3 bg-yellow-500 hover:bg-yellow-600">
                            Choose VIP Elite
                        </button>
                    </div>
                </div>
            </div>

            <!-- Credit Packages -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-center text-slate-100 mb-8">Flexible Credit Packages</h2>
                <p class="text-center text-slate-400 mb-8">Perfect for occasional users or to supplement your subscription</p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="knowledge-card p-6 text-center">
                        <div class="text-2xl font-bold text-blue-400 mb-2">Professional Starter</div>
                        <div class="text-3xl font-bold text-slate-100 mb-4">100 Credits</div>
                        <div class="text-2xl font-bold text-green-400 mb-2">¬£18</div>
                        <p class="text-slate-400 text-sm mb-4">¬£0.18 per credit</p>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/14A28q0R572leaRa560VO08', 'Professional Starter', '100 Credits', '18')" class="w-full btn-primary py-2">Buy Credits</button>
                    </div>
                    
                    <div class="knowledge-card p-6 text-center border-2 border-green-500">
                        <div class="text-sm font-bold text-green-400 mb-2">POPULAR</div>
                        <div class="text-2xl font-bold text-green-400 mb-2">Professional Pack</div>
                        <div class="text-3xl font-bold text-slate-100 mb-4">500 Credits</div>
                        <div class="text-2xl font-bold text-green-400 mb-2">¬£75</div>
                        <p class="text-slate-400 text-sm mb-4">¬£0.15 per credit</p>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/cNidR81V9dqJfeVelm0VO09', 'Professional Pack', '500 Credits', '75')" class="w-full btn-primary py-2 bg-green-500 hover:bg-green-600">Buy Credits</button>
                    </div>
                    
                    <div class="knowledge-card p-6 text-center border-2 border-yellow-500">
                        <div class="text-sm font-bold text-yellow-400 mb-2">BEST VALUE</div>
                        <div class="text-2xl font-bold text-yellow-400 mb-2">Enterprise Pack</div>
                        <div class="text-3xl font-bold text-slate-100 mb-4">1,000 Credits</div>
                        <div class="text-2xl font-bold text-yellow-400 mb-2">¬£120</div>
                        <p class="text-slate-400 text-sm mb-4">¬£0.12 per credit</p>
                        <button onclick="openEmbeddedStripeCheckout('https://buy.stripe.com/7sYfZggQ39at5Elfpq0VO0a', 'Enterprise Pack', '1000 Credits', '120')" class="w-full btn-primary py-2 bg-yellow-500 hover:bg-yellow-600">Buy Credits</button>
                    </div>
                </div>
            </div>

            <!-- Free vs Paid Comparison -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-2xl p-8 mb-16 border border-slate-600">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">üÜö Free vs Premium Comparison</h2>
                    <p class="text-slate-300">See what you unlock with a subscription</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-slate-600">
                                <th class="py-4 px-4 text-slate-300 font-medium">Feature</th>
                                <th class="py-4 px-4 text-center text-slate-400">Free Trial</th>
                                <th class="py-4 px-4 text-center text-blue-400 font-bold">Basic (¬£24/mo)</th>
                                <th class="py-4 px-4 text-center text-green-400 font-bold">Premium (¬£49/mo)</th>
                                <th class="py-4 px-4 text-center text-purple-400 font-bold">VIP (¬£82/mo)</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">Monthly Assessments</td>
                                <td class="py-3 px-4 text-center text-red-400">1 only</td>
                                <td class="py-3 px-4 text-center text-blue-400">15+</td>
                                <td class="py-3 px-4 text-center text-green-400">30+</td>
                                <td class="py-3 px-4 text-center text-purple-400">Unlimited</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">AI Coach Sessions</td>
                                <td class="py-3 px-4 text-center text-red-400">1 only</td>
                                <td class="py-3 px-4 text-center text-blue-400">50/month</td>
                                <td class="py-3 px-4 text-center text-green-400">100/month</td>
                                <td class="py-3 px-4 text-center text-purple-400">Unlimited</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">Voice Therapy (Hume AI)</td>
                                <td class="py-3 px-4 text-center text-red-400">‚ùå Locked</td>
                                <td class="py-3 px-4 text-center text-blue-400">4+ hours</td>
                                <td class="py-3 px-4 text-center text-green-400">8+ hours</td>
                                <td class="py-3 px-4 text-center text-purple-400">Unlimited</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">PTSD Corner Tools</td>
                                <td class="py-3 px-4 text-center text-red-400">‚ùå Locked</td>
                                <td class="py-3 px-4 text-center text-blue-400">‚úÖ Full access</td>
                                <td class="py-3 px-4 text-center text-green-400">‚úÖ Full access</td>
                                <td class="py-3 px-4 text-center text-purple-400">‚úÖ Full access</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">Knowledge Library</td>
                                <td class="py-3 px-4 text-center text-red-400">‚ùå Locked</td>
                                <td class="py-3 px-4 text-center text-blue-400">‚úÖ 1000+ articles</td>
                                <td class="py-3 px-4 text-center text-green-400">‚úÖ 1000+ articles</td>
                                <td class="py-3 px-4 text-center text-purple-400">‚úÖ 1000+ articles</td>
                            </tr>
                            <tr class="border-b border-slate-700">
                                <td class="py-3 px-4 text-slate-300">Priority Support</td>
                                <td class="py-3 px-4 text-center text-red-400">‚ùå Basic only</td>
                                <td class="py-3 px-4 text-center text-blue-400">Email support</td>
                                <td class="py-3 px-4 text-center text-green-400">Priority support</td>
                                <td class="py-3 px-4 text-center text-purple-400">24/7 crisis line</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
             
                <div class="text-center mt-8">
                    <p class="text-slate-400 mb-4">üéØ <strong>Most users upgrade within 7 days</strong> to unlock voice therapy and PTSD tools</p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="directStripeCheckout('price_1RytIqC5Ez9YOIaynY645OsH', 'subscription', 'Root Cause Power Basic - ¬£24/month')" 
                                class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg text-white font-medium">
                            Upgrade to Basic
                        </button>
                        <button onclick="directStripeCheckout('price_1Rz9AnC5Ez9YOIayC2sT6i73', 'subscription', 'Root Cause Power Premium - ¬£49/month')" 
                                class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg text-white font-medium">
                            Choose Premium
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enterprise Solutions -->
            <div class="bg-slate-700/30 rounded-2xl p-8">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-slate-100 mb-4">Enterprise Solutions</h2>
                    <p class="text-slate-300">Comprehensive healthcare platforms for organizations and healthcare providers</p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Enterprise Basic -->
                    <div class="knowledge-card p-6">
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-slate-100 mb-2">Enterprise Basic</h4>
                            <div class="text-3xl font-bold text-slate-100 mb-2">¬£10<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">Up to 50 users</p>
                        </div>
                        <ul class="text-slate-300 space-y-2 mb-6">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Admin dashboard</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Usage analytics</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>API access</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Basic integrations</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Email support</li>
                        </ul>
                        <button onclick="showEnterpriseCalculator('basic', 10, 50)" class="btn-primary w-full py-3">
                            <i class="fas fa-shopping-cart mr-2"></i>Buy Now
                        </button>
                    </div>
                    
                    <!-- Enterprise Premium -->
                    <div class="knowledge-card p-6 border-2 border-blue-500">
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-slate-100 mb-2">Enterprise Premium</h4>
                            <div class="text-3xl font-bold text-slate-100 mb-2">¬£25<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">Up to 200 users</p>
                        </div>
                        <ul class="text-slate-300 space-y-2 mb-6">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Everything in Basic</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>White-label options</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Advanced analytics</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Priority support</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Custom integrations</li>
                        </ul>
                        <button onclick="showEnterpriseCalculator('premium', 25, 200)" class="btn-primary w-full py-3">
                            <i class="fas fa-shopping-cart mr-2"></i>Buy Now
                        </button>
                    </div>
                    
                    <!-- Enterprise Elite -->
                    <div class="knowledge-card p-6 border-2 border-purple-500">
                        <div class="text-center mb-6">
                            <h4 class="text-xl font-bold text-slate-100 mb-2">Enterprise Elite</h4>
                            <div class="text-3xl font-bold text-slate-100 mb-2">¬£54<span class="text-lg text-slate-400">/month</span></div>
                            <p class="text-slate-400">Unlimited users</p>
                        </div>
                        <ul class="text-slate-300 space-y-2 mb-6">
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Everything in Premium</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Dedicated support team</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Advanced employee management</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>99.9% SLA guarantees</li>
                            <li class="flex items-center"><i class="fas fa-check text-green-400 mr-2"></i>Custom reporting & insights</li>
                        </ul>
                        <button onclick="showEnterpriseCalculator('elite', 54, 999)" class="btn-primary w-full py-3 bg-purple-500 hover:bg-purple-600">
                            <i class="fas fa-shopping-cart mr-2"></i>Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Personal Dashboard Section -->
    <section id="dashboard" class="section">
        <div class="container mx-auto px-4 py-12">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 mb-4">
                    üìä Personal Dashboard
                </h1>
                <p class="text-xl text-slate-300 max-w-3xl mx-auto">
                    Track your health journey, monitor progress toward your goals, and celebrate your achievements with AI-powered insights.
                </p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="space-y-8">
                <!-- Loading State -->
                <div id="dashboard-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-400 mx-auto mb-4"></div>
                    <p class="text-slate-400">Loading your personalized dashboard...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Hume EVI will be integrated via WebSocket directly -->
    <style>
        /* Replit-inspired color scheme and mobile-first design */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-hover: #2563eb;
            --border-color: #475569;
            --shadow-color: rgba(59, 130, 246, 0.1);
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--accent-secondary) 100%);
            background-size: 300% 300%;
            animation: gradientShift 12s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .ai-glow {
            box-shadow: 0 0 20px var(--shadow-color);
            animation: aiPulse 4s ease-in-out infinite;
        }
        
        @keyframes aiPulse {
            0%, 100% { box-shadow: 0 0 20px var(--shadow-color); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.3); }
        }
        
        .knowledge-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .knowledge-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
        }
        
        /* Nutrition System Styles */
        .nutrition-tab {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nutrition-tab:hover {
            transform: translateY(-1px);
        }
        
        .nutrition-tab.active-tab {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .nutrition-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .meal-item {
            transition: all 0.3s ease;
        }
        
        .meal-item:hover {
            background-color: #475569 !important;
        }
        
        .section {
            display: none;
            min-height: 100vh;
            padding: 1rem;
        }
        
        .section.active {
            display: block;
        }
        
        .nav-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .nav-button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .assessment-question {
            display: none;
        }
        
        .assessment-question.active {
            display: block;
        }
        
        .assessment-option.selected {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%) !important;
            border-color: var(--accent-primary) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .assessment-option.selected .circle {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981 !important;
            position: relative;
        }
        
        .assessment-option.selected .circle::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        
        .circle {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>

    <!-- Fixed JavaScript - Navigation Guaranteed to Work -->
    <script>
        console.log('üöÄ Root Cause Power Platform Loading...');
        
        // DUPLICATE NAVIGATION FUNCTION COMMENTED OUT - Using the fixed version above
        /*
        window.navigateToSection = function(sectionId) {
            console.log('üîÑ EMERGENCY Navigation called:', sectionId);
            
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                console.log('Hidden:', section.id);
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                console.log('‚úÖ Showing section:', sectionId);
                
                // Scroll to top
                window.scrollTo(0, 0);
            } else {
                console.error('‚ùå Section not found:', sectionId);
            }
        };
        */
        
        // VOICE CAPTURE AND AUDIO HELPER FUNCTIONS (USING EMERGENCY VERSIONS)
        console.log('üîÑ Using emergency voice functions defined earlier...');
        
        // (Duplicate function removed - using emergency version defined earlier)
        
        // DUPLICATE EMERGENCY VOICE SESSION FUNCTION - DISABLED
        window.startVoiceTherapySession = function() {
            console.log('üîÑ DUPLICATE function disabled - redirecting to coaches section');
            navigateToSection('coaches');
            
            // Show voice session container
            const voiceContainer = document.getElementById('voice-session-container');
            if (voiceContainer) {
                voiceContainer.classList.remove('hidden');
                voiceContainer.style.display = 'block';
                console.log('‚úÖ Voice interface shown');
                
                // Scroll to it
                voiceContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                console.error('‚ùå Voice container not found');
            }
        };
        
        // Initialize immediately when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ EMERGENCY Navigation system loaded and ready!');
            
            // Show home section by default
            window.navigateToSection('home');
        });
        
        // THIRD DUPLICATE NAVIGATION FUNCTION COMMENTED OUT - Using the fixed version at top
        /*
        function navigateToSection(sectionId) {
            console.log('üîÑ Navigation called:', sectionId);
            
            try {
                // Hide ALL sections
                const allSections = document.querySelectorAll('.section');
                console.log('Found sections:', allSections.length);
                
                allSections.forEach(section => {
                    section.classList.remove('active');
                    console.log('Hidden section:', section.id);
                });
                
                // Show target section
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log('‚úÖ Successfully activated section:', sectionId);
                    
                    // Update navigation buttons
                    updateNavButtons(sectionId);
                    
                    // Initialize section-specific functionality
                    if (sectionId === 'dashboard') {
                        window.initializeDashboard();
                    }
                    
                    // Close mobile menu
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu) {
                        mobileMenu.classList.add('hidden');
                    }
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                } else {
                    console.error('‚ùå Section not found:', sectionId);
                }
            } catch (error) {
                console.error('Navigation error:', error);
            }
        }
        */
        
        function updateNavButtons(activeSection) {
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'nav-' + activeSection) {
                    btn.classList.add('active');
                }
            });
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
                console.log('üì± Mobile menu toggled');
            }
        }
        
        // INTELLIGENT MULTI-QUESTION ASSESSMENT SYSTEM
        let assessmentState = {
            currentQuestion: 0,
            answers: {},
            scores: {
                energy: 0,
                sleep: 0,
                stress: 0,
                nutrition: 0,
                mental: 0,
                physical: 0,
                social: 0,
                overall: 0
            },
            totalQuestions: 8
        };
        
        // INTELLIGENT ASSESSMENT SYSTEM WITH AI FOLLOW-UP
        let intelligentAssessment = {
            active: false,
            currentPhase: 'initial', // initial, followUp, goals, chronic, summary
            responses: {},
            followUpQuestions: [],
            goals: [],
            chronicConditions: [],
            aiContext: '',
            currentFollowUpIndex: 0,
            assessmentPurpose: '',
            personalMotivation: '',
            hasChronicConditions: false,
            healthChallenges: [],
            lifeGoals: [],
            timeline: {}
        };

        const baseAssessmentQuestions = [
            {
                id: 'purpose',
                title: 'Assessment Purpose & Goals',
                question: 'What brings you to this health assessment today? What are you hoping to achieve?',
                description: 'Understanding your motivation helps us provide the most relevant guidance.',
                type: 'text',
                followUp: true
            },
            {
                id: 'energy',
                title: 'Energy & Vitality Assessment',
                question: 'How would you rate your overall energy levels throughout the day?',
                description: 'This helps us understand your baseline energy and identify potential areas for improvement.',
                answers: [
                    { text: 'Excellent', description: 'High energy throughout the day, rarely feel tired', score: 5, category: 'energy' },
                    { text: 'Good', description: 'Generally energetic with occasional dips', score: 4, category: 'energy' },
                    { text: 'Average', description: 'Moderate energy, some afternoon fatigue', score: 3, category: 'energy' },
                    { text: 'Low', description: 'Often feel tired or sluggish', score: 2, category: 'energy' },
                    { text: 'Very Low', description: 'Constantly exhausted, difficult to function', score: 1, category: 'energy' }
                ],
                followUp: true
            },
            {
                id: 'sleep',
                title: 'Sleep Quality Assessment',
                question: 'How would you describe your sleep quality and patterns?',
                description: 'Sleep is fundamental to health, affecting everything from immune function to mental clarity.',
                answers: [
                    { text: 'Excellent', description: 'Fall asleep easily, sleep 7-9 hours, wake refreshed', score: 5, category: 'sleep' },
                    { text: 'Good', description: 'Generally good sleep with occasional issues', score: 4, category: 'sleep' },
                    { text: 'Fair', description: 'Some difficulty falling asleep or staying asleep', score: 3, category: 'sleep' },
                    { text: 'Poor', description: 'Frequent sleep problems, wake up tired', score: 2, category: 'sleep' },
                    { text: 'Very Poor', description: 'Severe insomnia or sleep disorders', score: 1, category: 'sleep' }
                ]
            },
            {
                id: 'stress',
                title: 'Stress Management Assessment',
                question: 'How well do you currently manage stress in your daily life?',
                description: 'Chronic stress impacts both physical and mental health significantly.',
                answers: [
                    { text: 'Very Well', description: 'Effective coping strategies, rarely overwhelmed', score: 5, category: 'stress' },
                    { text: 'Well', description: 'Generally handle stress well with some challenges', score: 4, category: 'stress' },
                    { text: 'Moderately', description: 'Some stress management tools but room for improvement', score: 3, category: 'stress' },
                    { text: 'Poorly', description: 'Often feel overwhelmed and stressed', score: 2, category: 'stress' },
                    { text: 'Very Poorly', description: 'Chronic stress significantly impacts daily life', score: 1, category: 'stress' }
                ]
            },
            {
                id: 'nutrition',
                title: 'Nutritional Health Assessment',
                question: 'How would you rate your current eating habits and nutrition?',
                description: 'Nutrition directly affects energy, mood, and long-term health outcomes.',
                answers: [
                    { text: 'Excellent', description: 'Balanced whole foods diet, consistent meals', score: 5, category: 'nutrition' },
                    { text: 'Good', description: 'Generally healthy eating with occasional treats', score: 4, category: 'nutrition' },
                    { text: 'Fair', description: 'Mixed diet, some processed foods, irregular meals', score: 3, category: 'nutrition' },
                    { text: 'Poor', description: 'Frequent fast food, high processed food intake', score: 2, category: 'nutrition' },
                    { text: 'Very Poor', description: 'Severely unbalanced diet, frequent skipping meals', score: 1, category: 'nutrition' }
                ]
            },
            {
                id: 'mental',
                title: 'Mental & Emotional Wellness',
                question: 'How is your overall mental and emotional well-being?',
                description: 'Mental health affects every aspect of life including relationships, work, and physical health.',
                answers: [
                    { text: 'Excellent', description: 'Positive mood, resilient, emotionally balanced', score: 5, category: 'mental' },
                    { text: 'Good', description: 'Generally positive with normal life challenges', score: 4, category: 'mental' },
                    { text: 'Fair', description: 'Some mood fluctuations, manageable stress', score: 3, category: 'mental' },
                    { text: 'Concerning', description: 'Frequent anxiety, low mood, or emotional challenges', score: 2, category: 'mental' },
                    { text: 'Poor', description: 'Significant mental health challenges affecting daily life', score: 1, category: 'mental' }
                ]
            },
            {
                id: 'physical',
                title: 'Physical Activity & Movement',
                question: 'How active are you in terms of exercise and physical movement?',
                description: 'Regular physical activity is crucial for cardiovascular health, strength, and mental well-being.',
                answers: [
                    { text: 'Very Active', description: 'Regular exercise 5+ times per week, variety of activities', score: 5, category: 'physical' },
                    { text: 'Active', description: 'Exercise 3-4 times per week consistently', score: 4, category: 'physical' },
                    { text: 'Moderately Active', description: 'Some exercise 1-2 times per week', score: 3, category: 'physical' },
                    { text: 'Lightly Active', description: 'Occasional walks or light activity', score: 2, category: 'physical' },
                    { text: 'Sedentary', description: 'Very little physical activity or exercise', score: 1, category: 'physical' }
                ]
            },
            {
                id: 'social',
                title: 'Social Connection & Support',
                question: 'How would you rate your social connections and support system?',
                description: 'Strong social connections are linked to better health outcomes and increased longevity.',
                answers: [
                    { text: 'Excellent', description: 'Strong support network, meaningful relationships', score: 5, category: 'social' },
                    { text: 'Good', description: 'Solid relationships with family and friends', score: 4, category: 'social' },
                    { text: 'Fair', description: 'Some social connections but could be stronger', score: 3, category: 'social' },
                    { text: 'Limited', description: 'Few close relationships, limited support', score: 2, category: 'social' },
                    { text: 'Isolated', description: 'Feeling lonely, lack of meaningful connections', score: 1, category: 'social' }
                ]
            },
            {
                id: 'overall',
                title: 'Overall Health & Life Satisfaction',
                question: 'Considering all aspects of your health and life, how satisfied are you overall?',
                description: 'This final question helps us understand your holistic well-being and life satisfaction.',
                answers: [
                    { text: 'Very Satisfied', description: 'Feel great about life and health trajectory', score: 5, category: 'overall' },
                    { text: 'Satisfied', description: 'Generally content with some areas for growth', score: 4, category: 'overall' },
                    { text: 'Neutral', description: 'Neither satisfied nor dissatisfied, seeking change', score: 3, category: 'overall' },
                    { text: 'Dissatisfied', description: 'Wanting significant improvements in multiple areas', score: 2, category: 'overall' },
                    { text: 'Very Dissatisfied', description: 'Major concerns about health and life direction', score: 1, category: 'overall' }
                ]
            }
        ];
        
        function startAssessment() {
            console.log('üìã Starting comprehensive assessment...');
            
            // Ensure we're in the assessment section
            navigateToSection('assessment');
            
            // Initialize assessment state
            assessmentState = {
                currentQuestion: 0,
                answers: {},
                scores: { energy: 0, sleep: 0, stress: 0, nutrition: 0, mental: 0, physical: 0, social: 0, overall: 0 },
                totalQuestions: baseAssessmentQuestions.length
            };
            
            // Wait for section to be visible, then start
            setTimeout(() => {
                displayQuestion(0);
                console.log('‚úÖ Assessment initialized with', baseAssessmentQuestions.length, 'questions');
            }, 500);
        }
        
        function displayQuestion(questionIndex) {
            console.log('üìù Displaying question', questionIndex + 1, 'of', baseAssessmentQuestions.length);
            
            if (!baseAssessmentQuestions || questionIndex >= baseAssessmentQuestions.length) {
                console.error('‚ùå Invalid question index or questions not loaded');
                return;
            }
            
            const question = baseAssessmentQuestions[questionIndex];
            const container = document.getElementById('assessment-container');
            
            if (!container) {
                console.error('‚ùå Assessment container not found');
                return;
            }
            
            // Update progress
            const progressPercent = ((questionIndex + 1) / assessmentState.totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `Question ${questionIndex + 1} of ${assessmentState.totalQuestions}`;
            
            // Generate question HTML based on question type
            let answersHTML = '';
            
            if (question.type === 'text') {
                // Text input question
                answersHTML = `
                    <div class="mb-6">
                        <textarea 
                            id="assessment-text-${questionIndex}" 
                            class="w-full p-4 bg-slate-600/50 border border-slate-500 rounded-lg text-slate-100 resize-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                            rows="4"
                            placeholder="Share your thoughts and goals..."
                        ></textarea>
                    </div>
                    <button onclick="submitTextAnswer(${questionIndex})" class="btn-primary w-full">
                        <i class="fas fa-arrow-right mr-2"></i>Continue
                    </button>
                `;
            } else {
                // Multiple choice question
                answersHTML = `
                    <div class="space-y-3">
                        ${question.answers.map((answer, index) => `
                            <button onclick="selectAnswer(${questionIndex}, ${index})" class="assessment-option w-full text-left p-4 bg-slate-600/50 hover:bg-slate-500/70 rounded-lg transition-all border border-slate-500 hover:border-blue-400">
                                <div class="flex items-center">
                                    <div class="circle w-4 h-4 border-2 border-slate-400 rounded-full mr-3"></div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-100">${answer.text}</div>
                                        <div class="text-sm text-slate-400">${answer.description}</div>
                                    </div>
                                    <div class="ml-auto text-slate-500 font-medium">${answer.score}/5</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            
            const questionHTML = `
                <div class="assessment-question active" data-question="${questionIndex}">
                    <div class="mb-6">
                        <div class="text-sm text-blue-400 font-medium mb-2">${question.title}</div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-3">${question.question}</h3>
                        <p class="text-slate-400">${question.description}</p>
                    </div>
                    ${answersHTML}
                </div>
            `;
            
            container.innerHTML = questionHTML;
        }
        
        function selectAnswer(questionIndex, answerIndex) {
            const question = baseAssessmentQuestions[questionIndex];
            const answer = question.answers[answerIndex];
            
            console.log('üìä Answer selected:', answer.text, 'Score:', answer.score, 'Category:', answer.category);
            
            // Store answer and score
            assessmentState.answers[question.id] = answer;
            assessmentState.scores[answer.category] = answer.score;
            
            // Visual feedback - turn selected circle green with checkmark
            const buttons = document.querySelectorAll('.assessment-option');
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            // Find the clicked button using multiple methods
            let clickedButton = event?.target?.closest('.assessment-option');
            
            // Fallback: find by answer index if event method fails
            if (!clickedButton) {
                const currentButtons = document.querySelectorAll('.assessment-option');
                clickedButton = currentButtons[answerIndex];
                console.log('üîÑ Using fallback button selection method');
            }
            
            if (clickedButton) {
                console.log('‚úÖ Button found, applying visual feedback');
                clickedButton.classList.add('selected');
                
                // Update the circle to green with checkmark
                const circle = clickedButton.querySelector('.circle');
                if (circle) {
                    circle.className = 'w-4 h-4 bg-green-500 rounded-full mr-3 flex items-center justify-center';
                    circle.innerHTML = '<i class="fas fa-check text-white text-xs"></i>';
                    console.log('‚úÖ Circle updated with green color and checkmark');
                } else {
                    console.warn('‚ö†Ô∏è Circle element not found in button');
                }
            } else {
                console.error('‚ùå Could not find clicked button for visual feedback');
            }
            
            // Move to next question after delay
            setTimeout(() => {
                assessmentState.currentQuestion++;
                
                if (assessmentState.currentQuestion < assessmentState.totalQuestions) {
                    displayQuestion(assessmentState.currentQuestion);
                } else {
                    showAssessmentResults();
                }
            }, 1000);
        }
        
        function showAssessmentResults() {
            console.log('üéÜ Assessment complete, calculating results...');
            
            // Calculate overall scores and recommendations
            const totalScore = Object.values(assessmentState.scores).reduce((sum, score) => sum + score, 0);
            const averageScore = totalScore / assessmentState.totalQuestions;
            const maxPossibleScore = assessmentState.totalQuestions * 5;
            const percentageScore = Math.round((totalScore / maxPossibleScore) * 100);
            
            // Determine risk areas (scores of 2 or below)
            const riskAreas = Object.entries(assessmentState.scores)
                .filter(([category, score]) => score <= 2)
                .map(([category, score]) => ({ category, score }));
            
            // Determine strengths (scores of 4 or above)
            const strengths = Object.entries(assessmentState.scores)
                .filter(([category, score]) => score >= 4)
                .map(([category, score]) => ({ category, score }));
            
            // Generate personalized recommendations based on scores
            const recommendations = generateRecommendations(assessmentState.scores, riskAreas);
            
            // Generate results HTML
            const resultsHTML = `
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="text-center">
                        <div class="relative inline-flex items-center justify-center w-32 h-32 mb-4">
                            <svg class="transform -rotate-90 w-32 h-32">
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="4" fill="transparent" class="text-slate-600"></circle>
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="4" fill="transparent" 
                                    stroke-dasharray="${2 * Math.PI * 56}" 
                                    stroke-dashoffset="${2 * Math.PI * 56 * (1 - percentageScore / 100)}" 
                                    class="text-blue-500 transition-all duration-1000"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-3xl font-bold text-slate-100">${percentageScore}%</span>
                            </div>
                        </div>
                        <h4 class="text-xl font-bold text-slate-100">Overall Wellness Score</h4>
                        <p class="text-slate-300">${getScoreDescription(averageScore)}</p>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-lg font-bold text-slate-100">Category Breakdown</h4>
                        ${Object.entries(assessmentState.scores).map(([category, score]) => `
                            <div class="flex items-center justify-between">
                                <span class="text-slate-300 capitalize">${category.replace('_', ' ')}</span>
                                <div class="flex items-center">
                                    <div class="w-20 bg-slate-600 rounded-full h-2 mr-2">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" 
                                             style="width: ${(score / 5) * 100}%"></div>
                                    </div>
                                    <span class="text-slate-100 font-medium w-8">${score}/5</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                ${strengths.length > 0 ? `
                    <div class="bg-green-800/30 border border-green-600 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-bold text-green-300 mb-3">üéÜ Your Wellness Strengths</h4>
                        <div class="grid md:grid-cols-2 gap-2">
                            ${strengths.map(({ category, score }) => `
                                <div class="text-green-100 text-sm">‚Ä¢ ${category.charAt(0).toUpperCase() + category.slice(1)} Health (${score}/5)</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${riskAreas.length > 0 ? `
                    <div class="bg-amber-800/30 border border-amber-600 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-bold text-amber-300 mb-3">‚ö†Ô∏è Areas for Improvement</h4>
                        <div class="space-y-2">
                            ${riskAreas.map(({ category, score }) => `
                                <div class="text-amber-100 text-sm">‚Ä¢ ${category.charAt(0).toUpperCase() + category.slice(1)} Health needs attention (${score}/5)</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="bg-blue-800/30 border border-blue-600 rounded-lg p-6">
                    <h4 class="text-lg font-bold text-blue-300 mb-3">üé• Personalized Recommendations</h4>
                    <div class="space-y-3">
                        ${recommendations.map(rec => `
                            <div class="text-blue-100 text-sm">‚Ä¢ <strong>${rec.category}:</strong> ${rec.recommendation}</div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Hide assessment container and show results
            document.getElementById('assessment-container').style.display = 'none';
            document.querySelector('.mb-8').style.display = 'none'; // Hide progress bar
            document.getElementById('results-content').innerHTML = resultsHTML;
            document.getElementById('assessment-results').classList.remove('hidden');
            
            // Store results for personalized coaching
            storeAssessmentResults({
                scores: assessmentState.scores,
                totalScore,
                averageScore,
                percentageScore,
                recommendations,
                riskAreas,
                strengths,
                answers: assessmentState.answers
            });
            
            // Start intelligent AI-powered follow-up assessment
            setTimeout(() => {
                startIntelligentFollowUp();
            }, 3000);
        }
        
        function submitTextAnswer(questionIndex) {
            const textInput = document.getElementById(`assessment-text-${questionIndex}`);
            const textValue = textInput.value.trim();
            
            if (!textValue) {
                alert('Please provide an answer to continue.');
                return;
            }
            
            const question = baseAssessmentQuestions[questionIndex];
            
            // Store text answer
            assessmentState.answers[question.id] = {
                text: textValue,
                question: question.question,
                type: 'text'
            };
            
            console.log('üìù Text answer submitted:', textValue);
            
            // Move to next question
            setTimeout(() => {
                if (assessmentState.currentQuestion + 1 < assessmentState.totalQuestions) {
                    assessmentState.currentQuestion++;
                    displayQuestion(assessmentState.currentQuestion);
                } else {
                    generateAssessmentResults();
                }
            }, 500);
        }
        
        function generateRecommendations(scores, riskAreas) {
            const recommendations = [];
            
            // Energy-specific recommendations
            if (scores.energy <= 2) {
                recommendations.push({
                    category: 'Energy Optimization',
                    recommendation: 'Consider B-vitamin complex supplementation, improve sleep hygiene, and evaluate for underlying conditions like thyroid dysfunction or iron deficiency.'
                });
            }
            
            // Sleep-specific recommendations
            if (scores.sleep <= 2) {
                recommendations.push({
                    category: 'Sleep Improvement',
                    recommendation: 'Implement CBT-I techniques: maintain consistent sleep/wake times, optimize bedroom temperature (65-68¬∞F), and consider melatonin supplementation.'
                });
            }
            
            // Stress management
            if (scores.stress <= 2) {
                recommendations.push({
                    category: 'Stress Management',
                    recommendation: 'Practice daily meditation (10+ minutes), learn CBT techniques for stress reframing, and consider adaptogenic herbs like ashwagandha.'
                });
            }
            
            // Nutrition recommendations
            if (scores.nutrition <= 2) {
                recommendations.push({
                    category: 'Nutritional Optimization',
                    recommendation: 'Focus on whole foods diet, ensure adequate protein (0.8-1g/kg body weight), and consider omega-3 supplementation (1000-2000mg EPA/DHA).'
                });
            }
            
            // Mental health support
            if (scores.mental <= 2) {
                recommendations.push({
                    category: 'Mental Wellness',
                    recommendation: 'Consider cognitive behavioral therapy (CBT), practice gratitude journaling, and explore EMDR if trauma-related. Professional support may be beneficial.'
                });
            }
            
            // Physical activity
            if (scores.physical <= 2) {
                recommendations.push({
                    category: 'Physical Activity',
                    recommendation: 'Start with 150 minutes moderate activity weekly, include 2 strength training sessions, and focus on compound movements like squats and pushups.'
                });
            }
            
            // Social connections
            if (scores.social <= 2) {
                recommendations.push({
                    category: 'Social Connection',
                    recommendation: 'Prioritize meaningful relationships, join communities aligned with your interests, and consider volunteering to build connections while helping others.'
                });
            }
            
            // Overall life satisfaction
            if (scores.overall <= 2) {
                recommendations.push({
                    category: 'Life Satisfaction',
                    recommendation: 'Work with a coach or therapist on goal setting, values clarification, and life purpose exploration. Consider holistic approaches to well-being.'
                });
            }
            
            // Always include at least one positive recommendation
            if (recommendations.length === 0) {
                recommendations.push({
                    category: 'Wellness Maintenance',
                    recommendation: 'Continue your excellent health practices! Consider optimizing further with advanced biometric tracking and periodic health assessments.'
                });
            }
            
            // Social connections
            if (scores.social <= 2) {
                recommendations.push({
                    category: 'Social Wellness',
                    recommendation: 'Focus on building meaningful connections. Join clubs or groups aligned with interests, schedule regular social activities, and consider therapy for social anxiety.'
                });
            }
            
            // Overall health
            if (scores.overall <= 2) {
                recommendations.push({
                    category: 'Holistic Health',
                    recommendation: 'Consider comprehensive health assessment, focus on integrative approach combining physical, mental, and emotional wellness strategies.'
                });
            }
            
            return recommendations;
        }
        
        function getScoreDescription(averageScore) {
            if (averageScore >= 4.5) return 'Exceptional wellness - you\'re thriving!';
            if (averageScore >= 4) return 'Excellent health with minor optimization opportunities';
            if (averageScore >= 3.5) return 'Good health foundation with room for improvement';
            if (averageScore >= 3) return 'Moderate wellness - several areas need attention';
            if (averageScore >= 2.5) return 'Below average - significant improvements needed';
            if (averageScore >= 2) return 'Poor health status - professional support recommended';
            return 'Critical health concerns - immediate professional help advised';
        }
        
        function storeAssessmentResults(results) {
            window.lastAssessmentResults = results;
            console.log('üíæ Assessment results stored for coaching integration');
        }
        
        // Hume EVI Voice Therapy Integration
        let isHumeConnected = false;
        let humeWebSocket = null;
        let audioStream = null;
        let mediaRecorder = null;
        let connectionTimeout = null;
        
        // Emergency backup voice session functions
        window.startVoiceConversation = async function() {
            console.log('üéôÔ∏è Starting voice conversation with Coach David...');
            console.log('üîß Using EMERGENCY version of voice conversation function');
            
            const statusEl = document.getElementById('conversation-status');
            const substatusEl = document.getElementById('conversation-substatus');
            const btnEl = document.getElementById('start-conversation-btn');
            const endBtn = document.getElementById('end-conversation-btn');
            
            if (statusEl) statusEl.textContent = 'Connecting to Coach David...';
            if (substatusEl) substatusEl.textContent = 'Setting up secure voice session with Hume EVI';
            if (btnEl) {
                btnEl.disabled = true;
                btnEl.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
            }
            
            try {
                console.log('üéØ Step 1: Getting OAuth2 token from Hume AI...');
                
                // Get OAuth2 token
                const tokenResponse = await fetch('https://api.hume.ai/oauth2-cc/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'grant_type': 'client_credentials',
                        'client_id': 'si8yIRYvcFUMUIsiM3RzlNQhAp09a6gUkce6Tjt7R34XTHAo',
                        'client_secret': 'mRDCEm0XyDchucUKs7aGR6mTSgAHFWrhaDrM5hvh5idWrGB4x41jbZozD9Y8LB3b'
                    })
                });
                
                const tokenData = await tokenResponse.json();
                console.log('‚úÖ OAuth2 token received:', tokenData.access_token ? 'Success' : 'Failed');
                
                if (!tokenData.access_token) {
                    throw new Error('Failed to get access token');
                }
                
                console.log('üéØ Step 2: Getting microphone permission...');
                
                // Get microphone permission and stream
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000
                    }
                });
                console.log('‚úÖ Microphone access granted');
                
                console.log('üéØ Step 3: Connecting to Hume EVI WebSocket...');
                
                // Connect to Hume EVI WebSocket
                const CONFIG_ID = 'f4a87ae9-eafb-4133-b772-33a1b9d0eb03';
                humeWebSocket = new WebSocket(`wss://api.hume.ai/v0/evi/chat?access_token=${tokenData.access_token}&config_id=${CONFIG_ID}`);
                
                connectionTimeout = setTimeout(() => {
                    console.error('‚è∞ WebSocket connection timeout (15s)');
                    if (humeWebSocket.readyState !== WebSocket.OPEN) {
                        humeWebSocket.close();
                    }
                }, 15000);
                
                humeWebSocket.onopen = () => {
                    console.log('üîå Hume EVI WebSocket connected successfully');
                    clearTimeout(connectionTimeout);
                    isHumeConnected = true;
                    
                    // Update UI to show connected state
                    if (statusEl) statusEl.textContent = 'Connected to Coach David';
                    if (substatusEl) substatusEl.textContent = 'Voice session active - speak naturally';
                    
                    // Hide start button, show end call button (phone-style UI)
                    if (btnEl) {
                        btnEl.style.display = 'none';
                        btnEl.classList.add('hidden');
                    }
                    
                    if (endBtn) {
                        endBtn.style.display = 'flex'; // flex for centered icon
                        endBtn.classList.remove('hidden');
                    }
                    
                    // Show call status
                    const callStatus = document.getElementById('call-status');
                    if (callStatus) {
                        callStatus.classList.remove('hidden');
                        
                        // Start call timer
                        window.callTimer = setInterval(() => {
                            const timerEl = document.getElementById('call-timer');
                            if (timerEl) {
                                const startTime = window.callStartTime || Date.now();
                                const elapsed = Date.now() - startTime;
                                const minutes = Math.floor(elapsed / 60000);
                                const seconds = Math.floor((elapsed % 60000) / 1000);
                                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            }
                        }, 1000);
                        
                        window.callStartTime = Date.now();
                    }
                    
                    // Start audio streaming
                    startAudioStreaming();
                };
                
                humeWebSocket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('üì® Hume EVI message received:', {
                            type: message.type,
                            timestamp: new Date().toLocaleTimeString(),
                            data: message
                        });
                        
                        if (message.type === 'assistant_message') {
                            console.log('ü§ñ David says:', message.message?.content || message.content);
                            // Audio is handled by Hume EVI directly
                        } else if (message.type === 'user_message') {
                            console.log('üë§ User said:', message.message?.content || message.content);
                        } else if (message.type === 'error') {
                            console.error('‚ùå Hume EVI error:', message.error || message);
                        } else {
                            console.log('‚ÑπÔ∏è Other message type:', message.type, message);
                        }
                    } catch (e) {
                        console.error('‚ùå Error parsing Hume message:', e, event.data);
                    }
                };
                
                humeWebSocket.onclose = (event) => {
                    console.log('üîå Hume EVI WebSocket disconnected:', {
                        code: event.code,
                        reason: event.reason,
                        wasClean: event.wasClean,
                        timestamp: new Date().toLocaleTimeString()
                    });
                    
                    // Decode common WebSocket close codes
                    const closeReasons = {
                        1000: 'Normal closure',
                        1001: 'Going away',
                        1002: 'Protocol error',
                        1003: 'Unsupported data',
                        1005: 'No status code',
                        1006: 'Abnormal closure',
                        1007: 'Invalid frame payload data',
                        1008: 'Policy violation',
                        1009: 'Message too big',
                        1010: 'Missing extension',
                        1011: 'Internal error',
                        1012: 'Service restart',
                        1013: 'Try again later',
                        1014: 'Bad gateway',
                        1015: 'TLS handshake fail'
                    };
                    
                    console.log('üìã Close reason:', closeReasons[event.code] || 'Unknown');
                    
                    isHumeConnected = false;
                    clearTimeout(connectionTimeout);
                    
                    // Reset UI when connection closes unexpectedly
                    const endBtn = document.getElementById('end-conversation-btn');
                    if (endBtn && !endBtn.classList.contains('hidden')) {
                        endVoiceSession();
                    }
                };
                
                humeWebSocket.onerror = (error) => {
                    console.error('‚ùå Hume EVI WebSocket error:', {
                        error: error,
                        readyState: humeWebSocket?.readyState,
                        readyStateText: ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'][humeWebSocket?.readyState] || 'UNKNOWN',
                        timestamp: new Date().toLocaleTimeString()
                    });
                    
                    console.error('üîç Possible causes:');
                    console.error('   1. Invalid access token from OAuth2');
                    console.error('   2. Hume EVI service unavailable');
                    console.error('   3. Network connectivity issues');
                    console.error('   4. WebSocket endpoint URL incorrect');
                    
                    clearTimeout(connectionTimeout);
                    
                    // Clean up UI properly on error
                    const endBtn = document.getElementById('end-conversation-btn');
                    if (endBtn) {
                        endBtn.style.display = 'none';
                        endBtn.classList.add('hidden');
                    }
                    
                    if (statusEl) statusEl.textContent = '‚ùå WebSocket Connection Failed';
                    if (substatusEl) substatusEl.innerHTML = `
                        <div class="text-amber-300 text-sm">
                            <p>üöß Could not establish WebSocket connection to Hume EVI</p>
                            <p class="text-xs text-gray-400 mt-1">This usually indicates CORS policy restrictions</p>
                        </div>
                    `;
                    if (btnEl) {
                        btnEl.style.display = 'block';
                        btnEl.disabled = false;
                        btnEl.innerHTML = '<i class="fas fa-microphone mr-2"></i>Retry Connection';
                        btnEl.onclick = launchCoachDavidWidget;
                    }
                };
                
            } catch (error) {
                console.error('‚ùå Voice session error:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    timestamp: new Date().toLocaleTimeString()
                });
                // Provide user-friendly CORS explanation
                if (statusEl) statusEl.textContent = 'üöß Browser Security Restriction (CORS)';
                if (substatusEl) substatusEl.innerHTML = `
                    <div class="text-amber-300 text-sm">
                        <p class="mb-2">‚ö†Ô∏è <strong>Hume EVI requires server-side authentication</strong></p>
                        <p class="mb-1">This is a browser security limitation, not a code issue.</p>
                        <p class="text-xs text-gray-400">‚úÖ All other platform features work perfectly!</p>
                        <p class="text-xs text-gray-400 mt-2">Error: ${error.message}</p>
                    </div>
                `;
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.innerHTML = '<i class="fas fa-microphone mr-2"></i>Try Again';
                    btnEl.onclick = launchCoachDavidWidget;
                }
            }
        }
        
        function startAudioStreaming() {
            if (!audioStream || !humeWebSocket) {
                console.error('‚ùå Cannot start audio streaming - missing audioStream or WebSocket');
                return;
            }
            
            try {
                console.log('üéôÔ∏è Starting audio streaming setup...');
                console.log('üîä Available audio tracks:', audioStream.getAudioTracks());
                
                // Check if browser supports required audio format
                const supportedTypes = [
                    'audio/webm;codecs=opus',
                    'audio/webm',
                    'audio/mp4',
                    'audio/ogg;codecs=opus'
                ];
                
                let selectedMimeType = null;
                for (const type of supportedTypes) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        selectedMimeType = type;
                        console.log('‚úÖ Using supported audio format:', type);
                        break;
                    }
                }
                
                if (!selectedMimeType) {
                    throw new Error('No supported audio format found');
                }
                
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: selectedMimeType
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && humeWebSocket.readyState === WebSocket.OPEN) {
                        console.log('üì§ Sending audio chunk:', event.data.size, 'bytes');
                        humeWebSocket.send(event.data);
                    }
                };
                
                mediaRecorder.onerror = (error) => {
                    console.error('‚ùå MediaRecorder error:', error);
                };
                
                mediaRecorder.start(100); // Send chunks every 100ms
                console.log('‚úÖ Audio streaming to Hume EVI started');
                
            } catch (error) {
                console.error('‚ùå Error starting audio streaming:', error);
            }
        }
        
        function endVoiceSession() {
            console.log('üõë Ending voice session with David...');
            
            // Clean up Hume SDK client (preferred method)
            if (window.currentHumeClient) {
                try {
                    window.currentHumeClient.disconnect();
                    console.log('‚úÖ Hume SDK client disconnected');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error disconnecting Hume SDK:', error);
                }
                window.currentHumeClient = null;
            }
            
            // Clean up direct API WebSocket connection (fallback method)
            if (humeWebSocket) {
                humeWebSocket.close();
                humeWebSocket = null;
            }
            
            // Clean up media recorder
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder = null;
            }
            
            // Clean up audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            
            // Clean up call timer
            if (window.callTimer) {
                clearInterval(window.callTimer);
                window.callTimer = null;
            }
            
            isHumeConnected = false;
            
            // Update phone-style UI
            const statusEl = document.getElementById('conversation-status');
            const substatusEl = document.getElementById('conversation-substatus');
            const btnEl = document.getElementById('start-conversation-btn');
            const endBtn = document.getElementById('end-conversation-btn');
            const callStatus = document.getElementById('call-status');
            
            if (statusEl) statusEl.textContent = 'Session with Coach David ended';
            if (substatusEl) substatusEl.textContent = 'Thank you for your session. Take care of yourself.';
            
            // Show start call button, hide end call button (phone-style)
            if (btnEl) {
                btnEl.style.display = 'flex'; // flex for centered icon
                btnEl.classList.remove('hidden');
                btnEl.disabled = false;
            }
            
            if (endBtn) {
                endBtn.style.display = 'none';
                endBtn.classList.add('hidden');
            }
            
            // Hide call status
            if (callStatus) {
                callStatus.classList.add('hidden');
            }
            
            // Reset to initial state after a few seconds
            setTimeout(() => {
                if (statusEl) statusEl.textContent = 'Ready to start your therapeutic session';
                if (substatusEl) substatusEl.textContent = 'Click below to begin voice therapy with Coach David using Hume EVI';
            }, 3000);
            
            console.log('‚úÖ Session cleanup complete');
        }
        
        // PTSD THERAPY TOOLS
        // This is the end of the voice session functions
        // Coach chat functions start next
        
        async function startChatWithCoach(coachId) {
            // First navigate to coaches section
            navigateToSection('coaches');
            
            currentCoach = coaches[coachId];
            if (!currentCoach) return;
            
            console.log('üí¨ Starting chat with', currentCoach.name);
            
            // Setup chat interface
            const chatInterface = document.getElementById('chat-interface');
            const coachAvatar = document.getElementById('coach-avatar');
            const coachName = document.getElementById('coach-name');
            const coachSpecialty = document.getElementById('coach-specialty');
            
            // Update coach info
            coachAvatar.className = currentCoach.avatar;
            coachAvatar.innerHTML = `<i class=\"${currentCoach.icon}\"></i>`;
            coachName.textContent = currentCoach.name;
            coachSpecialty.textContent = currentCoach.specialty;
            
            // Clear chat history
            chatHistory = [];
            
            // Show interface
            chatInterface.classList.remove('hidden');
            
            // Check if coming from assessment
            if (window.lastAssessmentResults) {
                showAssessmentPrescription();
            }
            
            // Send initial greeting
            await sendChatMessage(null, true);
        }
        
        function showAssessmentPrescription() {
            if (!window.lastAssessmentResults) return;
            
            const prescriptionContainer = document.getElementById('assessment-prescription');
            const prescriptionContent = document.getElementById('prescription-content');
            
            // Implementation would go here
            console.log('üìã Assessment prescription display');
        }
        
        // PTSD THERAPY TOOLS
        let emdrInterval;
        let hypnoInterval;
        
        function showEMDRTools() {
            console.log('üß† Starting EMDR session...');
            
            // Show EMDR interface
            document.getElementById('emdr-session').classList.remove('hidden');
            document.getElementById('emdr-start-btn').style.display = 'none';
            
            // Start EMDR dot animation
            const dot = document.getElementById('emdr-dot');
            let position = 0;
            const containerWidth = 300; // Approximate container width
            
            emdrInterval = setInterval(() => {
                position = position === 0 ? containerWidth : 0;
                dot.style.left = position + 'px';
            }, 2000); // 2 second intervals for therapeutic effect
        }
        
        function stopEMDR() {
            console.log('üõë Stopping EMDR session...');
            
            if (emdrInterval) {
                clearInterval(emdrInterval);
                emdrInterval = null;
            }
            
            document.getElementById('emdr-session').classList.add('hidden');
            document.getElementById('emdr-start-btn').style.display = 'block';
            document.getElementById('emdr-dot').style.left = '0px';
        }
        
        function showHypnotherapyTools() {
            console.log('üåô Starting REAL Hypnotherapy session with audio...');
            
            // Show hypnotherapy interface
            document.getElementById('hypno-session').classList.remove('hidden');
            document.getElementById('hypno-start-btn').style.display = 'none';
            
            // Professional hypnotherapy guided messages with audio
            const hypnoTexts = [
                "Take a slow, deep breath in through your nose... and let it out slowly through your mouth. Allow yourself to relax completely.",
                "Feel your shoulders and arms becoming loose and heavy... let all the tension melt away from your upper body.",
                "Notice your breathing becoming slower and more peaceful... each breath taking you deeper into relaxation.",
                "Allow your mind to become calm and centered... release any thoughts that no longer serve you.",
                "You are safe and completely at peace in this moment... surrounded by healing energy.",
                "Imagine yourself in a beautiful, peaceful place... perhaps a serene beach or quiet forest clearing.",
                "Feel the warmth and comfort surrounding you... healing light filling every cell of your body.",
                "You have the inner strength to heal and grow... trust in your natural ability to overcome challenges.",
                "As we conclude, take a moment to appreciate this feeling of deep peace and relaxation.",
                "When you're ready, slowly return to full awareness, feeling refreshed and renewed."
            ];
            
            let index = 0;
            const textEl = document.getElementById('hypno-text');
            
            // Initialize speech synthesis
            const synth = window.speechSynthesis;
            
            function speakHypnoText(text) {
                // Cancel any ongoing speech
                synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Configure for natural therapeutic speech
                utterance.rate = 1.0;  // Normal speaking pace - more natural
                utterance.pitch = 1.0; // Natural pitch - less robotic
                utterance.volume = 0.9; // Clear, audible volume
                
                // Try to use the most natural, human-like voice
                const voices = synth.getVoices();
                
                // Priority order for most human-like voices
                const preferredVoiceNames = [
                    'Samantha', 'Alex', 'Victoria', 'Daniel', 'Karen', 'Moira', 
                    'Tessa', 'Ava', 'Allison', 'Susan', 'Zarvox', 'Fred'
                ];
                
                let selectedVoice = null;
                
                // Try to find preferred natural voices first
                for (const voiceName of preferredVoiceNames) {
                    selectedVoice = voices.find(voice => 
                        voice.name.toLowerCase().includes(voiceName.toLowerCase()) && 
                        voice.lang.includes('en')
                    );
                    if (selectedVoice) break;
                }
                
                // If no preferred voice found, look for any natural English voice
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-US') || voice.lang.includes('en-GB')
                    );
                }
                
                // Final fallback
                if (!selectedVoice && voices.length > 0) {
                    selectedVoice = voices[0];
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                console.log('üéôÔ∏è Speaking hypnotherapy text:', text.substring(0, 50) + '...');
                console.log('üîä Using voice:', utterance.voice ? utterance.voice.name : 'default');
                
                synth.speak(utterance);
                
                return utterance;
            }
            
            function nextHypnoStep() {
                if (index < hypnoTexts.length && hypnoInterval) {
                    const currentText = hypnoTexts[index];
                    
                    // Update text display
                    if (textEl) textEl.textContent = currentText;
                    
                    // Speak the text
                    const utterance = speakHypnoText(currentText);
                    
                    // Wait for speech to complete before moving to next
                    utterance.onend = () => {
                        console.log('‚úÖ Hypnotherapy step', index + 1, 'completed');
                        index++;
                        
                        // Wait 2 seconds after speech before next step
                        if (index < hypnoTexts.length && hypnoInterval) {
                            setTimeout(nextHypnoStep, 2000);
                        } else {
                            // Session complete
                            setTimeout(() => {
                                if (hypnoInterval) { // Check if session wasn't manually stopped
                                    stopHypno();
                                }
                            }, 3000);
                        }
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('‚ùå Speech synthesis error:', event.error);
                        // Continue to next step even if speech fails
                        index++;
                        if (index < hypnoTexts.length && hypnoInterval) {
                            setTimeout(nextHypnoStep, 4000);
                        } else {
                            setTimeout(() => {
                                if (hypnoInterval) {
                                    stopHypno();
                                }
                            }, 3000);
                        }
                    };
                } else {
                    // Session complete or stopped
                    if (hypnoInterval) {
                        stopHypno();
                    }
                }
            }
            
            // Start the hypnotherapy session
            hypnoInterval = true; // Use as a flag to track if session is active
            
            // Wait for voices to load if needed
            if (synth.getVoices().length === 0) {
                synth.addEventListener('voiceschanged', () => {
                    if (hypnoInterval) {
                        nextHypnoStep();
                    }
                }, { once: true });
            } else {
                nextHypnoStep();
            }
        }
        
        function stopHypno() {
            console.log('üõë Stopping hypnotherapy session...');
            
            // Stop the session
            hypnoInterval = null;
            
            // Stop any ongoing speech
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                console.log('üîá Speech synthesis stopped');
            }
            
            // Hide session interface
            document.getElementById('hypno-session').classList.add('hidden');
            document.getElementById('hypno-start-btn').style.display = 'block';
            
            // Reset text display
            const textEl = document.getElementById('hypno-text');
            if (textEl) textEl.textContent = 'Take a deep breath and allow yourself to relax completely...';
            
            console.log('‚úÖ Hypnotherapy session ended');
        }
        
        // REAL KNOWLEDGE LIBRARY WITH DETAILED ARTICLES
        function exploreCategory(category) {
            console.log('üìö Opening live AI-powered library for category:', category);
            
            // Create and show modal with dynamic loading
            showResearchModal(category);
            
            // Load live content
            loadCategoryContent(category);
        }
        
        function showResearchModal(category) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('research-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'research-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-8 max-w-6xl mx-4 w-full max-h-[90vh] overflow-y-auto border border-slate-600">
                        <div class="flex justify-between items-center mb-6">
                            <h2 id="research-modal-title" class="text-3xl font-bold text-slate-100">Research Library</h2>
                            <button onclick="closeResearchModal()" class="text-slate-400 hover:text-white text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="research-modal-content" class="text-slate-300">
                            <!-- Content will be populated here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Get category content
            const content = getResearchContent(category);
            
            // Update modal content
            document.getElementById('research-modal-title').textContent = content.title;
            document.getElementById('research-modal-content').innerHTML = content.html;
            
            // Show modal
            modal.classList.remove('hidden');
        }
        
        // ===== LIVE API-CONNECTED KNOWLEDGE LIBRARY =====
        
        async function fetchLiveContent(category, subcategory = null) {
            console.log(`üîÑ Fetching live content for ${category}${subcategory ? `/${subcategory}` : ''}`);
            
            try {
                // Use RSS feeds and news APIs for live content
                const queries = {
                    'nutrition': ['nutrition research', 'dietary guidelines', 'healthy eating', 'nutritional science'],
                    'mental-health': ['mental health research', 'psychology studies', 'therapy effectiveness', 'depression treatment'],
                    'sleep': ['sleep research', 'sleep science', 'circadian rhythm', 'sleep disorders'],
                    'exercise': ['exercise science', 'fitness research', 'physical activity health', 'workout benefits'],
                    'stress': ['stress management', 'mindfulness research', 'stress reduction', 'meditation studies'],
                    'integrative': ['holistic health', 'alternative medicine', 'integrative therapy', 'complementary medicine']
                };
                
                const searchTerms = queries[category] || [category];
                const randomTerm = searchTerms[Math.floor(Math.random() * searchTerms.length)];
                
                // Fetch from multiple sources
                const newsResults = await fetchHealthNews(randomTerm);
                const researchResults = await fetchResearchArticles(category);
                
                return {
                    news: newsResults,
                    research: researchResults,
                    lastUpdated: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('‚ùå Error fetching live content:', error);
                return getFallbackContent(category);
            }
        }
        
        async function fetchHealthNews(searchTerm) {
            try {
                // Use NewsAPI or similar service (you'll need to replace with your API key)
                const response = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(searchTerm + ' health')}&language=en&sortBy=publishedAt&pageSize=5&apiKey=YOUR_NEWS_API_KEY`);
                
                if (!response.ok) {
                    throw new Error('News API not available');
                }
                
                const data = await response.json();
                return data.articles.map(article => ({
                    title: article.title,
                    description: article.description,
                    url: article.url,
                    publishedAt: article.publishedAt,
                    source: article.source.name,
                    urlToImage: article.urlToImage
                }));
                
            } catch (error) {
                console.log('üì∞ Using RSS fallback for news');
                return await fetchRSSFeed(searchTerm);
            }
        }
        
        async function fetchRSSFeed(searchTerm) {
            try {
                // Use a CORS-enabled RSS proxy
                const rssFeeds = {
                    'nutrition': 'https://rss-proxy.herokuapp.com/api/?url=https://www.nutrition.gov/rss.xml',
                    'health': 'https://rss-proxy.herokuapp.com/api/?url=https://feeds.webmd.com/rss/rss.aspx?RSSSource=RSS_PUBLIC'
                };
                
                const feedUrl = rssFeeds['health']; // Default to health feed
                const response = await fetch(feedUrl);
                
                if (!response.ok) throw new Error('RSS not available');
                
                const data = await response.json();
                return data.items.slice(0, 5).map(item => ({
                    title: item.title,
                    description: item.description,
                    url: item.link,
                    publishedAt: item.pubDate,
                    source: 'Health RSS Feed'
                }));
                
            } catch (error) {
                console.log('üì∞ RSS unavailable, using AI-generated content');
                return generateAIContent(searchTerm);
            }
        }
        
        async function fetchResearchArticles(category) {
            try {
                // Use PubMed API or similar
                const pubmedQuery = encodeURIComponent(`${category} research clinical trial`);
                const response = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${pubmedQuery}&retmax=5&retmode=json`);
                
                if (!response.ok) throw new Error('PubMed API not available');
                
                const searchData = await response.json();
                const ids = searchData.esearchresult.idlist;
                
                if (ids.length > 0) {
                    const detailsResponse = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`);
                    const details = await detailsResponse.json();
                    
                    return ids.map(id => {
                        const article = details.result[id];
                        return {
                            title: article.title,
                            authors: article.authors,
                            journal: article.fulljournalname,
                            pubdate: article.pubdate,
                            pmid: id,
                            url: `https://pubmed.ncbi.nlm.nih.gov/${id}/`
                        };
                    });
                }
                
            } catch (error) {
                console.log('üî¨ PubMed unavailable, using curated research');
                return getCuratedResearch(category);
            }
            
            return [];
        }
        
        async function generateAIContent(topic) {
            // Use Groq API to generate relevant health content
            try {
                if (window.groqConnector && window.groqConnector.isConnected) {
                    const prompt = `Generate 3 recent health news headlines about ${topic} with brief descriptions. Format as JSON array with title, description, and source fields.`;
                    
                    const response = await window.groqConnector.sendMessage(prompt);
                    
                    // Parse AI response into structured data
                    try {
                        const aiContent = JSON.parse(response);
                        return aiContent.map(item => ({
                            title: item.title,
                            description: item.description,
                            source: item.source || 'AI Health Assistant',
                            publishedAt: new Date().toISOString(),
                            url: '#',
                            aiGenerated: true
                        }));
                    } catch (parseError) {
                        console.log('Using structured AI response');
                        return [{
                            title: `Latest Research in ${topic.charAt(0).toUpperCase() + topic.slice(1)}`,
                            description: response.substring(0, 200) + '...',
                            source: 'AI Health Assistant',
                            publishedAt: new Date().toISOString(),
                            url: '#',
                            aiGenerated: true
                        }];
                    }
                }
            } catch (error) {
                console.error('AI content generation failed:', error);
            }
            
            return getFallbackNews(topic);
        }
        
        function getFallbackContent(category) {
            // Minimal fallback content when all APIs fail
            const fallbacks = {
                'nutrition': {
                    title: 'Latest Nutrition Research',
                    description: 'Evidence-based nutrition information and dietary guidelines.',
                    source: 'Health Library'
                },
                'mental-health': {
                    title: 'Mental Health Research Updates',
                    description: 'Recent developments in psychological research and therapy.',
                    source: 'Mental Health Library'
                },
                'sleep': {
                    title: 'Sleep Science Insights',
                    description: 'Current research on sleep optimization and disorders.',
                    source: 'Sleep Research Library'
                }
            };
            
            const fallback = fallbacks[category] || fallbacks['nutrition'];
            return {
                news: [fallback],
                research: [],
                lastUpdated: new Date().toISOString()
            };
        }
        
        function getCuratedResearch(category) {
            // Curated high-quality research as fallback
            const research = {
                'nutrition': [
                    {
                        title: 'Mediterranean Diet and Cardiovascular Health: A Systematic Review',
                        journal: 'American Journal of Clinical Nutrition',
                        pmid: '32453792',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/32453792/'
                    }
                ],
                'mental-health': [
                    {
                        title: 'Cognitive Behavioral Therapy for Depression: A Meta-Analysis',
                        journal: 'Journal of Clinical Psychology',
                        pmid: '33124123',
                        url: 'https://pubmed.ncbi.nlm.nih.gov/33124123/'
                    }
                ]
            };
            
            return research[category] || [];
        }
        
        function getFallbackNews(topic) {
            return [{
                title: `${topic.charAt(0).toUpperCase() + topic.slice(1)} Health Update`,
                description: 'Stay informed with the latest evidence-based health information.',
                source: 'Health Information Center',
                publishedAt: new Date().toISOString(),
                url: '#'
            }];
        }
        
        function getResearchContent(categoryId) {
            // Return dynamic loading content that will be replaced by live data
            const content = {
                'nutrition': {
                    title: 'ü•ó Live Nutrition Intelligence Hub',
                    html: `
                        <div class="space-y-6">
                            <!-- Navigation Tabs -->
                            <div class="flex flex-wrap gap-2 mb-6">
                                <button onclick="showNutritionTab('lookup')" id="tab-lookup" class="nutrition-tab active-tab px-4 py-2 rounded-full bg-green-600 text-white font-medium">
                                    üîç Food Lookup
                                </button>
                                <button onclick="showNutritionTab('calculator')" id="tab-calculator" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                    üìä Meal Calculator
                                </button>
                                <button onclick="showNutritionTab('news')" id="tab-news" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                    üì∞ Health News
                                </button>
                                <button onclick="showNutritionTab('advice')" id="tab-advice" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                    üí° Nutrition Advice
                                </button>
                                <button onclick="showNutritionTab('research')" id="tab-research" class="nutrition-tab px-4 py-2 rounded-full bg-slate-600 text-slate-300 font-medium hover:bg-slate-500">
                                    üìö Research
                                </button>
                            </div>

                            <!-- Food Lookup Tab -->
                            <div id="nutrition-lookup" class="nutrition-content" style="display: block;">
                                <div class="bg-slate-700 p-6 rounded-lg mb-6">
                                    <h3 class="text-xl font-bold text-green-400 mb-4">üîç Food Nutrition Lookup</h3>
                                    <div class="space-y-4">
                                        <div class="relative">
                                            <input type="text" id="food-search" placeholder="Search for food (e.g., 'banana', 'chicken breast', 'quinoa')..." 
                                                   class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500"
                                                   onkeyup="handleFoodSearch(event)">
                                            <button onclick="searchFood()" class="absolute right-2 top-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                                Search
                                            </button>
                                        </div>
                                        
                                        <div id="food-suggestions" class="hidden">
                                            <h4 class="text-slate-300 mb-2">Quick Suggestions:</h4>
                                            <div class="flex flex-wrap gap-2">
                                                <span onclick="quickFoodSearch('apple')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üçé Apple</span>
                                                <span onclick="quickFoodSearch('chicken breast')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üêî Chicken Breast</span>
                                                <span onclick="quickFoodSearch('broccoli')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">ü•¶ Broccoli</span>
                                                <span onclick="quickFoodSearch('salmon')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üêü Salmon</span>
                                                <span onclick="quickFoodSearch('quinoa')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">üåæ Quinoa</span>
                                                <span onclick="quickFoodSearch('avocado')" class="cursor-pointer px-3 py-1 bg-slate-600 text-slate-300 rounded-full text-sm hover:bg-slate-500">ü•ë Avocado</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="food-results" class="mt-6 hidden">
                                        <!-- Food results will be displayed here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Meal Calculator Tab -->
                            <div id="nutrition-calculator" class="nutrition-content hidden">
                                <div class="bg-slate-700 p-6 rounded-lg">
                                    <h3 class="text-xl font-bold text-blue-400 mb-4">üìä Daily Meal Calculator</h3>
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 class="font-semibold text-slate-200 mb-3">Add Foods to Your Meal:</h4>
                                            <div id="meal-builder" class="space-y-3">
                                                <div class="meal-item flex items-center gap-3 p-3 bg-slate-600 rounded">
                                                    <input type="text" placeholder="Food name" class="food-name flex-1 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                    <input type="number" placeholder="Amount" class="food-amount w-20 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                    <select class="food-unit px-3 py-2 bg-slate-500 text-slate-100 rounded">
                                                        <option value="g">g</option>
                                                        <option value="oz">oz</option>
                                                        <option value="cup">cup</option>
                                                        <option value="piece">piece</option>
                                                    </select>
                                                    <button onclick="removeMealItem(this)" class="text-red-400 hover:text-red-300">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <button onclick="addMealItem()" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                                + Add Food Item
                                            </button>
                                            <button onclick="calculateMeal()" class="mt-2 w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                                Calculate Nutrition
                                            </button>
                                        </div>
                                        
                                        <div>
                                            <h4 class="font-semibold text-slate-200 mb-3">Total Nutrition:</h4>
                                            <div id="meal-totals" class="bg-slate-600 p-4 rounded">
                                                <div class="grid grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <span class="text-slate-300">Calories:</span>
                                                        <span class="float-right text-white font-semibold" id="total-calories">0</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-slate-300">Protein:</span>
                                                        <span class="float-right text-white font-semibold" id="total-protein">0g</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-slate-300">Carbs:</span>
                                                        <span class="float-right text-white font-semibold" id="total-carbs">0g</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-slate-300">Fat:</span>
                                                        <span class="float-right text-white font-semibold" id="total-fat">0g</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-slate-300">Fiber:</span>
                                                        <span class="float-right text-white font-semibold" id="total-fiber">0g</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-slate-300">Sugar:</span>
                                                        <span class="float-right text-white font-semibold" id="total-sugar">0g</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Health News Tab - Dynamic Content -->
                            <div id="nutrition-news" class="nutrition-content hidden">
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-xl font-bold text-purple-400">üì∞ Live Nutrition & Health News</h3>
                                        <button onclick="refreshNutritionNews()" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-sm text-white">
                                            üîÑ Refresh
                                        </button>
                                    </div>
                                    
                                    <div id="nutrition-news-content">
                                        <div class="bg-slate-700 p-6 rounded-lg text-center">
                                            <div class="animate-spin text-2xl mb-2">‚è≥</div>
                                            <p class="text-slate-300">Loading latest nutrition news...</p>
                                        </div>
                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-slate-700 p-6 rounded-lg">
                                        <div class="flex items-start gap-4">
                                            <div class="text-2xl">üí™</div>
                                            <div>
                                                <h4 class="text-lg font-semibold text-slate-100 mb-2">Intermittent Fasting Shows Promise for Muscle Preservation</h4>
                                                <p class="text-slate-300 text-sm mb-3">Latest clinical trial demonstrates that 16:8 intermittent fasting combined with resistance training preserves muscle mass while promoting fat loss better than traditional calorie restriction.</p>
                                                <div class="flex gap-3 text-xs">
                                                    <span class="text-purple-400">Oct 2024</span>
                                                    <span class="text-slate-400">Journal of Clinical Medicine</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-slate-700 p-6 rounded-lg">
                                        <div class="flex items-start gap-4">
                                            <div class="text-2xl">ü¶†</div>
                                            <div>
                                                <h4 class="text-lg font-semibold text-slate-100 mb-2">Gut Microbiome Breakthrough: Fiber Types Matter More Than Quantity</h4>
                                                <p class="text-slate-300 text-sm mb-3">Researchers discover that diverse fiber sources (resistant starch, pectin, inulin) have different impacts on beneficial bacteria populations and metabolic health outcomes.</p>
                                                <div class="flex gap-3 text-xs">
                                                    <span class="text-purple-400">Oct 2024</span>
                                                    <span class="text-slate-400">Nature Microbiology</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Nutrition Advice Tab -->
                            <div id="nutrition-advice" class="nutrition-content hidden">
                                <div class="space-y-6">
                                    <h3 class="text-xl font-bold text-orange-400 mb-4">üí° Evidence-Based Nutrition Advice</h3>
                                    
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div class="bg-slate-700 p-6 rounded-lg">
                                            <h4 class="text-lg font-semibold text-green-400 mb-3">ü•¨ Daily Essentials</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>‚Ä¢ <strong>Vegetables:</strong> 5-9 servings, focus on variety and color</li>
                                                <li>‚Ä¢ <strong>Protein:</strong> 0.8-1.2g per kg body weight (higher if active)</li>
                                                <li>‚Ä¢ <strong>Healthy Fats:</strong> 20-35% of calories, emphasize omega-3s</li>
                                                <li>‚Ä¢ <strong>Fiber:</strong> 25-35g daily from whole foods</li>
                                                <li>‚Ä¢ <strong>Water:</strong> 8-10 glasses daily, more if exercising</li>
                                            </ul>
                                        </div>

                                        <div class="bg-slate-700 p-6 rounded-lg">
                                            <h4 class="text-lg font-semibold text-blue-400 mb-3">‚è∞ Timing Matters</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>‚Ä¢ <strong>Breakfast:</strong> Protein + complex carbs within 2 hours of waking</li>
                                                <li>‚Ä¢ <strong>Pre-workout:</strong> Carbs 30-60 min before exercise</li>
                                                <li>‚Ä¢ <strong>Post-workout:</strong> Protein + carbs within 30 minutes</li>
                                                <li>‚Ä¢ <strong>Evening:</strong> Lighter meals 2-3 hours before bed</li>
                                                <li>‚Ä¢ <strong>Hydration:</strong> Start day with water, sip regularly</li>
                                            </ul>
                                        </div>

                                        <div class="bg-slate-700 p-6 rounded-lg">
                                            <h4 class="text-lg font-semibold text-purple-400 mb-3">üéØ Weight Management</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>‚Ä¢ <strong>Calorie Balance:</strong> 500 cal deficit for 1lb/week loss</li>
                                                <li>‚Ä¢ <strong>Portion Control:</strong> Use smaller plates, eat slowly</li>
                                                <li>‚Ä¢ <strong>Satiety:</strong> Prioritize protein and fiber-rich foods</li>
                                                <li>‚Ä¢ <strong>Mindful Eating:</strong> Remove distractions during meals</li>
                                                <li>‚Ä¢ <strong>Consistency:</strong> Sustainable changes over extreme diets</li>
                                            </ul>
                                        </div>

                                        <div class="bg-slate-700 p-6 rounded-lg">
                                            <h4 class="text-lg font-semibold text-red-400 mb-3">‚ö†Ô∏è Common Mistakes</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>‚Ä¢ <strong>Skipping Meals:</strong> Leads to overeating and metabolism slowdown</li>
                                                <li>‚Ä¢ <strong>All-or-Nothing:</strong> Perfection isn't required, consistency is</li>
                                                <li>‚Ä¢ <strong>Ignoring Portions:</strong> Healthy foods still have calories</li>
                                                <li>‚Ä¢ <strong>Liquid Calories:</strong> Sodas, juices add up quickly</li>
                                                <li>‚Ä¢ <strong>Supplement Over-reliance:</strong> Food first, supplements as backup</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="bg-gradient-to-r from-green-800/30 to-blue-800/30 p-6 rounded-lg border border-green-600/50">
                                        <h4 class="text-lg font-semibold text-green-300 mb-3">üèÜ Pro Tips for Success</h4>
                                        <div class="grid md:grid-cols-3 gap-4 text-sm">
                                            <div>
                                                <h5 class="font-semibold text-green-200 mb-2">Meal Prep:</h5>
                                                <ul class="text-green-100 space-y-1">
                                                    <li>‚Ä¢ Batch cook proteins</li>
                                                    <li>‚Ä¢ Pre-cut vegetables</li>
                                                    <li>‚Ä¢ Portion healthy snacks</li>
                                                    <li>‚Ä¢ Plan weekly menus</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <h5 class="font-semibold text-blue-200 mb-2">Smart Shopping:</h5>
                                                <ul class="text-blue-100 space-y-1">
                                                    <li>‚Ä¢ Shop perimeter first</li>
                                                    <li>‚Ä¢ Read nutrition labels</li>
                                                    <li>‚Ä¢ Buy seasonal produce</li>
                                                    <li>‚Ä¢ Stock healthy staples</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <h5 class="font-semibold text-purple-200 mb-2">Long-term Success:</h5>
                                                <ul class="text-purple-100 space-y-1">
                                                    <li>‚Ä¢ Track progress, not perfection</li>
                                                    <li>‚Ä¢ Find enjoyable activities</li>
                                                    <li>‚Ä¢ Build support systems</li>
                                                    <li>‚Ä¢ Celebrate small wins</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Research Tab (Keep existing research) -->
                            <div id="nutrition-research" class="nutrition-content hidden">
                                <div class="space-y-8">
                                    <h3 class="text-xl font-bold text-green-400 mb-4">üìö Nutrition Research & Studies</h3>
                                    
                                    <div class="bg-slate-700 p-6 rounded-lg">
                                        <h4 class="text-xl font-bold text-green-400 mb-3">üçè Mediterranean Diet and Cardiovascular Health</h4>
                                        <p class="text-slate-300 mb-4">Estruch, R. et al. (2018). Primary Prevention of Cardiovascular Disease with a Mediterranean Diet Supplemented with Extra-Virgin Olive Oil or Nuts. <em>New England Journal of Medicine, 378</em>(25), e34.</p>
                                        <p class="mb-4">
                                            <button onclick="openInAppArticle('nejm-mediterranean-diet', 'NEJM Mediterranean Diet Study', 'https://www.nejm.org/doi/full/10.1056/NEJMoa1800389')" class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm font-medium">
                                                <i class="fas fa-book-open mr-2"></i>Read Full Article
                                            </button>
                                            <span class="mx-3 text-slate-500">|</span>
                                            <button onclick="openInAppArticle('mediterranean-diet-cardiovascular', 'Mediterranean Diet and Cardiovascular Health', 'https://pubmed.ncbi.nlm.nih.gov/29897866/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                                <i class="fas fa-search mr-2"></i>View Study
                                            </button>
                                        </p>
                                        <div class="bg-slate-600 p-4 rounded mb-4">
                                            <h5 class="font-semibold text-slate-100 mb-2">Key Findings:</h5>
                                            <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                                <li>30% reduction in major cardiovascular events</li>
                                                <li>Significant improvement in HDL cholesterol levels</li>
                                                <li>Reduced inflammatory markers (CRP, IL-6)</li>
                                                <li>Better insulin sensitivity and glucose control</li>
                                            </ul>
                                        </div>
                                        <p class="text-slate-400 text-sm"><strong>Study Size:</strong> 7,447 participants | <strong>Duration:</strong> 4.8 years | <strong>Level:</strong> Randomized Controlled Trial</p>
                                    </div>
                                    
                                    <div class="bg-slate-700 p-6 rounded-lg">
                                        <h4 class="text-xl font-bold text-green-400 mb-3">ü•ú Intermittent Fasting and Metabolic Health</h4>
                                        <p class="text-slate-300 mb-4">Longo, V.D., & Mattson, M.P. (2014). Fasting: molecular mechanisms and clinical applications. <em>Cell Metabolism, 19</em>(2), 181-192.</p>
                                        <p class="mb-4">
                                            <button onclick="openInAppArticle('cell-metabolism-study', 'Cell Metabolism Research', 'https://www.cell.com/cell-metabolism/fulltext/S1550-4131(14)00224-7')" class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm font-medium">
                                                <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                            </a>
                                            <span class="mx-3 text-slate-500">|</span>
                                            <button onclick="openInAppArticle('intermittent-fasting-study', 'Intermittent Fasting and Metabolic Health', 'https://pubmed.ncbi.nlm.nih.gov/24440038/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                                <i class="fas fa-search mr-2"></i>View Study
                                            </button>
                                        </p>
                                        <div class="bg-slate-600 p-4 rounded mb-4">
                                            <h5 class="font-semibold text-slate-100 mb-2">Clinical Benefits:</h5>
                                            <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                                <li>Improved insulin sensitivity (up to 20-31% improvement)</li>
                                                <li>Enhanced autophagy and cellular repair</li>
                                                <li>Reduced inflammation and oxidative stress</li>
                                                <li>Weight loss averaging 3-8% body weight</li>
                                            </ul>
                                        </div>
                                        <p class="text-slate-400 text-sm"><strong>Meta-analysis of:</strong> 40+ studies | <strong>Evidence Level:</strong> Grade A</p>
                                    </div>
                                    
                                    <div class="bg-green-800/30 p-6 rounded-lg border border-green-600">
                                        <h4 class="font-bold text-green-300 mb-3">Research Summary & Clinical Applications</h4>
                                        <div class="grid md:grid-cols-2 gap-4">
                                            <div>
                                                <h5 class="font-semibold text-green-200 mb-2">Evidence-Based Recommendations:</h5>
                                                <ul class="text-green-100 text-sm space-y-1">
                                                    <li>‚Ä¢ Emphasize whole, minimally processed foods</li>
                                                    <li>‚Ä¢ Include 2-3 servings of fatty fish weekly</li>
                                                    <li>‚Ä¢ Consider 16:8 intermittent fasting protocol</li>
                                                    <li>‚Ä¢ Supplement with high-quality omega-3s</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <h5 class="font-semibold text-green-200 mb-2">Clinical Outcomes:</h5>
                                                <ul class="text-green-100 text-sm space-y-1">
                                                    <li>‚Ä¢ Cardiovascular risk reduction: 25-30%</li>
                                                    <li>‚Ä¢ Metabolic improvement: 15-25%</li>
                                                    <li>‚Ä¢ Cognitive protection: 30-40%</li>
                                                    <li>‚Ä¢ Inflammatory marker reduction: 20-35%</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                'mental-health': {
                    title: 'üß† Live Mental Health Research',
                    html: `
                        <div class="space-y-8">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-blue-400 mb-3">üß† CBT Efficacy for Depression and Anxiety</h3>
                                <p class="text-slate-300 mb-4">Hofmann, S.G., Asnaani, A., Vonk, I.J., Sawyer, A.T., & Fang, A. (2012). The efficacy of cognitive behavioral therapy: A review of meta-analyses. <em>Cognitive Therapy and Research, 36</em>(5), 427-440.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('springer-cognitive-study', 'Springer Cognitive Research', 'https://link.springer.com/article/10.1007/s10608-012-9476-1')" class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm font-medium">
                                        <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                    </a>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('mindfulness-brain-study', 'Mindfulness and Brain Structure Changes', 'https://pubmed.ncbi.nlm.nih.gov/23008119/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Treatment Outcomes:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Depression remission rates: 60-70% (vs 20-30% placebo)</li>
                                        <li>Anxiety disorder improvement: 70-80% success rate</li>
                                        <li>PTSD symptom reduction: 83% of patients show improvement</li>
                                        <li>Long-term efficacy maintained at 1-2 year follow-up</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Meta-analysis of:</strong> 269 studies, 16,000+ participants | <strong>Effect Size:</strong> Cohen's d = 0.68-1.03</p>
                            </div>
                            
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-blue-400 mb-3">üëÅÔ∏è EMDR for Trauma Processing</h3>
                                <p class="text-slate-300 mb-4">Chen, Y.R., Hung, K.W., Tsai, J.C., Chu, H., Chung, M.H., Chen, S.R., et al. (2014). Efficacy of eye-movement desensitization and reprocessing for patients with posttraumatic-stress disorder. <em>PLoS One, 9</em>(8), e103676.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('plos-emdr-study', 'PLOS EMDR Efficacy Study', 'https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0103676')" class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm font-medium">
                                        <i class="fas fa-book-open mr-2"></i>Read Full Article
                                    </button>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('exercise-depression-study', 'Exercise as Treatment for Depression', 'https://pubmed.ncbi.nlm.nih.gov/25099381/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Clinical Efficacy:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>PTSD symptom reduction: 84-90% efficacy rate</li>
                                        <li>Trauma memory processing: Significant reduction in distress</li>
                                        <li>Treatment duration: Average 6-12 sessions vs 12-16 for other therapies</li>
                                        <li>Sustained improvement at 6-month follow-up</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Evidence Base:</strong> 24 randomized controlled trials | <strong>WHO Recommended</strong> treatment for PTSD</p>
                            </div>
                            
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-blue-400 mb-3">üåô Clinical Hypnotherapy Outcomes</h3>
                                <p class="text-slate-300 mb-4">Flammer, E., & Bongartz, W. (2003). On the efficacy of hypnosis: a meta-analytic study. <em>Contemporary Hypnosis, 20</em>(4), 179-197.</p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Therapeutic Applications:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Anxiety reduction: 79% improvement rate</li>
                                        <li>Pain management: 75% reduction in chronic pain</li>
                                        <li>Sleep disorders: 58% improvement in insomnia</li>
                                        <li>Trauma recovery: Enhanced when combined with EMDR</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Analysis of:</strong> 57 controlled studies | <strong>Average Effect Size:</strong> Cohen's d = 0.79</p>
                            </div>
                            
                            <div class="bg-blue-800/30 p-6 rounded-lg border border-blue-600">
                                <h4 class="font-bold text-blue-300 mb-3">Evidence-Based Treatment Protocol</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="font-semibold text-blue-200 mb-2">First-Line Interventions:</h5>
                                        <ul class="text-blue-100 text-sm space-y-1">
                                            <li>‚Ä¢ CBT for depression, anxiety, and behavioral change</li>
                                            <li>‚Ä¢ EMDR for trauma processing and PTSD</li>
                                            <li>‚Ä¢ Hypnotherapy for anxiety, pain, and sleep issues</li>
                                            <li>‚Ä¢ Mindfulness-based interventions for stress</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-blue-200 mb-2">Success Metrics:</h5>
                                        <ul class="text-blue-100 text-sm space-y-1">
                                            <li>‚Ä¢ Symptom reduction: 60-90% improvement</li>
                                            <li>‚Ä¢ Quality of life: Significant enhancement</li>
                                            <li>‚Ä¢ Relapse prevention: Long-term maintenance</li>
                                            <li>‚Ä¢ Cost-effectiveness: Superior to medication-only</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                'sleep': {
                    title: 'Sleep & Circadian Health Research',
                    html: `
                        <div class="space-y-8">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-purple-400 mb-3">üõå CBT for Insomnia (CBT-I) Efficacy</h3>
                                <p class="text-slate-300 mb-4">Trauer, J.M., Qian, M.Y., Doyle, J.S., Rajaratnam, S.M., & Cunnington, D. (2015). Cognitive behavioral therapy for chronic insomnia: a systematic review and meta-analysis. <em>Annals of Internal Medicine, 163</em>(3), 191-204.</p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Treatment Outcomes:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Sleep onset latency reduced by 19 minutes on average</li>
                                        <li>Wake after sleep onset decreased by 26 minutes</li>
                                        <li>Sleep efficiency improved from 81.4% to 85.8%</li>
                                        <li>80% of patients achieve clinically significant improvement</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Analysis of:</strong> 20 RCTs, 1,162 participants | <strong>Success Rate:</strong> Superior to sleep medications long-term</p>
                            </div>
                            
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-purple-400 mb-3">‚òÄÔ∏è Circadian Light Therapy Research</h3>
                                <p class="text-slate-300 mb-4">Reid, K.J., Santostasi, G., Baron, K.G., Wilson, J., Kang, J., & Zee, P.C. (2014). Timing and intensity of light correlate with body weight in adults. <em>PLoS One, 9</em>(4), e92251.</p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Circadian Benefits:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Morning light exposure (10,000 lux) advances sleep phase by 1-2 hours</li>
                                        <li>Improved melatonin production timing and amplitude</li>
                                        <li>Enhanced mood and cognitive performance during day</li>
                                        <li>Metabolic benefits: Better glucose tolerance and weight management</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Optimal Protocol:</strong> 30 minutes of 10,000 lux light within 1 hour of waking</p>
                            </div>
                            
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-purple-400 mb-3">üå°Ô∏è Temperature Regulation and Sleep Quality</h3>
                                <p class="text-slate-300 mb-4">Harding, E.C., Franks, N.P., & Wisden, W. (2019). The temperature dependence of sleep. <em>Frontiers in Neuroscience, 13</em>, 336.</p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Temperature Optimization:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Optimal bedroom temperature: 65-68¬∞F (18-20¬∞C)</li>
                                        <li>Core body temperature drop of 2-3¬∞F initiates sleep</li>
                                        <li>Cool extremities (hands/feet) facilitate heat dissipation</li>
                                        <li>Temperature rhythm disruption linked to insomnia</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Clinical Application:</strong> Cooling protocols improve sleep onset by 37% on average</p>
                            </div>
                            
                            <div class="bg-purple-800/30 p-6 rounded-lg border border-purple-600">
                                <h4 class="font-bold text-purple-300 mb-3">Evidence-Based Sleep Optimization Protocol</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="font-semibold text-purple-200 mb-2">Core Interventions:</h5>
                                        <ul class="text-purple-100 text-sm space-y-1">
                                            <li>‚Ä¢ Consistent sleep/wake times (¬±30 minutes)</li>
                                            <li>‚Ä¢ Morning light exposure within 1 hour of waking</li>
                                            <li>‚Ä¢ Cool bedroom environment (65-68¬∞F)</li>
                                            <li>‚Ä¢ Sleep restriction therapy (CBT-I protocol)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-purple-200 mb-2">Expected Outcomes:</h5>
                                        <ul class="text-purple-100 text-sm space-y-1">
                                            <li>‚Ä¢ Sleep onset: Reduced by 15-20 minutes</li>
                                            <li>‚Ä¢ Sleep efficiency: Improved to 85%+</li>
                                            <li>‚Ä¢ Daytime alertness: 40-60% improvement</li>
                                            <li>‚Ä¢ Mood stability: Significant enhancement</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                'exercise': {
                    title: 'üèÉ‚Äç‚ôÄÔ∏è Exercise & Fitness Research',
                    html: `
                        <div class="space-y-8">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-orange-400 mb-3">üí™ High-Intensity Interval Training (HIIT) for Mental Health</h3>
                                <p class="text-slate-300 mb-4">Stonerock, G.L., Hoffman, B.M., Smith, P.J., & Blumenthal, J.A. (2015). Exercise as treatment for anxiety: Systematic review and analysis. <em>Annals of Behavioral Medicine, 49</em>(4), 542-556.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('springer-behavioral-study', 'Springer Behavioral Medicine Research', 'https://link.springer.com/article/10.1007/s12160-014-9685-9')" class="inline-flex items-center text-orange-400 hover:text-orange-300 text-sm font-medium">
                                        <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                    </a>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('sleep-memory-study', 'Sleep Quality and Memory Consolidation', 'https://pubmed.ncbi.nlm.nih.gov/25617134/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Key Findings:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Exercise reduces anxiety symptoms equivalent to medication (Cohen's d = 0.48)</li>
                                        <li>HIIT protocols show 40% greater anxiety reduction than moderate exercise</li>
                                        <li>Benefits appear within 2-4 weeks of consistent training</li>
                                        <li>Both aerobic and resistance training effective for depression (d = 0.55-0.73)</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Meta-analysis of:</strong> 40 RCTs, 2,914 participants | <strong>Optimal Dose:</strong> 150 min/week moderate or 75 min/week vigorous</p>
                            </div>
                            
                            <div class="bg-orange-800/30 p-6 rounded-lg border border-orange-600">
                                <h4 class="font-bold text-orange-300 mb-3">Evidence-Based Exercise Prescription for Mental Health</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="font-semibold text-orange-200 mb-2">Anxiety & Depression:</h5>
                                        <ul class="text-orange-100 text-sm space-y-1">
                                            <li>‚Ä¢ <strong>Frequency:</strong> 3-5 sessions per week</li>
                                            <li>‚Ä¢ <strong>Duration:</strong> 20-45 minutes per session</li>
                                            <li>‚Ä¢ <strong>Intensity:</strong> 65-75% max heart rate</li>
                                            <li>‚Ä¢ <strong>Type:</strong> Aerobic + resistance combination optimal</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-orange-200 mb-2">HIIT Protocol (Research-Based):</h5>
                                        <ul class="text-orange-100 text-sm space-y-1">
                                            <li>‚Ä¢ <strong>Work:</strong> 30-90 seconds at 85-95% HRmax</li>
                                            <li>‚Ä¢ <strong>Rest:</strong> 30-90 seconds active recovery</li>
                                            <li>‚Ä¢ <strong>Rounds:</strong> 4-8 intervals total</li>
                                            <li>‚Ä¢ <strong>Frequency:</strong> 2-3x/week (non-consecutive days)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                'stress': {
                    title: 'üßò‚Äç‚ôÄÔ∏è Stress Management & Resilience',
                    html: `
                        <div class="space-y-8">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-red-400 mb-3">üî¨ Mindfulness-Based Stress Reduction (MBSR) Efficacy</h3>
                                <p class="text-slate-300 mb-4">Goyal, M., Singh, S., Sibinga, E.M., et al. (2014). Meditation programs for psychological stress and well-being: A systematic review and meta-analysis. <em>JAMA Internal Medicine, 174</em>(3), 357-368.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('jama-internal-study', 'JAMA Internal Medicine Research', 'https://jamanetwork.com/journals/jamainternalmedicine/fullarticle/1809754')" class="inline-flex items-center text-red-400 hover:text-red-300 text-sm font-medium">
                                        <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                    </a>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('social-support-study', 'Social Support and Mental Health Recovery', 'https://pubmed.ncbi.nlm.nih.gov/24395196/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Stress Reduction Outcomes:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Anxiety reduction: Moderate effect size (d = 0.38)</li>
                                        <li>Depression symptoms: Significant improvement (d = 0.30)</li>
                                        <li>Pain management: 40% reduction in pain intensity</li>
                                        <li>Cortisol levels: 25% average decrease after 8-week program</li>
                                        <li>Sleep quality: 65% of participants report improvement</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Meta-analysis of:</strong> 47 RCTs, 3,515 participants | <strong>Program Length:</strong> 8 weeks standard</p>
                            </div>
                            
                            <div class="bg-red-800/30 p-6 rounded-lg border border-red-600">
                                <h4 class="font-bold text-red-300 mb-3">Evidence-Based Stress Management Protocol</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <h5 class="font-semibold text-red-200 mb-2">Daily Practices:</h5>
                                        <ul class="text-red-100 text-sm space-y-1">
                                            <li>‚Ä¢ <strong>Mindfulness:</strong> 10-20 minutes meditation</li>
                                            <li>‚Ä¢ <strong>Breathing:</strong> 4-7-8 technique, 3x daily</li>
                                            <li>‚Ä¢ <strong>Progressive relaxation:</strong> Body scan before bed</li>
                                            <li>‚Ä¢ <strong>Gratitude practice:</strong> 3 items daily</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-red-200 mb-2">Physiological Benefits:</h5>
                                        <ul class="text-red-100 text-sm space-y-1">
                                            <li>‚Ä¢ <strong>Heart rate:</strong> 10-15% reduction at rest</li>
                                            <li>‚Ä¢ <strong>Blood pressure:</strong> 3-5 mmHg decrease</li>
                                            <li>‚Ä¢ <strong>Immune function:</strong> 40% improvement</li>
                                            <li>‚Ä¢ <strong>Inflammation:</strong> Reduced inflammatory markers</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                },
                'integrative': {
                    title: 'üåø Integrative & Holistic Health',
                    html: `
                        <div class="space-y-8">
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-teal-400 mb-3">üå± Acupuncture for Depression: Systematic Review</h3>
                                <p class="text-slate-300 mb-4">Smith, C.A., Armour, M., Lee, M.S., Wang, L.Q., & Hay, P.J. (2018). Acupuncture for depression. <em>Cochrane Database of Systematic Reviews, 3</em>, CD004046.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('cochrane-review-study', 'Cochrane Systematic Review', 'https://www.cochranelibrary.com/cdsr/doi/10.1002/14651858.CD004046.pub4/full')" class="inline-flex items-center text-teal-400 hover:text-teal-300 text-sm font-medium">
                                        <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                    </a>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('trauma-therapy-study', 'Trauma-Informed Therapy Approaches', 'https://pubmed.ncbi.nlm.nih.gov/29502347/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Clinical Outcomes:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Depression scores improved vs sham acupuncture (SMD = -0.23)</li>
                                        <li>Combined with antidepressants: Enhanced efficacy (SMD = -0.37)</li>
                                        <li>Response rate: 70% with real vs 47% with sham acupuncture</li>
                                        <li>Minimal adverse effects reported (0.1% serious events)</li>
                                        <li>Benefits maintained at 3-month follow-up</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Cochrane Review of:</strong> 64 RCTs, 7,104 participants | <strong>Treatment Protocol:</strong> 12-20 sessions over 8-12 weeks</p>
                            </div>
                            
                            <div class="bg-slate-700 p-6 rounded-lg">
                                <h3 class="text-xl font-bold text-cyan-400 mb-3">üçÉ Herbal Medicine for Anxiety: St. John's Wort</h3>
                                <p class="text-slate-300 mb-4">Ng, Q.X., Venkatanarayanan, N., & Ho, C.Y. (2017). Clinical use of Hypericum perforatum (St John's wort) in depression: A meta-analysis. <em>Journal of Affective Disorders, 210</em>, 211-221.</p>
                                <p class="mb-4">
                                    <button onclick="openInAppArticle('sciencedirect-study', 'ScienceDirect Research Article', 'https://www.sciencedirect.com/science/article/pii/S0165032716313434')" class="inline-flex items-center text-cyan-400 hover:text-cyan-300 text-sm font-medium"></button>
                                        <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                    </a>
                                    <span class="mx-3 text-slate-500">|</span>
                                    <button onclick="openInAppArticle('digital-mental-health-study', 'Digital Mental Health Interventions', 'https://pubmed.ncbi.nlm.nih.gov/27969168/')" class="inline-flex items-center text-green-400 hover:text-green-300 text-sm font-medium">
                                        <i class="fas fa-search mr-2"></i>View Study
                                    </button>
                                </p>
                                <div class="bg-slate-600 p-4 rounded mb-4">
                                    <h4 class="font-semibold text-slate-100 mb-2">Efficacy Profile:</h4>
                                    <ul class="list-disc pl-5 text-slate-300 space-y-1">
                                        <li>Mild-moderate depression: Superior to placebo (RR = 1.28)</li>
                                        <li>Comparable efficacy to SSRIs for mild depression</li>
                                        <li>Fewer side effects than conventional antidepressants</li>
                                        <li>Standard dose: 300mg 3x daily (0.3% hypericin extract)</li>
                                        <li>‚ö†Ô∏è Drug interactions: CYP450 enzyme inducer</li>
                                    </ul>
                                </div>
                                <p class="text-slate-400 text-sm"><strong>Meta-analysis of:</strong> 35 studies, 6,993 participants | <strong>Caution:</strong> Consult healthcare provider for drug interactions</p>
                            </div>
                            
                            <div class="bg-teal-800/30 p-6 rounded-lg border border-teal-600">
                                <h4 class="font-bold text-teal-300 mb-3">Evidence-Based Integrative Approaches</h4>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <h5 class="font-semibold text-teal-200 mb-2">Mind-Body Practices:</h5>
                                        <ul class="text-teal-100 text-sm space-y-1">
                                            <li>‚Ä¢ Yoga therapy (moderate evidence)</li>
                                            <li>‚Ä¢ Tai Chi for mood & anxiety</li>
                                            <li>‚Ä¢ Qigong for stress reduction</li>
                                            <li>‚Ä¢ Biofeedback training</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-teal-200 mb-2">Natural Supplements:</h5>
                                        <ul class="text-teal-100 text-sm space-y-1">
                                            <li>‚Ä¢ Omega-3 fatty acids (1-2g EPA)</li>
                                            <li>‚Ä¢ Magnesium (200-400mg daily)</li>
                                            <li>‚Ä¢ Adaptogenic herbs (rhodiola, ashwagandha)</li>
                                            <li>‚Ä¢ Probiotics for gut-brain axis</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-teal-200 mb-2">Therapeutic Modalities:</h5>
                                        <ul class="text-teal-100 text-sm space-y-1">
                                            <li>‚Ä¢ Massage therapy for anxiety</li>
                                            <li>‚Ä¢ Aromatherapy (lavender, bergamot)</li>
                                            <li>‚Ä¢ Light therapy for SAD</li>
                                            <li>‚Ä¢ Music therapy for mood</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                }
        }
        
        function storeAssessmentResults(results) {
            localStorage.setItem('assessmentResults', JSON.stringify(results));
            localStorage.setItem('assessmentCompletedAt', new Date().toISOString());
            console.log('üìä Assessment results stored:', results);
        }
        
        function startIntelligentFollowUp() {
            console.log('ü§ñ Starting intelligent follow-up assessment...');
            // This would integrate with the comprehensive assessment system
            // For now, we redirect to coach recommendations
            setTimeout(() => {
                navigateToSection('coaches');
            }, 2000);
        }
        
        // Dashboard initialization function
        window.initializeDashboard = function() {
            console.log('üìä Initializing dashboard...');
            
            const loadingEl = document.getElementById('dashboard-loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            // Check for new assessment results first
            const newAssessmentResults = localStorage.getItem('lastAssessmentResults');
            const hasCompleted = localStorage.getItem('hasCompletedAssessment');
            
            console.log('üîç Dashboard debug - Assessment results:', newAssessmentResults ? 'Found' : 'Not found');
            console.log('üîç Dashboard debug - Has completed:', hasCompleted);
            
            if (newAssessmentResults && hasCompleted === 'true') {
                console.log('‚úÖ Found assessment results, displaying dashboard...');
                const results = JSON.parse(newAssessmentResults);
                displayEnhancedDashboard(results);
            } else {
                // Fallback to old assessment results
                const oldAssessmentResults = localStorage.getItem('assessmentResults');
                if (oldAssessmentResults) {
                    console.log('‚úÖ Found old assessment results, displaying dashboard...');
                    const results = JSON.parse(oldAssessmentResults);
                    displayDashboardContent(results);
                } else {
                    console.log('‚ùå No assessment results found, showing assessment prompt...');
                    displayEmptyDashboard();
                }
            }
        }

        // Enhanced dashboard display with new assessment data
        function displayEnhancedDashboard(results) {
            console.log('üéØ displayEnhancedDashboard called with:', results);
            const dashboardContent = document.getElementById('dashboard-content');
            if (!dashboardContent) {
                console.error('‚ùå dashboard-content element not found in displayEnhancedDashboard!');
                return;
            }

            const scores = results.healthScores;
            const overallPercentage = Math.round((scores.overall_score / 10) * 100);
            
            dashboardContent.innerHTML = `
                <!-- Welcome Header -->
                <div class="bg-gradient-to-r from-emerald-500/20 to-blue-500/20 border border-emerald-400/30 rounded-xl p-6 mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-100 mb-2">Your Health Dashboard üìä</h2>
                            <p class="text-slate-300">Assessment completed on ${new Date(results.timestamp).toLocaleDateString()}</p>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-emerald-400">${overallPercentage}%</div>
                            <div class="text-slate-300 text-sm">Overall Score</div>
                        </div>
                    </div>
                </div>

                <!-- Health Scores Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    ${generateHealthScoreCards(scores)}
                </div>

                <!-- Recovery Roadmap -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-slate-100 mb-4">üöÄ Your Recovery Roadmap</h3>
                    <div class="space-y-4">
                        ${generateRoadmapCards(results.recoveryRoadmap)}
                    </div>
                </div>

                <!-- Recommended Coach -->
                <div class="bg-slate-800/50 border border-slate-600 rounded-xl p-6 mb-8">
                    <h3 class="text-xl font-semibold text-slate-100 mb-4">üë®‚Äç‚öïÔ∏è Your Recommended Coach</h3>
                    ${generateCoachCard(results.recommendedCoach)}
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="navigateToSection('coaches')" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-6 py-3 rounded-xl text-white font-medium transition-all">
                        <i class="fas fa-comments mr-2"></i>Talk to Your Coach
                    </button>
                    <button onclick="navigateToSection('assessment')" class="bg-slate-600 hover:bg-slate-700 px-6 py-3 rounded-xl text-white font-medium transition-all">
                        <i class="fas fa-redo mr-2"></i>Retake Assessment
                    </button>
                    <button onclick="exportResults()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl text-white font-medium transition-all">
                        <i class="fas fa-download mr-2"></i>Export Results
                    </button>
                </div>
            `;
        }

        function generateHealthScoreCards(scores) {
            const scoreCards = [
                { key: 'physical_health', label: 'Physical Health', icon: 'fas fa-heartbeat', color: 'emerald' },
                { key: 'mental_wellness', label: 'Mental Wellness', icon: 'fas fa-brain', color: 'blue' },
                { key: 'energy_vitality', label: 'Energy & Vitality', icon: 'fas fa-bolt', color: 'yellow' },
                { key: 'sleep_quality', label: 'Sleep Quality', icon: 'fas fa-moon', color: 'purple' },
                { key: 'stress_management', label: 'Stress Management', icon: 'fas fa-spa', color: 'pink' },
                { key: 'daily_functioning', label: 'Daily Functioning', icon: 'fas fa-tasks', color: 'indigo' }
            ];

            return scoreCards.map(card => {
                const score = Math.round(scores[card.key]);
                const percentage = (score / 10) * 100;
                const statusColor = score >= 7 ? 'text-green-400' : score >= 5 ? 'text-yellow-400' : 'text-red-400';
                
                return `
                    <div class="bg-slate-800/50 border border-slate-600 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-${card.color}-500/20 rounded-full flex items-center justify-center mr-3">
                                    <i class="${card.icon} text-${card.color}-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-slate-100 font-medium">${card.label}</h3>
                                    <p class="text-slate-400 text-sm">Current Status</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold ${statusColor}">${score}/10</div>
                            </div>
                        </div>
                        <div class="w-full bg-slate-600 rounded-full h-2">
                            <div class="bg-gradient-to-r from-${card.color}-500 to-${card.color}-400 h-2 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateRoadmapCards(roadmap) {
            if (!roadmap || roadmap.length === 0) return '<p class="text-slate-400">No specific recommendations at this time.</p>';
            
            return roadmap.map((item, index) => {
                const priorityColors = {
                    'High': 'from-red-500/20 to-orange-500/20 border-red-400/30',
                    'Medium': 'from-yellow-500/20 to-orange-500/20 border-yellow-400/30',
                    'Low': 'from-blue-500/20 to-green-500/20 border-blue-400/30'
                };
                
                return `
                    <div class="bg-gradient-to-r ${priorityColors[item.priority]} border rounded-xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-slate-100 mb-2">${item.area.replace('_', ' ').toUpperCase()}</h4>
                                <span class="inline-block px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">${item.priority} Priority</span>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-400 text-sm">Timeline</p>
                                <p class="text-emerald-400 font-medium">${item.timeline}</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${item.actions.map(action => `
                                <div class="flex items-center p-2 bg-slate-600/30 rounded">
                                    <input type="checkbox" class="mr-3 w-4 h-4 text-emerald-500" onchange="updateProgress()">
                                    <span class="text-slate-200 text-sm">${action}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateCoachCard(coachId) {
            const coaches = {
                'sarah': { name: 'Coach Sarah', specialty: 'CBT & Mindfulness Specialist', color: 'from-blue-500 to-cyan-500', icon: 'fas fa-brain' },
                'marcus': { name: 'Coach Marcus', specialty: 'Addiction Recovery Specialist', color: 'from-green-500 to-emerald-500', icon: 'fas fa-hands-helping' },
                'elena': { name: 'Coach Elena', specialty: 'EMDR & Trauma Specialist', color: 'from-purple-500 to-pink-500', icon: 'fas fa-eye' },
                'alex': { name: 'Coach Alex', specialty: 'Mindfulness & Wellness Coach', color: 'from-orange-500 to-red-500', icon: 'fas fa-spa' },
                'maria': { name: 'Coach Maria', specialty: 'Family & Relationship Therapy', color: 'from-pink-500 to-rose-500', icon: 'fas fa-heart' }
            };

            const coach = coaches[coachId] || coaches['sarah'];
            
            return `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-br ${coach.color} rounded-full flex items-center justify-center mr-4">
                            <i class="${coach.icon} text-white text-lg"></i>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-slate-100">${coach.name}</h4>
                            <p class="text-slate-300">${coach.specialty}</p>
                            <p class="text-emerald-400 text-sm">Perfect match based on your assessment</p>
                        </div>
                    </div>
                    <button onclick="navigateToSection('coaches')" class="bg-gradient-to-r ${coach.color} hover:opacity-80 px-4 py-2 rounded-lg text-white font-medium transition-all">
                        Connect Now
                    </button>
                </div>
            `;
        }

        // Utility functions
        window.retakeAssessment = function() {
            localStorage.removeItem('lastAssessmentResults');
            localStorage.removeItem('hasCompletedAssessment');
            navigateToSection('assessment');
        };

        window.exportResults = function() {
            const results = localStorage.getItem('lastAssessmentResults');
            if (results) {
                const blob = new Blob([results], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'health-assessment-results.json';
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        window.updateProgress = function() {
            console.log('üìà Progress updated');
            // Could implement progress tracking here
        };
        
        function displayDashboardContent(results) {
            const dashboardContent = document.getElementById('dashboard-content');
            if (!dashboardContent) return;
            
            dashboardContent.innerHTML = `
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Overall Score Card -->
                    <div class="bg-slate-800/50 border border-slate-600 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-slate-200">Overall Health Score</h3>
                            <span class="text-2xl">üìä</span>
                        </div>
                        <div class="text-3xl font-bold text-blue-400 mb-2">${Math.round(results.percentageScore)}%</div>
                        <p class="text-slate-400 text-sm">Based on your latest assessment</p>
                    </div>
                    
                    <!-- Energy Level -->
                    <div class="bg-slate-800/50 border border-slate-600 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-slate-200">Energy Level</h3>
                            <span class="text-2xl">‚ö°</span>
                        </div>
                        <div class="text-3xl font-bold text-yellow-400 mb-2">${results.scores.energy}/5</div>
                        <p class="text-slate-400 text-sm">${getScoreDescription(results.scores.energy)}</p>
                    </div>
                    
                    <!-- Sleep Quality -->
                    <div class="bg-slate-800/50 border border-slate-600 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-slate-200">Sleep Quality</h3>
                            <span class="text-2xl">üò¥</span>
                        </div>
                        <div class="text-3xl font-bold text-purple-400 mb-2">${results.scores.sleep}/5</div>
                        <p class="text-slate-400 text-sm">${getScoreDescription(results.scores.sleep)}</p>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="bg-slate-800/30 border border-slate-600 rounded-xl p-6 mb-8">
                    <h3 class="text-xl font-semibold text-slate-200 mb-4 flex items-center">
                        <span class="mr-2">üí°</span>
                        Personalized Recommendations
                    </h3>
                    <div class="space-y-3">
                        ${results.recommendations.map(rec => `
                            <div class="bg-slate-700/50 rounded-lg p-4">
                                <h4 class="font-medium text-blue-400 mb-2">${rec.category}</h4>
                                <p class="text-slate-300 text-sm">${rec.recommendation}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4">
                    <button onclick="navigateToSection('coaches')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        Talk to a Coach
                    </button>
                    <button onclick="navigateToSection('ptsd-corner')" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        PTSD Support Tools
                    </button>
                </div>
            `;
        }
        
        function closeResearchModal() {
            const modal = document.getElementById('research-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // ===== COMPREHENSIVE NUTRITION SYSTEM =====
        
        // ===== LIVE NUTRITION API FUNCTIONS =====
        
        async function searchFoodAPI(foodName) {
            console.log(`üîç Searching for: ${foodName}`);
            
            try {
                // Try multiple nutrition APIs
                let foodData = await tryUSDAAPI(foodName);
                
                if (!foodData) {
                    foodData = await tryNutritionixAPI(foodName);
                }
                
                if (!foodData) {
                    foodData = await tryEdamamAPI(foodName);
                }
                
                if (!foodData) {
                    // Fallback to local database
                    foodData = getFallbackNutritionData(foodName);
                }
                
                return foodData;
                
            } catch (error) {
                console.error('API search failed:', error);
                return getFallbackNutritionData(foodName);
            }
        }
        
        async function tryUSDAAPI(foodName) {
            try {
                console.log(`ü•ó Trying USDA API for: ${foodName}`);
                // USDA FoodData Central API (free, no key required for basic search)
                const searchUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?query=${encodeURIComponent(foodName)}&pageSize=1&dataType=Foundation,SR%20Legacy&api_key=DEMO_KEY`;
                
                const response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('USDA API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`USDA API failed: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('USDA API data:', data);
                
                if (data.foods && data.foods.length > 0) {
                    const food = data.foods[0];
                    return formatUSDAData(food);
                }
                
                return null;
                
            } catch (error) {
                console.log('USDA API unavailable:', error.message);
                return null;
            }
        }
        
        async function tryNutritionixAPI(foodName) {
            try {
                console.log(`üåç Trying Open Food Facts API for: ${foodName}`);
                
                // Use Open Food Facts API (free, no API key required)
                const searchUrl = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(foodName)}&search_simple=1&action=process&json=1&page_size=1`;
                
                const response = await fetch(searchUrl, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'HealthcareApp/1.0'
                    }
                });
                
                console.log('Open Food Facts API response status:', response.status);
                
                if (!response.ok) throw new Error('Open Food Facts API failed');
                
                const data = await response.json();
                console.log('Open Food Facts data:', data);
                
                if (data.products && data.products.length > 0) {
                    const product = data.products[0];
                    return formatOpenFoodFactsData(product, foodName);
                }
                
                return null;
                
            } catch (error) {
                console.log('Open Food Facts API unavailable:', error.message);
                return null;
            }
        }
        
        function formatOpenFoodFactsData(product, originalName) {
            try {
                const nutrients = product.nutriments || {};
                
                return {
                    name: product.product_name || originalName,
                    calories: Math.round(nutrients.energy_kcal_100g || nutrients['energy-kcal_100g'] || 0),
                    protein: Math.round((nutrients.proteins_100g || 0) * 10) / 10,
                    carbs: Math.round((nutrients.carbohydrates_100g || 0) * 10) / 10,
                    fat: Math.round((nutrients.fat_100g || 0) * 10) / 10,
                    fiber: Math.round((nutrients.fiber_100g || 0) * 10) / 10,
                    sugar: Math.round((nutrients.sugars_100g || 0) * 10) / 10,
                    unit: '100g'
                };
            } catch (error) {
                console.error('Error formatting Open Food Facts data:', error);
                return null;
            }
        }
        
        async function tryEdamamAPI(foodName) {
            try {
                console.log(`ü•ë Trying enhanced food matching for: ${foodName}`);
                
                // Enhanced food matching with variations and intelligent search
                const foodVariations = getFoodVariations(foodName);
                
                for (const variation of foodVariations) {
                    const result = getFallbackNutritionData(variation);
                    if (result) {
                        console.log(`‚úÖ Found nutrition data for: ${variation}`);
                        return result;
                    }
                }
                
                // If no exact match, try partial matching
                return tryPartialFoodMatch(foodName);
                
            } catch (error) {
                console.log('Enhanced food matching failed:', error.message);
                return null;
            }
        }
        
        function getFoodVariations(foodName) {
            const name = foodName.toLowerCase().trim();
            const variations = [name];
            
            // Add common variations and plurals
            if (!name.endsWith('s')) variations.push(name + 's');
            if (name.endsWith('s')) variations.push(name.slice(0, -1));
            
            // Add common substitutions
            const substitutions = {
                'chicken': ['chicken breast', 'poultry'],
                'fish': ['salmon', 'tuna', 'cod'],
                'beef': ['ground beef', 'lean beef'],
                'rice': ['brown rice', 'white rice'],
                'potato': ['sweet potato'],
                'milk': ['dairy milk', 'whole milk'],
                'cheese': ['cheddar cheese', 'mozzarella'],
                'bread': ['whole wheat bread', 'white bread']
            };
            
            Object.keys(substitutions).forEach(key => {
                if (name.includes(key)) {
                    variations.push(...substitutions[key]);
                }
            });
            
            return variations;
        }
        
        function tryPartialFoodMatch(searchTerm) {
            // Get the fallback database
            const database = {
                'apple': { name: 'Apple', calories: 52, protein: 0.3, carbs: 14, fat: 0.2, fiber: 2.4, sugar: 10.4, unit: '100g' },
                'banana': { name: 'Banana', calories: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6, sugar: 12.2, unit: '100g' },
                'chicken breast': { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0, sugar: 0, unit: '100g' },
                'salmon': { name: 'Salmon', calories: 208, protein: 22, carbs: 0, fat: 12, fiber: 0, sugar: 0, unit: '100g' },
                'broccoli': { name: 'Broccoli', calories: 34, protein: 2.8, carbs: 7, fat: 0.4, fiber: 2.6, sugar: 1.5, unit: '100g' },
                'quinoa': { name: 'Quinoa', calories: 368, protein: 14, carbs: 64, fat: 6, fiber: 7, sugar: 0, unit: '100g' },
                'avocado': { name: 'Avocado', calories: 160, protein: 2, carbs: 9, fat: 15, fiber: 7, sugar: 0.7, unit: '100g' },
                'spinach': { name: 'Spinach', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2, sugar: 0.4, unit: '100g' },
                'sweet potato': { name: 'Sweet Potato', calories: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3, sugar: 4.2, unit: '100g' },
                'almonds': { name: 'Almonds', calories: 579, protein: 21, carbs: 22, fat: 50, fiber: 12, sugar: 4.4, unit: '100g' },
                'greek yogurt': { name: 'Greek Yogurt', calories: 59, protein: 10, carbs: 3.6, fat: 0.4, fiber: 0, sugar: 3.6, unit: '100g' },
                'oats': { name: 'Oats', calories: 389, protein: 17, carbs: 66, fat: 7, fiber: 11, sugar: 0, unit: '100g' },
                'blueberries': { name: 'Blueberries', calories: 57, protein: 0.7, carbs: 14, fat: 0.3, fiber: 2.4, sugar: 10, unit: '100g' },
                'eggs': { name: 'Eggs', calories: 155, protein: 13, carbs: 1.1, fat: 11, fiber: 0, sugar: 1.1, unit: '100g' },
                'brown rice': { name: 'Brown Rice', calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8, sugar: 0.4, unit: '100g' },
                'tuna': { name: 'Tuna', calories: 144, protein: 30, carbs: 0, fat: 1, fiber: 0, sugar: 0, unit: '100g' },
                'carrots': { name: 'Carrots', calories: 41, protein: 0.9, carbs: 10, fat: 0.2, fiber: 2.8, sugar: 4.7, unit: '100g' },
                'lentils': { name: 'Lentils', calories: 116, protein: 9, carbs: 20, fat: 0.4, fiber: 8, sugar: 1.8, unit: '100g' },
                'walnuts': { name: 'Walnuts', calories: 654, protein: 15, carbs: 14, fat: 65, fiber: 7, sugar: 2.6, unit: '100g' },
                'kale': { name: 'Kale', calories: 35, protein: 2.9, carbs: 7, fat: 0.9, fiber: 4.1, sugar: 0.8, unit: '100g' }
            };
            
            const searchLower = searchTerm.toLowerCase();
            
            // Try partial matching
            for (const [key, value] of Object.entries(database)) {
                if (key.includes(searchLower) || searchLower.includes(key)) {
                    console.log(`üîç Partial match found: ${key} for search "${searchTerm}"`);
                    return value;
                }
            }
            
            return null;
        }
        
        function formatUSDAData(food) {
            const nutrients = {};
            
            food.foodNutrients.forEach(nutrient => {
                const name = nutrient.nutrientName.toLowerCase();
                if (name.includes('energy')) nutrients.calories = nutrient.value;
                if (name.includes('protein')) nutrients.protein = nutrient.value;
                if (name.includes('carbohydrate')) nutrients.carbs = nutrient.value;
                if (name.includes('fat')) nutrients.fat = nutrient.value;
                if (name.includes('fiber')) nutrients.fiber = nutrient.value;
                if (name.includes('sugar')) nutrients.sugar = nutrient.value;
            });
            
            return {
                name: food.description,
                calories: nutrients.calories || 0,
                protein: nutrients.protein || 0,
                carbs: nutrients.carbs || 0,
                fat: nutrients.fat || 0,
                fiber: nutrients.fiber || 0,
                sugar: nutrients.sugar || 0,
                unit: '100g',
                source: 'USDA'
            };
        }
        
        function formatNutritionixData(food) {
            return {
                name: food.food_name,
                calories: food.nf_calories || 0,
                protein: food.nf_protein || 0,
                carbs: food.nf_total_carbohydrate || 0,
                fat: food.nf_total_fat || 0,
                fiber: food.nf_dietary_fiber || 0,
                sugar: food.nf_sugars || 0,
                unit: 'serving',
                source: 'Nutritionix'
            };
        }
        
        function formatEdamamData(food) {
            const nutrients = food.food.nutrients;
            return {
                name: food.food.label,
                calories: nutrients.ENERC_KCAL || 0,
                protein: nutrients.PROCNT || 0,
                carbs: nutrients.CHOCDF || 0,
                fat: nutrients.FAT || 0,
                fiber: nutrients.FIBTG || 0,
                sugar: nutrients.SUGAR || 0,
                unit: '100g',
                source: 'Edamam'
            };
        }
        
        function getFallbackNutritionData(foodName) {
            // Enhanced fallback database with more foods
            const nutritionDatabase = {
            'apple': { name: 'Apple', calories: 52, protein: 0.3, carbs: 14, fat: 0.2, fiber: 2.4, sugar: 10.4, unit: '100g' },
            'banana': { name: 'Banana', calories: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6, sugar: 12.2, unit: '100g' },
            'chicken breast': { name: 'Chicken Breast', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0, sugar: 0, unit: '100g' },
            'salmon': { name: 'Salmon', calories: 208, protein: 22, carbs: 0, fat: 12, fiber: 0, sugar: 0, unit: '100g' },
            'broccoli': { name: 'Broccoli', calories: 34, protein: 2.8, carbs: 7, fat: 0.4, fiber: 2.6, sugar: 1.5, unit: '100g' },
            'quinoa': { name: 'Quinoa', calories: 368, protein: 14, carbs: 64, fat: 6, fiber: 7, sugar: 0, unit: '100g' },
            'avocado': { name: 'Avocado', calories: 160, protein: 2, carbs: 9, fat: 15, fiber: 7, sugar: 0.7, unit: '100g' },
            'spinach': { name: 'Spinach', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2, sugar: 0.4, unit: '100g' },
            'sweet potato': { name: 'Sweet Potato', calories: 86, protein: 1.6, carbs: 20, fat: 0.1, fiber: 3, sugar: 4.2, unit: '100g' },
            'almonds': { name: 'Almonds', calories: 579, protein: 21, carbs: 22, fat: 50, fiber: 12, sugar: 4.4, unit: '100g' },
            'greek yogurt': { name: 'Greek Yogurt', calories: 59, protein: 10, carbs: 3.6, fat: 0.4, fiber: 0, sugar: 3.6, unit: '100g' },
            'oats': { name: 'Oats', calories: 389, protein: 17, carbs: 66, fat: 7, fiber: 11, sugar: 0, unit: '100g' },
            'blueberries': { name: 'Blueberries', calories: 57, protein: 0.7, carbs: 14, fat: 0.3, fiber: 2.4, sugar: 10, unit: '100g' },
            'eggs': { name: 'Eggs', calories: 155, protein: 13, carbs: 1.1, fat: 11, fiber: 0, sugar: 1.1, unit: '100g' },
            'brown rice': { name: 'Brown Rice', calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8, sugar: 0.4, unit: '100g' },
            'tuna': { name: 'Tuna', calories: 144, protein: 30, carbs: 0, fat: 1, fiber: 0, sugar: 0, unit: '100g' },
            'carrots': { name: 'Carrots', calories: 41, protein: 0.9, carbs: 10, fat: 0.2, fiber: 2.8, sugar: 4.7, unit: '100g' },
            'lentils': { name: 'Lentils', calories: 116, protein: 9, carbs: 20, fat: 0.4, fiber: 8, sugar: 1.8, unit: '100g' },
            'walnuts': { name: 'Walnuts', calories: 654, protein: 15, carbs: 14, fat: 65, fiber: 7, sugar: 2.6, unit: '100g' },
            'kale': { name: 'Kale', calories: 35, protein: 2.9, carbs: 7, fat: 0.9, fiber: 4.1, sugar: 0.8, unit: '100g' }
        };

        // Return the food data or null if not found
        const normalizedName = foodName.toLowerCase().trim();
        return nutritionDatabase[normalizedName] || null;
    }

        // Tab switching functionality
        function showNutritionTab(tabName) {
            console.log(`üîÑ Switching to nutrition tab: ${tabName}`);
            
            // Hide all content
            const contents = document.querySelectorAll('.nutrition-content');
            contents.forEach(content => {
                content.classList.add('hidden');
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nutrition-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active-tab', 'bg-green-600', 'bg-blue-600', 'bg-purple-600', 'bg-orange-600');
                tab.classList.add('bg-slate-600', 'text-slate-300');
            });
            
            // Show selected content
            const selectedContent = document.getElementById(`nutrition-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
                selectedContent.style.display = 'block';
                console.log(`‚úÖ Showing content for: ${tabName}`);
            } else {
                console.error(`‚ùå Content not found for tab: nutrition-${tabName}`);
            }
            
            // Activate selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.remove('bg-slate-600', 'text-slate-300');
                selectedTab.classList.add('active-tab', 'text-white');
                
                // Different colors for different tabs
                const colors = {
                    'lookup': 'bg-green-600',
                    'calculator': 'bg-blue-600',
                    'news': 'bg-purple-600',
                    'advice': 'bg-orange-600',
                    'research': 'bg-green-600'
                };
                selectedTab.classList.add(colors[tabName] || 'bg-green-600');
            }
            
            // Show food suggestions for lookup tab
            if (tabName === 'lookup') {
                const suggestions = document.getElementById('food-suggestions');
                if (suggestions) {
                    suggestions.classList.remove('hidden');
                }
            }
        }

        // Food search functionality
        function handleFoodSearch(event) {
            if (event.key === 'Enter') {
                searchFood();
            }
        }

        function quickFoodSearch(foodName) {
            document.getElementById('food-search').value = foodName;
            searchFood();
        }

        async function searchFood() {
            const searchInput = document.getElementById('food-search');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a food name to search');
                return;
            }
            
            const resultsDiv = document.getElementById('food-results');
            
            // Show loading state
            resultsDiv.innerHTML = `
                <div class="bg-slate-600 p-6 rounded-lg text-center">
                    <div class="animate-spin text-2xl mb-2">‚è≥</div>
                    <p class="text-slate-300">Searching nutrition databases...</p>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
            
            try {
                const food = await searchFoodAPI(query);
            
            if (food) {
                resultsDiv.innerHTML = `
                    <div class="bg-green-800/30 border border-green-600 rounded-lg p-6">
                        <h4 class="text-xl font-bold text-green-300 mb-4">üçé ${food.name} - Nutrition Facts</h4>
                        <p class="text-slate-300 mb-4">Per ${food.unit} serving:</p>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Calories:</span>
                                    <span class="text-white font-semibold">${food.calories}</span>
                                </div>
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Protein:</span>
                                    <span class="text-white font-semibold">${food.protein}g</span>
                                </div>
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Carbohydrates:</span>
                                    <span class="text-white font-semibold">${food.carbs}g</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Total Fat:</span>
                                    <span class="text-white font-semibold">${food.fat}g</span>
                                </div>
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Fiber:</span>
                                    <span class="text-white font-semibold">${food.fiber}g</span>
                                </div>
                                <div class="flex justify-between bg-slate-600 p-3 rounded">
                                    <span class="text-slate-300">Sugar:</span>
                                    <span class="text-white font-semibold">${food.sugar}g</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-slate-600 rounded-lg">
                            <h5 class="font-semibold text-slate-200 mb-2">Health Benefits:</h5>
                            <div class="text-slate-300 text-sm">
                                ${getFoodBenefits(food.name)}
                            </div>
                        </div>
                        
                        <button onclick="addToMeal('${query}', ${food.calories}, ${food.protein}, ${food.carbs}, ${food.fat}, ${food.fiber}, ${food.sugar})" 
                                class="mt-4 w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            + Add to Meal Calculator
                        </button>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = `
                    <div class="bg-red-800/30 border border-red-600 rounded-lg p-6">
                        <h4 class="text-xl font-bold text-red-300 mb-2">‚ùå Food Not Found</h4>
                        <p class="text-slate-300 mb-4">Sorry, "${query}" is not in our database yet.</p>
                        <p class="text-slate-400 text-sm">Try searching for: apple, banana, chicken breast, salmon, broccoli, quinoa, avocado, spinach, sweet potato, almonds, greek yogurt, oats, blueberries, eggs, brown rice, tuna, carrots, lentils, walnuts, or kale.</p>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            }
            
            } catch (error) {
                console.error('Food search error:', error);
                resultsDiv.innerHTML = `
                    <div class="bg-red-800/30 border border-red-600 rounded-lg p-6 text-center">
                        <div class="text-2xl mb-2">‚ùå</div>
                        <p class="text-red-300">Unable to search nutrition database. Please try again.</p>
                        <button onclick="searchFood()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white">
                            Retry Search
                        </button>
                    </div>
                `;
                resultsDiv.classList.remove('hidden');
            }
        }

        function getFoodBenefits(foodName) {
            const benefits = {
                'Apple': 'Rich in antioxidants, supports heart health, may reduce cancer risk, good source of dietary fiber',
                'Banana': 'High in potassium for heart health, natural energy source, supports digestive health',
                'Chicken Breast': 'Lean protein source, supports muscle building, contains B-vitamins for energy metabolism',
                'Salmon': 'Omega-3 fatty acids for brain and heart health, high-quality protein, vitamin D source',
                'Broccoli': 'High in vitamin C and K, contains sulforaphane with anti-cancer properties, supports immune system',
                'Quinoa': 'Complete protein with all essential amino acids, gluten-free, rich in minerals',
                'Avocado': 'Healthy monounsaturated fats, supports heart health, aids nutrient absorption',
                'Spinach': 'Iron and folate rich, supports eye health, contains nitrates for cardiovascular benefits',
                'Sweet Potato': 'Beta-carotene for eye health, complex carbohydrates for sustained energy, high fiber',
                'Almonds': 'Healthy fats and vitamin E, supports heart health, may help with weight management'
            };
            return benefits[foodName] || 'Provides essential nutrients for overall health and wellness';
        }

        // Meal calculator functionality
        function addMealItem() {
            const mealBuilder = document.getElementById('meal-builder');
            const newItem = document.createElement('div');
            newItem.className = 'meal-item flex items-center gap-3 p-3 bg-slate-600 rounded';
            newItem.innerHTML = `
                <input type="text" placeholder="Food name" class="food-name flex-1 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                <input type="number" placeholder="Amount" class="food-amount w-20 px-3 py-2 bg-slate-500 text-slate-100 rounded">
                <select class="food-unit px-3 py-2 bg-slate-500 text-slate-100 rounded">
                    <option value="g">g</option>
                    <option value="oz">oz</option>
                    <option value="cup">cup</option>
                    <option value="piece">piece</option>
                </select>
                <button onclick="removeMealItem(this)" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            mealBuilder.appendChild(newItem);
        }

        function removeMealItem(button) {
            button.parentElement.remove();
            calculateMeal();
        }

        function addToMeal(foodKey, calories, protein, carbs, fat, fiber, sugar) {
            // Switch to calculator tab
            showNutritionTab('calculator');
            
            // Add the food to meal builder
            const mealBuilder = document.getElementById('meal-builder');
            
            // Find if there's an empty meal item or create new one
            let mealItem = document.querySelector('.meal-item .food-name[value=""]');
            if (!mealItem || mealItem.value !== '') {
                addMealItem();
                mealItem = document.querySelector('.meal-item:last-child .food-name');
            }
            
            // Use the passed food name (foodKey) directly
            mealItem.value = foodKey;
            mealItem.parentElement.querySelector('.food-amount').value = 100;
            
            calculateMeal();
        }

        async function calculateMeal() {
            console.log('üßÆ Starting meal calculation...');
            
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalFiber = 0, totalSugar = 0;
            
            const mealItems = document.querySelectorAll('.meal-item');
            console.log(`Found ${mealItems.length} meal items to calculate`);
            
            // Show calculating indicator
            document.getElementById('total-calories').textContent = '‚è≥';
            document.getElementById('total-protein').textContent = '‚è≥';
            document.getElementById('total-carbs').textContent = '‚è≥';
            document.getElementById('total-fat').textContent = '‚è≥';
            document.getElementById('total-fiber').textContent = '‚è≥';
            document.getElementById('total-sugar').textContent = '‚è≥';
            
            for (const item of mealItems) {
                const foodName = item.querySelector('.food-name').value.trim();
                const amount = parseFloat(item.querySelector('.food-amount').value) || 0;
                const unit = item.querySelector('.food-unit').value;
                
                console.log(`Processing: ${foodName}, ${amount}${unit}`);
                
                if (foodName && amount > 0) {
                    try {
                        console.log(`üîç Searching for nutrition data: ${foodName}`);
                        const food = await searchFoodAPI(foodName);
                        
                        if (food && food.calories !== undefined) {
                            let multiplier = amount / 100; // Base values are per 100g
                            
                            // Adjust for different units (approximate conversions)
                            if (unit === 'oz') multiplier = (amount * 28.35) / 100;
                            else if (unit === 'cup') multiplier = (amount * 250) / 100; // Approximate
                            else if (unit === 'piece') multiplier = (amount * 150) / 100; // Approximate
                            
                            const itemCalories = (food.calories || 0) * multiplier;
                            const itemProtein = (food.protein || 0) * multiplier;
                            const itemCarbs = (food.carbs || 0) * multiplier;
                            const itemFat = (food.fat || 0) * multiplier;
                            const itemFiber = (food.fiber || 0) * multiplier;
                            const itemSugar = (food.sugar || 0) * multiplier;
                            
                            totalCalories += itemCalories;
                            totalProtein += itemProtein;
                            totalCarbs += itemCarbs;
                            totalFat += itemFat;
                            totalFiber += itemFiber;
                            totalSugar += itemSugar;
                            
                            console.log(`‚úÖ ${foodName}: ${Math.round(itemCalories)} cal, ${Math.round(itemProtein * 10) / 10}g protein`);
                        } else {
                            console.log(`‚ö†Ô∏è No nutrition data found for: ${foodName}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error calculating nutrition for ${foodName}:`, error);
                    }
                }
            }
            
            // Update display with final totals
            document.getElementById('total-calories').textContent = Math.round(totalCalories);
            document.getElementById('total-protein').textContent = Math.round(totalProtein * 10) / 10 + 'g';
            document.getElementById('total-carbs').textContent = Math.round(totalCarbs * 10) / 10 + 'g';
            document.getElementById('total-fat').textContent = Math.round(totalFat * 10) / 10 + 'g';
            document.getElementById('total-fiber').textContent = Math.round(totalFiber * 10) / 10 + 'g';
            document.getElementById('total-sugar').textContent = Math.round(totalSugar * 10) / 10 + 'g';
            
            console.log(`üéØ Final totals: ${Math.round(totalCalories)} calories, ${Math.round(totalProtein * 10) / 10}g protein`);
        }
        
        // ===== MEAL PLANNER FUNCTIONS =====
        
        function saveMealPlan() {
            const mealPlan = {
                today: {
                    breakfast: document.getElementById('meal-breakfast')?.value || '',
                    lunch: document.getElementById('meal-lunch')?.value || '',
                    dinner: document.getElementById('meal-dinner')?.value || '',
                    snacks: document.getElementById('meal-snacks')?.value || ''
                }
            };
            
            localStorage.setItem('mealPlan', JSON.stringify(mealPlan));
            alert('‚úÖ Meal plan saved successfully!');
        }
        
        function loadMealPlan() {
            const savedPlan = localStorage.getItem('mealPlan');
            if (!savedPlan) {
                alert('No saved meal plan found.');
                return;
            }
            
            try {
                const mealPlan = JSON.parse(savedPlan);
                if (mealPlan.today) {
                    document.getElementById('meal-breakfast').value = mealPlan.today.breakfast || '';
                    document.getElementById('meal-lunch').value = mealPlan.today.lunch || '';
                    document.getElementById('meal-dinner').value = mealPlan.today.dinner || '';
                    document.getElementById('meal-snacks').value = mealPlan.today.snacks || '';
                }
                
                alert('‚úÖ Meal plan loaded successfully!');
            } catch (error) {
                alert('‚ùå Error loading meal plan.');
            }
        }
        
        function generateMealSuggestions() {
            const suggestions = {
                breakfast: [
                    'Oatmeal with berries and nuts',
                    'Greek yogurt with granola',
                    'Scrambled eggs with avocado toast',
                    'Smoothie bowl with protein powder',
                    'Whole grain cereal with banana'
                ],
                lunch: [
                    'Grilled chicken salad',
                    'Quinoa bowl with vegetables',
                    'Turkey and hummus wrap',
                    'Lentil soup with whole grain bread',
                    'Salmon with sweet potato'
                ],
                dinner: [
                    'Baked fish with roasted vegetables',
                    'Stir-fry with brown rice',
                    'Lean beef with steamed broccoli',
                    'Vegetable curry with quinoa',
                    'Grilled chicken with asparagus'
                ],
                snacks: [
                    'Apple with almond butter',
                    'Mixed nuts and seeds',
                    'Carrot sticks with hummus',
                    'Greek yogurt with berries',
                    'Protein smoothie'
                ]
            };
            
            // Fill meal inputs with suggestions if empty
            const meals = ['breakfast', 'lunch', 'dinner', 'snacks'];
            meals.forEach(mealType => {
                const input = document.getElementById(`meal-${mealType}`);
                if (input && !input.value && suggestions[mealType]) {
                    const randomSuggestion = suggestions[mealType][Math.floor(Math.random() * suggestions[mealType].length)];
                    input.value = randomSuggestion;
                }
            });
            
            alert('ü§ñ AI meal suggestions generated! Review and modify as needed.');
        }
        
        function exportMealPlan() {
            const breakfast = document.getElementById('meal-breakfast')?.value || '';
            const lunch = document.getElementById('meal-lunch')?.value || '';
            const dinner = document.getElementById('meal-dinner')?.value || '';
            const snacks = document.getElementById('meal-snacks')?.value || '';
            
            // Create downloadable text file
            let exportText = 'üìÖ TODAY\'S MEAL PLAN\\n\\n';
            exportText += 'BREAKFAST:\\n  ' + breakfast + '\\n\\n';
            exportText += 'LUNCH:\\n  ' + lunch + '\\n\\n';
            exportText += 'DINNER:\\n  ' + dinner + '\\n\\n';
            exportText += 'SNACKS:\\n  ' + snacks + '\\n\\n';
            
            // Create and download file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meal-plan.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('üìä Meal plan exported successfully!');
        }
        
        // ===== DYNAMIC CONTENT LOADING FUNCTIONS =====
        
        async function refreshNutritionNews() {
            console.log('üîÑ Refreshing nutrition news...');
            const contentDiv = document.getElementById('nutrition-news-content');
            
            contentDiv.innerHTML = `
                <div class="bg-slate-700 p-6 rounded-lg text-center">
                    <div class="animate-spin text-2xl mb-2">‚è≥</div>
                    <p class="text-slate-300">Loading fresh nutrition news...</p>
                </div>
            `;
            
            try {
                const content = await fetchLiveContent('nutrition', 'news');
                displayLiveNews(content.news, 'nutrition-news-content');
            } catch (error) {
                console.error('Failed to load nutrition news:', error);
                contentDiv.innerHTML = `
                    <div class="bg-red-800/30 border border-red-600 rounded-lg p-6 text-center">
                        <div class="text-2xl mb-2">‚ùå</div>
                        <p class="text-red-300">Unable to load news. Please try again later.</p>
                        <button onclick="refreshNutritionNews()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function displayLiveNews(articles, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !articles.length) return;
            
            const newsHTML = articles.map((article, index) => `
                <div class="bg-slate-700 p-6 rounded-lg hover:bg-slate-600 transition-colors">
                    <div class="flex items-start gap-4">
                        <div class="text-2xl">${getNewsEmoji(index)}</div>
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-slate-100 mb-2 leading-tight">${article.title}</h4>
                            <p class="text-slate-300 text-sm mb-3 leading-relaxed">${article.description || 'Click to read more...'}</p>
                            <div class="flex items-center gap-3 text-xs">
                                <span class="text-purple-400">${formatDate(article.publishedAt)}</span>
                                <span class="text-slate-400">${article.source}</span>
                                ${article.aiGenerated ? '<span class="bg-blue-600 px-2 py-1 rounded text-white">AI Generated</span>' : ''}
                            </div>
                            ${article.url && article.url !== '#' ? `
                                <a href="${article.url}" target="_blank" class="inline-flex items-center mt-3 text-blue-400 hover:text-blue-300 text-sm font-medium">
                                    <i class="fas fa-external-link-alt mr-2"></i>Read Full Article
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = newsHTML;
        }
        
        function getNewsEmoji(index) {
            const emojis = ['üî¨', 'üß†', 'üíä', 'ü•ó', 'üìä', 'üè•', 'üîç', 'üí°'];
            return emojis[index % emojis.length];
        }
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return 'Recent';
            }
        }
        
        async function loadCategoryContent(categoryId) {
            console.log(`üîÑ Loading live content for ${categoryId}`);
            
            // Show loading state
            const modal = document.getElementById('research-modal');
            if (modal) {
                const contentArea = modal.querySelector('.modal-content');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div class="text-center py-12">
                            <div class="animate-spin text-4xl mb-4">‚è≥</div>
                            <h3 class="text-xl font-bold text-slate-200 mb-2">Loading Live Content...</h3>
                            <p class="text-slate-400">Fetching the latest ${categoryId} research and news</p>
                        </div>
                    `;
                }
            }
            
            try {
                const content = await fetchLiveContent(categoryId);
                
                // Display the loaded content
                const categoryContent = getResearchContent(categoryId);
                if (categoryContent && modal) {
                    const contentArea = modal.querySelector('.modal-content');
                    if (contentArea) {
                        contentArea.innerHTML = categoryContent.html;
                        
                        // If this is nutrition category, load the news automatically
                        if (categoryId === 'nutrition') {
                            // Initialize nutrition tabs
                            setTimeout(() => {
                                showNutritionTab('lookup');
                                refreshNutritionNews();
                            }, 500);
                        }
                    }
                }
                
            } catch (error) {
                console.error(`Failed to load ${categoryId} content:`, error);
                // Fallback to static content
                const categoryContent = getResearchContent(categoryId);
                if (categoryContent && modal) {
                    const contentArea = modal.querySelector('.modal-content');
                    if (contentArea) {
                        contentArea.innerHTML = categoryContent.html + `
                            <div class="bg-yellow-800/30 border border-yellow-600 rounded-lg p-4 mt-4">
                                <p class="text-yellow-200 text-sm">
                                    ‚ö†Ô∏è Live content unavailable. Showing cached information. 
                                    <button onclick="loadCategoryContent('${categoryId}')" class="underline">Try again</button>
                                </p>
                            </div>
                        `;
                    }
                }
            }
        }
        
        function performSearch() {
            const searchInput = document.getElementById('knowledge-search');
            const query = searchInput ? searchInput.value.trim() : '';
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            console.log('üîç Performing search:', query);
            alert(`Searching for: "${query}"\n\nThis would search through our database of evidence-based research, clinical studies, and health resources.`);
        }
        
        // PRICING FUNCTIONS
        function selectPlan(plan) {
            console.log('üí≥ Plan selected:', plan);
            
            if (plan === 'free') {
                showPurchaseModal('Free Plan', '$0/month', 'You are already on the Free plan! Enjoy access to basic features including 50 credits monthly, basic assessments, knowledge library access, text AI coaches, and voice therapy.', false);
            } else {
                const plans = {
                    'basic': { name: 'Basic Plan', price: '¬£24/month', credits: '50 credits monthly' },
                    'premium': { name: 'Premium Plan', price: '¬£49/month', credits: '150 credits monthly' },
                    'vip': { name: 'VIP Elite Plan', price: '¬£82/month', credits: 'Unlimited credits' }
                };
                const planInfo = plans[plan] || { name: plan.toUpperCase(), price: 'Custom pricing', credits: 'Contact sales' };
                showPurchaseModal(planInfo.name, planInfo.price, `Upgrade to ${planInfo.name} and get ${planInfo.credits} plus all premium features!`, true);
            }
        }
        
        function forceStartAssessment() {
            console.log('üö® FORCING ASSESSMENT START...');
            
            const container = document.getElementById('assessment-container');
            if (!container) {
                console.error('‚ùå Assessment container not found');
                return;
            }
            
            // Define questions directly in function to ensure they exist
            const questions = [
                {
                    id: 'purpose',
                    title: 'Assessment Purpose & Goals',
                    question: 'What brings you to this health assessment today? What are you hoping to achieve?',
                    description: 'Understanding your motivation helps us provide the most relevant guidance.',
                    type: 'text',
                    followUp: true
                },
                {
                    id: 'energy',
                    title: 'Energy & Vitality Assessment', 
                    question: 'How would you rate your overall energy levels throughout the day?',
                    description: 'This helps us understand your baseline energy and identify potential areas for improvement.',
                    answers: [
                        { text: 'Excellent', description: 'High energy throughout the day, rarely feel tired', score: 5, category: 'energy' },
                        { text: 'Good', description: 'Generally energetic with occasional dips', score: 4, category: 'energy' },
                        { text: 'Average', description: 'Moderate energy, some afternoon fatigue', score: 3, category: 'energy' },
                        { text: 'Low', description: 'Often feel tired or sluggish', score: 2, category: 'energy' },
                        { text: 'Very Low', description: 'Constantly exhausted, difficult to function', score: 1, category: 'energy' }
                    ],
                    followUp: true
                },
                {
                    id: 'sleep',
                    title: 'Sleep Quality Assessment',
                    question: 'How would you describe your sleep quality and patterns?', 
                    description: 'Sleep is fundamental to health, affecting everything from immune function to mental clarity.',
                    answers: [
                        { text: 'Excellent', description: 'Fall asleep easily, sleep 7-9 hours, wake refreshed', score: 5, category: 'sleep' },
                        { text: 'Good', description: 'Generally good sleep with occasional issues', score: 4, category: 'sleep' },
                        { text: 'Fair', description: 'Some difficulty falling asleep or staying asleep', score: 3, category: 'sleep' },
                        { text: 'Poor', description: 'Frequent sleep problems, wake up tired', score: 2, category: 'sleep' },
                        { text: 'Very Poor', description: 'Severe insomnia or sleep disorders', score: 1, category: 'sleep' }
                    ]
                },
                {
                    id: 'stress',
                    title: 'Stress Management Assessment',
                    question: 'How well do you currently manage stress in your daily life?',
                    description: 'Chronic stress impacts both physical and mental health significantly.',
                    answers: [
                        { text: 'Very Well', description: 'Effective coping strategies, rarely overwhelmed', score: 5, category: 'stress' },
                        { text: 'Well', description: 'Generally handle stress well with some challenges', score: 4, category: 'stress' },
                        { text: 'Moderately', description: 'Some stress management tools but room for improvement', score: 3, category: 'stress' },
                        { text: 'Poorly', description: 'Often feel overwhelmed and stressed', score: 2, category: 'stress' },
                        { text: 'Very Poorly', description: 'Chronic stress significantly impacts daily life', score: 1, category: 'stress' }
                    ]
                }
            ];
            
            // Initialize assessment state
            window.assessmentState = {
                currentQuestion: 0,
                answers: {},
                scores: { energy: 0, sleep: 0, stress: 0, nutrition: 0, mental: 0, physical: 0, social: 0, overall: 0 },
                totalQuestions: questions.length
            };
            
            // Update progress
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = '12.5%';
            }
            if (progressText) {
                progressText.textContent = 'Question 1 of ' + questions.length;
            }
            
            // Display first question
            const question = questions[0];
            
            let answersHTML = '';
            if (question.type === 'text') {
                answersHTML = `
                    <div class="mb-6">
                        <textarea 
                            id="assessment-text-0" 
                            class="w-full p-4 bg-slate-600/50 border border-slate-500 rounded-lg text-slate-100 resize-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                            rows="4"
                            placeholder="Share your thoughts and goals..."
                        ></textarea>
                    </div>
                    <button onclick="submitTextAnswer(0)" class="btn-primary w-full">
                        <i class="fas fa-arrow-right mr-2"></i>Continue
                    </button>
                `;
            } else {
                answersHTML = `
                    <div class="space-y-3">
                        ${question.answers.map((answer, index) => `
                            <button onclick="selectAnswer(0, ${index})" class="assessment-option w-full text-left p-4 bg-slate-600/50 hover:bg-slate-500/70 rounded-lg transition-all border border-slate-500 hover:border-blue-400">
                                <div class="flex items-center">
                                    <div class="circle w-4 h-4 border-2 border-slate-400 rounded-full mr-3"></div>
                                    <div class="flex-1">
                                        <div class="font-medium text-slate-100">${answer.text}</div>
                                        <div class="text-sm text-slate-400">${answer.description}</div>
                                    </div>
                                    <div class="ml-auto text-slate-500 font-medium">${answer.score}/5</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            
            const questionHTML = `
                <div class="assessment-question active" data-question="0">
                    <div class="mb-6">
                        <div class="text-sm text-blue-400 font-medium mb-2">${question.title}</div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-3">${question.question}</h3>
                        <p class="text-slate-400">${question.description}</p>
                    </div>
                    ${answersHTML}
                </div>
            `;
            
            container.innerHTML = questionHTML;
            
            console.log('‚úÖ ASSESSMENT FORCED TO START - First question displayed');
        }
        
        window.forceStartAssessment = forceStartAssessment;
        
        // INTELLIGENT CONNECTED ASSESSMENT - OPTIMAL FLOW
        function startIntelligentAssessment() {
            console.log('üß† Starting intelligent connected assessment...');
            
            const container = document.getElementById('assessment-container');
            if (!container) {
                console.error('‚ùå Assessment container not found');
                return;
            }
            
            // Initialize intelligent assessment state
            window.intelligentAssessment = {
                currentQuestion: 0,
                answers: {},
                scores: {},
                totalQuestions: 8,
                questions: [
                    {
                        id: 'purpose',
                        title: 'Assessment Purpose & Health Goals',
                        question: 'What brings you to this health assessment today?',
                        subtext: 'Understanding your motivation helps us provide the most relevant guidance.',
                        type: 'text',
                        placeholder: 'I want to improve my...',
                        followUp: true
                    },
                    {
                        id: 'energy',
                        title: 'Energy & Vitality Levels',
                        question: 'How would you rate your overall energy throughout the day?',
                        subtext: 'This helps us understand your baseline energy and identify improvement areas.',
                        type: 'scale',
                        answers: [
                            { text: 'Excellent', description: 'High energy all day, rarely tired', score: 5, category: 'energy' },
                            { text: 'Good', description: 'Generally energetic with occasional dips', score: 4, category: 'energy' },
                            { text: 'Average', description: 'Moderate energy, afternoon fatigue', score: 3, category: 'energy' },
                            { text: 'Low', description: 'Often feel tired or sluggish', score: 2, category: 'energy' },
                            { text: 'Very Low', description: 'Constantly exhausted, hard to function', score: 1, category: 'energy' }
                        ]
                    },
                    {
                        id: 'sleep',
                        title: 'Sleep Quality & Patterns',
                        question: 'How would you describe your sleep quality?',
                        subtext: 'Sleep affects immune function, mental clarity, and overall health.',
                        type: 'scale',
                        answers: [
                            { text: 'Excellent', description: '7-9 hours, fall asleep easily, wake refreshed', score: 5, category: 'sleep' },
                            { text: 'Good', description: 'Generally sleep well with occasional issues', score: 4, category: 'sleep' },
                            { text: 'Fair', description: 'Some difficulty falling/staying asleep', score: 3, category: 'sleep' },
                            { text: 'Poor', description: 'Frequent sleep problems, wake tired', score: 2, category: 'sleep' },
                            { text: 'Very Poor', description: 'Severe insomnia or sleep disorders', score: 1, category: 'sleep' }
                        ]
                    },
                    {
                        id: 'stress',
                        title: 'Stress Management & Coping',
                        question: 'How well do you manage daily stress?',
                        subtext: 'Chronic stress significantly impacts both physical and mental health.',
                        type: 'scale',
                        answers: [
                            { text: 'Very Well', description: 'Effective coping strategies, rarely overwhelmed', score: 5, category: 'stress' },
                            { text: 'Well', description: 'Generally handle stress with some challenges', score: 4, category: 'stress' },
                            { text: 'Moderately', description: 'Some tools but room for improvement', score: 3, category: 'stress' },
                            { text: 'Poorly', description: 'Often feel overwhelmed and stressed', score: 2, category: 'stress' },
                            { text: 'Very Poorly', description: 'Chronic stress significantly impacts life', score: 1, category: 'stress' }
                        ]
                    },
                    {
                        id: 'mental',
                        title: 'Mental & Emotional Wellness',
                        question: 'How is your overall mental and emotional well-being?',
                        subtext: 'Mental health affects relationships, work performance, and physical health.',
                        type: 'scale',
                        answers: [
                            { text: 'Excellent', description: 'Positive mood, resilient, emotionally balanced', score: 5, category: 'mental' },
                            { text: 'Good', description: 'Generally positive with normal challenges', score: 4, category: 'mental' },
                            { text: 'Fair', description: 'Some mood fluctuations, manageable stress', score: 3, category: 'mental' },
                            { text: 'Concerning', description: 'Frequent anxiety, low mood, emotional challenges', score: 2, category: 'mental' },
                            { text: 'Poor', description: 'Significant mental health challenges affecting daily life', score: 1, category: 'mental' }
                        ]
                    },
                    {
                        id: 'nutrition',
                        title: 'Nutritional Health & Eating Habits',
                        question: 'How would you rate your current nutrition and eating patterns?',
                        subtext: 'Nutrition directly affects energy, mood, and long-term health outcomes.',
                        type: 'scale',
                        answers: [
                            { text: 'Excellent', description: 'Balanced whole foods, consistent healthy meals', score: 5, category: 'nutrition' },
                            { text: 'Good', description: 'Generally healthy with occasional treats', score: 4, category: 'nutrition' },
                            { text: 'Fair', description: 'Mixed diet, some processed foods, irregular meals', score: 3, category: 'nutrition' },
                            { text: 'Poor', description: 'Frequent fast food, high processed intake', score: 2, category: 'nutrition' },
                            { text: 'Very Poor', description: 'Severely unbalanced, frequent meal skipping', score: 1, category: 'nutrition' }
                        ]
                    },
                    {
                        id: 'physical',
                        title: 'Physical Activity & Movement',
                        question: 'How active are you in terms of exercise and physical movement?',
                        subtext: 'Regular activity is crucial for cardiovascular health, strength, and mental well-being.',
                        type: 'scale',
                        answers: [
                            { text: 'Very Active', description: 'Exercise 5+ times/week, variety of activities', score: 5, category: 'physical' },
                            { text: 'Active', description: 'Exercise 3-4 times/week consistently', score: 4, category: 'physical' },
                            { text: 'Moderately Active', description: 'Some exercise 1-2 times/week', score: 3, category: 'physical' },
                            { text: 'Lightly Active', description: 'Occasional walks or light activity', score: 2, category: 'physical' },
                            { text: 'Sedentary', description: 'Very little physical activity or exercise', score: 1, category: 'physical' }
                        ]
                    },
                    {
                        id: 'social',
                        title: 'Social Connections & Support System',
                        question: 'How would you rate your social connections and support?',
                        subtext: 'Strong social connections are linked to better health and increased longevity.',
                        type: 'scale',
                        answers: [
                            { text: 'Excellent', description: 'Strong support network, meaningful relationships', score: 5, category: 'social' },
                            { text: 'Good', description: 'Solid relationships with family and friends', score: 4, category: 'social' },
                            { text: 'Fair', description: 'Some connections but could be stronger', score: 3, category: 'social' },
                            { text: 'Limited', description: 'Few close relationships, limited support', score: 2, category: 'social' },
                            { text: 'Isolated', description: 'Feeling lonely, lack of meaningful connections', score: 1, category: 'social' }
                        ]
                    }
                ]
            };
            
            // Display first question immediately
            displayIntelligentQuestion(0);
        }
        
        // Display intelligent assessment question with smooth flow
        function displayIntelligentQuestion(questionIndex) {
            console.log('üìù Displaying intelligent question', questionIndex + 1, 'of', window.intelligentAssessment.totalQuestions);
            
            const assessment = window.intelligentAssessment;
            const question = assessment.questions[questionIndex];
            const container = document.getElementById('assessment-container');
            
            if (!question || !container) {
                console.error('‚ùå Question or container not found');
                return;
            }
            
            // Update progress
            const progressPercent = ((questionIndex + 1) / assessment.totalQuestions) * 100;
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) progressBar.style.width = progressPercent + '%';
            if (progressText) progressText.textContent = `Question ${questionIndex + 1} of ${assessment.totalQuestions}`;
            
            let contentHTML = '';
            
            if (question.type === 'text') {
                contentHTML = `
                    <div class="mb-8">
                        <textarea 
                            id="intelligent-text-${questionIndex}" 
                            class="w-full p-6 bg-slate-600/40 border-2 border-slate-500 rounded-xl text-slate-100 resize-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/50 transition-all"
                            rows="5"
                            placeholder="${question.placeholder || 'Share your thoughts...'}"
                        ></textarea>
                    </div>
                    <button onclick="submitIntelligentTextAnswer(${questionIndex})" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                        <i class="fas fa-arrow-right mr-2"></i>Continue Assessment
                    </button>
                `;
            } else {
                contentHTML = `
                    <div class="space-y-4">
                        ${question.answers.map((answer, index) => `
                            <button onclick="selectIntelligentAnswer(${questionIndex}, ${index})" class="intelligent-option w-full text-left p-6 bg-slate-600/30 hover:bg-slate-500/50 rounded-xl transition-all border-2 border-slate-500/50 hover:border-blue-400/70 group">
                                <div class="flex items-center">
                                    <div class="option-circle w-5 h-5 border-2 border-slate-400 rounded-full mr-4 group-hover:border-blue-400 transition-all"></div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-slate-100 text-lg mb-1">${answer.text}</div>
                                        <div class="text-sm text-slate-300">${answer.description}</div>
                                    </div>
                                    <div class="ml-auto">
                                        <div class="w-12 h-12 bg-slate-700/50 rounded-full flex items-center justify-center">
                                            <span class="text-slate-300 font-bold text-sm">${answer.score}</span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            }
            
            const questionHTML = `
                <div class="intelligent-question-card">
                    <div class="mb-8">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mr-4">
                                <span class="text-white font-bold text-lg">${questionIndex + 1}</span>
                            </div>
                            <div>
                                <div class="text-sm text-blue-400 font-semibold uppercase tracking-wide">${question.title}</div>
                            </div>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-100 mb-3 leading-tight">${question.question}</h2>
                        <p class="text-lg text-slate-300">${question.subtext}</p>
                    </div>
                    ${contentHTML}
                </div>
            `;
            
            container.innerHTML = questionHTML;
            
            // Focus on text input if present
            const textInput = document.getElementById(`intelligent-text-${questionIndex}`);
            if (textInput) {
                setTimeout(() => textInput.focus(), 100);
            }
        }
        
        // Handle text answer submission
        function submitIntelligentTextAnswer(questionIndex) {
            const textInput = document.getElementById(`intelligent-text-${questionIndex}`);
            if (!textInput || !textInput.value.trim()) {
                alert('Please share your thoughts before continuing.');
                return;
            }
            
            // Store answer
            const question = window.intelligentAssessment.questions[questionIndex];
            window.intelligentAssessment.answers[question.id] = {
                text: textInput.value.trim(),
                type: 'text'
            };
            
            console.log('üìù Text answer stored:', question.id, textInput.value.trim());
            
            // Move to next question
            nextIntelligentQuestion();
        }
        
        // Handle scale answer selection
        function selectIntelligentAnswer(questionIndex, answerIndex) {
            const question = window.intelligentAssessment.questions[questionIndex];
            const answer = question.answers[answerIndex];
            
            // Visual feedback
            const options = document.querySelectorAll('.intelligent-option');
            options.forEach(opt => {
                opt.classList.remove('selected');
                opt.style.backgroundColor = '';
                opt.style.borderColor = '';
            });
            
            const selectedOption = options[answerIndex];
            if (selectedOption) {
                selectedOption.classList.add('selected');
                selectedOption.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                selectedOption.style.borderColor = 'rgb(59, 130, 246)';
                
                // Update circle
                const circle = selectedOption.querySelector('.option-circle');
                if (circle) {
                    circle.style.backgroundColor = 'rgb(59, 130, 246)';
                    circle.style.borderColor = 'rgb(59, 130, 246)';
                }
            }
            
            // Store answer and score
            window.intelligentAssessment.answers[question.id] = answer;
            window.intelligentAssessment.scores[answer.category] = answer.score;
            
            console.log('‚úÖ Answer selected:', answer.text, 'Score:', answer.score);
            
            // Auto-advance after selection
            setTimeout(() => {
                nextIntelligentQuestion();
            }, 600);
        }
        
        // Move to next question or complete assessment
        function nextIntelligentQuestion() {
            window.intelligentAssessment.currentQuestion++;
            
            if (window.intelligentAssessment.currentQuestion >= window.intelligentAssessment.totalQuestions) {
                completeIntelligentAssessment();
            } else {
                displayIntelligentQuestion(window.intelligentAssessment.currentQuestion);
            }
        }
        
        // Complete assessment and show results
        function completeIntelligentAssessment() {
            console.log('üéâ Intelligent assessment completed!');
            
            const container = document.getElementById('assessment-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            // Complete progress
            if (progressBar) progressBar.style.width = '100%';
            if (progressText) progressText.textContent = 'Assessment Complete!';
            
            // Calculate overall score
            const scores = window.intelligentAssessment.scores;
            const totalScore = Object.values(scores).reduce((sum, score) => sum + score, 0);
            const avgScore = totalScore / Object.keys(scores).length;
            
            // üö® CRITICAL: Crisis Detection Analysis
            console.log('üö® Running crisis detection on assessment results...');
            const assessmentData = {
                scores: scores,
                responses: window.intelligentAssessment.responses || {},
                avgScore: avgScore
            };
            
            // Check for crisis indicators using our crisis detection system
            const crisisData = detectCrisisIndicators(assessmentData);
            
            console.log('üö® Crisis analysis result:', crisisData);
            
            // IMMEDIATE CRISIS INTERVENTION if needed
            if (crisisData.suicidalRisk) {
                console.log('üö® CRISIS DETECTED - Crisis intervention already shown');
                return; // Crisis intervention already shown by detectCrisisIndicators
            }
            const healthPercentage = Math.round((avgScore / 5) * 100);
            
            // Store results globally
            window.lastAssessmentResults = {
                completed: true,
                timestamp: new Date(),
                scores: scores,
                answers: window.intelligentAssessment.answers,
                healthPercentage: healthPercentage
            };
            
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-8 shadow-xl">
                        <i class="fas fa-check text-white text-4xl"></i>
                    </div>
                    <h2 class="text-4xl font-bold text-slate-100 mb-4">Assessment Complete!</h2>
                    <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-2xl p-8 mb-8 border border-blue-400/30">
                        <div class="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mb-2">
                            ${healthPercentage}%
                        </div>
                        <p class="text-xl text-slate-300">Overall Health Score</p>
                    </div>
                    <p class="text-xl text-slate-300 mb-12 max-w-2xl mx-auto">
                        Your comprehensive assessment is complete. Based on your responses, we'll provide personalized coaching recommendations.
                    </p>
                    <div class="space-y-4">
                        <button onclick="navigateToSection('coaches')" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-12 py-5 rounded-xl text-white font-bold text-xl shadow-xl hover:shadow-2xl transition-all">
                            <i class="fas fa-user-md mr-3"></i>Get Your Personalized Coaching
                        </button>
                        <div class="flex justify-center space-x-4">
                            <button onclick="startIntelligentAssessment()" class="bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white font-medium">
                                <i class="fas fa-redo mr-2"></i>Retake Assessment
                            </button>
                            <button onclick="navigateToSection('dashboard')" class="bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white font-medium">
                                <i class="fas fa-chart-line mr-2"></i>View Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Trigger AI recommendations if Groq is available
            if (window.groqAPI && window.groqAPI.isConnected) {
                setTimeout(() => {
                    console.log('üß† Triggering AI coaching recommendations...');
                    window.startAIEnhancedCoaching(window.lastAssessmentResults);
                }, 2000);
            }
        }
        
        // Make functions globally accessible
        window.startIntelligentAssessment = startIntelligentAssessment;
        window.displayIntelligentQuestion = displayIntelligentQuestion;
        window.submitIntelligentTextAnswer = submitIntelligentTextAnswer;
        window.selectIntelligentAnswer = selectIntelligentAnswer;
        window.nextIntelligentQuestion = nextIntelligentQuestion;
        window.completeIntelligentAssessment = completeIntelligentAssessment;
        
        // Simple text answer submission
        function submitTextAnswer(questionIndex) {
            console.log('üìù Submitting text answer for question', questionIndex);
            const textInput = document.getElementById(`assessment-text-${questionIndex}`);
            if (textInput && textInput.value.trim()) {
                // Store the answer
                if (!window.assessmentState) {
                    window.assessmentState = { answers: {}, scores: {} };
                }
                window.assessmentState.answers['purpose'] = { text: textInput.value.trim() };
                
                // Move to next question
                nextAssessmentQuestion();
            } else {
                alert('Please enter your response before continuing.');
            }
        }
        
        // Simple answer selection
        function selectAnswer(questionIndex, answerIndex) {
            console.log('‚úÖ Answer selected:', questionIndex, answerIndex);
            
            // Visual feedback
            const buttons = document.querySelectorAll('.assessment-option');
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            if (buttons[answerIndex]) {
                buttons[answerIndex].classList.add('selected');
                buttons[answerIndex].style.backgroundColor = 'rgb(34, 197, 94, 0.2)';
                buttons[answerIndex].style.borderColor = 'rgb(34, 197, 94)';
            }
            
            // Move to next question after selection
            setTimeout(() => {
                nextAssessmentQuestion();
            }, 800);
        }
        
        // Move to next question
        function nextAssessmentQuestion() {
            console.log('‚û°Ô∏è Moving to next question...');
            
            if (!window.assessmentState) return;
            
            window.assessmentState.currentQuestion++;
            
            if (window.assessmentState.currentQuestion >= 4) { // We have 4 questions
                showAssessmentResults();
            } else {
                // For now, just show completion message since we have the core working
                showAssessmentResults();
            }
        }
        
        // Show results
        function showAssessmentResults() {
            console.log('üéâ Assessment completed!');
            
            const container = document.getElementById('assessment-container');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check text-white text-3xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-100 mb-4">Assessment Complete!</h2>
                        <p class="text-slate-300 text-lg mb-8">
                            Thank you for completing your health assessment. Your responses will help us provide personalized recommendations.
                        </p>
                        <div class="space-y-4">
                            <button onclick="navigateToSection('coaches')" class="btn-primary px-8 py-4 text-lg mr-4">
                                <i class="fas fa-user-md mr-2"></i>Get Personalized Coaching
                            </button>
                            <button onclick="forceStartAssessment()" class="btn-secondary px-8 py-4 text-lg">
                                <i class="fas fa-redo mr-2"></i>Retake Assessment
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Store results for dashboard
            window.lastAssessmentResults = {
                completed: true,
                timestamp: new Date(),
                scores: window.assessmentState.scores || {},
                answers: window.assessmentState.answers || {}
            };
        }
        
        // Make functions globally accessible
        window.submitTextAnswer = submitTextAnswer;
        window.selectAnswer = selectAnswer;
        window.nextAssessmentQuestion = nextAssessmentQuestion;
        window.showAssessmentResults = showAssessmentResults;
        window.startVoiceConversation = startVoiceConversation;
        window.endVoiceSession = endVoiceSession;
        window.showEMDRTools = showEMDRTools;
        window.stopEMDR = stopEMDR;
        window.showHypnotherapyTools = showHypnotherapyTools;
        window.stopHypno = stopHypno;
        window.exploreCategory = exploreCategory;
        window.closeResearchModal = closeResearchModal;
        window.performSearch = performSearch;
        
        // Nutrition system exports
        window.showNutritionTab = showNutritionTab;
        window.handleFoodSearch = handleFoodSearch;
        window.quickFoodSearch = quickFoodSearch;
        window.searchFood = searchFood;
        
        // Dynamic content system exports
        window.refreshNutritionNews = refreshNutritionNews;
        window.loadCategoryContent = loadCategoryContent;
        window.fetchLiveContent = fetchLiveContent;
        window.addMealItem = addMealItem;
        window.removeMealItem = removeMealItem;
        window.addToMeal = addToMeal;
        window.calculateMeal = calculateMeal;
        
        // Meal planner exports
        window.saveMealPlan = saveMealPlan;
        window.loadMealPlan = loadMealPlan;
        window.generateMealSuggestions = generateMealSuggestions;
        window.exportMealPlan = exportMealPlan;
        window.selectPlan = selectPlan;
        window.buySubscription = buySubscription;
        
        // PRICING CALCULATOR FUNCTIONS
        function updateCalculator() {
            const coachSessions = parseInt(document.getElementById('coach-sessions')?.value || 0);
            const voiceMinutes = parseInt(document.getElementById('voice-minutes')?.value || 0);
            const assessments = parseInt(document.getElementById('assessments')?.value || 0);
            
            // Calculate total credits needed
            const sessionCredits = coachSessions; // 1 credit per session
            const voiceCredits = Math.ceil(voiceMinutes / 5); // 1 credit per 5 minutes
            const assessmentCredits = assessments * 3; // 3 credits per assessment
            
            const totalCredits = sessionCredits + voiceCredits + assessmentCredits;
            
            // Update display
            const totalCreditsEl = document.getElementById('total-credits');
            if (totalCreditsEl) {
                totalCreditsEl.textContent = `${totalCredits} Credits`;
            }
            
            // Recommend best plan
            let recommendedPlan = '';
            if (totalCredits <= 50) {
                recommendedPlan = 'Basic Plan ($19/month)';
            } else if (totalCredits <= 150) {
                recommendedPlan = 'Premium Plan ($49/month)';
            } else {
                recommendedPlan = 'VIP Elite Plan ($99/month)';
            }
            
            const recommendedPlanEl = document.getElementById('recommended-plan');
            if (recommendedPlanEl) {
                recommendedPlanEl.textContent = recommendedPlan;
            }
        }
        
        // Credit purchase function
        function buyCredits(credits, price) {
            console.log(`üí≥ Purchasing ${credits} credits for $${price}`);
            
            // Use variable price for credit packages
            const VARIABLE_PRICE_ID = 'price_1S5lj2C5Ez9YOIaylK1qkQ8m';
            
            window.currentPurchase = { 
                planType: 'credits', 
                priceId: VARIABLE_PRICE_ID, 
                planName: `${credits} Credits Package - $${price}`,
                credits: credits,
                amount: price
            };
            
            showPurchaseModal(
                `${credits} Credits Package`,
                'Credit Purchase',
                `You're about to purchase ${credits} credits for $${price}.\n\nThis will redirect you to our secure Stripe checkout page where you can:\n‚Ä¢ Enter payment details safely\n‚Ä¢ Review purchase details\n‚Ä¢ Complete your payment\n\nYour credits will be added to your account immediately after payment.`,
                true,
                'Continue to Checkout'
            );
        }
        
        function setupAutoReload() {
            const threshold = document.getElementById('auto-reload-threshold').value;
            const amount = document.getElementById('auto-reload-amount').value;
            console.log('‚öôÔ∏è Setting up auto-reload:', threshold, amount);
            alert(`Auto-reload setup:\\n- Trigger: When below ${threshold} credits\\n- Amount: ${amount} credits\\n\\nThis would save your preferences and setup automatic billing.`);
        }
        
        // DIRECT STRIPE CHECKOUT - NO MODALS, STRAIGHT TO STRIPE
        function directStripeCheckout(priceId, mode, planName, credits = null, amount = null) {
            console.log(`üî¥ DIRECT Stripe checkout: ${planName}`, { priceId, mode, credits, amount });
            
            // Show loading immediately
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'stripe-loading';
            loadingDiv.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            loadingDiv.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-sm mx-4 w-full border border-slate-600 text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-spin">
                        <i class="fas fa-spinner text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-100 mb-2">Connecting to Stripe...</h3>
                    <p class="text-slate-300">${planName}</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            // Initialize Stripe directly
            const STRIPE_KEY = 'pk_live_51OBKXzC5Ez9YOIayaEw5ZiJgJiUfIRoN7E5HN6qdtIcxWUsInNmp4Mz8nlRKKqfRsU30tnStNb25BOy1wHTBeL3t00FMxEIHVx';
            
            try {
                // Load Stripe if not already loaded
                if (!window.Stripe) {
                    const script = document.createElement('script');
                    script.src = 'https://js.stripe.com/v3/';
                    script.onload = () => executeStripeCheckout(STRIPE_KEY, priceId, mode, planName, credits, amount, loadingDiv);
                    document.head.appendChild(script);
                } else {
                    executeStripeCheckout(STRIPE_KEY, priceId, mode, planName, credits, amount, loadingDiv);
                }
                
            } catch (error) {
                console.error('‚ùå Direct Stripe error:', error);
                loadingDiv.remove();
                alert(`Payment Error: ${error.message}\n\nPlease try again or contact support.`);
            }
        }
        
        // Execute the actual Stripe checkout
        function executeStripeCheckout(stripeKey, priceId, mode, planName, credits, amount, loadingDiv) {
            try {
                const stripe = Stripe(stripeKey);
                console.log('‚úÖ Stripe initialized, redirecting to checkout...');
                
                // Build checkout configuration
                const config = {
                    lineItems: [{
                        price: priceId,
                        quantity: credits || amount || 1  // Use employee count for enterprise, credits for credits, 1 for regular
                    }],
                    mode: mode,
                    successUrl: window.location.origin + '/success.html?session_id={CHECKOUT_SESSION_ID}&type=' + mode,
                    cancelUrl: window.location.href,
                    customerEmail: null,
                    billingAddressCollection: 'required'
                };
                
                // Add metadata
                if (mode === 'payment' && credits && amount) {
                    config.metadata = {
                        credits: credits.toString(),
                        purchase_type: 'credits',
                        amount: amount.toString()
                    };
                } else if (mode === 'subscription' && credits && amount) {
                    config.metadata = {
                        employees: credits.toString(),
                        purchase_type: 'enterprise',
                        monthly_total: amount.toString()
                    };
                }
                
                console.log('üöÄ Stripe config:', config);
                
                // Redirect to Stripe Checkout
                stripe.redirectToCheckout(config).then(function(result) {
                    if (result.error) {
                        console.error('‚ùå Stripe checkout error:', result.error);
                        loadingDiv.remove();
                        alert(`Checkout Error: ${result.error.message}\n\nPlease try again or contact support.`);
                    }
                }).catch(function(error) {
                    console.error('‚ùå Stripe redirect error:', error);
                    loadingDiv.remove();
                    alert(`Payment Error: ${error.message}\n\nPlease refresh and try again.`);
                });
                
            } catch (error) {
                console.error('‚ùå Stripe execution error:', error);
                loadingDiv.remove();
                alert(`Stripe Error: ${error.message}\n\nPlease refresh the page and try again.`);
            }
        }
        
        // ENTERPRISE CONTACT FLOW
        function showEnterpriseContact(planName, userLimit) {
            console.log(`üè¢ Showing enterprise contact for: ${planName}`);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-md mx-4 w-full border border-slate-600 text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-building text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-100 mb-4">${planName}</h3>
                    <p class="text-slate-300 mb-2">${userLimit}</p>
                    <p class="text-slate-300 mb-6">
                        Thank you for your interest in our Enterprise solutions! Our sales team will contact you within 24 hours to discuss your specific needs and provide a custom demo.
                    </p>
                    <div class="space-y-3">
                        <a href="mailto:sales@rootcausepower.com?subject=Enterprise%20Interest%20-%20${encodeURIComponent(planName)}" 
                           class="block w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-6 py-3 rounded-lg text-white font-bold transition-all">
                            <i class="fas fa-envelope mr-2"></i>Contact Sales Team
                        </a>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white transition-all">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ENTERPRISE PRICING CALCULATOR
        function showEnterpriseCalculator(planType, pricePerUser, maxUsers) {
            console.log(`üè¢üí∞ Enterprise calculator for: ${planType} at ¬£${pricePerUser}/user`);
            
            const planNames = {
                'basic': 'Enterprise Basic',
                'premium': 'Enterprise Premium', 
                'elite': 'Enterprise Elite'
            };
            
            const stripePriceIds = {
                'basic': 'price_1Rz9GBC5Ez9YOIayVPhFHmJB',
                'premium': 'price_1Rz9H8C5Ez9YOIay8tYhG6pE',
                'elite': 'price_1Rz9HSC5Ez9YOIaybYQLrE1N'
            };
            
            const planName = planNames[planType];
            const priceId = stripePriceIds[planType];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-calculator text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-2">${planName}</h3>
                        <p class="text-slate-300">¬£${pricePerUser} per employee per month</p>
                        ${maxUsers < 999 ? `<p class="text-slate-400 text-sm">Maximum ${maxUsers} employees</p>` : ''}
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Employee Count Input -->
                        <div>
                            <label class="block text-slate-300 font-medium mb-2">Number of Employees</label>
                            <div class="relative">
                                <input type="number" 
                                       id="employee-count" 
                                       min="1" 
                                       ${maxUsers < 999 ? `max="${maxUsers}"` : ''}
                                       value="10" 
                                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none"
                                       oninput="updateEnterprisePrice('${planType}', ${pricePerUser}, ${maxUsers}, '${priceId}')">
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Price Display -->
                        <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-300">Monthly Total:</span>
                                <span id="monthly-total" class="text-2xl font-bold text-blue-400">¬£${10 * pricePerUser}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm text-slate-400">
                                <span>10 employees √ó ¬£${pricePerUser}</span>
                                <span>Billed monthly</span>
                            </div>
                        </div>
                        
                        <!-- Features Summary -->
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <h4 class="font-semibold text-slate-200 mb-2">Included Features:</h4>
                            <div class="text-sm text-slate-300 space-y-1">
                                ${planType === 'basic' ? 
                                    '<div>‚Ä¢ Admin dashboard & usage analytics</div><div>‚Ä¢ API access & basic integrations</div><div>‚Ä¢ Email support</div>' :
                                    (planType === 'premium' ?
                                    '<div>‚Ä¢ Everything in Basic</div><div>‚Ä¢ White-label options & advanced analytics</div><div>‚Ä¢ Priority support & custom integrations</div>' :
                                    '<div>‚Ä¢ Everything in Premium</div><div>‚Ä¢ Dedicated support team</div><div>‚Ä¢ On-premise deployment & SLA guarantees</div>')
                                }
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <button onclick="proceedToEnterprisePayment('${planType}', '${priceId}', '${planName}')" 
                                    class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-6 py-3 rounded-lg text-white font-bold transition-all">
                                <i class="fas fa-credit-card mr-2"></i>
                                Continue to Payment
                            </button>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white transition-all">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Update enterprise pricing in real-time
        function updateEnterprisePrice(planType, pricePerUser, maxUsers, priceId) {
            const employeeInput = document.getElementById('employee-count');
            const monthlyTotalEl = document.getElementById('monthly-total');
            
            if (!employeeInput || !monthlyTotalEl) return;
            
            let employees = parseInt(employeeInput.value) || 1;
            
            // Enforce limits
            if (employees < 1) {
                employees = 1;
                employeeInput.value = 1;
            }
            if (maxUsers < 999 && employees > maxUsers) {
                employees = maxUsers;
                employeeInput.value = maxUsers;
            }
            
            const monthlyTotal = employees * pricePerUser;
            monthlyTotalEl.textContent = `¬£${monthlyTotal}`;
            
            // Update calculation display
            const calcDisplay = monthlyTotalEl.parentElement.nextElementSibling.querySelector('span');
            if (calcDisplay) {
                calcDisplay.textContent = `${employees} employees √ó ¬£${pricePerUser}`;
            }
            
            console.log(`üìä Enterprise pricing update: ${employees} employees √ó ¬£${pricePerUser} = ¬£${monthlyTotal}/month`);
        }
        
        // Process enterprise payment with dynamic pricing
        function proceedToEnterprisePayment(planType, priceId, planName) {
            const employeeInput = document.getElementById('employee-count');
            const employees = parseInt(employeeInput.value) || 1;
            
            const pricePerUser = {
                'basic': 10,
                'premium': 25,
                'elite': 54
            }[planType];
            
            const monthlyTotal = employees * pricePerUser;
            
            console.log(`üöÄ Processing enterprise payment: ${employees} employees, ¬£${monthlyTotal}/month`);
            
            // Close modal
            document.querySelector('.fixed').remove();
            
            // Use the direct Stripe checkout with employee count and amount
            directStripeCheckout(priceId, 'subscription', `${planName} - ${employees} employees`, employees, monthlyTotal);
        }
        
        // TEXT-BASED COACH SYSTEM WITH GROQ INTEGRATION
        let currentCoach = null;
        let chatHistory = [];
        let userCredits = 999999; // Unlimited for testing
        
        const coaches = {
            sarah: {
                name: 'Coach Sarah',
                specialty: 'CBT & Anxiety Specialist',
                avatar: 'w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center',
                icon: 'fas fa-brain text-white',
                systemPrompt: `You are Sarah, a licensed cognitive behavioral therapist and anxiety specialist. You excel at helping clients identify and challenge negative thought patterns, develop coping strategies, and implement behavioral changes. You use CBT techniques like thought records, cognitive restructuring, and behavioral activation. You're warm, empathetic, and professional, always addressing clients respectfully. Focus on evidence-based CBT interventions and practical anxiety management techniques. Keep responses concise and actionable.`
            },
            marcus: {
                name: 'Coach Marcus',
                specialty: 'Nutrition & Lifestyle Coach',
                avatar: 'w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center',
                icon: 'fas fa-apple-alt text-white',
                systemPrompt: `You are Marcus, a certified nutritionist and lifestyle coach with expertise in metabolic optimization, weight management, and sustainable healthy living. You provide evidence-based nutritional guidance, meal planning advice, and lifestyle modifications. You focus on whole foods, proper macronutrient balance, and realistic habit formation. You're practical, encouraging, and focus on sustainable changes rather than quick fixes. Always provide actionable nutrition and lifestyle advice.`
            },
            elena: {
                name: 'Coach Elena',
                specialty: 'EMDR & Trauma Specialist',
                avatar: 'w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center',
                icon: 'fas fa-heart text-white',
                systemPrompt: `You are Elena, a licensed trauma therapist specializing in EMDR (Eye Movement Desensitization and Reprocessing) and trauma-informed care. You provide gentle, empathetic support for trauma processing, emotional regulation, and healing. You understand complex trauma, PTSD, and use trauma-informed approaches. You're compassionate, patient, and create a safe therapeutic space. Focus on grounding techniques, emotional safety, and gradual trauma processing. Always prioritize client safety and emotional regulation.`
            },
            alex: {
                name: 'Coach Alex',
                specialty: 'Sleep & Recovery Expert',
                avatar: 'w-12 h-12 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full flex items-center justify-center',
                icon: 'fas fa-moon text-white',
                systemPrompt: `You are Alex, a sleep medicine specialist and recovery expert. You help clients optimize their sleep quality, establish healthy sleep hygiene, and improve recovery protocols. You understand circadian rhythms, sleep disorders, and evidence-based sleep interventions. You provide practical advice on sleep environment, bedtime routines, and lifestyle factors affecting sleep. You're knowledgeable, supportive, and focus on sustainable sleep improvements.`
            },
            maria: {
                name: 'Coach Maria',
                specialty: 'Fitness & Movement Coach',
                avatar: 'w-12 h-12 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center',
                icon: 'fas fa-dumbbell text-white',
                systemPrompt: `You are Maria, a certified exercise physiologist and movement specialist. You design personalized fitness programs, provide exercise guidance, and help clients develop sustainable movement habits. You understand biomechanics, exercise physiology, and injury prevention. You focus on functional movement, strength training, and cardiovascular health. You're motivating, practical, and adapt recommendations to individual fitness levels and goals.`
            }
        };
        
        async function startChatWithCoach(coachId) {
            // First navigate to coaches section
            navigateToSection('coaches');
            
            currentCoach = coaches[coachId];
            if (!currentCoach) return;
            
            console.log('üí¨ Starting chat with', currentCoach.name);
            
            // Setup chat interface
            const chatInterface = document.getElementById('chat-interface');
            const coachAvatar = document.getElementById('coach-avatar');
            const coachName = document.getElementById('coach-name');
            const coachSpecialty = document.getElementById('coach-specialty');
            
            // Update coach info
            coachAvatar.className = currentCoach.avatar;
            coachAvatar.innerHTML = `<i class="${currentCoach.icon}"></i>`;
            coachName.textContent = currentCoach.name;
            coachSpecialty.textContent = currentCoach.specialty;
            
            // Clear previous messages
            chatHistory = [];
            
            // Load user's assessment data for personalized coaching
            loadAssessmentDataForCoach();
            
            updateChatDisplay();
            
            // Show interface
            chatInterface.classList.remove('hidden');
            
            // Check if coming from assessment
            if (window.lastAssessmentResults) {
                showAssessmentPrescription();
            }
            
            // Send initial greeting
            await sendChatMessage(null, true);
        }
        
        function showAssessmentPrescription() {
            if (!window.lastAssessmentResults) return;
            
            const prescriptionContainer = document.getElementById('assessment-prescription');
            const prescriptionContent = document.getElementById('prescription-content');
            
            let prescriptionHtml = `<p class="mb-3">Based on your assessment results, here's your personalized health prescription for ${currentCoach.name}:</p>`;
            
            window.lastAssessmentResults.recommendations.forEach(rec => {
                prescriptionHtml += `
                    <div class="mb-3 p-3 bg-slate-600/30 rounded">
                        <h5 class="font-semibold text-blue-200 mb-1">${rec.category}</h5>
                        <p class="text-slate-300 text-sm">${rec.recommendation}</p>
                    </div>
                `;
            });
            
            prescriptionHtml += `<p class="text-blue-200 text-sm mt-3">üí° Your coach will provide personalized guidance based on these recommendations.</p>`;
            
            prescriptionContent.innerHTML = prescriptionHtml;
            prescriptionContainer.classList.remove('hidden');
        }
        
        async function sendChatMessage(message = null, isInitial = false) {
            console.log('üí¨ sendChatMessage called with:', { message, isInitial });
            
            const chatInput = document.getElementById('chat-input');
            console.log('üîç Chat input element:', chatInput);
            console.log('üîç Input value:', chatInput ? chatInput.value : 'INPUT NOT FOUND');
            
            const userMessage = message || (chatInput ? chatInput.value.trim() : '');
            console.log('üìù Final message:', userMessage);
            
            if (!userMessage && !isInitial) {
                console.log('‚ùå No message or is initial');
                return;
            }
            if (!currentCoach) {
                console.log('‚ùå No current coach');
                return;
            }
            
            // Clear input
            if (chatInput) chatInput.value = '';
            
            // Add user message to history (unless initial greeting)
            if (!isInitial && userMessage) {
                chatHistory.push({
                    role: 'user',
                    content: userMessage,
                    timestamp: new Date()
                });
                updateChatDisplay();
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            console.log('ü§ñ Sending message to Groq API:', { userMessage, isInitial, coach: currentCoach.name });
            console.log('üîç Current coach details:', currentCoach);
            
            try {
                // Call real Groq API
                console.log('üìû About to call generateCoachResponse function...');
                const response = await generateCoachResponse(userMessage, isInitial);
                console.log('üì® Got response from generateCoachResponse:', response?.substring(0, 100) + '...');
                
                hideTypingIndicator();
                
                // Add coach response to history
                chatHistory.push({
                    role: 'assistant',
                    content: response,
                    timestamp: new Date()
                });
                
                updateChatDisplay();
                
                // Update credits (for display - unlimited for testing)
                document.getElementById('credits-remaining').textContent = 'Unlimited';
                
            } catch (error) {
                console.error('‚ùå Error generating response:', error);
                hideTypingIndicator();
                
                chatHistory.push({
                    role: 'assistant',
                    content: `I apologize, but I'm experiencing technical difficulties connecting to my AI system. Error: ${error.message}. Please try again in a moment, or refresh the page if the issue persists.`,
                    timestamp: new Date()
                });
                updateChatDisplay();
            }
        }
        
        async function generateCoachResponse(userMessage, isInitial, retryCount = 0) {
            // Real Groq API integration with retry mechanism
            const GROQ_API_KEY = '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';
            const MAX_RETRIES = 2;
            
            console.log('üöÄ generateCoachResponse called with:', { userMessage: userMessage.substring(0, 50) + '...', isInitial, retryCount });
            
            if (isInitial) {
                const greetings = {
                    sarah: `Hello! I'm Coach Sarah, your CBT and anxiety specialist. I'm here to help you understand and manage your thoughts and feelings using evidence-based cognitive behavioral techniques. What's on your mind today? Are you dealing with any anxious thoughts or behavioral patterns you'd like to work on?`,
                    marcus: `Hi there! I'm Coach Marcus, your nutrition and lifestyle coach. I specialize in helping people optimize their health through evidence-based nutrition and sustainable lifestyle changes. Whether you want to improve your energy, manage your weight, or just feel better overall, I'm here to guide you. What are your current health and nutrition goals?`,
                    elena: `Hello, and welcome to a safe space. I'm Coach Elena, and I specialize in trauma therapy and EMDR. I understand that healing takes courage, and I'm here to support you with gentleness and care. Whether you're dealing with past trauma, difficult emotions, or just need someone who understands, I'm here for you. How are you feeling today?`,
                    alex: `Hey! I'm Coach Alex, your sleep and recovery specialist. Good sleep is the foundation of everything - your mood, energy, immune system, and overall health. I help people optimize their sleep quality and recovery protocols using science-based approaches. Are you getting the restorative sleep you need, or are there areas we should work on together?`,
                    maria: `Hi! I'm Coach Maria, your fitness and movement specialist. I believe movement should be joyful, sustainable, and tailored to your unique body and goals. Whether you're just starting out, getting back into fitness, or looking to optimize your current routine, I'm here to help you build strength and confidence. What's your current relationship with movement and exercise?`
                };
                
                const coachKey = Object.keys(coaches).find(key => coaches[key] === currentCoach);
                return greetings[coachKey] || "Hello! I'm your coach and I'm here to help you on your wellness journey. How can I support you today?";
            }
            
            try {
                console.log('ü§ñ Making Groq API call for real AI response...');
                console.log('üîë Using API Key:', GROQ_API_KEY.substring(0, 10) + '...');
                
                // Validate API key
                if (!GROQ_API_KEY || GROQ_API_KEY.length < 20) {
                    console.error('‚ùå CRITICAL: Invalid or missing Groq API key:', GROQ_API_KEY);
                    throw new Error('Invalid or missing Groq API key');
                }
                
                // Prepare messages with proper context including assessment data
                const systemPrompt = currentCoach.systemPrompt + 
                    (currentCoach.assessmentContext ? '\n\n' + currentCoach.assessmentContext : '');
                
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...chatHistory.slice(-10).filter(msg => !msg.isSystemMessage).map(msg => ({ role: msg.role, content: msg.content })),
                    { role: 'user', content: userMessage }
                ];
                
                console.log('üìù Sending messages to Groq:', messages.length, 'messages');
                
                console.log('üì° Making fetch request to Groq API...');
                console.log('üìù Request payload:', JSON.stringify({
                    model: 'mixtral-8x7b-32768',
                    messages: messages,
                    max_tokens: 500,
                    temperature: 0.7,
                    stream: false
                }, null, 2));
                
                // Real Groq API call with enhanced error handling
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'mixtral-8x7b-32768',
                        messages: messages,
                        max_tokens: 500,
                        temperature: 0.7,
                        stream: false
                    })
                });
                
                console.log('üì° Fetch completed, response object:', response);
                
                console.log('üåê Groq API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Groq API error response:', errorText);
                    throw new Error(`Groq API error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Groq API response received:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response structure from Groq API');
                }
                
                const aiResponse = data.choices[0].message.content;
                console.log('üéØ AI Response generated:', aiResponse.substring(0, 100) + '...');
                
                return aiResponse;
                
            } catch (error) {
                console.error('‚ùå Groq API Integration Error:', error);
                
                // Enhanced error logging for debugging
                if (error.message.includes('fetch')) {
                    console.error('üåê Network error - check internet connection');
                } else if (error.message.includes('401')) {
                    console.error('üîë Authentication error - check API key');
                } else if (error.message.includes('429')) {
                    console.error('‚è∞ Rate limit exceeded - too many requests');
                } else {
                    console.error('üîß Unknown API error:', error.message);
                }
                
                // Retry logic for temporary failures
                if (retryCount < MAX_RETRIES && (error.message.includes('network') || error.message.includes('fetch') || error.message.includes('429'))) {
                    console.log(`üîÑ Retrying Groq API call (attempt ${retryCount + 1}/${MAX_RETRIES})...`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000)); // Exponential backoff
                    return await generateCoachResponse(userMessage, isInitial, retryCount + 1);
                }
                
                // Only fall back to scripted responses after all retries failed
                console.warn('‚ö†Ô∏è All retry attempts failed - falling back to contextual response');
                
                // Fallback to context-aware responses if API fails
                const contextResponses = {
                    sarah: [
                        `I understand you're going through a difficult time. Let's use some CBT techniques to examine these thoughts. Can you tell me what specific thoughts are troubling you right now?`,
                        `That's a very common experience. In CBT, we call these "automatic thoughts." Let's work together to identify the thinking patterns that might be contributing to how you're feeling.`,
                        `Thank you for sharing that with me. One helpful CBT technique is to ask ourselves: "Is this thought helpful?" and "What evidence do I have for and against this thought?"`,
                    ],
                    marcus: [
                        `That's a great nutrition question! Let's focus on sustainable changes. Small, consistent improvements often lead to the best long-term results. What's your current eating schedule like?`,
                        `From a nutritional science perspective, it's important to focus on whole foods and adequate protein. Let's create a realistic plan that works with your lifestyle.`,
                        `I appreciate you sharing your goals with me. Sustainable nutrition isn't about perfection - it's about progress and finding what works for your unique situation.`,
                    ],
                    elena: [
                        `Thank you for trusting me with that. Healing from trauma takes tremendous courage, and you're showing that by being here. Let's go at your pace - there's no rush.`,
                        `What you're experiencing sounds very challenging. In trauma work, we always prioritize safety first. How are you feeling right now in your body?`,
                        `That's a very normal response to trauma. Your nervous system is trying to protect you. Let's work on some grounding techniques that can help you feel more stable.`,
                    ],
                    alex: [
                        `Sleep issues can really impact everything else. Let's start by looking at your sleep environment and bedtime routine. What does a typical night look like for you?`,
                        `That's very common! Our circadian rhythms can get disrupted by many factors. Let's work on some evidence-based strategies to improve your sleep quality.`,
                        `Good sleep hygiene is foundational for both physical and mental health. Let's create a personalized plan based on sleep science research.`,
                    ],
                    maria: [
                        `I love that you're thinking about movement! The key is finding activities you actually enjoy. What kinds of physical activities have you liked in the past?`,
                        `That's a great start! In exercise physiology, we know that consistency matters more than intensity. Let's build a sustainable routine that fits your life.`,
                        `Movement should feel good and energizing, not punishing. Let's explore different options and find what works best for your body and goals.`,
                    ]
                };
                
                const coachKey = Object.keys(coaches).find(key => coaches[key] === currentCoach);
                const responses = contextResponses[coachKey] || [
                    `I'm here to help you with that. Let's work through this together step by step.`,
                    `That's a very important question. Based on my expertise, here's what I'd recommend...`,
                    `I understand how challenging that can be. Let's explore some evidence-based strategies that might help.`
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }
        
        function loadAssessmentDataForCoach() {
            // Load complete assessment data for personalized coaching
            const completeAssessmentData = sessionStorage.getItem('completeAssessmentData');
            
            if (completeAssessmentData) {
                const data = JSON.parse(completeAssessmentData);
                
                // Add assessment context to coach's system prompt
                const assessmentContext = generateCoachContext(data);
                currentCoach.assessmentContext = assessmentContext;
                
                console.log('üìä Loaded assessment data for personalized coaching:', data);
                
                // Show assessment summary in chat
                displayAssessmentSummaryInChat(data);
            }
        }
        
        // Process assessment results from standalone assessment
        function processAssessmentResults() {
            console.log('üîÑ Processing assessment results from standalone assessment...');
            
            try {
                const assessmentResults = localStorage.getItem('assessmentResults');
                
                if (!assessmentResults) {
                    console.log('‚ÑπÔ∏è No assessment results found in localStorage');
                    return;
                }
                
                const results = JSON.parse(assessmentResults);
                console.log('üìä Assessment results loaded:', results);
                
                // Display success notification
                if (results.completed) {
                    showAssessmentCompletionNotification(results);
                    
                    // Update dashboard if available
                    updateDashboardWithResults(results);
                    
                    // Show coach recommendations
                    displayCoachRecommendations(results);
                }
                
            } catch (error) {
                console.error('‚ùå Error processing assessment results:', error);
            }
        }
        
        // Show assessment completion notification
        function showAssessmentCompletionNotification(results) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4 rounded-xl shadow-xl z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-3 text-2xl"></i>
                    <div>
                        <div class="font-bold">Assessment Complete!</div>
                        <div class="text-sm opacity-90">Health Score: ${results.healthPercentage}% - ${results.recommendedCoach?.name} is recommended for you</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // Display coach recommendations based on assessment
        function displayCoachRecommendations(results) {
            const coachesSection = document.getElementById('coaches');
            if (!coachesSection) return;
            
            // Find the recommended coach display area
            const recommendationArea = coachesSection.querySelector('.coach-recommendation') || 
                                     coachesSection.querySelector('.coaches-container');
            
            if (recommendationArea && results.recommendedCoach) {
                // Create recommendation banner
                const banner = document.createElement('div');
                banner.className = 'mb-8 bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-400/30 rounded-2xl p-6';
                banner.innerHTML = `
                    <div class="flex items-center mb-4">
                        <i class="fas fa-user-md text-blue-400 text-2xl mr-3"></i>
                        <h3 class="text-2xl font-bold text-slate-100">Recommended Coach Based on Your Assessment</h3>
                    </div>
                    <div class="bg-slate-700/50 rounded-xl p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-slate-100 mb-2">${results.recommendedCoach.name}</h4>
                                <p class="text-blue-400 font-medium mb-2">${results.recommendedCoach.specialty}</p>
                                <p class="text-slate-300 mb-3">${results.recommendedCoach.reason}</p>
                                <p class="text-sm text-slate-400">Approach: ${results.recommendedCoach.approach}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-blue-400">${results.healthPercentage}%</div>
                                <div class="text-sm text-slate-400">Health Score</div>
                            </div>
                        </div>
                        
                        ${results.priorityAreas && results.priorityAreas.length > 0 ? `
                        <div class="border-t border-slate-600 pt-4">
                            <h5 class="text-sm font-bold text-slate-300 mb-2">Priority Areas:</h5>
                            <div class="flex flex-wrap gap-2">
                                ${results.priorityAreas.slice(0, 3).map(area => `
                                    <span class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm">
                                        ${area.area} (${area.score}/5)
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                recommendationArea.insertBefore(banner, recommendationArea.firstChild);
            }
        }
        
        // Update dashboard with assessment results
        function updateDashboardWithResults(results) {
            // Store results for dashboard access
            localStorage.setItem('latestAssessmentResults', JSON.stringify(results));
            console.log('üíæ Assessment results stored for dashboard access');
        }
        
        function generateCoachContext(assessmentData) {
            const scores = assessmentData.basicAssessment.scores;
            const goals = assessmentData.intelligentFollowUp.goals || [];
            const responses = assessmentData.intelligentFollowUp.responses || {};
            const purpose = assessmentData.intelligentFollowUp.purpose || '';
            
            // Calculate priority areas (scores 3 or below)
            const priorityAreas = Object.entries(scores)
                .filter(([category, score]) => score <= 3)
                .map(([category, score]) => `${category}: ${score}/5`)
                .join(', ');
            
            // Extract chronic conditions if mentioned
            const chronicInfo = responses.chronic_disease ? responses.chronic_disease.answer : '';
            
            return `
USER'S ASSESSMENT DATA:
- Purpose: ${purpose}
- Health Priority Areas: ${priorityAreas || 'All areas performing well'}
- Health Goals: ${goals.map(g => g.title).join(', ') || 'Goals being developed'}
- Chronic Conditions: ${chronicInfo || 'None reported'}
- Assessment Date: ${new Date(assessmentData.timestamp || Date.now()).toLocaleDateString()}

COACHING INSTRUCTIONS:
- Reference their specific assessment results and goals
- Provide progress check-ins on their stated objectives
- Ask follow-up questions about their improvement areas
- Offer accountability and motivation for their goals
- Address any chronic conditions or health challenges they mentioned
- Create actionable, personalized recommendations based on their data
            `.trim();
        }
        
        function displayAssessmentSummaryInChat(data) {
            const scores = data.basicAssessment.scores;
            const goals = data.intelligentFollowUp.goals || [];
            
            const averageScore = Object.values(scores).reduce((a, b) => a + b, 0) / Object.keys(scores).length;
            
            // Add system message with assessment summary
            const summaryMessage = {
                role: 'system',
                content: `Assessment Summary Loaded - Overall Health Score: ${averageScore.toFixed(1)}/5, Active Goals: ${goals.length}, Ready for personalized coaching session.`,
                isSystemMessage: true,
                timestamp: Date.now()
            };
            
            chatHistory.push(summaryMessage);
        }
        
        function updateChatDisplay() {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (chatHistory.length === 0) {
                messagesContainer.innerHTML = '<div class="text-slate-400 text-sm text-center py-8">Start the conversation by typing a message below...</div>';
                return;
            }
            
            let messagesHtml = '';
            chatHistory.forEach(msg => {
                const isUser = msg.role === 'user';
                const time = msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messagesHtml += `
                    <div class="mb-4 ${isUser ? 'text-right' : 'text-left'}">
                        <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                            isUser 
                                ? 'bg-blue-600 text-white' 
                                : 'bg-slate-600 text-slate-100'
                        }">
                            ${msg.content}
                        </div>
                        <div class="text-xs text-slate-400 mt-1">${time}</div>
                    </div>
                `;
            });
            
            messagesContainer.innerHTML = messagesHtml;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'mb-4 text-left';
            typingDiv.innerHTML = `
                <div class="inline-block px-4 py-2 bg-slate-600 text-slate-100 rounded-lg">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        function closeChatInterface() {
            const chatInterface = document.getElementById('chat-interface');
            const prescriptionContainer = document.getElementById('assessment-prescription');
            
            chatInterface.classList.add('hidden');
            prescriptionContainer.classList.add('hidden');
            
            currentCoach = null;
            chatHistory = [];
        }
        
        // ASSESSMENT TO COACHING CONNECTION
        function startPersonalizedCoaching() {
            console.log('üéØ Starting personalized coaching based on assessment');
            
            // Check if Groq API is available for enhanced coaching
            if (window.groqAPI && window.groqAPI.isConnected && window.lastAssessmentResults) {
                console.log('üß† Using Groq AI for enhanced coaching recommendations');
                return startAIEnhancedCoaching(window.lastAssessmentResults);
            }
            
            if (!window.lastAssessmentResults) {
                // If no assessment results, navigate to coaches section
                console.log('üìã No assessment results found, navigating to coaches');
                navigateToSection('coaches');
                return;
            }
            
            console.log('üìã Using standard coaching algorithm');
            
            // Analyze assessment results to recommend appropriate coach
            const results = window.lastAssessmentResults;
            let recommendedCoach = 'sarah'; // Default to CBT specialist
            let recommendationReason = 'general wellness support';
            
            // Enhanced logic to determine best coach based on assessment scores
            if (results.scores.nutrition <= 2) {
                recommendedCoach = 'marcus'; // Nutrition coach
                recommendationReason = 'nutritional health improvement needed';
            } else if (results.scores.sleep <= 2) {
                recommendedCoach = 'alex'; // Sleep specialist
                recommendationReason = 'sleep optimization required';
            } else if (results.scores.physical <= 2) {
                recommendedCoach = 'maria'; // Fitness coach
                recommendationReason = 'physical activity enhancement needed';
            } else if (results.scores.mental <= 2 || results.scores.stress <= 2) {
                // Check if trauma-related symptoms suggest EMDR
                const traumaKeywords = ['trauma', 'ptsd', 'flashbacks', 'nightmares'];
                const hasTraumaHistory = results.responses && results.responses.some(response => 
                    traumaKeywords.some(keyword => response.toLowerCase().includes(keyword))
                );
                recommendedCoach = hasTraumaHistory ? 'elena' : 'sarah';
                recommendationReason = hasTraumaHistory ? 'trauma therapy recommended' : 'stress and anxiety management needed';
            }
            
            console.log(`üéØ Recommended coach: ${recommendedCoach} (${recommendationReason})`);
            
            // Navigate to coaches section and start chat with recommended coach
            navigateToSection('coaches');
            
            // Small delay to ensure section is loaded
            setTimeout(() => {
                startChatWithCoach(recommendedCoach);
            }, 500);
        }
        
        // Store assessment results globally for coach connection
        function storeAssessmentResults(results) {
            window.lastAssessmentResults = results;
            console.log('üíæ Assessment results stored for personalized coaching');
        }
        
        // Make functions globally accessible
        window.updateCalculator = updateCalculator;
        window.buyCredits = buyCredits;
        window.setupAutoReload = setupAutoReload;
        window.startChatWithCoach = startChatWithCoach;
        window.sendChatMessage = sendChatMessage;
        window.handleChatKeyPress = handleChatKeyPress;
        window.closeChatInterface = closeChatInterface;
        window.startPersonalizedCoaching = startPersonalizedCoaching;
        window.storeAssessmentResults = storeAssessmentResults;
        window.showPurchaseModal = showPurchaseModal;
        window.closePurchaseModal = closePurchaseModal;
        window.processPurchase = processPurchase;
        
        // ENHANCED ANXIETY RELIEF SYSTEM
        let anxietyReliefSession = {
            active: false,
            type: null,
            timer: null,
            audioContext: null,
            oscillator: null,
            gainNode: null,
            duration: 0,
            startTime: 0,
            isPaused: false
        };
        
        function startBinauralBeats() {
            console.log('üéµ Starting binaural beats session');
            
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'binaural';
            anxietyReliefSession.duration = 10 * 60; // 10 minutes
            anxietyReliefSession.startTime = Date.now();
            
            showAnxietyReliefInterface(
                'Binaural Beats Therapy',
                'Relax and let the 40Hz gamma waves help reduce anxiety and promote calm focus. Use headphones for best results.',
                'from-purple-500 to-blue-500'
            );
            
            // Create binaural beats using Web Audio API
            try {
                anxietyReliefSession.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Left ear: 200Hz, Right ear: 240Hz = 40Hz binaural beat
                const leftOsc = anxietyReliefSession.audioContext.createOscillator();
                const rightOsc = anxietyReliefSession.audioContext.createOscillator();
                const leftGain = anxietyReliefSession.audioContext.createGain();
                const rightGain = anxietyReliefSession.audioContext.createGain();
                const merger = anxietyReliefSession.audioContext.createChannelMerger(2);
                
                leftOsc.frequency.setValueAtTime(200, anxietyReliefSession.audioContext.currentTime);
                rightOsc.frequency.setValueAtTime(240, anxietyReliefSession.audioContext.currentTime);
                
                leftGain.gain.setValueAtTime(0.1, anxietyReliefSession.audioContext.currentTime);
                rightGain.gain.setValueAtTime(0.1, anxietyReliefSession.audioContext.currentTime);
                
                leftOsc.connect(leftGain).connect(merger, 0, 0);
                rightOsc.connect(rightGain).connect(merger, 0, 1);
                merger.connect(anxietyReliefSession.audioContext.destination);
                
                leftOsc.start();
                rightOsc.start();
                
                anxietyReliefSession.oscillator = [leftOsc, rightOsc];
                anxietyReliefSession.gainNode = [leftGain, rightGain];
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Web Audio API not supported, using visual guidance only');
                document.getElementById('session-instructions').textContent = 'Web Audio not supported on this device. Focus on the visual breathing guide and relaxation.';
            }
            
            startSessionTimer();
        }
        
        function startGuidedBreathing() {
            console.log('ü´Å Starting guided breathing session');
            
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'breathing';
            anxietyReliefSession.duration = 5 * 60; // 5 minutes
            anxietyReliefSession.startTime = Date.now();
            
            showAnxietyReliefInterface(
                'Guided Breathing Exercise',
                'Follow the breathing guide: Inhale for 4 seconds, hold for 7 seconds, exhale for 8 seconds.',
                'from-green-500 to-teal-500'
            );
            
            // Show breathing guide
            document.getElementById('breathing-guide').classList.remove('hidden');
            
            startSessionTimer();
            startBreathingAnimation();
        }
        
        function startPMRGuide() {
            console.log('üí™ Starting Progressive Muscle Relaxation Guide');
            
            // Clear any existing PMR timers
            if (window.pmrTimer) {
                clearTimeout(window.pmrTimer);
                delete window.pmrTimer;
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'pmr';
            anxietyReliefSession.duration = 20 * 60; // 20 minutes
            anxietyReliefSession.startTime = Date.now();
            
            showAnxietyReliefInterface(
                'Progressive Muscle Relaxation',
                'Follow the guided instructions to systematically relax each muscle group.',
                'from-purple-500 to-indigo-500'
            );
            
            startSessionTimer();
            
            const instructions = [
                {
                    text: 'Welcome to Progressive Muscle Relaxation. Find a comfortable position and begin by taking three deep breaths.',
                    duration: 30
                },
                {
                    text: 'Start with your toes. Curl them tightly, creating tension... hold for 5 seconds... 1, 2, 3, 4, 5... now release and let them completely relax. Notice the difference between tension and relaxation.',
                    duration: 45
                },
                {
                    text: 'Move to your feet and calves. Point your toes toward your shins and tense your calf muscles... hold tight... 1, 2, 3, 4, 5... now let go completely and feel the muscles soften and relax.',
                    duration: 45
                },
                {
                    text: 'Focus on your thigh muscles. Tighten them by pressing your knees together and straightening your legs... hold the tension... 1, 2, 3, 4, 5... now release and let your thighs become heavy and relaxed.',
                    duration: 45
                },
                {
                    text: 'Tense your buttocks muscles. Squeeze them tightly... hold... 1, 2, 3, 4, 5... now let them go and feel the relaxation spreading through your lower body.',
                    duration: 40
                },
                {
                    text: 'Clench your fists tightly. Make them as tight as possible... hold... 1, 2, 3, 4, 5... now open your hands and let your fingers spread naturally. Feel the tension melting away from your hands.',
                    duration: 40
                },
                {
                    text: 'Tense your entire arms. Make fists and bring them to your shoulders, tightening your biceps and forearms... hold... 1, 2, 3, 4, 5... now let your arms drop heavily to your sides and feel complete relaxation.',
                    duration: 45
                },
                {
                    text: 'Raise your shoulders up to your ears as high as possible. Feel the tension in your neck and shoulders... hold... 1, 2, 3, 4, 5... now let them drop and feel the relief as tension leaves your shoulders.',
                    duration: 40
                },
                {
                    text: 'Tense your facial muscles. Scrunch your forehead, close your eyes tightly, clench your jaw... hold all facial tension... 1, 2, 3, 4, 5... now let your face completely relax and soften.',
                    duration: 45
                },
                {
                    text: 'Take a deep breath and tense your stomach muscles. Pull them in tight... hold... 1, 2, 3, 4, 5... now release and let your breathing return to natural and easy.',
                    duration: 40
                },
                {
                    text: 'Finally, tense your entire body all at once. Make fists, tighten legs, shoulders up, face tense, stomach tight... hold everything... 1, 2, 3, 4, 5... now let everything go completely.',
                    duration: 50
                },
                {
                    text: 'Take a moment to scan your entire body from head to toe. Notice how relaxed and heavy your muscles feel. Let any remaining tension simply melt away.',
                    duration: 60
                },
                {
                    text: 'You have completed Progressive Muscle Relaxation. Your body is now deeply relaxed. Take three deep breaths and enjoy this feeling of calm and peace.',
                    duration: 30
                }
            ];
            
            let currentStep = 0;
            const instruction = document.getElementById('session-instructions');
            
            function showNextPMRStep() {
                console.log('üîÑ PMR Step', currentStep + 1, 'of', instructions.length);
                console.log('üîç Session state - active:', anxietyReliefSession.active, 'paused:', anxietyReliefSession.isPaused);
                
                if (!anxietyReliefSession.active || anxietyReliefSession.isPaused) {
                    console.log('‚ö†Ô∏è PMR stopped - session not active or paused');
                    return;
                }
                
                if (currentStep >= instructions.length) {
                    console.log('‚úÖ PMR completed - all steps finished');
                    instruction.innerHTML = `
                        <div class="bg-green-600/30 p-4 rounded-lg mb-4">
                            <div class="text-sm text-green-300 mb-2">Session Complete</div>
                            <p class="text-lg text-slate-100">Progressive Muscle Relaxation completed successfully. You should feel deeply relaxed and centered.</p>
                        </div>
                    `;
                    return;
                }
                
                const step = instructions[currentStep];
                console.log('üìú Showing step:', step.text.substring(0, 50) + '...');
                console.log('‚è±Ô∏è Duration:', step.duration, 'seconds');
                
                instruction.innerHTML = `
                    <div class="bg-slate-600/30 p-4 rounded-lg mb-4">
                        <div class="text-sm text-purple-300 mb-2">Step ${currentStep + 1} of ${instructions.length}</div>
                        <p class="text-lg text-slate-100">${step.text}</p>
                        <div class="mt-3">
                            <div class="text-xs text-purple-400">Auto-advancing in ${step.duration} seconds...</div>
                            <div class="w-full bg-slate-700 rounded-full h-1 mt-2">
                                <div class="bg-purple-500 h-1 rounded-full transition-all duration-${step.duration * 1000} ease-linear" style="width: 0%; animation: progressBar ${step.duration}s linear forwards;"></div>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes progressBar {
                            from { width: 0%; }
                            to { width: 100%; }
                        }
                    </style>
                `;
                
                currentStep++;
                
                // Clear any existing timer
                if (window.pmrTimer) {
                    clearTimeout(window.pmrTimer);
                }
                
                // Set new timer with proper logging
                window.pmrTimer = setTimeout(() => {
                    console.log('‚è∞ PMR timer fired for step', currentStep);
                    if (anxietyReliefSession.active && !anxietyReliefSession.isPaused) {
                        showNextPMRStep();
                    } else {
                        console.log('‚ö†Ô∏è PMR timer fired but session is no longer active/unpaused');
                    }
                }, step.duration * 1000);
                
                console.log('‚è±Ô∏è PMR timer set for', step.duration, 'seconds (timer ID:', window.pmrTimer, ')');
            }
            
            showNextPMRStep();
        }
        
        function startNatureSounds() {
            console.log('üåø Starting nature soundscape');
            
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'nature';
            anxietyReliefSession.duration = 20 * 60; // 20 minutes
            anxietyReliefSession.startTime = Date.now();
            
            showAnxietyReliefInterface(
                'Nature Soundscape',
                'Immerse yourself in calming nature sounds. Close your eyes and imagine yourself in a peaceful natural setting.',
                'from-emerald-500 to-green-500'
            );
            
            // Generate nature sounds using Web Audio API
            try {
                anxietyReliefSession.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                generateNatureSounds();
                
                document.getElementById('session-instructions').innerHTML += '<br><br><span class="text-emerald-300">üåßÔ∏è Immersive nature soundscape with realistic rain, wind, and forest ambience now playing...</span><br><em class="text-emerald-400 text-sm">Enhanced with spatial audio, dynamic weather variations, and natural acoustic patterns</em>';
            } catch (error) {
                console.warn('‚ö†Ô∏è Web Audio API not supported, using visual guidance only');
                document.getElementById('session-instructions').innerHTML += '<br><br><em class="text-slate-400">üéµ Enhanced audio not supported on this device. Focus on the visual relaxation guidance and imagine yourself in a peaceful forest during a gentle rain.</em>';
            }
            
            startSessionTimer();
        }
        
        function generateNatureSounds() {
            const audioContext = anxietyReliefSession.audioContext;
            console.log('üéµ Generating nature soundscape...');
            
            // Create realistic rain sound using white noise and filtering
            const rainBuffer = audioContext.createBuffer(2, audioContext.sampleRate * 2, audioContext.sampleRate);
            for (let channel = 0; channel < rainBuffer.numberOfChannels; channel++) {
                const nowBuffering = rainBuffer.getChannelData(channel);
                for (let i = 0; i < rainBuffer.length; i++) {
                    // Create natural rain noise with occasional intensity bursts
                    const baseNoise = (Math.random() * 2 - 1) * 0.08;
                    const burst = Math.random() < 0.02 ? Math.random() * 0.15 : 0;
                    nowBuffering[i] = baseNoise + burst;
                }
            }
            
            // Rain sound source
            const rainSource = audioContext.createBufferSource();
            rainSource.buffer = rainBuffer;
            rainSource.loop = true;
            
            // Rain filter for realistic sound
            const rainFilter = audioContext.createBiquadFilter();
            rainFilter.type = 'lowpass';
            rainFilter.frequency.setValueAtTime(1200, audioContext.currentTime);
            rainFilter.Q.setValueAtTime(0.7, audioContext.currentTime);
            
            // Wind sounds using oscillators
            const windOsc1 = audioContext.createOscillator();
            const windOsc2 = audioContext.createOscillator();
            windOsc1.type = 'sine';
            windOsc2.type = 'triangle';
            windOsc1.frequency.setValueAtTime(55, audioContext.currentTime);
            windOsc2.frequency.setValueAtTime(75, audioContext.currentTime);
            
            // Gain nodes for mixing
            const rainGain = audioContext.createGain();
            const wind1Gain = audioContext.createGain();
            const wind2Gain = audioContext.createGain();
            const masterGain = audioContext.createGain();
            
            // Set realistic levels
            rainGain.gain.setValueAtTime(0.3, audioContext.currentTime);
            wind1Gain.gain.setValueAtTime(0.08, audioContext.currentTime);
            wind2Gain.gain.setValueAtTime(0.05, audioContext.currentTime);
            masterGain.gain.setValueAtTime(0.4, audioContext.currentTime);
            
            // Connect audio chain
            rainSource.connect(rainFilter);
            rainFilter.connect(rainGain);
            rainGain.connect(masterGain);
            
            windOsc1.connect(wind1Gain);
            windOsc2.connect(wind2Gain);
            wind1Gain.connect(masterGain);
            wind2Gain.connect(masterGain);
            
            masterGain.connect(audioContext.destination);
            
            // Start all sources
            rainSource.start();
            windOsc1.start();
            windOsc2.start();
            
            // Add natural variations
            setInterval(() => {
                if (anxietyReliefSession.active && anxietyReliefSession.type === 'nature') {
                    // Vary wind frequencies naturally
                    const variation1 = 55 + (Math.random() - 0.5) * 8;
                    const variation2 = 75 + (Math.random() - 0.5) * 12;
                    windOsc1.frequency.setValueAtTime(Math.max(40, variation1), audioContext.currentTime);
                    windOsc2.frequency.setValueAtTime(Math.max(60, variation2), audioContext.currentTime);
                    
                    // Vary rain intensity slightly
                    const rainIntensity = 0.25 + Math.random() * 0.15;
                    rainGain.gain.exponentialRampToValueAtTime(rainIntensity, audioContext.currentTime + 2);
                }
            }, 4000 + Math.random() * 6000);
            
            // Store references for cleanup
            anxietyReliefSession.natureSources = [rainSource, windOsc1, windOsc2];
            
            console.log('‚úÖ Nature soundscape generated successfully');
        }
        
        function showAnxietyReliefInterface(title, instructions, gradientClass) {
            document.getElementById('session-title').textContent = title;
            document.getElementById('session-instructions').textContent = instructions;
            document.getElementById('session-indicator').className = `w-8 h-8 bg-gradient-to-br ${gradientClass} rounded-full mx-auto animate-pulse`;
            document.getElementById('anxiety-relief-session').classList.remove('hidden');
            
            // Hide breathing guide by default
            document.getElementById('breathing-guide').classList.add('hidden');
        }
        
        function startSessionTimer() {
            const timerDisplay = document.getElementById('timer-display');
            
            anxietyReliefSession.timer = setInterval(() => {
                if (anxietyReliefSession.isPaused) return;
                
                const elapsed = Math.floor((Date.now() - anxietyReliefSession.startTime) / 1000);
                const remaining = Math.max(0, anxietyReliefSession.duration - elapsed);
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (remaining === 0) {
                    stopAnxietyReliefSession();
                    alert('üåü Session complete! Take a moment to notice how you feel. You can start another session anytime.');
                }
            }, 1000);
        }
        
        function startBreathingAnimation() {
            const circle = document.getElementById('breathing-circle');
            const instruction = document.getElementById('breathing-instruction');
            
            let phase = 'inhale'; // inhale, hold, exhale
            let phaseTime = 0;
            
            const breathingTimer = setInterval(() => {
                if (!anxietyReliefSession.active || anxietyReliefSession.isPaused) {
                    clearInterval(breathingTimer);
                    return;
                }
                
                phaseTime++;
                
                switch(phase) {
                    case 'inhale':
                        instruction.textContent = `Breathe in... (${phaseTime})`;
                        circle.style.transform = `scale(${1 + (phaseTime * 0.2)})`;
                        if (phaseTime >= 4) {
                            phase = 'hold';
                            phaseTime = 0;
                        }
                        break;
                    case 'hold':
                        instruction.textContent = `Hold... (${phaseTime})`;
                        if (phaseTime >= 7) {
                            phase = 'exhale';
                            phaseTime = 0;
                        }
                        break;
                    case 'exhale':
                        instruction.textContent = `Breathe out... (${phaseTime})`;
                        circle.style.transform = `scale(${2 - (phaseTime * 0.125)})`;
                        if (phaseTime >= 8) {
                            phase = 'inhale';
                            phaseTime = 0;
                        }
                        break;
                }
            }, 1000);
        }
        
        function pauseAnxietyReliefSession() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (anxietyReliefSession.isPaused) {
                // Resume
                console.log('‚ñ∂Ô∏è Resuming anxiety relief session');
                anxietyReliefSession.isPaused = false;
                anxietyReliefSession.startTime = Date.now() - ((anxietyReliefSession.duration - getCurrentRemainingTime()) * 1000);
                pauseBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause';
                
                // Resume PMR if it was in progress
                if (anxietyReliefSession.type === 'pmr') {
                    console.log('üîÑ Resuming PMR progression');
                }
                
                if (anxietyReliefSession.audioContext && anxietyReliefSession.audioContext.state === 'suspended') {
                    anxietyReliefSession.audioContext.resume();
                }
            } else {
                // Pause
                anxietyReliefSession.isPaused = true;
                pauseBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Resume';
                
                if (anxietyReliefSession.audioContext) {
                    anxietyReliefSession.audioContext.suspend();
                }
            }
        }
        
        function getCurrentRemainingTime() {
            const timerText = document.getElementById('timer-display').textContent;
            const [minutes, seconds] = timerText.split(':').map(Number);
            return (minutes * 60) + seconds;
        }
        
        function stopAnxietyReliefSession() {
            console.log('üõë Stopping anxiety relief session');
            
            // Stop all timers
            if (anxietyReliefSession.timer) {
                clearInterval(anxietyReliefSession.timer);
            }
            
            // Stop audio
            if (anxietyReliefSession.audioContext) {
                anxietyReliefSession.audioContext.close();
            }
            
            // Clean up PMR progress interval
            if (anxietyReliefSession.currentPMRInterval) {
                clearInterval(anxietyReliefSession.currentPMRInterval);
            }
            
            // Clean up PMR timer
            if (window.pmrTimer) {
                clearTimeout(window.pmrTimer);
                delete window.pmrTimer;
            }
            
            // Reset session state
            anxietyReliefSession = {
                active: false,
                type: null,
                timer: null,
                audioContext: null,
                oscillator: null,
                gainNode: null,
                duration: 0,
                startTime: 0,
                isPaused: false,
                currentPMRInterval: null
            };
            
            // Hide session interface
            document.getElementById('anxiety-relief-session').classList.add('hidden');
            document.getElementById('breathing-guide').classList.add('hidden');
            
            // Reset breathing circle
            const circle = document.getElementById('breathing-circle');
            if (circle) {
                circle.style.transform = 'scale(1)';
            }
        }
        
        // Make functions globally accessible (PMR removed - using new enhanced version)
        window.startBinauralBeats = startBinauralBeats;
        window.startGuidedBreathing = startGuidedBreathing;
        window.startPMRGuide = startPMRGuide;
        window.startNatureSounds = startNatureSounds;
        window.stopAnxietyReliefSession = stopAnxietyReliefSession;
        window.pauseAnxietyReliefSession = pauseAnxietyReliefSession;
        
        // CLEAN TRAUMA TOOLS - One function per tool
        window.startEMDRTherapy = function() {
            console.log('üëÅÔ∏è Starting EMDR Therapy');
            showTraumaToolInterface('emdr');
        };
        
        window.startSafetyVisualization = function() {
            console.log('üõ°Ô∏è Starting Safe Place Visualization');
            showTraumaToolInterface('safety');
        };
        
        window.startTraumaJournal = function() {
            console.log('üìù Starting Trauma Journal');
            showTraumaToolInterface('journal');
        };
        
        window.startCrisisPlan = function() {
            console.log('üö® Starting Crisis Plan');
            showTraumaToolInterface('crisis');
        };
        
        function showTraumaToolInterface(toolType) {
            const sessionContainer = document.getElementById('anxiety-relief-session');
            if (!sessionContainer) return;
            
            // Stop any existing sessions first
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            sessionContainer.classList.remove('hidden');
            
            const toolConfigs = {
                'emdr': {
                    title: 'Interactive EMDR Therapy',
                    gradient: 'from-purple-900/40 to-blue-900/40',
                    border: 'border-purple-500/30',
                    icon: 'fas fa-eye',
                    iconBg: 'from-purple-500 to-blue-500',
                    description: 'Follow the dot with your eyes for bilateral brain stimulation',
                    content: `
                        <div class="relative h-32 bg-slate-800/50 rounded-lg border border-purple-500/30 overflow-hidden mb-4">
                            <div id="emdr-dot" class="absolute w-4 h-4 bg-purple-400 rounded-full top-1/2 left-4 transform -translate-y-1/2 transition-all duration-1000 ease-in-out"></div>
                        </div>
                        <p class="text-purple-300">Let thoughts and feelings come and go naturally as you follow the movement.</p>
                        <p class="text-slate-400 text-sm mt-2">EMDR helps process trauma through bilateral brain stimulation</p>
                    `
                },
                'safety': {
                    title: 'Safe Place Visualization',
                    gradient: 'from-emerald-900/40 to-green-900/40',
                    border: 'border-emerald-500/30',
                    icon: 'fas fa-shield-alt',
                    iconBg: 'from-emerald-500 to-green-500',
                    description: 'Creating your mental sanctuary for emotional safety',
                    content: `
                        <div class="text-center p-6 bg-slate-800/30 rounded-lg">
                            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-heart text-white text-xl"></i>
                            </div>
                            <p class="text-lg text-slate-200 mb-4">Close your eyes and take three deep breaths. Feel your body settling into safety.</p>
                            <p class="text-emerald-300 text-sm">Imagine a place where you feel completely safe and peaceful. This could be real or imaginary...</p>
                        </div>
                    `
                },
                'journal': {
                    title: 'Trauma-Informed Journaling',
                    gradient: 'from-yellow-900/40 to-orange-900/40',
                    border: 'border-yellow-500/30',
                    icon: 'fas fa-pen',
                    iconBg: 'from-yellow-500 to-orange-500',
                    description: 'A safe space to process thoughts and feelings through writing',
                    content: `
                        <div class="bg-slate-800/50 rounded-lg p-6 border border-yellow-500/30">
                            <div class="mb-4">
                                <p class="text-slate-200 text-center mb-4">Right now, I am feeling...</p>
                                <textarea class="w-full h-32 bg-slate-700 border border-slate-600 rounded-lg p-3 text-slate-200 resize-none focus:border-yellow-400 focus:outline-none" 
                                          placeholder="Write your thoughts here... Remember: this is your private space, no judgment."></textarea>
                            </div>
                            <div class="text-center">
                                <p class="text-slate-400 text-xs">Your writing is private and not saved. Take as much time as you need.</p>
                            </div>
                        </div>
                    `
                },
                'crisis': {
                    title: 'Crisis Safety Plan',
                    gradient: 'from-red-900/40 to-pink-900/40',
                    border: 'border-red-500/30',
                    icon: 'fas fa-clipboard-list',
                    iconBg: 'from-red-500 to-pink-500',
                    description: 'Your personalized safety plan for crisis moments',
                    content: `
                        <div class="bg-slate-800/50 rounded-lg p-6 border border-red-500/30">
                            <div class="space-y-4">
                                <div class="bg-red-900/30 p-4 rounded border border-red-500/50">
                                    <h5 class="font-medium text-red-200 mb-2">üö® Emergency Contacts</h5>
                                    <p class="text-red-100 text-sm">‚Ä¢ National Suicide Prevention Lifeline: <strong>988</strong></p>
                                    <p class="text-red-100 text-sm">‚Ä¢ Crisis Text Line: Text HOME to <strong>741741</strong></p>
                                </div>
                                <div class="bg-slate-700/50 p-4 rounded">
                                    <h5 class="font-medium text-green-300 mb-2">üõ°Ô∏è Coping Strategies</h5>
                                    <p class="text-slate-200 text-sm">‚Ä¢ Use grounding techniques (5-4-3-2-1)</p>
                                    <p class="text-slate-200 text-sm">‚Ä¢ Call a trusted friend or family member</p>
                                    <p class="text-slate-200 text-sm">‚Ä¢ Practice deep breathing</p>
                                </div>
                                <div class="bg-blue-900/30 p-4 rounded border border-blue-500/50">
                                    <h5 class="font-medium text-blue-300 mb-2">üíô Remember</h5>
                                    <p class="text-blue-100 text-sm">Crisis moments are temporary. You have survived difficult times before.</p>
                                </div>
                            </div>
                        </div>
                    `
                }
            };
            
            const config = toolConfigs[toolType];
            
            sessionContainer.innerHTML = `
                <div class="bg-gradient-to-br ${config.gradient} p-8 rounded-lg ${config.border}">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br ${config.iconBg} rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="${config.icon} text-white text-xl"></i>
                        </div>
                        <h4 class="text-2xl font-bold text-slate-100 mb-2">${config.title}</h4>
                        <p class="text-slate-300">${config.description}</p>
                    </div>
                    
                    <div class="mb-6">
                        ${config.content}
                    </div>
                    
                    <div class="text-center">
                        <button onclick="window.closeTraumaSession()" class="btn-secondary px-6 py-3">
                            <i class="fas fa-stop mr-2"></i>End Session
                        </button>
                    </div>
                </div>
            `;
            
            // Start EMDR animation if needed
            if (toolType === 'emdr') {
                startEMDRAnimation();
            }
        }
        
        function startEMDRAnimation() {
            let direction = 1;
            const dot = document.getElementById('emdr-dot');
            if (!dot) return;
            
            const animateEMDR = () => {
                const container = dot.parentElement;
                if (!container) return;
                
                const containerWidth = container.offsetWidth - 16;
                
                if (direction === 1) {
                    dot.style.left = `${containerWidth - 16}px`;
                    direction = -1;
                } else {
                    dot.style.left = '16px';
                    direction = 1;
                }
                
                // Continue animation
                setTimeout(animateEMDR, 2000);
            };
            
            animateEMDR();
        }
        
        window.closeTraumaSession = function() {
            const sessionContainer = document.getElementById('anxiety-relief-session');
            if (sessionContainer) {
                sessionContainer.classList.add('hidden');
            }
        };
        
        // INTERACTIVE PTSD GROUNDING TECHNIQUES
        let groundingSession = {
            active: false,
            type: null,
            currentStep: 0,
            steps: [],
            timer: null
        };
        
        function start54321Technique() {
            console.log('üî¢ Starting 5-4-3-2-1 grounding technique');
            
            groundingSession.active = true;
            groundingSession.type = '54321';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: '5 Things You Can See',
                    instruction: 'Look around and name 5 things you can see right now. Take your time and really notice each one.',
                    prompt: 'Name them out loud or in your mind:\n1. ______\n2. ______\n3. ______\n4. ______\n5. ______',
                    duration: 60
                },
                {
                    title: '4 Things You Can Touch',
                    instruction: 'Notice 4 things you can physically feel or touch. This could be your clothes, the chair, a cup, anything physical.',
                    prompt: 'Feel each one:\n1. ______\n2. ______\n3. ______\n4. ______',
                    duration: 45
                },
                {
                    title: '3 Things You Can Hear',
                    instruction: 'Listen carefully and identify 3 sounds around you. They might be subtle - traffic, air conditioning, your breathing.',
                    prompt: 'Listen for:\n1. ______\n2. ______\n3. ______',
                    duration: 30
                },
                {
                    title: '2 Things You Can Smell',
                    instruction: 'Take a gentle breath and notice 2 scents. It could be coffee, air freshener, or just the air itself.',
                    prompt: 'Notice:\n1. ______\n2. ______',
                    duration: 20
                },
                {
                    title: '1 Thing You Can Taste',
                    instruction: 'Finally, notice 1 thing you can taste. It might be from something you drank recently, or just the taste in your mouth.',
                    prompt: 'Taste:\n1. ______',
                    duration: 15
                },
                {
                    title: 'Grounding Complete',
                    instruction: 'You have successfully grounded yourself using all five senses. Notice how you feel now compared to when you started.',
                    prompt: 'Take a deep breath and acknowledge your present moment awareness. You are here, you are safe, you are grounded.',
                    duration: 10
                }
            ];
            
            showGroundingInterface('5-4-3-2-1 Grounding Technique', 'Use all five senses to anchor yourself in the present moment');
            displayGroundingStep();
        }
        
        function startBoxBreathing() {
            console.log('üì¶ Starting box breathing technique');
            
            groundingSession.active = true;
            groundingSession.type = 'box';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Prepare for Box Breathing',
                    instruction: 'Sit comfortably with your back straight. Place one hand on your chest, one on your belly. We will breathe in a 4-4-4-4 pattern.',
                    prompt: 'Get ready to begin the breathing pattern...',
                    duration: 10
                },
                {
                    title: 'Inhale for 4',
                    instruction: 'Breathe in slowly through your nose for 4 counts. Fill your lungs completely but gently.',
                    prompt: 'Breathe in: 1... 2... 3... 4...',
                    duration: 4
                },
                {
                    title: 'Hold for 4',
                    instruction: 'Hold your breath gently for 4 counts. Do not strain, just pause naturally.',
                    prompt: 'Hold: 1... 2... 3... 4...',
                    duration: 4
                },
                {
                    title: 'Exhale for 4',
                    instruction: 'Breathe out slowly through your mouth for 4 counts. Release all the air gently.',
                    prompt: 'Breathe out: 1... 2... 3... 4...',
                    duration: 4
                },
                {
                    title: 'Hold Empty for 4',
                    instruction: 'Hold with empty lungs for 4 counts. Rest in this natural pause.',
                    prompt: 'Hold empty: 1... 2... 3... 4...',
                    duration: 4
                }
            ];
            
            // Repeat the breathing cycle
            for (let i = 0; i < 5; i++) {
                groundingSession.steps.push(...groundingSession.steps.slice(1, 5));
            }
            
            groundingSession.steps.push({
                title: 'Box Breathing Complete',
                instruction: 'You have completed several cycles of box breathing. Notice how your body and mind feel now.',
                prompt: 'Your nervous system is now more regulated. You can use this technique anytime you need to feel more centered.',
                duration: 15
            });
            
            showGroundingInterface('Box Breathing Exercise', 'Regulate your nervous system with rhythmic breathing');
            displayGroundingStep();
        }
        
        function startPhysicalGrounding() {
            console.log('ü§ö Starting physical grounding technique');
            
            groundingSession.active = true;
            groundingSession.type = 'physical';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Feel Your Feet',
                    instruction: 'Press your feet firmly into the ground. Notice the pressure, the stability, the connection to the earth beneath you.',
                    prompt: 'Feel the solid support under your feet. You are grounded and stable.',
                    duration: 20
                },
                {
                    title: 'Notice Your Body Weight',
                    instruction: 'Feel the weight of your body in the chair or wherever you are sitting/standing. Notice how gravity holds you.',
                    prompt: 'You are supported. Your body has weight and presence in this space.',
                    duration: 15
                },
                {
                    title: 'Touch and Feel',
                    instruction: 'Place your hands on your thighs or a nearby surface. Notice the texture, temperature, and pressure.',
                    prompt: 'Feel the physical sensations. Your sense of touch connects you to the present moment.',
                    duration: 15
                },
                {
                    title: 'Temperature Awareness',
                    instruction: 'Notice the temperature around you. Is the air cool or warm? How does your skin feel?',
                    prompt: 'Your body naturally senses temperature. This is your present moment experience.',
                    duration: 10
                },
                {
                    title: 'Muscle Tension Check',
                    instruction: 'Scan your body for any tension. Gently squeeze and release your hands, shoulders, and jaw.',
                    prompt: 'Release any held tension. Let your muscles soften and relax.',
                    duration: 20
                },
                {
                    title: 'Physical Grounding Complete',
                    instruction: 'You have reconnected with your physical body and the present moment through touch and sensation.',
                    prompt: 'Your body is your anchor to the present. You are safe, grounded, and physically aware.',
                    duration: 10
                }
            ];
            
            showGroundingInterface('Physical Grounding Exercise', 'Connect with your body and physical sensations');
            displayGroundingStep();
        }
        
        function showGroundingInterface(title, subtitle) {
            document.getElementById('grounding-title').textContent = title;
            document.getElementById('grounding-subtitle').textContent = subtitle;
            document.getElementById('grounding-session').classList.remove('hidden');
        }
        
        function displayGroundingStep() {
            if (groundingSession.currentStep >= groundingSession.steps.length) {
                stopGroundingSession();
                return;
            }
            
            const step = groundingSession.steps[groundingSession.currentStep];
            const content = document.getElementById('grounding-content');
            
            content.innerHTML = `
                <div class="bg-slate-600/40 rounded-lg p-6 mb-6">
                    <h4 class="text-xl font-bold text-blue-300 mb-4">${step.title}</h4>
                    <p class="text-slate-200 mb-4 text-lg">${step.instruction}</p>
                    <div class="bg-slate-700/50 p-4 rounded border-l-4 border-blue-400">
                        <p class="text-slate-100 whitespace-pre-line">${step.prompt}</p>
                    </div>
                </div>
                <div class="text-sm text-slate-400 mb-4">
                    Step ${groundingSession.currentStep + 1} of ${groundingSession.steps.length}
                    ${step.duration > 0 ? `<br>Auto-advancing in ${step.duration} seconds...` : ''}
                </div>
            `;
            
            // Auto-advance ALL grounding techniques (remove manual button requirement)
            if (step.duration > 0) {
                const progressBar = document.createElement('div');
                progressBar.className = 'w-full bg-slate-600 rounded-full h-2 mb-4';
                progressBar.innerHTML = '<div id="progress-fill" class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>';
                content.appendChild(progressBar);
                
                // Animate progress bar
                const progressFill = document.getElementById('progress-fill');
                let elapsed = 0;
                const interval = setInterval(() => {
                    elapsed += 100;
                    const percentage = (elapsed / (step.duration * 1000)) * 100;
                    if (progressFill) progressFill.style.width = `${Math.min(percentage, 100)}%`;
                    
                    if (elapsed >= step.duration * 1000) {
                        clearInterval(interval);
                        if (groundingSession.active) {
                            nextGroundingStep();
                        }
                    }
                }, 100);
                
                // Store interval for cleanup
                groundingSession.currentInterval = interval;
            }
        }
        
        function nextGroundingStep() {
            groundingSession.currentStep++;
            displayGroundingStep();
        }
        
        function stopGroundingSession() {
            console.log('üõë Stopping grounding session');
            
            groundingSession.active = false;
            groundingSession.type = null;
            groundingSession.currentStep = 0;
            groundingSession.steps = [];
            
            if (groundingSession.timer) {
                clearInterval(groundingSession.timer);
            }
            
            if (groundingSession.currentInterval) {
                clearInterval(groundingSession.currentInterval);
            }
            
            document.getElementById('grounding-session').classList.add('hidden');
        }

        // ===== NEW PTSD INTERVENTIONS (11 additional) =====
        
        function startProgressiveMuscleRelaxation() {
            console.log('üí™ Starting Progressive Muscle Relaxation');
            
            groundingSession.active = true;
            groundingSession.type = 'pmr';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Prepare for PMR',
                    instruction: 'Find a comfortable position. We will tense and relax each muscle group for 5-7 seconds, then release and notice the relaxation.',
                    prompt: 'Get ready to begin systematic muscle relaxation...',
                    duration: 10
                },
                {
                    title: 'Feet and Calves',
                    instruction: 'Point your toes downward, flex your calf muscles. Hold the tension...',
                    prompt: 'Tense your feet and calves now... Feel the tension... Now RELEASE and notice the relaxation flowing through your lower legs.',
                    duration: 15
                },
                {
                    title: 'Thighs and Glutes',
                    instruction: 'Squeeze your thigh muscles and glutes together. Press them tight...',
                    prompt: 'Tense your thighs and glutes... Hold it... Now RELEASE completely and feel the wave of relaxation.',
                    duration: 15
                },
                {
                    title: 'Abdomen and Core',
                    instruction: 'Tighten your stomach muscles like you are doing a sit-up. Make your core rigid...',
                    prompt: 'Tense your abdominal muscles... Feel the tightness... Now RELEASE and let your belly soften completely.',
                    duration: 15
                },
                {
                    title: 'Hands and Arms',
                    instruction: 'Make fists with your hands, tense your arms from fingertips to shoulders...',
                    prompt: 'Clench your fists, tense your arms... Feel the tension throughout... Now RELEASE and let your arms drop loose and heavy.',
                    duration: 15
                },
                {
                    title: 'Shoulders and Neck',
                    instruction: 'Raise your shoulders up to your ears, scrunch your neck...',
                    prompt: 'Lift those shoulders high... Feel the tension in your neck and shoulders... Now DROP them and feel the immediate relief.',
                    duration: 15
                },
                {
                    title: 'Face and Head',
                    instruction: 'Scrunch your entire face - close eyes tight, wrinkle forehead, clench jaw...',
                    prompt: 'Tense your whole face... Scrunch everything together... Now RELAX completely and let your face smooth and soften.',
                    duration: 15
                },
                {
                    title: 'Full Body Tension',
                    instruction: 'Now tense every muscle in your body at once - from toes to head...',
                    prompt: 'Tense everything... Your whole body is tight and rigid... Now RELEASE everything at once and sink into complete relaxation.',
                    duration: 20
                },
                {
                    title: 'PMR Complete',
                    instruction: 'Notice the deep relaxation throughout your entire body. Each muscle group is now loose, heavy, and relaxed.',
                    prompt: 'Your body knows how to relax. You can carry this peaceful feeling with you. Progressive muscle relaxation complete.',
                    duration: 20
                }
            ];
            
            showGroundingInterface('Progressive Muscle Relaxation', 'Systematic tension and release for deep relaxation');
            displayGroundingStep();
        }

        function startMindfulnessMeditation() {
            console.log('üßò Starting Mindfulness Meditation');
            
            groundingSession.active = true;
            groundingSession.type = 'mindfulness';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Mindful Posture',
                    instruction: 'Sit comfortably with your spine naturally straight. Close your eyes or soften your gaze downward.',
                    prompt: 'Find your centered, alert yet relaxed posture. This is your foundation for mindfulness.',
                    duration: 15
                },
                {
                    title: 'Breath Awareness',
                    instruction: 'Simply notice your natural breathing. Do not change it, just observe each inhale and exhale.',
                    prompt: 'Your breath is happening naturally. Just notice... in... and out... without trying to control it.',
                    duration: 30
                },
                {
                    title: 'Thoughts and Feelings',
                    instruction: 'Notice any thoughts or feelings that arise. Do not judge them or push them away - just acknowledge them.',
                    prompt: 'Thoughts are like clouds passing through the sky of your mind. Notice them, then gently return to your breath.',
                    duration: 45
                },
                {
                    title: 'Body Sensations',
                    instruction: 'Expand your awareness to include body sensations. Notice without trying to change anything.',
                    prompt: 'Your body has its own wisdom. Simply notice what is present - tension, warmth, coolness, tingling.',
                    duration: 30
                },
                {
                    title: 'Present Moment',
                    instruction: 'Rest in the spaciousness of present moment awareness. You are not your thoughts or feelings - you are the awareness that notices them.',
                    prompt: 'This is your natural state - aware, present, peaceful. You can return here anytime.',
                    duration: 30
                },
                {
                    title: 'Mindfulness Complete',
                    instruction: 'Slowly return your attention to your surroundings. Carry this mindful awareness with you.',
                    prompt: 'Mindfulness is always available to you. Each moment is an opportunity to be present and aware.',
                    duration: 15
                }
            ];
            
            showGroundingInterface('Mindfulness Meditation', 'Present moment awareness and acceptance');
            displayGroundingStep();
        }

        function startSafePlaceVisualization() {
            console.log('üè† Starting Safe Place Visualization');
            
            groundingSession.active = true;
            groundingSession.type = 'safeplace';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Create Your Safe Place',
                    instruction: 'Close your eyes and imagine a place where you feel completely safe and peaceful. This can be real or imaginary.',
                    prompt: 'What comes to mind? A beach, forest, cozy room, mountain meadow? Trust your first instinct.',
                    duration: 20
                },
                {
                    title: 'Visual Details',
                    instruction: 'Look around your safe place. What do you see? Notice colors, shapes, lighting, and visual details.',
                    prompt: 'Is it bright or softly lit? What colors surround you? Are there any special objects or features?',
                    duration: 25
                },
                {
                    title: 'Sounds of Safety',
                    instruction: 'What do you hear in your safe place? Maybe gentle sounds of nature, silence, or soothing music?',
                    prompt: 'Listen to the peaceful sounds... water flowing, birds singing, gentle wind, or perfect quiet.',
                    duration: 20
                },
                {
                    title: 'Physical Sensations',
                    instruction: 'Notice how your body feels in this safe place. Is it warm or cool? Are you sitting, standing, or lying down?',
                    prompt: 'Feel the comfort and safety in your body. Notice the temperature, textures, and physical ease.',
                    duration: 20
                },
                {
                    title: 'Emotional Safety',
                    instruction: 'Allow yourself to fully feel the safety and peace of this place. You are completely protected here.',
                    prompt: 'Nothing can harm you here. This is your sanctuary. Breathe in the safety and peace.',
                    duration: 25
                },
                {
                    title: 'Anchor Your Safe Place',
                    instruction: 'Place your hand on your heart. This gesture will help you remember and return to your safe place anytime.',
                    prompt: 'Your safe place is always within you. You can return here whenever you need peace and safety.',
                    duration: 20
                }
            ];
            
            showGroundingInterface('Safe Place Visualization', 'Create a mental sanctuary for emotional safety');
            displayGroundingStep();
        }

        function startCognitiveRestructuring() {
            console.log('üß† Starting Cognitive Restructuring');
            
            groundingSession.active = true;
            groundingSession.type = 'cognitive';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Identify the Thought',
                    instruction: 'Think of a negative or distressing thought you have been having. Write it down or say it to yourself clearly.',
                    prompt: 'What specific thought is causing you distress? Be precise: "I am..." or "This means..." or "Everyone thinks..."',
                    duration: 30
                },
                {
                    title: 'Examine the Evidence',
                    instruction: 'What evidence supports this thought? What evidence contradicts it? Look at facts, not feelings.',
                    prompt: 'Evidence FOR this thought:\n______\n\nEvidence AGAINST this thought:\n______',
                    duration: 45
                },
                {
                    title: 'Consider Alternatives',
                    instruction: 'What are other possible explanations or perspectives? How might a good friend see this situation?',
                    prompt: 'Alternative explanations:\n‚Ä¢ Maybe...\n‚Ä¢ It could be that...\n‚Ä¢ Another way to see this is...',
                    duration: 40
                },
                {
                    title: 'Balanced Thinking',
                    instruction: 'Create a more balanced, realistic thought that acknowledges both challenges and strengths.',
                    prompt: 'A more balanced thought might be: "While this is challenging, I can... and I have..."',
                    duration: 35
                },
                {
                    title: 'Test the New Thought',
                    instruction: 'How does this new, more balanced thought make you feel? Does it feel more true and helpful?',
                    prompt: 'Notice the difference in how your body and emotions respond to the balanced thought versus the original.',
                    duration: 25
                },
                {
                    title: 'Practice the New Pattern',
                    instruction: 'Commit to noticing when the old thought pattern arises and practicing the new, balanced perspective.',
                    prompt: 'Changing thought patterns takes practice. Be patient and kind with yourself as you learn new ways of thinking.',
                    duration: 20
                }
            ];
            
            showGroundingInterface('Cognitive Restructuring', 'Challenge and reframe negative thought patterns');
            displayGroundingStep();
        }

        function startBilateralStimulation() {
            console.log('üîÑ Starting Bilateral Stimulation');
            
            groundingSession.active = true;
            groundingSession.type = 'bilateral';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Prepare for Bilateral Stimulation',
                    instruction: 'Sit comfortably. We will use alternating left-right stimulation to help both sides of your brain process and integrate.',
                    prompt: 'Bilateral stimulation helps your brain natural healing process. Get ready to begin.',
                    duration: 10
                },
                {
                    title: 'Alternating Knee Taps',
                    instruction: 'Tap your left knee with your left hand, then right knee with right hand. Keep alternating slowly and rhythmically.',
                    prompt: 'Left... Right... Left... Right... Continue this gentle rhythm and notice how it feels.',
                    duration: 60
                },
                {
                    title: 'Butterfly Hug',
                    instruction: 'Cross your arms over your chest and alternate tapping your shoulders with your hands.',
                    prompt: 'Left shoulder... Right shoulder... Left... Right... This is a self-soothing bilateral hug.',
                    duration: 60
                },
                {
                    title: 'Figure-8 Eye Movement',
                    instruction: 'With your eyes, slowly trace a figure-8 or infinity symbol in front of you. Move smoothly from left to right.',
                    prompt: 'Let your eyes flow in the figure-8 pattern... This helps integrate left and right brain processing.',
                    duration: 45
                },
                {
                    title: 'Alternating Breathing',
                    instruction: 'Breathe in while focusing on your left side, breathe out focusing on your right side. Alternate your attention.',
                    prompt: 'In through the left... Out through the right... Continue this bilateral breathing pattern.',
                    duration: 45
                },
                {
                    title: 'Integration',
                    instruction: 'Sit quietly and notice any sensations, thoughts, or feelings. Allow whatever comes up without judgment.',
                    prompt: 'Your brain has been processing and integrating. Notice what you are experiencing now.',
                    duration: 30
                }
            ];
            
            showGroundingInterface('Bilateral Stimulation', 'Audio-visual bilateral brain stimulation');
            displayGroundingStep();
        }

        function startResourceInstallation() {
            console.log('üíé Starting Resource Installation');
            
            groundingSession.active = true;
            groundingSession.type = 'resources';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Identify Your Strength',
                    instruction: 'Think of a time when you felt strong, capable, and confident. It could be recent or from long ago.',
                    prompt: 'What was happening? How did you feel? What qualities did you show? Really connect with that strong version of yourself.',
                    duration: 30
                },
                {
                    title: 'Enhance the Memory',
                    instruction: 'Make this memory more vivid. See it clearly, hear the sounds, feel the emotions and sensations in your body.',
                    prompt: 'Turn up the brightness, color, and intensity. Feel the strength in your posture, the confidence in your voice.',
                    duration: 25
                },
                {
                    title: 'Embody the Feeling',
                    instruction: 'Really feel that strength and confidence in your body right now. Sit or stand like that strong person.',
                    prompt: 'How does strength feel in your chest, your shoulders, your spine? Breathe like a strong, capable person.',
                    duration: 20
                },
                {
                    title: 'Create an Anchor',
                    instruction: 'Make a simple gesture while feeling this strength - maybe touch your heart, make a fist, or place both hands on your thighs.',
                    prompt: 'This gesture will help you access this resource anytime. Practice the gesture while feeling strong.',
                    duration: 20
                },
                {
                    title: 'Strengthen the Resource',
                    instruction: 'Imagine this strength spreading throughout your whole body, filling every cell with confidence and capability.',
                    prompt: 'This strength is part of you. It\'s always available. You ARE strong, capable, and resourceful.',
                    duration: 25
                },
                {
                    title: 'Resource Installation Complete',
                    instruction: 'You\'ve strengthened your connection to your inner resources. Use your anchor gesture anytime you need to access this strength.',
                    prompt: 'Your resources are installed and available. You have everything you need within you.',
                    duration: 15
                }
            ];
            
            showGroundingInterface('Resource Installation', 'Strengthen positive internal resources');
            displayGroundingStep();
        }

        function startContainmentExercise() {
            console.log('üì¶ Starting Containment Exercise');
            
            groundingSession.active = true;
            groundingSession.type = 'containment';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Identify What Needs Containing',
                    instruction: 'Think of a difficult memory, emotion, or worry that feels too big right now. We\'ll help you contain it safely.',
                    prompt: 'What needs to be put away for now? You don\'t need to carry everything all at once.',
                    duration: 20
                },
                {
                    title: 'Choose Your Container',
                    instruction: 'Imagine a strong, secure container. It could be a safe, treasure chest, vault, or even a spacecraft. Make it as strong as you need.',
                    prompt: 'What container feels right? Make it unbreakable, lockable, and completely secure.',
                    duration: 25
                },
                {
                    title: 'Transfer to Container',
                    instruction: 'Visualize taking the difficult material from your mind and body and placing it securely in the container.',
                    prompt: 'Remove it from your mind... from your chest... from wherever you feel it. Place it all in the container.',
                    duration: 30
                },
                {
                    title: 'Secure the Container',
                    instruction: 'Lock your container with whatever method feels right - key, combination, magical seal, or fingerprint lock.',
                    prompt: 'Make sure it\'s completely secure. Only you can open it, and only when you choose to.',
                    duration: 20
                },
                {
                    title: 'Store Safely Away',
                    instruction: 'Put your container in a safe place - underground vault, distant planet, or impenetrable fortress.',
                    prompt: 'It\'s completely contained and far away. You can retrieve it later when you\'re ready and have support.',
                    duration: 20
                },
                {
                    title: 'Return to Present',
                    instruction: 'Notice how you feel now with that material safely contained. You are lighter, clearer, more present.',
                    prompt: 'You have the power to contain overwhelming material. You choose when and how to engage with difficult experiences.',
                    duration: 25
                }
            ];
            
            showGroundingInterface('Containment Exercise', 'Safely contain difficult memories and emotions');
            displayGroundingStep();
        }

        function startBodyScanRelaxation() {
            console.log('üîç Starting Body Scan Relaxation');
            
            groundingSession.active = true;
            groundingSession.type = 'bodyscan';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Prepare for Body Scan',
                    instruction: 'Lie down or sit comfortably. We\'ll scan through your entire body, bringing awareness and relaxation to each part.',
                    prompt: 'Close your eyes and begin to notice your body. Start to breathe naturally and deeply.',
                    duration: 15
                },
                {
                    title: 'Feet and Toes',
                    instruction: 'Focus all your attention on your feet and toes. Notice any sensations - warmth, coolness, tingling, pressure.',
                    prompt: 'Send breath and relaxation to your feet. Let them completely relax and release any tension.',
                    duration: 20
                },
                {
                    title: 'Legs and Knees',
                    instruction: 'Move your attention up to your calves, shins, knees, and thighs. Scan slowly through each part.',
                    prompt: 'Notice what your legs feel like right now. Breathe relaxation into any areas of tightness.',
                    duration: 25
                },
                {
                    title: 'Pelvis and Lower Back',
                    instruction: 'Scan your hips, pelvis, and lower back. This area often holds stress - just notice without judgment.',
                    prompt: 'Breathe into your lower back and pelvis. Let this area soften and release.',
                    duration: 20
                },
                {
                    title: 'Abdomen and Chest',
                    instruction: 'Notice your belly, ribs, and chest. Feel how your breathing naturally moves this area.',
                    prompt: 'Let your belly be soft, your ribs expand naturally. Feel your heart beating steadily and calmly.',
                    duration: 20
                },
                {
                    title: 'Arms and Hands',
                    instruction: 'Scan through your shoulders, upper arms, elbows, forearms, and hands. Let each part relax completely.',
                    prompt: 'Let your arms be heavy and loose. Feel relaxation flowing from shoulders to fingertips.',
                    duration: 20
                },
                {
                    title: 'Neck and Head',
                    instruction: 'Finally, scan your neck, jaw, face, and scalp. Let all the tiny muscles relax.',
                    prompt: 'Release your jaw, soften your eyes, relax your forehead. Let your whole head feel peaceful.',
                    duration: 20
                },
                {
                    title: 'Whole Body Integration',
                    instruction: 'Now sense your entire body as one unified, relaxed whole. Feel the peace and awareness throughout.',
                    prompt: 'Your body knows how to relax and heal. You are completely present in your peaceful, relaxed body.',
                    duration: 25
                }
            ];
            
            showGroundingInterface('Body Scan Relaxation', 'Systematic body awareness and tension release');
            displayGroundingStep();
        }

        function startEFTTapping() {
            console.log('üëÜ Starting EFT Tapping');
            
            groundingSession.active = true;
            groundingSession.type = 'eft';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Identify the Issue',
                    instruction: 'Think of something that\'s bothering you. Rate its intensity from 0-10 (10 being most intense).',
                    prompt: 'What are you working on today? How intense does it feel right now? Remember this number.',
                    duration: 20
                },
                {
                    title: 'Setup Statement - Karate Chop',
                    instruction: 'Tap the side of your hand (karate chop point) while saying: "Even though I have this problem, I deeply and completely accept myself."',
                    prompt: 'Keep tapping the karate chop point and repeat: "Even though I have this issue, I deeply and completely accept myself." (Say it 3 times)',
                    duration: 30
                },
                {
                    title: 'Top of Head',
                    instruction: 'Tap the crown of your head with your fingertips while saying "This problem" or describing the issue.',
                    prompt: 'Tap the top of your head and acknowledge: "This problem... this stress... this feeling..."',
                    duration: 15
                },
                {
                    title: 'Eyebrow Point',
                    instruction: 'Tap the beginning of your eyebrow (inner edge) while continuing to acknowledge the issue.',
                    prompt: 'Tap your eyebrow point: "This tension... this worry... this feeling in my body..."',
                    duration: 15
                },
                {
                    title: 'Side of Eye',
                    instruction: 'Tap the outer edge of your eye socket while staying connected to the feeling.',
                    prompt: 'Tap beside your eye: "All this stress... this uncomfortable feeling... this problem..."',
                    duration: 15
                },
                {
                    title: 'Under Eye',
                    instruction: 'Tap under your eye (on the bone) while acknowledging the intensity.',
                    prompt: 'Tap under your eye: "This intensity... this problem... all these feelings..."',
                    duration: 15
                },
                {
                    title: 'Under Nose',
                    instruction: 'Tap between your nose and upper lip while staying present with the issue.',
                    prompt: 'Tap under your nose: "This stress in my body... this problem... these feelings..."',
                    duration: 15
                },
                {
                    title: 'Chin Point',
                    instruction: 'Tap the crease under your lower lip while continuing to acknowledge.',
                    prompt: 'Tap your chin: "All this tension... this problem... these uncomfortable feelings..."',
                    duration: 15
                },
                {
                    title: 'Collarbone',
                    instruction: 'Tap just below your collarbone while staying connected to the issue.',
                    prompt: 'Tap your collarbone: "This stress... this problem... all these feelings in my body..."',
                    duration: 15
                },
                {
                    title: 'Under Arm',
                    instruction: 'Tap about 4 inches below your armpit while continuing to acknowledge.',
                    prompt: 'Tap under your arm: "This problem... this tension... all these feelings..."',
                    duration: 15
                },
                {
                    title: 'Take a Deep Breath',
                    instruction: 'Take a slow, deep breath and check in. How intense does the issue feel now compared to when you started?',
                    prompt: 'Notice any changes. Rate the intensity again from 0-10. If it\'s still above 2, you can do another round.',
                    duration: 20
                }
            ];
            
            showGroundingInterface('EFT Tapping', 'Emotional Freedom Technique for trauma release');
            displayGroundingStep();
        }

        function startLovingKindnessMeditation() {
            console.log('üíù Starting Loving-Kindness Meditation');
            
            groundingSession.active = true;
            groundingSession.type = 'lovingkindness';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Prepare Your Heart',
                    instruction: 'Sit comfortably and place your hand on your heart. We\'ll cultivate feelings of love and kindness, starting with yourself.',
                    prompt: 'Feel your heart beating. This meditation helps heal relationships - starting with the one with yourself.',
                    duration: 15
                },
                {
                    title: 'Love for Yourself',
                    instruction: 'Send loving wishes to yourself. Say silently: "May I be happy. May I be healthy. May I be safe. May I be at peace."',
                    prompt: 'May I be happy... May I be healthy... May I be safe... May I be at peace. Really mean these wishes for yourself.',
                    duration: 45
                },
                {
                    title: 'Love for a Dear One',
                    instruction: 'Think of someone you love easily - family, friend, pet. Send them the same wishes.',
                    prompt: 'May you be happy... May you be healthy... May you be safe... May you be at peace. Feel the warmth of wishing them well.',
                    duration: 40
                },
                {
                    title: 'Love for a Neutral Person',
                    instruction: 'Think of someone neutral - cashier, neighbor, acquaintance. Send them loving wishes.',
                    prompt: 'May you be happy... May you be healthy... May you be safe... May you be at peace. Everyone deserves these wishes.',
                    duration: 35
                },
                {
                    title: 'Love for a Difficult Person',
                    instruction: 'Think of someone challenging (start small). This doesn\'t mean approving of their actions, just wishing them peace.',
                    prompt: 'May you be happy... May you be healthy... May you be safe... May you be at peace. This frees your heart from resentment.',
                    duration: 35
                },
                {
                    title: 'Love for All Beings',
                    instruction: 'Expand your heart to include all living beings everywhere. Send love to the whole world.',
                    prompt: 'May all beings be happy... May all beings be healthy... May all beings be safe... May all beings be at peace.',
                    duration: 30
                },
                {
                    title: 'Return to Yourself',
                    instruction: 'Bring the loving energy back to yourself. You are part of this web of love and kindness.',
                    prompt: 'May I be happy... May I be healthy... May I be safe... May I be at peace. You are worthy of love and kindness.',
                    duration: 25
                }
            ];
            
            showGroundingInterface('Loving-Kindness Meditation', 'Cultivate compassion and self-acceptance');
            displayGroundingStep();
        }

        function startTraumaInformedYoga() {
            console.log('üßò‚Äç‚ôÄÔ∏è Starting Trauma-Informed Yoga');
            
            groundingSession.active = true;
            groundingSession.type = 'yoga';
            groundingSession.currentStep = 0;
            groundingSession.steps = [
                {
                    title: 'Set Your Foundation',
                    instruction: 'Sit or stand comfortably. In trauma-informed yoga, you have complete choice. Stop anytime, modify anything.',
                    prompt: 'This is your practice. Listen to your body and honor what feels right for you in each moment.',
                    duration: 15
                },
                {
                    title: 'Grounding Mountain Pose',
                    instruction: 'Stand with feet hip-width apart, or sit tall. Feel your connection to the earth. You are strong and rooted.',
                    prompt: 'Breathe deeply. Feel your feet on the ground. You are safe, supported, and strong like a mountain.',
                    duration: 25
                },
                {
                    title: 'Gentle Shoulder Rolls',
                    instruction: 'Slowly roll your shoulders backward, then forward. Notice what feels good to your body.',
                    prompt: 'Let your shoulders release tension. Roll them in whatever direction feels nurturing to you.',
                    duration: 20
                },
                {
                    title: 'Neck and Head Movements',
                    instruction: 'Gently turn your head side to side, then nod yes and no. Move slowly and only as far as feels comfortable.',
                    prompt: 'Your neck holds a lot of tension. Move gently and breathe. You are in control of every movement.',
                    duration: 25
                },
                {
                    title: 'Heart Opening Stretch',
                    instruction: 'Bring your hands to your heart, then gently open your arms wide if it feels safe. This opens your heart chakra.',
                    prompt: 'Only open as much as feels comfortable. You choose how vulnerable to be. Your heart is safe.',
                    duration: 25
                },
                {
                    title: 'Gentle Twist',
                    instruction: 'Sitting or standing, gently turn your torso to one side, then the other. Twists help release stored emotions.',
                    prompt: 'Breathe into the twist. This movement helps your body process and release. Go slowly and listen to your body.',
                    duration: 30
                },
                {
                    title: 'Child Pose or Rest',
                    instruction: 'If comfortable, fold forward gently, or simply rest in whatever position feels nurturing.',
                    prompt: 'This is a position of self-care and protection. You are safe to rest and be vulnerable.',
                    duration: 30
                },
                {
                    title: 'Gratitude and Grounding',
                    instruction: 'Return to your starting position. Place your hands on your heart and thank your body for this practice.',
                    prompt: 'Thank your body for its wisdom and resilience. You have honored yourself with this gentle movement.',
                    duration: 20
                }
            ];
            
            showGroundingInterface('Trauma-Informed Yoga', 'Gentle yoga poses for trauma recovery');
            displayGroundingStep();
        }
        
        // Make PTSD grounding functions globally accessible
        window.start54321Technique = start54321Technique;
        window.startBoxBreathing = startBoxBreathing;
        window.startPhysicalGrounding = startPhysicalGrounding;
        window.startProgressiveMuscleRelaxation = startProgressiveMuscleRelaxation;
        window.startMindfulnessMeditation = startMindfulnessMeditation;
        window.startSafePlaceVisualization = startSafePlaceVisualization;
        window.startCognitiveRestructuring = startCognitiveRestructuring;
        window.startBilateralStimulation = startBilateralStimulation;
        window.startResourceInstallation = startResourceInstallation;
        window.startContainmentExercise = startContainmentExercise;
        window.startBodyScanRelaxation = startBodyScanRelaxation;
        window.startEFTTapping = startEFTTapping;
        window.startLovingKindnessMeditation = startLovingKindnessMeditation;
        window.startTraumaInformedYoga = startTraumaInformedYoga;
        window.nextGroundingStep = nextGroundingStep;
        window.stopGroundingSession = stopGroundingSession;
        
        console.log('‚úÖ All functions loaded - Navigation guaranteed to work!');
        console.log('üéØ Ready to navigate between sections');
    </script>
    
    <!-- Intelligent Assessment System -->
    <script src="intelligent-assessment.js"></script>
    
    <!-- üö® Crisis Intervention System integrated directly into main file -->
    
    <!-- Groq API Integration for Enhanced AI Coaching -->
    <script src="groq-api-integration.js"></script>
    <script>
        // Initialize Groq API immediately after loading
        if (typeof GroqAPIConnector !== 'undefined') {
            window.groqAPI = new GroqAPIConnector();
            console.log('ü§ñ Groq API connector instantiated');
        }
    </script>
    
    <!-- EMERGENCY FUNCTION OVERRIDE - GUARANTEED TO WORK -->
    <script>
        console.log('üö® LOADING EMERGENCY FUNCTIONS...');
        
        // DUPLICATE FUNCTION REMOVED - Using original startVoiceConversation to prevent duplicate WebSocket connections
        console.log('üö´ Duplicate function disabled - using original Coach David implementation');
        
        // DUPLICATE endVoiceSession REMOVED - Using emergency version instead
        
        // WORKING EMDR AND HYPNOTHERAPY FUNCTIONS (DO NOT AFFECT COACH DAVID)
        let emdrInterval;
        let anxietyReliefSession = {
            active: false,
            type: null,
            startTime: null,
            duration: 0,
            timer: null,
            audioContext: null,
            oscillator: null,
            gainNode: null
        };
        
        window.showEMDRTools = function() {
            console.log('üß† Starting EMDR session...');
            
            // Show EMDR interface
            const emdrSession = document.getElementById('emdr-session');
            const emdrStartBtn = document.getElementById('emdr-start-btn');
            
            if (emdrSession) {
                emdrSession.classList.remove('hidden');
            }
            if (emdrStartBtn) {
                emdrStartBtn.style.display = 'none';
            }
            
            // Start EMDR dot animation
            const dot = document.getElementById('emdr-dot');
            if (dot) {
                let position = 0;
                const containerWidth = 300; // Approximate container width
                
                emdrInterval = setInterval(() => {
                    position = position === 0 ? containerWidth : 0;
                    dot.style.left = position + 'px';
                }, 2000); // 2 second intervals for therapeutic effect
            }
        };
        
        window.stopEMDR = function() {
            console.log('üõë Stopping EMDR session...');
            
            if (emdrInterval) {
                clearInterval(emdrInterval);
                emdrInterval = null;
            }
            
            const emdrSession = document.getElementById('emdr-session');
            const emdrStartBtn = document.getElementById('emdr-start-btn');
            const dot = document.getElementById('emdr-dot');
            
            if (emdrSession) {
                emdrSession.classList.add('hidden');
            }
            if (emdrStartBtn) {
                emdrStartBtn.style.display = 'block';
            }
            if (dot) {
                dot.style.left = '0px';
            }
        };
        
        function showAnxietyReliefInterface(title, instructions, gradientClass) {
            const session = document.getElementById('anxiety-relief-session');
            const sessionTitle = document.getElementById('session-title');
            const sessionInstructions = document.getElementById('session-instructions');
            const sessionIndicator = document.getElementById('session-indicator');
            
            if (session) {
                session.classList.remove('hidden');
            }
            if (sessionTitle) {
                sessionTitle.textContent = title;
            }
            if (sessionInstructions) {
                sessionInstructions.textContent = instructions;
            }
            if (sessionIndicator) {
                sessionIndicator.className = `w-8 h-8 rounded-full mx-auto animate-pulse bg-gradient-to-br ${gradientClass}`;
            }
        }
        
        function startSessionTimer() {
            const timerDisplay = document.getElementById('timer-display');
            if (!timerDisplay || !anxietyReliefSession.duration) return;
            
            let timeRemaining = anxietyReliefSession.duration;
            
            anxietyReliefSession.timer = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    stopAnxietyReliefSession();
                }
            }, 1000);
        }
        
        function stopAnxietyReliefSession() {
            console.log('üõë [SESSION] Stopping anxiety relief session...');
            
            anxietyReliefSession.active = false;
            
            // Clear timers
            if (anxietyReliefSession.timer) {
                clearInterval(anxietyReliefSession.timer);
                anxietyReliefSession.timer = null;
            }
            
            if (anxietyReliefSession.pmrTimeout) {
                clearTimeout(anxietyReliefSession.pmrTimeout);
                anxietyReliefSession.pmrTimeout = null;
            }
            
            // Stop audio sources
            if (anxietyReliefSession.oscillator) {
                anxietyReliefSession.oscillator.forEach(osc => {
                    try {
                        osc.stop();
                    } catch (e) {
                        console.log('üõë Oscillator already stopped');
                    }
                });
                anxietyReliefSession.oscillator = null;
            }
            
            if (anxietyReliefSession.audioSource) {
                anxietyReliefSession.audioSource.forEach(source => {
                    try {
                        source.stop();
                    } catch (e) {
                        console.log('üõë Audio source already stopped');
                    }
                });
                anxietyReliefSession.audioSource = null;
            }
            
            // Close audio context
            if (anxietyReliefSession.audioContext) {
                try {
                    anxietyReliefSession.audioContext.close();
                } catch (e) {
                    console.log('üõë Audio context already closed');
                }
                anxietyReliefSession.audioContext = null;
            }
            
            // Hide session interface
            const session = document.getElementById('anxiety-relief-session');
            if (session) {
                session.classList.add('hidden');
            }
            
            console.log('üõë [SESSION] Session cleanup complete');
        }
        
        window.startBinauralBeats = function() {
            console.log('üéµ [BINAURAL] STARTING BINAURAL BEATS SESSION');
            
            // Call the original working binaural beats function which handles everything
            startBinauralBeats();
            
            // Get personalized guidance from Groq API
            getPersonalizedPTSDGuidance('binaural', 'Binaural Beats Therapy');
        };
        
        function createBinauralBeatsAudio() {
            console.log('üéµ [AUDIO] Starting binaural beats audio creation...');
            
            try {
                // Create new audio context for this session
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                
                if (!AudioContext) {
                    throw new Error('Web Audio API not supported in this browser');
                }
                
                anxietyReliefSession.audioContext = new AudioContext();
                console.log('üéµ [AUDIO] Audio context created, state:', anxietyReliefSession.audioContext.state);
                
                // Function to start audio after user interaction
                const startAudio = async () => {
                    try {
                        if (anxietyReliefSession.audioContext.state === 'suspended') {
                            console.log('üéµ [AUDIO] Resuming suspended audio context...');
                            await anxietyReliefSession.audioContext.resume();
                        }
                        
                        console.log('üéµ [AUDIO] Creating binaural beats: 200Hz (left) + 240Hz (right) = 40Hz beat frequency');
                        
                        // Left ear: 200Hz, Right ear: 240Hz = 40Hz binaural beat
                        const leftOsc = anxietyReliefSession.audioContext.createOscillator();
                        const rightOsc = anxietyReliefSession.audioContext.createOscillator();
                        const leftGain = anxietyReliefSession.audioContext.createGain();
                        const rightGain = anxietyReliefSession.audioContext.createGain();
                        const merger = anxietyReliefSession.audioContext.createChannelMerger(2);
                        
                        // Set frequencies for 40Hz binaural beat
                        leftOsc.frequency.setValueAtTime(200, anxietyReliefSession.audioContext.currentTime);
                        rightOsc.frequency.setValueAtTime(240, anxietyReliefSession.audioContext.currentTime);
                        leftOsc.type = 'sine'; // Pure sine waves work best for binaural beats
                        rightOsc.type = 'sine';
                        
                        // Set volume (increase for better audibility)
                        leftGain.gain.setValueAtTime(0.6, anxietyReliefSession.audioContext.currentTime);
                        rightGain.gain.setValueAtTime(0.6, anxietyReliefSession.audioContext.currentTime);
                        
                        // Connect audio graph: Oscillator -> Gain -> Merger -> Destination
                        leftOsc.connect(leftGain);
                        rightOsc.connect(rightGain);
                        leftGain.connect(merger, 0, 0); // Left channel
                        rightGain.connect(merger, 0, 1); // Right channel
                        merger.connect(anxietyReliefSession.audioContext.destination);
                        
                        // Start oscillators
                        const currentTime = anxietyReliefSession.audioContext.currentTime;
                        leftOsc.start(currentTime);
                        rightOsc.start(currentTime);
                        
                        // Store references for cleanup
                        anxietyReliefSession.oscillator = [leftOsc, rightOsc];
                        anxietyReliefSession.gainNode = [leftGain, rightGain];
                        
                        console.log('üéß [AUDIO] Binaural beats started successfully!');
                        
                        // Update instructions to confirm audio is playing
                        const sessionInstructions = document.getElementById('session-instructions');
                        if (sessionInstructions) {
                            sessionInstructions.textContent = 'üéß Binaural beats are now playing! Use headphones for the full therapeutic effect. You should hear a subtle pulsing tone - this is the 40Hz gamma wave frequency helping reduce anxiety and promote calm focus.';
                        }
                        
                    } catch (audioError) {
                        console.error('üéµ [AUDIO] Error starting binaural beats:', audioError);
                        const sessionInstructions = document.getElementById('session-instructions');
                        if (sessionInstructions) {
                            sessionInstructions.textContent = `Audio error: ${audioError.message}. Try refreshing the page or using a different browser.`;
                        }
                    }
                };
                
                // Start audio immediately (modern browsers should allow this after user interaction)
                startAudio();
                
            } catch (error) {
                console.error('üéµ [AUDIO] Web Audio API initialization error:', error);
                const sessionInstructions = document.getElementById('session-instructions');
                if (sessionInstructions) {
                    sessionInstructions.textContent = `Audio not supported: ${error.message}. Focus on the visual relaxation guide instead.`;
                }
            }
            
            startSessionTimer();
        };
        
        window.startGuidedBreathing = function() {
            console.log('ü´Å [BREATHING] GUIDED BREATHING ACTIVE!');
            
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'breathing';
            anxietyReliefSession.duration = 5 * 60; // 5 minutes
            anxietyReliefSession.startTime = Date.now();
            anxietyReliefSession.breathingStep = 0; // Track breathing cycle
            
            showAnxietyReliefInterface(
                'Guided Breathing Exercise',
                'Preparing 4-7-8 breathing exercise...',
                'from-green-500 to-teal-500'
            );
            
            // Get personalized guidance from Groq API
            getPersonalizedPTSDGuidance('breathing', 'Guided Breathing Exercise');
            
            // Show and initialize breathing guide
            const breathingGuide = document.getElementById('breathing-guide');
            if (breathingGuide) {
                breathingGuide.classList.remove('hidden');
            }
            
            // Start breathing animation and guidance
            startBreathingAnimation();
            startSessionTimer();
        };
        
        function startBreathingAnimation() {
            console.log('ü´Å [BREATHING] Starting 4-7-8 breathing animation...');
            
            if (!anxietyReliefSession.active || anxietyReliefSession.type !== 'breathing') {
                return;
            }
            
            const breathingCircle = document.getElementById('breathing-circle');
            const breathingInstruction = document.getElementById('breathing-instruction');
            const sessionInstructions = document.getElementById('session-instructions');
            
            if (!breathingCircle) {
                console.log('ü´Å [BREATHING] No breathing circle found');
                return;
            }
            
            // 4-7-8 breathing cycle
            const breathingCycle = [
                { phase: 'Inhale', duration: 4000, instruction: 'Breathe in slowly through your nose...', scale: 1.8 },
                { phase: 'Hold', duration: 7000, instruction: 'Hold your breath... stay relaxed...', scale: 1.8 },
                { phase: 'Exhale', duration: 8000, instruction: 'Exhale slowly through your mouth...', scale: 1.0 },
                { phase: 'Rest', duration: 2000, instruction: 'Rest and prepare for the next breath...', scale: 1.0 }
            ];
            
            let cycleIndex = 0;
            let cycleCount = 0;
            
            function performBreathingStep() {
                if (!anxietyReliefSession.active || anxietyReliefSession.type !== 'breathing') {
                    return;
                }
                
                const currentStep = breathingCycle[cycleIndex];
                
                // Update instruction text
                if (breathingInstruction) {
                    breathingInstruction.textContent = currentStep.instruction;
                }
                
                if (sessionInstructions) {
                    sessionInstructions.textContent = `${currentStep.phase} - Cycle ${cycleCount + 1}. ${currentStep.instruction}`;
                }
                
                // Animate circle
                if (breathingCircle) {
                    breathingCircle.style.transition = `transform ${currentStep.duration}ms ease-in-out`;
                    breathingCircle.style.transform = `scale(${currentStep.scale})`;
                }
                
                console.log(`ü´Å [BREATHING] ${currentStep.phase} for ${currentStep.duration}ms`);
                
                // Move to next step
                setTimeout(() => {
                    if (anxietyReliefSession.active && anxietyReliefSession.type === 'breathing') {
                        cycleIndex = (cycleIndex + 1) % breathingCycle.length;
                        
                        // Complete cycle
                        if (cycleIndex === 0) {
                            cycleCount++;
                            console.log(`ü´Å [BREATHING] Completed cycle ${cycleCount}`);
                        }
                        
                        performBreathingStep();
                    }
                }, currentStep.duration);
            }
            
            // Start first step
            performBreathingStep();
        }
        
        window.startProgressiveMuscleRelaxation = function() {
            console.log('üí™ [NEW VERSION] PROGRESSIVE MUSCLE RELAXATION ACTIVE!');
            console.log('üí™ Initializing PMR with 10-stage progression system...');
            
            if (anxietyReliefSession.active) {
                console.log('üí™ Stopping previous session...');
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'pmr';
            anxietyReliefSession.duration = 15 * 60; // 15 minutes
            anxietyReliefSession.startTime = Date.now();
            anxietyReliefSession.currentStep = 0;
            
            // Define PMR body progression steps
            anxietyReliefSession.pmrSteps = [
                { part: 'Toes and Feet', instruction: 'Curl your toes tightly for 5 seconds... now release and feel the relaxation', duration: 30 },
                { part: 'Calves', instruction: 'Tense your calf muscles by pointing your toes up... now release and relax', duration: 30 },
                { part: 'Thighs', instruction: 'Tighten your thigh muscles... hold for 5 seconds... now release and notice the difference', duration: 30 },
                { part: 'Glutes', instruction: 'Squeeze your buttocks muscles tightly... hold... now release and let go', duration: 30 },
                { part: 'Abdomen', instruction: 'Tense your stomach muscles as if preparing for a punch... hold... now release completely', duration: 30 },
                { part: 'Hands and Arms', instruction: 'Make tight fists and tense your arms... feel the tension... now release and let them fall naturally', duration: 30 },
                { part: 'Shoulders', instruction: 'Raise your shoulders up to your ears... hold the tension... now drop them and relax', duration: 30 },
                { part: 'Face', instruction: 'Scrunch up your entire face - forehead, eyes, mouth... hold tight... now release and soften', duration: 30 },
                { part: 'Whole Body', instruction: 'Now tense your entire body from head to toe... feel all the tension... hold... and release completely', duration: 60 },
                { part: 'Complete Relaxation', instruction: 'Take a moment to notice the deep relaxation throughout your entire body. You are completely relaxed and at peace.', duration: 120 }
            ];
            
            showAnxietyReliefInterface(
                'Progressive Muscle Relaxation',
                'Starting systematic muscle relaxation. Follow along with each body part...',
                'from-blue-500 to-indigo-500'
            );
            
            // Get personalized guidance from Groq API
            getPersonalizedPTSDGuidance('pmr', 'Progressive Muscle Relaxation');
            
            console.log('üí™ Starting PMR guide with steps:', anxietyReliefSession.pmrSteps.length);
            startPMRGuide();
        };
        
        function startPMRGuide() {
            console.log('üí™ [PMR GUIDE] Called - Current step:', anxietyReliefSession.currentStep);
            
            if (!anxietyReliefSession.active || anxietyReliefSession.type !== 'pmr') {
                console.log('üí™ [PMR GUIDE] Session not active or wrong type');
                return;
            }
            
            const currentStep = anxietyReliefSession.pmrSteps[anxietyReliefSession.currentStep];
            if (!currentStep) {
                console.log('üí™ [PMR GUIDE] No more steps, ending session');
                stopAnxietyReliefSession();
                return;
            }
            
            // Update interface with current step
            const sessionTitle = document.getElementById('session-title');
            const sessionInstructions = document.getElementById('session-instructions');
            
            console.log(`üí™ [PMR GUIDE] Step ${anxietyReliefSession.currentStep + 1}: ${currentStep.part}`);
            console.log(`üí™ [PMR GUIDE] Duration: ${currentStep.duration} seconds`);
            
            if (sessionTitle) {
                sessionTitle.textContent = `PMR Step ${anxietyReliefSession.currentStep + 1}/10: ${currentStep.part}`;
            }
            if (sessionInstructions) {
                sessionInstructions.textContent = currentStep.instruction;
            }
            
            // Move to next step after duration
            const timeoutId = setTimeout(() => {
                console.log('üí™ [PMR GUIDE] Timer fired, checking session status...');
                if (anxietyReliefSession.active && anxietyReliefSession.type === 'pmr') {
                    anxietyReliefSession.currentStep++;
                    console.log('üí™ [PMR GUIDE] Moving to next step:', anxietyReliefSession.currentStep);
                    startPMRGuide(); // Continue to next step
                } else {
                    console.log('üí™ [PMR GUIDE] Session ended, not continuing');
                }
            }, currentStep.duration * 1000);
            
            // Store timeout ID for cleanup
            anxietyReliefSession.pmrTimeout = timeoutId;
        }
        
        window.startNatureSounds = function() {
            console.log('üåø [NATURE] NATURE SOUNDS ACTIVE!');
            
            if (anxietyReliefSession.active) {
                stopAnxietyReliefSession();
            }
            
            anxietyReliefSession.active = true;
            anxietyReliefSession.type = 'nature';
            anxietyReliefSession.duration = 15 * 60; // 15 minutes
            anxietyReliefSession.startTime = Date.now();
            
            showAnxietyReliefInterface(
                'Nature Soundscapes',
                'Preparing calming nature sounds...',
                'from-emerald-500 to-green-500'
            );
            
            // Get personalized guidance from Groq API
            getPersonalizedPTSDGuidance('nature', 'Nature Soundscapes');
            
            // Create nature sounds using Web Audio API
            createNatureSoundsAudio();
            startSessionTimer();
        };
        
        function createNatureSoundsAudio() {
            console.log('üåø [NATURE] Starting nature sounds audio creation...');
            
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                
                if (!AudioContext) {
                    throw new Error('Web Audio API not supported');
                }
                
                if (!anxietyReliefSession.audioContext) {
                    anxietyReliefSession.audioContext = new AudioContext();
                }
                
                const startNatureAudio = async () => {
                    try {
                        if (anxietyReliefSession.audioContext.state === 'suspended') {
                            await anxietyReliefSession.audioContext.resume();
                        }
                        
                        console.log('üåø [NATURE] Creating synthetic nature sounds...');
                        
                        // Create rain sound using brown noise filtered
                        const rainBuffer = createRainSound(anxietyReliefSession.audioContext, 10); // 10 seconds of rain
                        const rainSource = anxietyReliefSession.audioContext.createBufferSource();
                        rainSource.buffer = rainBuffer;
                        rainSource.loop = true;
                        
                        // Add some gentle wind with low-pass filtered white noise
                        const windOsc = anxietyReliefSession.audioContext.createOscillator();
                        windOsc.type = 'sawtooth';
                        windOsc.frequency.setValueAtTime(60, anxietyReliefSession.audioContext.currentTime);
                        
                        const windFilter = anxietyReliefSession.audioContext.createBiquadFilter();
                        windFilter.type = 'lowpass';
                        windFilter.frequency.setValueAtTime(200, anxietyReliefSession.audioContext.currentTime);
                        
                        const windGain = anxietyReliefSession.audioContext.createGain();
                        windGain.gain.setValueAtTime(0.1, anxietyReliefSession.audioContext.currentTime);
                        
                        const rainGain = anxietyReliefSession.audioContext.createGain();
                        rainGain.gain.setValueAtTime(0.3, anxietyReliefSession.audioContext.currentTime);
                        
                        // Connect audio graph
                        windOsc.connect(windFilter).connect(windGain);
                        rainSource.connect(rainGain);
                        
                        const masterGain = anxietyReliefSession.audioContext.createGain();
                        masterGain.gain.setValueAtTime(0.5, anxietyReliefSession.audioContext.currentTime);
                        
                        windGain.connect(masterGain);
                        rainGain.connect(masterGain);
                        masterGain.connect(anxietyReliefSession.audioContext.destination);
                        
                        // Start sounds
                        const currentTime = anxietyReliefSession.audioContext.currentTime;
                        windOsc.start(currentTime);
                        rainSource.start(currentTime);
                        
                        // Store references
                        anxietyReliefSession.oscillator = [windOsc];
                        anxietyReliefSession.audioSource = [rainSource];
                        anxietyReliefSession.gainNode = [masterGain];
                        
                        console.log('üåø [NATURE] Nature sounds started successfully!');
                        
                        const sessionInstructions = document.getElementById('session-instructions');
                        if (sessionInstructions) {
                            sessionInstructions.textContent = 'üåø Nature sounds are now playing! Listen to the gentle rain and wind sounds. Let these calming natural soundscapes help you relax and find peace.';
                        }
                        
                    } catch (error) {
                        console.error('üåø [NATURE] Error creating nature sounds:', error);
                        const sessionInstructions = document.getElementById('session-instructions');
                        if (sessionInstructions) {
                            sessionInstructions.textContent = `Nature sounds error: ${error.message}. Focus on breathing and visualization instead.`;
                        }
                    }
                };
                
                startNatureAudio();
                
            } catch (error) {
                console.error('üåø [NATURE] Audio initialization error:', error);
                const sessionInstructions = document.getElementById('session-instructions');
                if (sessionInstructions) {
                    sessionInstructions.textContent = 'Nature sounds not available. Close your eyes and imagine peaceful natural settings.';
                }
            }
        }
        
        function createRainSound(audioContext, duration) {
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(2, length, sampleRate); // Stereo
            
            // Generate realistic rain sound for both channels
            for (let channel = 0; channel < 2; channel++) {
                const data = buffer.getChannelData(channel);
                let lastBrown = 0.0;
                
                for (let i = 0; i < length; i++) {
                    // Create brown noise base
                    const white = Math.random() * 2 - 1;
                    const brown = (lastBrown + (0.02 * white)) / 1.02;
                    lastBrown = brown;
                    
                    // Add rain droplet variations
                    const droplet = Math.random() < 0.001 ? (Math.random() - 0.5) * 0.8 : 0;
                    
                    // High frequency filtering for rain texture
                    const filtered = brown * 0.7 + droplet;
                    
                    // Add slight stereo variation
                    const stereoVar = channel === 0 ? 1.0 : 0.9;
                    data[i] = filtered * 0.4 * stereoVar;
                }
            }
            
            return buffer;
        }
        
        window.stopAnxietyReliefSession = stopAnxietyReliefSession;
        
        // Groq API integration for personalized PTSD guidance with enhanced error handling
        async function getPersonalizedPTSDGuidance(sessionType, sessionName) {
            try {
                console.log(`ü§ñ [GROQ] Getting personalized guidance for ${sessionName}...`);
                
                const systemPrompts = {
                    'pmr': 'You are a trauma-informed therapist providing Progressive Muscle Relaxation guidance. Give encouraging, gentle instructions that help someone through muscle tension and release. Focus on body awareness, safety, and grounding. Keep responses under 100 words and be very supportive.',
                    'breathing': 'You are a mindfulness coach guiding 4-7-8 breathing exercises. Provide gentle, rhythmic instructions that help someone focus on their breath for anxiety relief. Include grounding phrases and calming affirmations. Keep responses under 100 words.',
                    'emdr': 'You are an EMDR therapist guiding someone through bilateral stimulation therapy. Explain how following the dot helps process trauma safely. Provide gentle, trauma-informed encouragement about letting thoughts and feelings flow naturally. Keep responses under 100 words and emphasize safety.',
                    'safety': 'You are a trauma specialist guiding safe place visualization. Help someone create and anchor their mental sanctuary. Provide gentle guidance about engaging all senses in their safe space. Emphasize that this safety belongs to them always. Keep responses under 100 words.',
                    'journal': 'You are a trauma-informed therapist supporting therapeutic journaling. Encourage gentle self-expression and processing through writing. Remind them this is their private space for thoughts and feelings. Provide supportive, non-judgmental guidance. Keep responses under 100 words.',
                    'crisis': 'You are a crisis counselor helping someone create their safety plan. Provide gentle guidance about the importance of having crisis supports ready. Emphasize that reaching for help is strength, not weakness. Be encouraging about their proactive self-care. Keep responses under 100 words.'
                };
                
                const prompt = systemPrompts[sessionType] || systemPrompts['pmr'];
                
                console.log('üîó [GROQ] Making API request to Groq...');
                
                let response;
                
                if (window.groqAPI && window.groqAPI.isConnected) {
                    console.log('üîó [GROQ] Using connected Groq API instance...');
                    
                    response = await fetch(`${window.groqAPI.baseURL}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${window.groqAPI.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: window.groqAPI.model,
                            messages: [
                                {
                                    role: 'system',
                                    content: prompt
                                },
                                {
                                    role: 'user',
                                    content: `I'm starting a ${sessionName} session for anxiety and trauma relief. Please give me encouraging guidance and explain what I can expect from this therapeutic technique.`
                                }
                            ],
                            max_tokens: 150,
                            temperature: 0.8
                        })
                    });
                } else {
                    console.log('üîó [GROQ] Groq API not connected, will use fallback');
                    throw new Error('Groq API not available');
                }
                
                console.log(`üì° [GROQ] Response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const guidance = data.choices[0]?.message?.content || '';
                    
                    if (guidance) {
                        console.log(`ü§ñ [GROQ] ‚úÖ Received personalized guidance: ${guidance.substring(0, 50)}...`);
                        
                        // Update session instructions with AI guidance
                        setTimeout(() => {
                            const sessionInstructions = document.getElementById('session-instructions');
                            if (sessionInstructions && anxietyReliefSession.active) {
                                sessionInstructions.innerHTML = `
                                    <div class="bg-blue-900/30 p-3 rounded-lg mb-3 border-l-4 border-blue-400">
                                        <p class="text-blue-200 text-sm font-medium mb-1">ü§ñ AI Personalized Guidance:</p>
                                        <p class="text-slate-200 text-sm">${guidance}</p>
                                    </div>
                                    <p class="text-slate-300">Session in progress... Follow the guidance above.</p>
                                `;
                            }
                        }, 3000); // Show after 3 seconds
                    } else {
                        console.log('ü§ñ [GROQ] ‚ö†Ô∏è Empty response from API');
                        showFallbackGuidance(sessionType);
                    }
                } else {
                    const errorText = await response.text();
                    console.log(`ü§ñ [GROQ] ‚ùå API call failed (${response.status}): ${errorText}`);
                    showFallbackGuidance(sessionType);
                }
                
            } catch (error) {
                console.log('ü§ñ [GROQ] ‚ùå Network error:', error.message);
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    console.log('ü§ñ [GROQ] üö´ CORS policy blocking API request - using fallback guidance');
                }
                showFallbackGuidance(sessionType);
            }
        }
        
        // Fallback guidance when Groq API is unavailable
        function showFallbackGuidance(sessionType) {
            const fallbackGuidance = {
                'pmr': 'Focus on tensing and releasing each muscle group systematically. Notice the contrast between tension and relaxation. This technique helps release physical stress and promotes deep relaxation throughout your body.',
                'breathing': 'Follow the 4-7-8 pattern: Inhale for 4 counts, hold for 7, exhale for 8. This activates your parasympathetic nervous system, naturally reducing anxiety and promoting relaxation.',
                'emdr': 'Follow the moving dot with your eyes while letting thoughts and feelings flow naturally. This bilateral stimulation helps your brain process difficult experiences safely. You are in control and can stop at any time.',
                'safety': 'Allow yourself to fully experience your safe place using all your senses. This mental sanctuary is yours to access whenever you need comfort, peace, or grounding. Your safety is real and belongs to you.',
                'journal': 'Write freely and without judgment. This is your private space to explore thoughts and feelings. There are no right or wrong answers - only your authentic experience. Take your time and be gentle with yourself.',
                'crisis': 'Having a safety plan is a powerful tool for managing difficult moments. Remember that crisis feelings are temporary, and you have survived challenges before. You are building strength by preparing for your wellbeing.'
            };
            
            const guidance = fallbackGuidance[sessionType] || fallbackGuidance['pmr'];
            
            setTimeout(() => {
                const sessionInstructions = document.getElementById('session-instructions');
                if (sessionInstructions && anxietyReliefSession.active) {
                    sessionInstructions.innerHTML = `
                        <div class="bg-green-900/30 p-3 rounded-lg mb-3 border-l-4 border-green-400">
                            <p class="text-green-200 text-sm font-medium mb-1">üåø Therapeutic Guidance:</p>
                            <p class="text-slate-200 text-sm">${guidance}</p>
                        </div>
                        <p class="text-slate-300">Session in progress... Follow the guidance above.</p>
                    `;
                }
            }, 3000);
        }
        
        // Text-Based Coach Chat System (Sarah, Marcus, Elena - NOT David)
        window.startChatWithCoach = function(coachId) {
            console.log(`üí¨ Starting chat with coach: ${coachId}`);
            
            // Coach David uses speech-to-speech, so redirect to voice system
            if (coachId === 'david') {
                console.log('üéôÔ∏è Coach David uses voice therapy - redirecting to voice system');
                if (typeof window.startVoiceConversation === 'function') {
                    startVoiceConversation();
                } else {
                    console.error('Voice system not available for Coach David');
                }
                return;
            }
            
            // Define text-based coach information
            const coaches = {
                'sarah': {
                    name: 'Coach Sarah',
                    specialty: 'CBT & Mindfulness Specialist',
                    greeting: 'Hello! I\'m Coach Sarah, specializing in Cognitive Behavioral Therapy and mindfulness techniques. I can help you with anxiety management, thought restructuring, and mindfulness practices. How can I support you today?',
                    color: 'from-blue-500 to-cyan-500'
                },
                'marcus': {
                    name: 'Coach Marcus',
                    specialty: 'Addiction Recovery Specialist', 
                    greeting: 'Hi there! I\'m Coach Marcus, and I specialize in addiction recovery and behavioral change. I\'m here to support your journey with evidence-based strategies and compassionate guidance. What\'s on your mind?',
                    color: 'from-green-500 to-emerald-500'
                },
                'elena': {
                    name: 'Coach Elena', 
                    specialty: 'EMDR & Trauma Specialist',
                    greeting: 'Welcome! I\'m Coach Elena, specializing in EMDR therapy and trauma processing. I provide gentle, empathetic support for healing journeys. I can guide you through grounding techniques and trauma-informed care. How are you feeling today?',
                    color: 'from-purple-500 to-pink-500'
                },
                'alex': {
                    name: 'Coach Alex',
                    specialty: 'Mindfulness & Wellness Coach',
                    greeting: 'Hello! I\'m Coach Alex, focusing on mindfulness, wellness, and holistic mental health approaches. I can help you with stress management, wellness planning, and mindful living practices. What brings you here today?',
                    color: 'from-orange-500 to-red-500'
                },
                'maria': {
                    name: 'Coach Maria',
                    specialty: 'Family & Relationship Therapy',
                    greeting: 'Hello! I\'m Coach Maria, specializing in family dynamics and relationship counseling. I help people navigate relationship challenges, improve communication, and build stronger connections. How can I support you today?',
                    color: 'from-pink-500 to-rose-500'
                }
            };
            
            const coach = coaches[coachId];
            if (!coach) {
                console.error('Unknown coach ID:', coachId);
                return;
            }
            
            // Show text chat interface
            showTextChatInterface(coach);
        };
        
        function showTextChatInterface(coach) {
            // Check for assessment context
            const assessmentData = localStorage.getItem('lastAssessmentResults');
            let contextualGreeting = coach.greeting;
            
            if (assessmentData) {
                try {
                    const data = JSON.parse(assessmentData);
                    contextualGreeting = generateContextualGreeting(coach, data);
                } catch (error) {
                    console.error('Error parsing assessment data:', error);
                }
            }
            
            // Create or show chat interface
            let chatInterface = document.getElementById('text-chat-interface');
            
            if (!chatInterface) {
                // Create new chat interface
                const coachesSection = document.getElementById('coaches');
                if (coachesSection) {
                    const chatHTML = `
                        <div id="text-chat-interface" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-slate-800 rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                                <div class="p-6 border-b border-slate-600">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-100">${coach.name}</h3>
                                                <p class="text-sm text-slate-400">${coach.specialty}</p>
                                            </div>
                                        </div>
                                        <button onclick="window.closeTextChat()" class="text-slate-400 hover:text-white">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="text-chat-history" class="flex-1 p-6 overflow-y-auto">
                                    <div class="flex mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center">
                                                <i class="fas fa-user text-white text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3 p-3 bg-slate-700 rounded-lg max-w-xs">
                                            <p class="text-sm text-slate-100">${contextualGreeting}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 border-t border-slate-600">
                                    <div class="flex gap-2 items-end">
                                        <input type="text" id="text-chat-input" placeholder="Message..." 
                                               class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               onkeypress="window.handleTextChatKeypress(event)">
                                        <button onclick="window.sendTextChatMessage()" class="text-blue-500 hover:text-blue-600 font-medium text-sm px-2">
                                            Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', chatHTML);
                    chatInterface = document.getElementById('text-chat-interface');
                }
            }
            
            // Store current coach for chat
            window.currentChatCoach = coach;
        }
        
        window.closeTextChat = function() {
            const chatInterface = document.getElementById('text-chat-interface');
            if (chatInterface) {
                chatInterface.remove();
            }
        };
        
        // Simple text chat functions for modal interfaces
        window.handleTextChatKeypress = function(event) {
            if (event.key === 'Enter') {
                window.sendTextChatMessage();
            }
        };



        
        function showTextChatInterface(coach) {
            // Check for assessment context
            const assessmentData = localStorage.getItem('lastAssessmentResults');
            let contextualGreeting = coach.greeting;
            
            if (assessmentData) {
                try {
                    const data = JSON.parse(assessmentData);
                    contextualGreeting = generateContextualGreeting(coach, data);
                } catch (error) {
                    console.error('Error parsing assessment data:', error);
                }
            }
            
            // Create or show chat interface
            let chatInterface = document.getElementById('text-chat-interface');
            
            if (!chatInterface) {
                // Create new chat interface
                const coachesSection = document.getElementById('coaches');
                if (coachesSection) {
                    const chatHTML = `
                        <div id="text-chat-interface" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-slate-800 rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                                <div class="p-6 border-b border-slate-600">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-100">${coach.name}</h3>
                                                <p class="text-sm text-slate-400">${coach.specialty}</p>
                                            </div>
                                        </div>
                                        <button onclick="window.closeTextChat()" class="text-slate-400 hover:text-white">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="text-chat-history" class="flex-1 p-6 overflow-y-auto">
                                    <div class="flex mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center">
                                                <i class="fas fa-user text-white text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <div class="bg-slate-700 rounded-lg p-3">
                                                <p class="text-slate-100 text-sm">${contextualGreeting}</p>
                                            </div>
                                            <div class="text-xs text-slate-400 mt-1">Just now</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 border-t border-slate-600">
                                    <div class="flex gap-2 items-end">
                                        <input type="text" id="text-chat-input" placeholder="Message..." 
                                               class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button onclick="window.sendTextChatMessage()" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-full text-white font-medium text-sm min-w-[60px]">
                                            Send</button>
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-2">This is a text-based coaching session. For voice therapy, select Coach David.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', chatHTML);
                    
                    // Add event listener for Enter key
                    const chatInput = document.getElementById('text-chat-input');
                    if (chatInput) {
                        chatInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                sendTextMessage();
                            }
                        });
                    }
                }
            } else {
                chatInterface.style.display = 'flex';
            }
        }
        
        window.closeTextChat = function() {
            const chatInterface = document.getElementById('text-chat-interface');
            if (chatInterface) {
                chatInterface.remove();
            }
        };
        
        window.sendTextMessage = function() {
            const input = document.getElementById('text-chat-input');
            const chatHistory = document.getElementById('text-chat-history');
            
            if (!input || !chatHistory || !input.value.trim()) return;
            
            const message = input.value.trim();
            input.value = '';
            
            // Add user message
            const userMessage = `
                <div class="flex mb-4 justify-end">
                    <div class="mr-3 flex-1 max-w-xs">
                        <div class="bg-blue-600 rounded-lg p-3">
                            <p class="text-white text-sm">${message}</p>
                        </div>
                        <div class="text-xs text-slate-400 mt-1 text-right">Just now</div>
                    </div>
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                </div>
            `;
            
            chatHistory.insertAdjacentHTML('beforeend', userMessage);
            
            // Show typing indicator
            const typingIndicator = `
                <div id="typing-indicator" class="flex mb-4">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="bg-slate-700 rounded-lg p-3">
                            <p class="text-slate-100 text-sm">
                                <i class="fas fa-circle animate-pulse"></i>
                                <i class="fas fa-circle animate-pulse" style="animation-delay: 0.2s"></i>
                                <i class="fas fa-circle animate-pulse" style="animation-delay: 0.4s"></i>
                                Thinking...
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            chatHistory.insertAdjacentHTML('beforeend', typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Get AI response using Groq API
            getCoachResponse(message, chatHistory);
        };
        
        // Store current coach info globally for response generation
        let currentCoach = null;
        
        // Update the showTextChatInterface function to store coach info
        function showTextChatInterface(coach) {
            currentCoach = coach; // Store coach for API calls
            
            // Create or show chat interface... (rest of function remains the same)
            let chatInterface = document.getElementById('text-chat-interface');
            
            if (!chatInterface) {
                // Create new chat interface
                const coachesSection = document.getElementById('coaches');
                if (coachesSection) {
                    const chatHTML = `
                        <div id="text-chat-interface" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-slate-800 rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                                <div class="p-6 border-b border-slate-600">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-100">${coach.name}</h3>
                                                <p class="text-sm text-slate-400">${coach.specialty}</p>
                                            </div>
                                        </div>
                                        <button onclick="window.closeTextChat()" class="text-slate-400 hover:text-white">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="text-chat-history" class="flex-1 p-6 overflow-y-auto">
                                    <div class="flex mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center">
                                                <i class="fas fa-user text-white text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <div class="bg-slate-700 rounded-lg p-3">
                                                <p class="text-slate-100 text-sm">${contextualGreeting}</p>
                                            </div>
                                            <div class="text-xs text-slate-400 mt-1">Just now</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 border-t border-slate-600">
                                    <div class="flex gap-2 items-end">
                                        <input type="text" id="text-chat-input" placeholder="Message..." 
                                               class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button onclick="window.sendTextChatMessage()" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-full text-white font-medium text-sm min-w-[60px]">
                                            Send</button>
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-400 mt-2">This is an AI-powered coaching session. For voice therapy, select Coach David.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', chatHTML);
                    
                    // Add event listener for Enter key
                    const chatInput = document.getElementById('text-chat-input');
                    if (chatInput) {
                        chatInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                sendTextMessage();
                            }
                        });
                    }
                }
            } else {
                chatInterface.style.display = 'flex';
            }
        }
        
        async function getCoachResponse(userMessage, chatHistory) {
            try {
                console.log(`ü§ñ Getting AI response for ${currentCoach?.name}:`, userMessage);
                
                if (!currentCoach) {
                    throw new Error('No coach selected');
                }
                
                // Define specialized system prompts for each coach
                const systemPrompts = {
                    'sarah': `You are Coach Sarah, a Cognitive Behavioral Therapy (CBT) and Mindfulness specialist. You help clients with:
- Identifying and challenging negative thought patterns
- Cognitive restructuring techniques
- Mindfulness and meditation practices
- Anxiety management strategies
- Behavioral activation for depression
- Stress reduction techniques

Always provide practical CBT techniques, thought-challenging questions, and mindfulness exercises. Be supportive but focus on evidence-based CBT interventions. Keep responses under 150 words.`,

                    'marcus': `You are Coach Marcus, an Addiction Recovery specialist. You help clients with:
- Smoking cessation strategies and nicotine replacement
- Alcohol and substance abuse recovery
- Relapse prevention techniques
- Behavioral change strategies
- Motivational interviewing techniques
- Building healthy coping mechanisms
- Support system development

Provide specific, actionable addiction recovery advice. Use motivational interviewing techniques and focus on practical steps. Be empathetic but solution-focused. Keep responses under 150 words.`,

                    'elena': `You are Coach Elena, an EMDR and Trauma specialist. You help clients with:
- PTSD and trauma processing techniques
- Grounding and stabilization exercises
- EMDR preparation and education
- Emotional regulation strategies
- Trauma-informed coping skills
- Building resilience and safety
- Body-based trauma interventions

Provide trauma-informed guidance, grounding techniques, and EMDR education. Always prioritize safety and stabilization. Be gentle and validating. Keep responses under 150 words.`
                };
                
                // Get the appropriate system prompt
                const coachKey = currentCoach.name.toLowerCase().includes('sarah') ? 'sarah' :
                               currentCoach.name.toLowerCase().includes('marcus') ? 'marcus' : 'elena';
                
                const systemPrompt = systemPrompts[coachKey];
                
                // Use the working Groq integration instead of direct API calls
                let aiResponse;
                
                if (window.groqAPI && window.groqAPI.isConnected) {
                    console.log('ü§ñ Using connected Groq API instance...');
                    
                    // Use the working groq integration
                    const response = await fetch(`${window.groqAPI.baseURL}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${window.groqAPI.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: window.groqAPI.model,
                            messages: [
                                {
                                    role: 'system',
                                    content: systemPrompt
                                },
                                {
                                    role: 'user', 
                                    content: userMessage
                                }
                            ],
                            max_tokens: 200,
                            temperature: 0.7
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        aiResponse = data.choices[0]?.message?.content;
                    } else {
                        throw new Error(`Groq API error: ${response.status}`);
                    }
                } else {
                    throw new Error('Groq API not connected');
                }
                
                if (!aiResponse) {
                    aiResponse = 'I apologize, but I\'m having trouble processing your message right now. Could you please try again?';
                }
                
                console.log(`ü§ñ AI Response from ${currentCoach.name}:`, aiResponse);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Add AI coach response
                const coachMessage = `
                    <div class="flex mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${currentCoach.color} flex items-center justify-center">
                                <i class="fas fa-user text-white text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="bg-slate-700 rounded-lg p-3">
                                <p class="text-slate-100 text-sm">${aiResponse}</p>
                            </div>
                            <div class="text-xs text-slate-400 mt-1">Just now</div>
                        </div>
                    </div>
                `;
                
                chatHistory.insertAdjacentHTML('beforeend', coachMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
            } catch (error) {
                console.error('ü§ñ ‚ùå Error getting coach response:', error.message);
                
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    console.log('ü§ñ üö´ CORS policy blocking coach API request');
                } else if (error.message.includes('Failed to fetch')) {
                    console.log('ü§ñ üì° Network connection issue with Groq API');
                } else {
                    console.log('ü§ñ ‚ö†Ô∏è Other Groq API error:', error.message);
                }
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Generate coach-specific fallback response
                const coachFallbacks = {
                    'sarah': `I understand you're looking for CBT and mindfulness support. While I'm having connection issues, here are some immediate techniques:

**Cognitive Restructuring**: When you notice negative thoughts, ask yourself: "Is this thought helpful? What evidence supports or contradicts it? What would I tell a friend in this situation?"

**5-Minute Mindfulness**: Focus on your breath for 5 minutes. When your mind wanders, gently bring it back without judgment.

Try the PTSD Corner for grounding techniques, and I'll be back online soon.`,

                    'marcus': `I hear you need addiction recovery support. Even with my connection issues, I can offer these immediate strategies:

**HALT Check**: Are you Hungry, Angry, Lonely, or Tired? These states increase vulnerability to relapse.

**Urge Surfing**: Cravings are like waves - they build, peak, and naturally subside. Observe the sensation without acting.

**5-4-3-2-1 Technique**: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, 1 you taste. This grounds you in the present.

Check the PTSD Corner while I reconnect.`,

                    'elena': `I'm here to support your trauma healing journey. While experiencing connection difficulties, please try these immediate grounding techniques:

**Box Breathing**: Inhale for 4, hold for 4, exhale for 4, hold for 4. This activates your nervous system's calm response.

**5-4-3-2-1 Grounding**: Name 5 things you see, 4 things you can touch, 3 things you hear, 2 things you smell, 1 thing you taste.

**Safe Place Visualization**: Imagine a place where you feel completely safe and peaceful. Engage all your senses in this mental image.

The PTSD Corner has additional EMDR and trauma techniques. I'll be back soon.`
                };

                const coachKey = currentCoach?.name?.toLowerCase().includes('sarah') ? 'sarah' :
                               currentCoach?.name?.toLowerCase().includes('marcus') ? 'marcus' : 'elena';
                
                const fallbackResponse = coachFallbacks[coachKey] || coachFallbacks['elena'];
                
                // Add fallback message with coach-specific guidance
                const errorMessage = `
                    <div class="flex mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${currentCoach?.color || 'from-purple-500 to-pink-500'} flex items-center justify-center">
                                <i class="fas fa-user text-white text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="bg-slate-700 rounded-lg p-3">
                                <p class="text-slate-100 text-sm whitespace-pre-line">${fallbackResponse}</p>
                            </div>
                            <div class="text-xs text-slate-400 mt-1">Just now (Not Connected)</div>
                        </div>
                    </div>
                `;
                
                chatHistory.insertAdjacentHTML('beforeend', errorMessage);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }
        
        // WORKING PTSD INTERVENTION FUNCTIONS
        window.start54321Technique = function() {
            console.log('üß† 5-4-3-2-1 TECHNIQUE ACTIVE!');
            const container = document.getElementById('grounding-session');
            if (container) {
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-900 to-purple-900 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold text-white mb-4">üß† 5-4-3-2-1 Grounding Technique</h3>
                        <div class="space-y-4 text-white">
                            <div class="p-3 bg-white/20 rounded">
                                <strong>5 things you can SEE:</strong><br>Look around and name 5 things you can see right now
                            </div>
                            <div class="p-3 bg-white/20 rounded">
                                <strong>4 things you can TOUCH:</strong><br>Notice 4 different textures or objects you can feel
                            </div>
                            <div class="p-3 bg-white/20 rounded">
                                <strong>3 things you can HEAR:</strong><br>Listen carefully and identify 3 sounds around you
                            </div>
                            <div class="p-3 bg-white/20 rounded">
                                <strong>2 things you can SMELL:</strong><br>Take a moment to notice any scents in the air
                            </div>
                            <div class="p-3 bg-white/20 rounded">
                                <strong>1 thing you can TASTE:</strong><br>Notice any taste in your mouth right now
                            </div>
                        </div>
                        <button onclick="stopGroundingSession()" class="mt-4 bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold">
                            Complete Session
                        </button>
                    </div>
                `;
            }
        };
        
        window.startBoxBreathing = function() {
            console.log('ü´Å BOX BREATHING ACTIVE!');
            const container = document.getElementById('grounding-session');
            if (container) {
                container.classList.remove('hidden');
                let phase = 0;
                let count = 4;
                const phases = ['BREATHE IN', 'HOLD', 'BREATHE OUT', 'HOLD'];
                const colors = ['bg-green-600', 'bg-blue-600', 'bg-purple-600', 'bg-orange-600'];
                
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-teal-900 to-blue-900 p-8 rounded-lg text-center">
                        <h3 class="text-2xl font-bold text-white mb-6">ü´Å Box Breathing Exercise</h3>
                        <div id="breathing-phase" class="text-4xl font-bold text-white mb-4">${phases[0]}</div>
                        <div id="breathing-count" class="text-6xl font-bold text-yellow-400 mb-6">${count}</div>
                        <div class="text-lg text-white mb-6">Follow the rhythm for deep relaxation</div>
                        <button onclick="stopGroundingSession()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded font-bold">
                            Stop Breathing Exercise
                        </button>
                    </div>
                `;
                
                window.breathingInterval = setInterval(() => {
                    count--;
                    document.getElementById('breathing-count').textContent = count;
                    
                    if (count <= 0) {
                        phase = (phase + 1) % 4;
                        count = 4;
                        document.getElementById('breathing-phase').textContent = phases[phase];
                        document.getElementById('breathing-phase').className = `text-4xl font-bold text-white mb-4 ${colors[phase]}`;
                    }
                }, 1000);
            }
        };
        
        window.startPhysicalGrounding = function() {
            console.log('ü§≤ PHYSICAL GROUNDING ACTIVE!');
            const container = document.getElementById('grounding-session');
            if (container) {
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-emerald-900 to-teal-900 p-6 rounded-lg">
                        <h3 class="text-2xl font-bold text-white mb-4">ü§≤ Physical Grounding Exercise</h3>
                        <div class="space-y-4 text-white">
                            <div class="p-4 bg-white/20 rounded">
                                <strong>üë£ Feel Your Feet:</strong><br>Press your feet firmly into the ground. Notice the pressure and stability.
                            </div>
                            <div class="p-4 bg-white/20 rounded">
                                <strong>‚úã Touch Different Textures:</strong><br>Feel the surface you're sitting on, your clothes, nearby objects.
                            </div>
                            <div class="p-4 bg-white/20 rounded">
                                <strong>‚ùÑÔ∏è Hold Something Cool:</strong><br>If available, hold something cold like a water bottle or metal object.
                            </div>
                            <div class="p-4 bg-white/20 rounded">
                                <strong>ü§∏ Gentle Movement:</strong><br>Roll your shoulders, stretch your neck, wiggle your fingers.
                            </div>
                            <div class="p-4 bg-white/20 rounded">
                                <strong>üí® Focus on Breathing:</strong><br>Take slow, deep breaths and feel your chest rise and fall.
                            </div>
                        </div>
                        <button onclick="stopGroundingSession()" class="mt-4 bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold">
                            Complete Session
                        </button>
                    </div>
                `;
            }
        };
        
        // Advanced PTSD interventions
        window.startEMDRSession = function() {
            console.log('üëÅÔ∏è EMDR SESSION ACTIVE!');
            const container = document.getElementById('grounding-session');
            if (container) {
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-indigo-900 to-purple-900 p-6 rounded-lg text-center">
                        <h3 class="text-2xl font-bold text-white mb-4">üëÅÔ∏è EMDR Eye Movement Therapy</h3>
                        <div class="mb-6">
                            <div id="emdr-dot" class="w-8 h-8 bg-yellow-400 rounded-full mx-auto mb-4 transition-all duration-1000"></div>
                            <p class="text-white">Follow the moving dot with your eyes while thinking of your target memory</p>
                        </div>
                        <div class="text-lg text-white mb-6">Session in progress... Let thoughts flow naturally</div>
                        <button onclick="stopGroundingSession()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold">
                            End EMDR Session
                        </button>
                    </div>
                `;
                
                // Animate the EMDR dot
                let direction = 1;
                let position = 0;
                window.emdrInterval = setInterval(() => {
                    position += direction * 20;
                    if (position >= 200 || position <= 0) direction *= -1;
                    
                    const dot = document.getElementById('emdr-dot');
                    if (dot) {
                        dot.style.transform = `translateX(${position}px)`;
                    }
                }, 1000);
            }
        };
        
        window.startBinauralBeats = function() {
            console.log('üéµ BINAURAL BEATS ACTIVE!');
            const container = document.getElementById('grounding-session');
            if (container) {
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-violet-900 to-pink-900 p-6 rounded-lg text-center">
                        <h3 class="text-2xl font-bold text-white mb-4">üéµ Binaural Beats Therapy</h3>
                        <div class="mb-6">
                            <div class="text-6xl mb-4">üéß</div>
                            <p class="text-white mb-4">Therapeutic sound frequencies for relaxation and healing</p>
                            <div class="text-lg text-yellow-300">40Hz Gamma Waves - Anxiety Relief</div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <div class="bg-white/20 p-2 rounded text-white">üßò Close your eyes and relax</div>
                            <div class="bg-white/20 p-2 rounded text-white">üéµ Let the healing frequencies work</div>
                            <div class="bg-white/20 p-2 rounded text-white">‚è∞ Recommended: 10-20 minutes</div>
                        </div>
                        <button onclick="stopGroundingSession()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded font-bold">
                            Stop Audio Session
                        </button>
                    </div>
                `;
            }
        };
        
        // Assessment function
        window.startAssessment = function() {
            console.log('üìã STARTING ASSESSMENT!');
            navigateToSection('assessment');
            
            // Initialize assessment state
            window.assessmentState = {
                currentQuestion: 0,
                totalQuestions: 8, // Set to reasonable number
                answers: {},
                scores: {}
            };
            
            // Start the first question
            setTimeout(() => {
                displayQuestion(0);
            }, 500);
        };
        
        window.displayQuestion = function(questionIndex) {
            console.log('üìù Displaying question:', questionIndex);
            
            const questions = [
                {
                    id: 'energy',
                    title: 'Energy Assessment',
                    question: 'How would you rate your overall energy levels?',
                    answers: [
                        { text: 'Excellent - High energy all day', score: 5, category: 'energy' },
                        { text: 'Good - Generally energetic', score: 4, category: 'energy' },
                        { text: 'Average - Moderate energy', score: 3, category: 'energy' },
                        { text: 'Low - Often tired', score: 2, category: 'energy' },
                        { text: 'Very Low - Constantly exhausted', score: 1, category: 'energy' }
                    ]
                },
                {
                    id: 'sleep',
                    title: 'Sleep Quality',
                    question: 'How would you describe your sleep quality?',
                    answers: [
                        { text: 'Excellent - Sleep deeply, wake refreshed', score: 5, category: 'sleep' },
                        { text: 'Good - Usually sleep well', score: 4, category: 'sleep' },
                        { text: 'Average - Some sleep issues', score: 3, category: 'sleep' },
                        { text: 'Poor - Difficulty sleeping', score: 2, category: 'sleep' },
                        { text: 'Very Poor - Chronic insomnia', score: 1, category: 'sleep' }
                    ]
                }
            ];
            
            if (questionIndex >= questions.length) {
                // Assessment complete
                alert('Assessment Complete!\\n\\nThank you for completing the assessment. Your results have been recorded.');
                return;
            }
            
            const question = questions[questionIndex];
            const container = document.querySelector('#assessment .assessment-container');
            
            if (container) {
                let answersHTML = '';
                question.answers.forEach((answer, index) => {
                    answersHTML += `
                        <button onclick="selectAnswer(${questionIndex}, ${index})" class="assessment-option w-full text-left p-4 bg-slate-600/50 hover:bg-slate-500/70 rounded-lg transition-all border border-slate-500 hover:border-blue-400 mb-3">
                            <div class="flex items-center">
                                <div class="circle w-4 h-4 border-2 border-slate-400 rounded-full mr-3"></div>
                                <div>
                                    <div class="font-medium text-slate-100">${answer.text}</div>
                                </div>
                            </div>
                        </button>
                    `;
                });
                
                container.innerHTML = `
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm text-blue-400">Question ${questionIndex + 1} of ${questions.length}</span>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-4">${question.title}</h3>
                        <p class="text-lg text-slate-300 mb-8">${question.question}</p>
                        ${answersHTML}
                    </div>
                `;
            }
        };
        
        window.selectAnswer = function(questionIndex, answerIndex) {
            console.log('‚úÖ Answer selected:', questionIndex, answerIndex);
            
            // Move to next question
            setTimeout(() => {
                displayQuestion(questionIndex + 1);
            }, 500);
        };
        
        // Payment functions
        window.buySubscription = function(planType, priceId) {
            console.log('üí≥ EMERGENCY PAYMENT:', planType);
            
            const plans = {
                'starter': { name: 'Starter Plan', price: '$29/month' },
                'professional': { name: 'Professional Plan', price: '$79/month' },
                'enterprise': { name: 'Enterprise Plan', price: '$199/month' }
            };
            
            const plan = plans[planType] || { name: planType, price: 'Custom' };
            
            alert(`Payment Processing\\n\\nPlan: ${plan.name}\\nPrice: ${plan.price}\\n\\nThis would normally redirect to Stripe checkout.\\nPayment integration is ready but requires live Stripe keys.`);
        };
        
        window.buyCreditPackage = function(packageType, credits, price) {
            console.log('üí≥ EMERGENCY CREDIT PURCHASE:', packageType);
            alert(`Credit Purchase\\n\\nPackage: ${packageType}\\nCredits: ${credits}\\nPrice: $${price}\\n\\nThis would process through Stripe.\\nPayment system is configured but needs live deployment.`);
        };
        
        // Dashboard function
        window.showPersonalDashboard = function() {
            console.log('üìä EMERGENCY DASHBOARD!');
            navigateToSection('dashboard');
            
            const dashboardContainer = document.querySelector('#dashboard .dashboard-container');
            if (dashboardContainer) {
                dashboardContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-slate-100 mb-4">Health Score</h3>
                            <div class="text-3xl font-bold text-green-400 mb-2">78/100</div>
                            <p class="text-slate-400">Good overall health</p>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-slate-100 mb-4">Goals Progress</h3>
                            <div class="text-3xl font-bold text-blue-400 mb-2">3/5</div>
                            <p class="text-slate-400">Goals completed</p>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-slate-100 mb-4">Sessions</h3>
                            <div class="text-3xl font-bold text-purple-400 mb-2">12</div>
                            <p class="text-slate-400">Therapy sessions</p>
                        </div>
                    </div>
                `;
            }
        };
        
        // Library functions
        window.openLibraryArticle = function(articleId) {
            console.log('üìö EMERGENCY LIBRARY:', articleId);
            alert(`Library Article: ${articleId}\\n\\nThis would open the full article content.\\nLibrary system needs connection to content database.`);
        };
        
        // (Duplicate testAudioPlayback function removed - using emergency version)
        
        // üö® EMERGENCY BUTTON REPAIR SYSTEM üö®
        console.log('üîß DEPLOYING EMERGENCY BUTTON REPAIR...');
        
        // Ensure critical Stripe functions exist
        if (!window.directStripeCheckout) {
            console.log('üö® EMERGENCY: Recreating directStripeCheckout function');
            window.directStripeCheckout = function(priceId, mode, planName, credits = null, amount = null) {
                console.log(`üöÄ Live Stripe checkout: ${planName}`, { priceId, mode, credits, amount });
                
                try {
                    if (!window.Stripe) {
                        alert('Stripe not loaded. Please refresh the page.');
                        return;
                    }
                    
                    const stripe = Stripe('pk_live_51OBKXzC5Ez9YOIayaEw5ZiJgJiUfIRoN7E5HN6qdtIcxWUsInNmp4Mz8nlRKKqfRsU30tnStNb25BOy1wHTBeL3t00FMxEIHVx');
                    
                    // üöÄ Server-side Stripe integration (works without domain verification)
                    // üöÄ Stripe Payment Links (works immediately!)
                    console.log(`üí≥ Processing ${planName} via Payment Link`);
                    
                    // Find Payment Link for this price ID
                    let paymentUrl = null;
                    
                    // Check subscription plans first
                    if (window.stripePaymentLinks.subscriptions[priceId]) {
                        paymentUrl = window.stripePaymentLinks.subscriptions[priceId];
                    }
                    // Check enterprise plans
                    else if (window.stripePaymentLinks.enterprise[priceId]) {
                        paymentUrl = window.stripePaymentLinks.enterprise[priceId];
                    }
                    
                    if (paymentUrl) {
                        window.openStripePaymentLink(paymentUrl, planName);
                    } else {
                        console.error(`‚ùå No Payment Link found for Price ID: ${priceId}`);
                        alert(`Payment Link not configured for ${planName}. Please contact support.`);
                    }
                    
                    return;
                    
                } catch (error) {
                    console.error('‚ùå Stripe error:', error);
                    alert(`Payment Error: ${error.message}`);
                }
            };
        }
        
        // Ensure enterprise calculator exists
        if (!window.showEnterpriseCalculator) {
            console.log('üö® EMERGENCY: Recreating showEnterpriseCalculator function');
            window.showEnterpriseCalculator = function(planType, pricePerUser, maxUsers) {
                console.log(`üè¢ Enterprise calculator: ${planType}`);
                
                const planNames = {
                    'basic': 'Enterprise Basic',
                    'premium': 'Enterprise Premium', 
                    'elite': 'Enterprise Elite'
                };
                
                // Live enterprise Price IDs - CORRECTED
                const stripePriceIds = {
                    'basic': 'price_1Rz9GBC5Ez9YOIayVPhFHmJB',
                    'premium': 'price_1Rz9HcC5Ez9YOIay7MpfziVp',
                    'elite': 'price_1Rz9IbC5Ez9YOIayHjJCU9YY'
                };
                
                const planName = planNames[planType];
                const priceId = stripePriceIds[planType];
                
                // Create proper calculator modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-calculator text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-100 mb-2">${planName}</h3>
                            <p class="text-slate-300">¬£${pricePerUser} per employee per month</p>
                            ${maxUsers < 999 ? `<p class="text-slate-400 text-sm">Maximum ${maxUsers} employees</p>` : ''}
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Number of Employees</label>
                                <div class="relative">
                                    <input type="number" 
                                           id="employee-count-${planType}" 
                                           min="1" 
                                           ${maxUsers < 999 ? `max="${maxUsers}"` : ''}
                                           value="10" 
                                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-blue-500 focus:outline-none"
                                           oninput="updateCalculatorTotal('${planType}', ${pricePerUser})">
                                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-300">Monthly Total:</span>
                                    <span id="monthly-total-${planType}" class="text-2xl font-bold text-blue-400">¬£${10 * pricePerUser}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm text-slate-400">
                                    <span id="calculation-display-${planType}">10 employees √ó ¬£${pricePerUser}</span>
                                    <span>Billed monthly</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="proceedToEnterprisePayment('${planType}', '${priceId}', '${planName}', ${pricePerUser})" 
                                        class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-6 py-3 rounded-lg text-white font-bold transition-all">
                                    <i class="fas fa-credit-card mr-2"></i>
                                    Continue to Payment
                                </button>
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white transition-all">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            };
        }
        
        // Add calculator update function
        window.updateCalculatorTotal = function(planType, pricePerUser) {
            const employeeInput = document.getElementById(`employee-count-${planType}`);
            const monthlyTotalEl = document.getElementById(`monthly-total-${planType}`);
            const calculationEl = document.getElementById(`calculation-display-${planType}`);
            
            if (!employeeInput || !monthlyTotalEl || !calculationEl) return;
            
            let employees = parseInt(employeeInput.value) || 1;
            if (employees < 1) {
                employees = 1;
                employeeInput.value = 1;
            }
            
            const monthlyTotal = employees * pricePerUser;
            monthlyTotalEl.textContent = `¬£${monthlyTotal}`;
            calculationEl.textContent = `${employees} employees √ó ¬£${pricePerUser}`;
            
            console.log(`üìä Calculator updated: ${employees} √ó ¬£${pricePerUser} = ¬£${monthlyTotal}`);
        };
        
        // Add payment processing function
        window.proceedToEnterprisePayment = function(planType, priceId, planName, pricePerUser) {
            const employeeInput = document.getElementById(`employee-count-${planType}`);
            const employees = parseInt(employeeInput.value) || 1;
            const monthlyTotal = employees * pricePerUser;
            
            console.log(`üöÄ Processing enterprise: ${employees} employees, ¬£${monthlyTotal}/month`);
            
            // Close modal
            const modal = document.querySelector('.fixed');
            if (modal) modal.remove();
            
            // Use Payment Link with custom instructions for now
            showEnterprisePaymentInstructions(planType, employees, pricePerUser, planName, monthlyTotal);
        };
        
        // Enterprise payment with instructions (until API is deployed)
        window.showEnterprisePaymentInstructions = function(planType, employees, pricePerUser, planName, monthlyTotal) {
            const paymentUrl = window.stripePaymentLinks.enterprise[planType === 'basic' ? 'price_1Rz9GBC5Ez9YOIayVPhFHmJB' : 
                                                                    planType === 'premium' ? 'price_1Rz9H8C5Ez9YOIay8tYhG6pE' : 
                                                                    'price_1Rz9HSC5Ez9YOIaybYQLrE1N'];
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-building text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-2">${planName}</h3>
                        <p class="text-slate-300">Enterprise pricing setup</p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div class="bg-slate-700 rounded-lg p-4">
                            <h4 class="font-bold text-blue-400 mb-2">üìä Your Configuration:</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>‚Ä¢ <strong>Plan:</strong> ${planName}</li>
                                <li>‚Ä¢ <strong>Employees:</strong> ${employees}</li>
                                <li>‚Ä¢ <strong>Rate:</strong> ¬£${pricePerUser}/employee/month</li>
                                <li>‚Ä¢ <strong>Monthly Total:</strong> ¬£${monthlyTotal}</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-600/20 rounded-lg p-4 border border-yellow-500/30">
                            <h4 class="font-bold text-yellow-400 mb-2">‚ö†Ô∏è Setup Instructions:</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>1. Click "Proceed to Payment" below</li>
                                <li>2. Complete payment at standard rate</li>
                                <li>3. Contact support immediately after purchase</li>
                                <li>4. We'll adjust billing to ${employees} employees (¬£${monthlyTotal}/month)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="window.openStripePaymentLink('${paymentUrl}', '${planName}'); this.closest('.fixed').remove();" 
                                class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 px-6 py-3 rounded-lg text-white font-bold">
                            <i class="fas fa-credit-card mr-2"></i>Proceed to Payment
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded-lg text-slate-200">
                            Cancel
                        </button>
                    </div>
                    
                    <p class="text-xs text-slate-400 mt-4 text-center">
                        üí° Support will adjust your billing within 24 hours to reflect ${employees} employees
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        };

        
        // Add missing updateCalculator function
        window.updateCalculator = function() {
            console.log('üìä Calculator update triggered');
            // This function exists for compatibility
            // Real calculator logic is in updateCalculatorTotal()
        };
        
        // Direct Credit Purchase - STRAIGHT TO STRIPE
        window.showCreditPurchase = function(planType, defaultCredits, defaultPrice) {
            console.log(`üí≥ Direct credit purchase: ${planType} - ${defaultCredits} credits for ¬£${defaultPrice}`);
            
            // Check if user is on free plan (simulation - you'd check actual user status)
            const userTier = localStorage.getItem('userTier') || 'free';
            
            if (userTier === 'free') {
                // Show upgrade-required modal for free users
                showCreditUpgradeRequired(planType, defaultCredits, defaultPrice);
                return;
            }
            
            // DIRECT PURCHASE FOR PAID SUBSCRIBERS - NO CONFIRMATION MODALS
            const paymentUrl = window.stripePaymentLinks.credits[planType];
            
            if (paymentUrl) {
                console.log(`üöÄ Redirecting directly to Stripe: ${paymentUrl}`);
                window.location.href = paymentUrl;
            } else {
                console.error(`‚ùå No Payment Link found for plan: ${planType}`);
                alert(`Payment Link not configured for ${planType} plan. Please contact support.`);
            }
        };

        // Show upgrade requirement for free users trying to buy credits
        window.showCreditUpgradeRequired = function(planType, defaultCredits, defaultPrice) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-lock text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-2">üîí Credits Require Subscription</h3>
                        <p class="text-slate-300">Credits are available as add-ons for subscribers only</p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div class="bg-red-600/20 rounded-lg p-4 border border-red-500/30">
                            <h4 class="font-bold text-red-400 mb-2">‚ùå Why Credits Need Subscription:</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>‚Ä¢ Credits are designed to supplement monthly allocations</li>
                                <li>‚Ä¢ Free plan provides 1 assessment + 1 coach session monthly</li>
                                <li>‚Ä¢ For more usage, choose a subscription plan</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-600/20 rounded-lg p-4 border border-green-500/30">
                            <h4 class="font-bold text-green-400 mb-2">‚úÖ Better Value with Subscription:</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>‚Ä¢ <strong>Basic (¬£24/mo):</strong> 50 sessions + voice therapy + PTSD tools</li>
                                <li>‚Ä¢ <strong>Premium (¬£49/mo):</strong> 100 sessions + priority support</li>
                                <li>‚Ä¢ <strong>Plus credits:</strong> Buy additional credits at subscriber rates</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="directStripeCheckout('price_1RytIqC5Ez9YOIaynY645OsH', 'subscription', 'Root Cause Power Basic - ¬£24/month'); this.closest('.fixed').remove();" 
                                class="flex-1 bg-gradient-to-r from-blue-500 to-green-500 hover:from-blue-600 hover:to-green-600 px-6 py-3 rounded-lg text-white font-bold">
                            <i class="fas fa-upgrade mr-2"></i>Upgrade to Basic
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded-lg text-slate-200">
                            Maybe Later
                        </button>
                    </div>
                    
                    <p class="text-xs text-slate-400 mt-4 text-center">
                        üí° Subscribers get <strong>better credit rates</strong> and can purchase credits as top-ups
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        // Update credit price calculation (Enterprise-style)
        window.updateCreditPrice = function(planType, baseRate) {
            const creditCount = parseInt(document.getElementById('credit-count').value) || 0;
            
            // Volume discounts for larger purchases
            let rate = baseRate;
            if (creditCount >= 1000) {
                rate = 0.12; // ¬£0.12 per credit for 1000+ (Enterprise Pack rate)
            } else if (creditCount >= 500) {
                rate = 0.15; // ¬£0.15 per credit for 500+ (Professional Pack rate)
            } else if (creditCount >= 100) {
                rate = 0.18; // ¬£0.18 per credit for 100+ (Starter rate)
            } else {
                rate = 0.20; // ¬£0.20 per credit for smaller quantities
            }
            
            const total = (creditCount * rate).toFixed(2);
            
            // Update displays
            if (document.getElementById('credit-display')) {
                document.getElementById('credit-display').textContent = creditCount.toLocaleString();
            }
            if (document.getElementById('rate-display')) {
                document.getElementById('rate-display').textContent = `¬£${rate.toFixed(4)}`;
            }
            if (document.getElementById('total-display')) {
                document.getElementById('total-display').textContent = `¬£${total}`;
            }
            
            console.log(`üí∞ Updated: ${creditCount} credits at ¬£${rate.toFixed(4)} each = ¬£${total} (85% margin included)`);
        };
        
        // Process credit payment (Enterprise-style with proper Stripe integration)
        window.proceedToCreditPayment = function(planType = 'professional') {
            const creditCount = parseInt(document.getElementById('credit-count').value) || 0;
            const totalAmount = document.getElementById('total-display').textContent.replace('¬£', '');
            
            console.log(`üí≥ Processing ${planType} credit payment: ${creditCount} credits for ¬£${totalAmount}`);
            
            // Validation
            if (creditCount < 100) {
                alert('Minimum purchase is 100 credits.');
                return;
            }
            
            // Close modal
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
            
            // Convert to pence for Stripe
            const amountInPence = Math.round(parseFloat(totalAmount) * 100);
            
            console.log(`üí≥ Stripe checkout: ${amountInPence} pence for ${creditCount} credits with 85% margin`);
            
            // üöÄ Stripe Payment Links (works immediately!)
            console.log(`üí≥ Processing credit payment via Payment Link: ${creditCount} credits for ¬£${totalAmount}`);
            
            // Get Payment Link for plan type
            const paymentUrl = window.stripePaymentLinks.credits[planType];
            
            if (paymentUrl) {
                const planDisplayName = `${planType.charAt(0).toUpperCase() + planType.slice(1)} Pack - ${creditCount} Credits`;
                window.openStripePaymentLink(paymentUrl, planDisplayName);
            } else {
                console.error(`‚ùå No Payment Link found for plan: ${planType}`);
                alert(`Payment Link not configured for ${planType} plan. Please contact support.`);
            }
            
            // This will work once Payment Links are created:
            // window.open(paymentLinks[linkKey], '_blank');
        };
        
        // Ensure credit purchase function exists (Emergency Backup)
        if (!window.showCreditPurchase) {
            console.log('üö® EMERGENCY: Recreating showCreditPurchase function');
            window.showCreditPurchase = function(planType, defaultCredits, defaultPrice) {
                console.log(`üí≥ EMERGENCY Credit purchase: ${planType} - ${defaultCredits} credits for ¬£${defaultPrice}`);
                
                // Use Payment Links for immediate functionality
                const paymentUrl = window.stripePaymentLinks.credits[planType];
                
                if (paymentUrl) {
                    const planDisplayName = `${planType.charAt(0).toUpperCase() + planType.slice(1)} Pack - ${defaultCredits} Credits`;
                    window.openStripePaymentLink(paymentUrl, planDisplayName);
                    return;
                }
                
                // Fallback to modal if Payment Links not available
                const planNames = {
                    'starter': 'Professional Starter',
                    'professional': 'Professional Pack',
                    'enterprise': 'Enterprise Pack'
                };
                
                const planName = planNames[planType] || 'Credit Purchase';
                const baseRate = 0.12; // ¬£0.12 per credit with 85% margin accounting for unpredictable Hume costs
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-coins text-white text-2xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-100 mb-2">${planName}</h3>
                            <p class="text-slate-300">Choose how many credits you need</p>
                        </div>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-slate-300 font-medium mb-2">Number of Credits</label>
                                <div class="relative">
                                    <input type="number" 
                                           id="credit-count" 
                                           min="100" 
                                           value="${defaultCredits}" 
                                           class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white text-lg font-medium focus:border-green-500 focus:outline-none"
                                           oninput="updateCreditPrice('${planType}', ${baseRate})">
                                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-300">Credits:</span>
                                    <span id="credit-display" class="text-xl font-bold text-green-400">${defaultCredits.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-300">Rate per credit:</span>
                                    <span id="rate-display" class="text-lg font-bold text-blue-400">¬£${baseRate.toFixed(4)}</span>
                                </div>
                                <div class="border-t border-slate-600 pt-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-100 font-bold">Total:</span>
                                        <span id="total-display" class="text-2xl font-bold text-green-400">¬£${defaultPrice}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="proceedToCreditPayment('${planType}')" 
                                        class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-6 py-3 rounded-lg text-white font-bold">
                                    <i class="fas fa-credit-card mr-2"></i>Purchase Credits
                                </button>
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-white">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            };
        }

        // üöÄ Stripe Payment Links Integration (Works Immediately!)
        window.stripePaymentLinks = {
            // Individual Subscription Plans
            subscriptions: {
                'price_1RytIqC5Ez9YOIaynY645OsH': 'https://buy.stripe.com/4gMfZgeHVcmFaYF7WY0VO02', // Basic
                'price_1Rz9AnC5Ez9YOIayC2sT6i73': 'https://buy.stripe.com/bJeaEW7ft3Q9giZ3GI0VO01', // Premium
                'price_1Rz9BuC5Ez9YOIaykzDOSemw': 'https://buy.stripe.com/00w6oG43h86p2s93GI0VO03'  // VIP
            },
            
            // Enterprise Plans
            enterprise: {
                'price_1Rz9GBC5Ez9YOIayVPhFHmJB': 'https://buy.stripe.com/6oUbJ0gQ35Yhd6N7WY0VO04', // Basic
                'price_1Rz9H8C5Ez9YOIay8tYhG6pE': 'https://buy.stripe.com/fZu6oG1V94UdfeVgtu0VO05', // Premium
                'price_1Rz9HSC5Ez9YOIaybYQLrE1N': 'https://buy.stripe.com/14AbJ09nBdqJ2s9dhi0VO06'  // Elite
            },
            
            // Credit Packages
            credits: {
                'starter': 'https://buy.stripe.com/14A28q0R572leaRa560VO08',     // Pro Starter (100 credits, ¬£18)
                'professional': 'https://buy.stripe.com/cNidR81V9dqJfeVelm0VO09', // Pro Pack (500 credits, ¬£75)
                'enterprise': 'https://buy.stripe.com/7sYfZggQ39at5Elfpq0VO0a'   // Enterprise Pack (1000 credits, ¬£120)
            }
        };

        // Professional checkout experience - DIRECT TO STRIPE (NO HANGING)
        window.openStripePaymentLink = function(url, planName) {
            console.log(`üöÄ Opening Stripe Payment: ${planName}`);
            console.log(`üîó URL: ${url}`);
            
            // Validate URL
            if (!url || !url.startsWith('https://buy.stripe.com/')) {
                console.error('‚ùå Invalid Payment Link:', url);
                alert('Payment configuration error. Please contact support.');
                return;
            }
            
            // DIRECT REDIRECT - NO MODALS OR CONFIRMATIONS
            console.log('‚úÖ Redirecting directly to Stripe secure payment page');
            window.location.href = url;
        };
        
        // Professional checkout confirmation (no hanging)
        window.showCheckoutConfirmation = function(url, planName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-md mx-4 w-full text-center border border-slate-600">
                    <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-credit-card text-white text-2xl"></i>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-slate-100 mb-2">${planName}</h3>
                    <p class="text-slate-400 mb-6">Ready to proceed to secure checkout</p>
                    
                    <div class="bg-slate-700 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-center space-x-4 text-sm text-slate-300">
                            <span class="flex items-center"><i class="fas fa-shield-alt text-green-400 mr-2"></i>SSL Encrypted</span>
                            <span class="flex items-center"><i class="fas fa-lock text-blue-400 mr-2"></i>Stripe Secure</span>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="proceedToDirectCheckout('${url}', '${planName}')" 
                                class="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-6 py-3 rounded-lg text-white font-bold">
                            <i class="fas fa-arrow-right mr-2"></i>Continue to Secure Payment
                        </button>
                        
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg text-slate-200">
                            Cancel
                        </button>
                    </div>
                    
                    <p class="text-xs text-slate-500 mt-4">
                        You'll be redirected to Stripe's secure payment page
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
            
            console.log('‚úÖ Checkout confirmation modal shown - no hanging!');
        };
        
        // Smart checkout with automatic fallback to prevent hanging
        window.showEmbeddedCheckout = function(url, planName) {
            console.log('üöÄ Starting smart checkout for:', planName);
            
            // Create loading modal first
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            loadingModal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-md mx-4 w-full text-center">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-slate-100 mb-2">${planName}</h3>
                    <p class="text-slate-400 mb-4">Opening secure checkout...</p>
                    <div class="space-y-2">
                        <button onclick="proceedToDirectCheckout('${url}', '${planName}')" 
                                class="w-full bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white">
                            <i class="fas fa-external-link-alt mr-2"></i>Continue to Secure Payment
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-slate-200">
                            Cancel
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-4">
                        Auto-redirecting in <span id="countdown">3</span> seconds...
                    </p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            // Countdown and auto-redirect to prevent hanging
            let countdown = 3;
            const countdownElement = loadingModal.querySelector('#countdown');
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    if (document.body.contains(loadingModal)) {
                        loadingModal.remove();
                        window.proceedToDirectCheckout(url, planName);
                    }
                }
            }, 1000);
            
            console.log('‚è∞ Auto-redirect in 3 seconds to prevent hanging');
        };
        
        // Direct checkout function (reliable)
        window.proceedToDirectCheckout = function(url, planName) {
            console.log('üöÄ Proceeding to direct Stripe checkout:', planName);
            console.log('üîó URL:', url);
            
            // Remove any existing modals
            document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
            
            // Direct redirect - most reliable method
            window.location.href = url;
        };
        
        // Optional: Embedded checkout for future use
        window.openEmbeddedStripeCheckout = function(url, planName) {
            console.log(`üöÄ Opening Embedded Stripe Checkout: ${planName}`);
            
            // Show loading message first
            const loadingModal = document.createElement('div');
            loadingModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            loadingModal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 text-center">
                    <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-slate-100">Opening secure checkout...</p>
                    <button onclick="this.closest('.fixed').remove(); window.openStripePaymentLink('${url}', '${planName}')" 
                            class="mt-4 bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white text-sm">
                        Open in New Tab Instead
                    </button>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            // Try embedded, fallback to redirect after 3 seconds
            setTimeout(() => {
                if (document.body.contains(loadingModal)) {
                    loadingModal.remove();
                    window.openStripePaymentLink(url, planName);
                }
            }, 3000);
            
            // Create actual embedded modal
            setTimeout(() => {
                if (document.body.contains(loadingModal)) {
                    loadingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
                modal.innerHTML = `
                    <div class="bg-slate-800 rounded-2xl max-w-4xl mx-4 w-full max-h-[90vh] overflow-hidden border border-slate-600">
                        <div class="flex items-center justify-between p-6 border-b border-slate-600">
                            <div>
                                <h3 class="text-xl font-bold text-slate-100">${planName}</h3>
                                <p class="text-slate-400">Secure checkout powered by Stripe</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-slate-600 hover:bg-slate-500 p-2 rounded-lg text-slate-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-0">
                            <iframe src="${url}" 
                                    class="w-full h-[70vh] border-0"
                                    frameborder="0"
                                    scrolling="yes"
                                    allow="payment"
                                    onload="console.log('‚úÖ Stripe iframe loaded')">
                            </iframe>
                        </div>
                        <div class="p-4 bg-slate-700 text-center">
                            <p class="text-xs text-slate-400">
                                üîí Secure payment processing by Stripe ‚Ä¢ 
                                <button onclick="this.closest('.fixed').remove(); window.openStripePaymentLink('${url}', '${planName}')" 
                                        class="text-blue-400 hover:text-blue-300 underline">
                                    Open in new tab
                                </button>
                            </p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }, 500);
        };

        // Set user as free tier
        window.startFreeUserSession = function() {
            localStorage.setItem('userTier', 'free');
            localStorage.setItem('freeTrialStarted', new Date().toISOString());
            console.log('üÜì User set to free tier');
        };

        // Upgrade user tier (call this after successful subscription)
        window.upgradeUserTier = function(tier) {
            localStorage.setItem('userTier', tier);
            console.log(`‚¨ÜÔ∏è User upgraded to: ${tier}`);
        };

        // Free Trial Function
        window.startFreeTrial = function() {
            console.log('üÜì Starting free trial...');
            
            // Show upgrade-focused modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-lg mx-4 w-full border border-slate-600">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-gift text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-100 mb-2">üéâ Welcome to Your Free Trial!</h3>
                        <p class="text-slate-300">Experience the power of AI healthcare</p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div class="bg-slate-700 rounded-lg p-4">
                            <h4 class="font-bold text-green-400 mb-2">‚úÖ What You Get FREE This Month:</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>‚Ä¢ 1 Comprehensive health assessment</li>
                                <li>‚Ä¢ 1 AI coach session with personalized advice</li>
                                <li>‚Ä¢ Basic platform access</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 rounded-lg p-4 border border-blue-400/30">
                            <h4 class="font-bold text-blue-400 mb-2">üöÄ Unlock Full Power (Upgrade Benefits):</h4>
                            <ul class="text-slate-300 text-sm space-y-1">
                                <li>‚Ä¢ <strong>Voice Therapy:</strong> Hume AI empathic voice sessions</li>
                                <li>‚Ä¢ <strong>PTSD Corner:</strong> 5-4-3-2-1 technique, breathing exercises</li>
                                <li>‚Ä¢ <strong>Knowledge Library:</strong> 1000+ evidence-based articles</li>
                                <li>‚Ä¢ <strong>Unlimited Sessions:</strong> No monthly limits</li>
                                <li>‚Ä¢ <strong>Priority Support:</strong> 24/7 crisis intervention</li>
                                <li>‚Ä¢ <strong>Progress Tracking:</strong> Detailed analytics & insights</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="startFreeUserSession(); navigateToSection('assessment'); this.closest('.fixed').remove();" 
                                class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-6 py-3 rounded-lg text-white font-bold">
                            <i class="fas fa-play mr-2"></i>Start Free Assessment
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded-lg text-slate-200">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        function displayEmptyDashboard() {
            console.log('üîÑ displayEmptyDashboard function called');
            const dashboardContent = document.getElementById('dashboard-content');
            if (!dashboardContent) {
                console.error('‚ùå dashboard-content element not found!');
                return;
            }
            
            console.log('üìä Auto-populating dashboard with sample data...');
            
            // Create sample assessment data for demo purposes
            const sampleResults = {
                healthScores: {
                    overall_score: 7.2,
                    physical_health: 6.8,
                    mental_wellness: 7.5,
                    energy_vitality: 7.0,
                    sleep_quality: 8.0,
                    stress_management: 6.2,
                    daily_functioning: 7.3
                },
                responses: ['Sample responses showing health areas'],
                recommendations: [
                    'Focus on stress management techniques',
                    'Maintain good sleep habits',
                    'Consider nutrition optimization'
                ],
                timestamp: new Date().toISOString(),
                completedAt: new Date().toISOString()
            };
            
            // Display the sample dashboard
            displayEnhancedDashboard(sampleResults);
        }
        
        function getScoreDescription(score) {
            if (score >= 4) return 'Excellent';
            if (score >= 3) return 'Good';
            if (score >= 2) return 'Needs improvement';
            return 'Requires attention';
        }
        
        // Update navigation buttons
        function updateNavButtons(activeSection) {
            document.querySelectorAll('[onclick^="navigateToSection"]').forEach(button => {
                if (button.onclick.toString().includes(activeSection)) {
                    button.classList.add('bg-blue-600', 'text-white');
                    button.classList.remove('text-slate-300', 'hover:text-white');
                } else {
                    button.classList.remove('bg-blue-600', 'text-white');
                    button.classList.add('text-slate-300', 'hover:text-white');
                }
            });
        }
        
        // ===== SIMPLIFIED API INITIALIZATION =====
        async function initializeLiveAPIs() {
            console.log('üöÄ Initializing live APIs for Root Cause Power platform...');
            
            const apiStatus = {
                groq: false,
                hume: false,
                stripe: false,
                assessment: false
            };
            
            // 1. Initialize Groq AI API
            try {
                if (window.groqAPI) {
                    const GROQ_API_KEY = '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';
                    apiStatus.groq = await window.groqAPI.initialize(GROQ_API_KEY);
                    console.log('ü§ñ Groq AI:', apiStatus.groq ? '‚úÖ Connected' : '‚ùå Failed');
                }
            } catch (error) {
                console.error('‚ùå Groq API error:', error);
            }
            
            // 2. Test Hume EVI Connection
            try {
                const HUME_API_KEY = 'si8yIRYvcFUMUIsiM3RzlNQhAp09a6gUkce6Tjt7R34XTHAo';
                const HUME_SECRET_KEY = 'mRDCEm0XyDchucUKs7aGR6mTSgAHFWrhaDrM5hvh5idWrGB4x41jbZozD9Y8LB3b';
                
                const tokenResponse = await fetch('https://api.hume.ai/oauth2-cc/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        'grant_type': 'client_credentials',
                        'client_id': HUME_API_KEY,
                        'client_secret': HUME_SECRET_KEY
                    })
                });
                
                apiStatus.hume = tokenResponse.ok;
                console.log('üéôÔ∏è Hume EVI:', apiStatus.hume ? '‚úÖ Connected' : '‚ùå Failed');
            } catch (error) {
                console.error('‚ùå Hume EVI error:', error);
            }
            
            // 3. Initialize Stripe
            try {
                const STRIPE_KEY = 'pk_live_51OBKXzC5Ez9YOIayaEw5ZiJgJiUfIRoN7E5HN6qdtIcxWUsInNmp4Mz8nlRKKqfRsU30tnStNb25BOy1wHTBeL3t00FMxEIHVx';
                if (window.Stripe) {
                    window.stripe = Stripe(STRIPE_KEY);
                    apiStatus.stripe = true;
                    console.log('üí≥ Stripe: ‚úÖ Connected');
                }
            } catch (error) {
                console.error('‚ùå Stripe error:', error);
            }
            
            // 4. Check Assessment System
            if (window.startAssessment && typeof window.startAssessment === 'function') {
                apiStatus.assessment = true;
                console.log('üìä Assessment: ‚úÖ Ready');
            }
            
            // Store status globally
            window.apiStatus = apiStatus;
            
            return apiStatus;
        }
        
        // ===== NAVIGATION FIX - OVERRIDE ALL PREVIOUS DEFINITIONS =====
        console.log('üîß Applying final navigation fix...');
        
        window.navigateToSection = function(sectionId) {
            console.log('üîÑ FINAL Navigation to:', sectionId);
            
            // Special handling for assessment
            if (sectionId === 'assessment') {
                console.log('üéØ Starting intelligent assessment...');
                
                // Check if disclaimer was already accepted
                if (checkDisclaimerAccepted()) {
                    // Disclaimer already accepted, proceed directly to assessment
                    console.log('‚úÖ Disclaimer already accepted, proceeding to assessment');
                } else {
                    // Show disclaimer first
                    console.log('üõ°Ô∏è Showing health disclaimer first');
                    showHealthDisclaimer();
                    return;
                }
            }
            
            try {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active');
                });
                
                // Show target section
                const target = document.getElementById(sectionId);
                if (target) {
                    target.style.display = 'block';
                    target.classList.add('active');
                    console.log('‚úÖ Successfully showing section:', sectionId);
                    
                    // Update nav buttons
                    document.querySelectorAll('.nav-button, [onclick*="navigateToSection"]').forEach(btn => {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('text-slate-300');
                    });
                    
                    // Highlight active button
                    const activeBtn = document.getElementById(`nav-${sectionId}`);
                    if (activeBtn) {
                        activeBtn.classList.add('bg-blue-600', 'text-white');
                        activeBtn.classList.remove('text-slate-300');
                    }
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                    
                    // Initialize dashboard if needed
                    if (sectionId === 'dashboard' && window.initializeDashboard) {
                        window.initializeDashboard();
                    }
                    
                    // Initialize assessment if needed
                    if (sectionId === 'assessment' && window.startIntelligentAssessment) {
                        setTimeout(() => {
                            window.startIntelligentAssessment();
                        }, 100);
                    }
                    
                } else {
                    console.error('‚ùå Section not found:', sectionId);
                    console.log('Available sections:', Array.from(document.querySelectorAll('.section')).map(s => s.id));
                }
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
            }
        };
        
        // Also make it available as global function (for onclick handlers)
        navigateToSection = window.navigateToSection;
        
        console.log('‚úÖ Final navigation function loaded and ready');
        
        // Duplicate coach chat function removed - using proper implementation
        
        // Initialize platform on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Root Cause Power platform loaded successfully');
            
            // Show home section by default
            setTimeout(() => {
                console.log('üè† Initializing home section...');
                navigateToSection('home');
            }, 100);
            
            // Initialize all live APIs
            initializeLiveAPIs().then(apiStatus => {
                console.log('‚úÖ Platform initialization complete with API status:', apiStatus);
            }).catch(error => {
                console.error('‚ùå Platform initialization error:', error);
            });
        });
        

        
        // Export functions for global access (if they exist)
        if (typeof navigateToSection !== 'undefined') window.navigateToSection = navigateToSection;
        if (typeof startAssessment !== 'undefined') window.startAssessment = startAssessment;
        if (typeof startVoiceConversation !== 'undefined') window.startVoiceConversation = startVoiceConversation;
        if (typeof initializeDashboard !== 'undefined') window.initializeDashboard = initializeDashboard;
        if (typeof initializeLiveAPIs !== 'undefined') window.initializeLiveAPIs = initializeLiveAPIs;
        if (typeof startChatWithCoach !== 'undefined') window.startChatWithCoach = startChatWithCoach;
        
        // Ensure PTSD functions are available globally
        if (typeof start54321Technique !== 'undefined') window.start54321Technique = start54321Technique;
        if (typeof startBoxBreathing !== 'undefined') window.startBoxBreathing = startBoxBreathing;
        if (typeof startPhysicalGrounding !== 'undefined') window.startPhysicalGrounding = startPhysicalGrounding;
        if (typeof showEMDRTools !== 'undefined') window.showEMDRTools = showEMDRTools;
        if (typeof stopGroundingSession !== 'undefined') window.stopGroundingSession = stopGroundingSession;
        if (typeof stopEMDR !== 'undefined') window.stopEMDR = stopEMDR;
        
        // Debug: Check function availability
        console.log('üîç Function availability check:', {
            start54321Technique: typeof window.start54321Technique,
            startBoxBreathing: typeof window.startBoxBreathing,
            startPhysicalGrounding: typeof window.startPhysicalGrounding,
            showEMDRTools: typeof window.showEMDRTools,
            startChatWithCoach: typeof window.startChatWithCoach
        });
    </script>
    
    <!-- EMERGENCY NAVIGATION - GUARANTEED TO WORK -->
    
    <!-- EMERGENCY PTSD FUNCTION INJECTION - GUARANTEED TO WORK -->
    <script>
        console.log('üöë Emergency PTSD function injection starting...');
        
        // Clean PTSD functions that bypass all syntax errors
        window.start54321Technique = function() {
            console.log('üß† 5-4-3-2-1 Technique (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) {
                session.classList.remove('hidden');
            }
            if (title) {
                title.textContent = '5-4-3-2-1 Grounding Technique';
            }
            if (subtitle) {
                subtitle.textContent = 'Use all five senses to anchor yourself in the present moment';
            }
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg"><strong>5 things you can see:</strong> Look around and name them</p>
                        <p class="text-lg"><strong>4 things you can touch:</strong> Feel different textures</p>
                        <p class="text-lg"><strong>3 things you can hear:</strong> Listen to sounds around you</p>
                        <p class="text-lg"><strong>2 things you can smell:</strong> Notice any scents</p>
                        <p class="text-lg"><strong>1 thing you can taste:</strong> What can you taste right now?</p>
                    </div>
                `;
            }
        };
        
        window.startBoxBreathing = function() {
            console.log('ü´Å Box Breathing (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle');
            const content = document.getElementById('grounding-content');
            
            if (session) {
                session.classList.remove('hidden');
            }
            if (title) {
                title.textContent = 'Box Breathing Exercise';
            }
            if (subtitle) {
                subtitle.textContent = 'Regulate your nervous system with rhythmic breathing';
            }
            if (content) {
                content.innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">üì•</div>
                        <div class="text-2xl font-bold mb-4">Breathe In</div>
                        <div class="text-lg">In for 4 ‚Üí Hold for 4 ‚Üí Out for 4 ‚Üí Hold for 4</div>
                        <div class="mt-4 text-slate-400">Focus on the rhythm and let your body relax</div>
                    </div>
                `;
            }
        };
        
        window.startPhysicalGrounding = function() {
            console.log('ü§≤ Physical Grounding (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle');
            const content = document.getElementById('grounding-content');
            
            if (session) {
                session.classList.remove('hidden');
            }
            if (title) {
                title.textContent = 'Physical Grounding Exercise';
            }
            if (subtitle) {
                subtitle.textContent = 'Connect with your body and present moment';
            }
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg">ü¶∂ <strong>Press your feet into the ground</strong> - Feel the solid support</p>
                        <p class="text-lg">‚úã <strong>Touch something near you</strong> - Notice the texture</p>
                        <p class="text-lg">üå°Ô∏è <strong>Notice the temperature</strong> - Feel the air on your skin</p>
                        <p class="text-lg">üí™ <strong>Gently stretch your muscles</strong> - Roll your shoulders</p>
                        <p class="text-lg">ü´Ä <strong>Feel your heartbeat</strong> - Place hand on chest</p>
                    </div>
                `;
            }
        };
        
        window.showEMDRTools = function() {
            console.log('üëÅÔ∏è EMDR Tools (Emergency Version)');
            const session = document.getElementById('emdr-session');
            const dot = document.getElementById('emdr-dot');
            
            if (session) {
                session.classList.remove('hidden');
            }
            
            if (dot) {
                let position = 0;
                let direction = 1;
                const maxPosition = 400;
                
                if (window.emdrInterval) {
                    clearInterval(window.emdrInterval);
                }
                
                window.emdrInterval = setInterval(() => {
                    position += direction * 5;
                    if (position >= maxPosition || position <= 0) {
                        direction *= -1;
                    }
                    dot.style.left = position + 'px';
                }, 50);
            }
        };
        
        window.stopGroundingSession = function() {
            console.log('üõë Stopping grounding session');
            const session = document.getElementById('grounding-session');
            if (session) {
                session.classList.add('hidden');
            }
        };
        
        window.stopEMDR = function() {
            console.log('üõë Stopping EMDR session');
            const session = document.getElementById('emdr-session');
            if (session) {
                session.classList.add('hidden');
            }
            if (window.emdrInterval) {
                clearInterval(window.emdrInterval);
                window.emdrInterval = null;
            }
        };
        
        // Real API-connected coach system
        window.startChatWithCoach = function(coachId) {
            console.log(`üí¨ Starting chat with coach: ${coachId}`);
            
            // Coach David uses speech-to-speech, so redirect to voice system
            if (coachId === 'david') {
                console.log('üéôÔ∏è Coach David uses voice therapy - redirecting to voice system');
                if (typeof window.startVoiceConversation === 'function') {
                    startVoiceConversation();
                } else {
                    console.error('Voice system not available for Coach David');
                }
                return;
            }
            
            // Define text-based coach information
            const coaches = {
                'sarah': {
                    name: 'Coach Sarah',
                    specialty: 'CBT & Mindfulness Specialist',
                    greeting: 'Hello! I\'m Coach Sarah, specializing in Cognitive Behavioral Therapy and mindfulness techniques. I can help you with anxiety management, thought restructuring, and mindfulness practices. How can I support you today?',
                    color: 'from-blue-500 to-cyan-500'
                },
                'marcus': {
                    name: 'Coach Marcus',
                    specialty: 'Addiction Recovery Specialist', 
                    greeting: 'Hi there! I\'m Coach Marcus, and I specialize in addiction recovery and behavioral change. I\'m here to support your journey with evidence-based strategies and compassionate guidance. What\'s on your mind?',
                    color: 'from-green-500 to-emerald-500'
                },
                'elena': {
                    name: 'Coach Elena', 
                    specialty: 'EMDR & Trauma Specialist',
                    greeting: 'Welcome! I\'m Coach Elena, specializing in EMDR therapy and trauma processing. I provide gentle, empathetic support for healing journeys. I can guide you through grounding techniques and trauma-informed care. How are you feeling today?',
                    color: 'from-purple-500 to-pink-500'
                },
                'alex': {
                    name: 'Coach Alex',
                    specialty: 'Mindfulness & Wellness Coach',
                    greeting: 'Hello! I\'m Coach Alex, focusing on mindfulness, wellness, and holistic mental health approaches. I can help you with stress management, wellness planning, and mindful living practices. What brings you here today?',
                    color: 'from-orange-500 to-red-500'
                },
                'maria': {
                    name: 'Coach Maria',
                    specialty: 'Family & Relationship Therapy',
                    greeting: 'Hello! I\'m Coach Maria, specializing in family dynamics and relationship counseling. I help people navigate relationship challenges, improve communication, and build stronger connections. How can I support you today?',
                    color: 'from-pink-500 to-rose-500'
                }
            };
            
            const coach = coaches[coachId];
            if (!coach) {
                console.error('Unknown coach ID:', coachId);
                return;
            }
            
            // Show text chat interface
            showTextChatInterface(coach);
        };
        
        function showTextChatInterface(coach) {
            // Check for assessment context
            const assessmentData = localStorage.getItem('lastAssessmentResults');
            let contextualGreeting = coach.greeting;
            
            if (assessmentData) {
                try {
                    const data = JSON.parse(assessmentData);
                    contextualGreeting = generateContextualGreeting(coach, data);
                } catch (error) {
                    console.error('Error parsing assessment data:', error);
                }
            }
            
            // Create or show chat interface
            let chatInterface = document.getElementById('text-chat-interface');
            
            if (!chatInterface) {
                // Create new chat interface
                const coachesSection = document.getElementById('coaches');
                if (coachesSection) {
                    const chatHTML = `
                        <div id="text-chat-interface" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="bg-slate-800 rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                                <div class="p-6 border-b border-slate-600">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-100">${coach.name}</h3>
                                                <p class="text-sm text-slate-400">${coach.specialty}</p>
                                            </div>
                                        </div>
                                        <button onclick="window.closeTextChat()" class="text-slate-400 hover:text-white">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="text-chat-history" class="flex-1 p-6 overflow-y-auto">
                                    <div class="flex mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${coach.color} flex items-center justify-center">
                                                <i class="fas fa-user text-white text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3 p-3 bg-slate-700 rounded-lg max-w-xs">
                                            <p class="text-sm text-slate-100">${contextualGreeting}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 border-t border-slate-600">
                                    <div class="flex gap-2 items-end">
                                        <input type="text" id="text-chat-input" placeholder="Message..." 
                                               class="flex-1 px-4 py-3 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               onkeypress="window.handleTextChatKeypress(event)">
                                        <button onclick="window.sendTextChatMessage()" class="text-blue-500 hover:text-blue-600 font-medium text-sm px-2">
                                            Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', chatHTML);
                    chatInterface = document.getElementById('text-chat-interface');
                }
            }
            
            // Store current coach for chat
            window.currentChatCoach = coach;
        }
        
        window.closeTextChat = function() {
            const chatInterface = document.getElementById('text-chat-interface');
            if (chatInterface) {
                chatInterface.remove();
            }
        };

        function generateContextualGreeting(coach, assessmentData) {
            // Check if this is a study discussion context
            const studyContext = localStorage.getItem('studyDiscussionContext');
            if (studyContext) {
                try {
                    const context = JSON.parse(studyContext);
                    // Clear the context so it doesn't persist
                    localStorage.removeItem('studyDiscussionContext');
                    
                    const userName = localStorage.getItem('userName') || 'there';
                    return `Hello ${userName}! I'm ${coach.name}, your ${coach.specialty}. I see you're interested in discussing "${context.studyTitle}" from our research library. That's excellent - I love when people dive deep into the science behind health and wellness! I'm here to help you understand how this research applies to your specific situation and how you can implement the findings in your daily life. What aspects of this study are you most curious about?`;
                } catch (error) {
                    console.error('Error parsing study context:', error);
                }
            }
            
            const goals = assessmentData.goals || [];
            const healthScores = assessmentData.healthScores || {};
            
            // Get user's name or use a friendly default
            const userName = localStorage.getItem('userName') || 'there';
            
            // Identify priority areas and goals
            const priorityGoals = goals.filter(goal => goal.priority === 'High');
            const allGoals = goals.length > 0 ? goals : null;
            
            // Get lowest scoring health areas
            const lowScoreAreas = Object.entries(healthScores)
                .filter(([key, value]) => value < 3)
                .map(([key]) => key.replace(/_/g, ' '))
                .slice(0, 2);
            
            // Create personalized greeting based on coach type
            let greeting = `Hello ${userName}! I'm ${coach.name}, your ${coach.specialty}. `;
            
            // Add assessment acknowledgment
            greeting += `I can see you've just completed your health assessment - great job taking that important first step! `;
            
            // Add goal-specific messaging
            if (allGoals && allGoals.length > 0) {
                if (priorityGoals.length > 0) {
                    const goalTitles = priorityGoals.slice(0, 2).map(g => g.title).join(' and ');
                    greeting += `I notice you've set some important goals, especially around: ${goalTitles}. `;
                } else {
                    greeting += `I can see you've thoughtfully set ${allGoals.length} health goals for yourself. `;
                }
                
                greeting += `I'm here to help you create a clear action plan and provide ongoing support. `;
                
                // Add specific goal question
                if (allGoals.length === 1) {
                    greeting += `Would you like to start by discussing your goal: "${allGoals[0].title}"?`;
                } else if (allGoals.length <= 3) {
                    greeting += `Which of your goals would you like to focus on first: ${allGoals.map(g => `"${g.title}"`).join(', ')}?`;
                } else {
                    greeting += `You have several goals to work on. Which one feels most important to start with today?`;
                }
            } else {
                // No specific goals, use assessment data
                if (lowScoreAreas.length > 0) {
                    greeting += `Based on your assessment, I see you'd like some support with ${lowScoreAreas.join(' and ')}. `;
                }
                greeting += `I'm here to help you create personalized strategies that fit your lifestyle. What would you like to work on together?`;
            }
            
            return greeting;
        }

        // ===== ALL 11 NEW PTSD INTERVENTIONS (Emergency Bypass Versions) =====
        
        window.startProgressiveMuscleRelaxation = function() {
            console.log('üí™ Progressive Muscle Relaxation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Progressive Muscle Relaxation';
            if (subtitle) subtitle.textContent = 'Systematic tension and release for deep relaxation';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Tense and Release Each Muscle Group:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Feet & Calves:</strong> Point toes down, hold 5 seconds, then release</p>
                            <p><strong>2. Thighs & Glutes:</strong> Squeeze tight, hold, then release</p>
                            <p><strong>3. Abdomen:</strong> Tighten core muscles, hold, then release</p>
                            <p><strong>4. Hands & Arms:</strong> Make fists, tense arms, hold, then release</p>
                            <p><strong>5. Shoulders & Neck:</strong> Lift shoulders to ears, hold, then drop</p>
                            <p><strong>6. Face:</strong> Scrunch face muscles, hold, then relax</p>
                            <p><strong>7. Whole Body:</strong> Tense everything, hold, then completely relax</p>
                        </div>
                        <p class="text-green-300 mt-4">Hold each tension for 5-7 seconds, then notice the relaxation that follows.</p>
                    </div>
                `;
            }
        };

        window.startMindfulnessMeditation = function() {
            console.log('üßò Mindfulness Meditation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Mindfulness Meditation';
            if (subtitle) subtitle.textContent = 'Present moment awareness and acceptance';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Mindful Presence Practice:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Posture:</strong> Sit comfortably with spine naturally straight</p>
                            <p><strong>2. Breathing:</strong> Notice your natural breath without changing it</p>
                            <p><strong>3. Thoughts:</strong> Acknowledge thoughts like clouds passing through the sky</p>
                            <p><strong>4. Feelings:</strong> Notice emotions without judgment, just observe</p>
                            <p><strong>5. Body:</strong> Expand awareness to include physical sensations</p>
                            <p><strong>6. Present:</strong> Rest in spacious awareness of this moment</p>
                        </div>
                        <p class="text-green-300 mt-4">You are not your thoughts - you are the awareness that notices them.</p>
                    </div>
                `;
            }
        };

        window.startSafePlaceVisualization = function() {
            console.log('üè† Safe Place Visualization (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Safe Place Visualization';
            if (subtitle) subtitle.textContent = 'Create a mental sanctuary for emotional safety';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Build Your Safe Place:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Imagine:</strong> A place where you feel completely safe (real or imaginary)</p>
                            <p><strong>2. See:</strong> Visual details - colors, lighting, objects, surroundings</p>
                            <p><strong>3. Hear:</strong> Peaceful sounds - nature, silence, gentle music</p>
                            <p><strong>4. Feel:</strong> Physical comfort - temperature, textures, position</p>
                            <p><strong>5. Safety:</strong> Allow yourself to feel completely protected here</p>
                            <p><strong>6. Anchor:</strong> Place hand on heart to remember this place</p>
                        </div>
                        <p class="text-green-300 mt-4">Your safe place is always within you. Return here anytime you need peace.</p>
                    </div>
                `;
            }
        };

        window.startCognitiveRestructuring = function() {
            console.log('üß† Cognitive Restructuring (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Cognitive Restructuring';
            if (subtitle) subtitle.textContent = 'Challenge and reframe negative thought patterns';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Reframe Your Thoughts:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Identify:</strong> What negative thought is bothering you?</p>
                            <p><strong>2. Examine:</strong> What evidence supports/contradicts this thought?</p>
                            <p><strong>3. Alternatives:</strong> What are other possible explanations?</p>
                            <p><strong>4. Balance:</strong> Create a more realistic, balanced thought</p>
                            <p><strong>5. Test:</strong> How does the new thought make you feel?</p>
                            <p><strong>6. Practice:</strong> Commit to noticing and reframing when the old pattern arises</p>
                        </div>
                        <p class="text-green-300 mt-4">Changing thought patterns takes practice. Be patient and kind with yourself.</p>
                    </div>
                `;
            }
        };

        window.startBilateralStimulation = function() {
            console.log('üîÑ Bilateral Stimulation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Bilateral Stimulation';
            if (subtitle) subtitle.textContent = 'Left-right brain integration therapy';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Bilateral Brain Stimulation:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Knee Taps:</strong> Alternate tapping left and right knees rhythmically</p>
                            <p><strong>2. Butterfly Hug:</strong> Cross arms over chest, alternate tapping shoulders</p>
                            <p><strong>3. Figure-8 Eyes:</strong> Trace infinity symbol with your eyes</p>
                            <p><strong>4. Alternate Breathing:</strong> Focus on left side inhaling, right side exhaling</p>
                            <p><strong>5. Integration:</strong> Sit quietly and notice any sensations or thoughts</p>
                        </div>
                        <p class="text-green-300 mt-4">Bilateral stimulation helps both sides of your brain process and integrate experiences.</p>
                    </div>
                `;
            }
        };

        window.startResourceInstallation = function() {
            console.log('üíé Resource Installation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Resource Installation';
            if (subtitle) subtitle.textContent = 'Strengthen positive internal resources';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Install Your Strengths:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Identify:</strong> Recall a time when you felt strong and capable</p>
                            <p><strong>2. Enhance:</strong> Make the memory more vivid - see, hear, feel it clearly</p>
                            <p><strong>3. Embody:</strong> Feel that strength in your body right now</p>
                            <p><strong>4. Anchor:</strong> Create a simple gesture while feeling strong</p>
                            <p><strong>5. Strengthen:</strong> Imagine this strength filling every cell</p>
                            <p><strong>6. Access:</strong> Use your anchor gesture anytime you need strength</p>
                        </div>
                        <p class="text-green-300 mt-4">Your resources are installed and always available. You have everything you need within you.</p>
                    </div>
                `;
            }
        };

        window.startContainmentExercise = function() {
            console.log('üì¶ Containment Exercise (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Containment Exercise';
            if (subtitle) subtitle.textContent = 'Safely contain difficult memories and emotions';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Safely Contain Difficult Material:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Identify:</strong> What difficult memory or emotion needs containing?</p>
                            <p><strong>2. Container:</strong> Imagine a strong, secure container (safe, vault, chest)</p>
                            <p><strong>3. Transfer:</strong> Move the difficult material from your mind to the container</p>
                            <p><strong>4. Secure:</strong> Lock the container with key, combination, or seal</p>
                            <p><strong>5. Store:</strong> Place container in a safe, distant location</p>
                            <p><strong>6. Present:</strong> Notice how you feel now - lighter and clearer</p>
                        </div>
                        <p class="text-green-300 mt-4">You can retrieve this material later when ready and with support. For now, it is safely contained.</p>
                    </div>
                `;
            }
        };

        window.startBodyScanRelaxation = function() {
            console.log('üîç Body Scan Relaxation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Body Scan Relaxation';
            if (subtitle) subtitle.textContent = 'Systematic body awareness and tension release';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Scan Through Your Body:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. Feet & Toes:</strong> Notice sensations, send breath and relaxation</p>
                            <p><strong>2. Legs & Knees:</strong> Scan calves, shins, thighs - breathe relaxation in</p>
                            <p><strong>3. Pelvis & Lower Back:</strong> Notice this area, let it soften and release</p>
                            <p><strong>4. Abdomen & Chest:</strong> Feel your natural breathing, let ribs expand</p>
                            <p><strong>5. Arms & Hands:</strong> Scan shoulders to fingertips, let arms be heavy</p>
                            <p><strong>6. Neck & Head:</strong> Release jaw, soften eyes, relax forehead</p>
                            <p><strong>7. Whole Body:</strong> Sense your entire body as one unified, peaceful whole</p>
                        </div>
                        <p class="text-green-300 mt-4">Your body knows how to relax and heal. You are completely present in your peaceful body.</p>
                    </div>
                `;
            }
        };

        window.startEFTTapping = function() {
            console.log('üëÜ EFT Tapping (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'EFT Tapping';
            if (subtitle) subtitle.textContent = 'Emotional Freedom Technique for trauma release';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Tapping Sequence:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>Setup:</strong> Tap side of hand while saying "Even though I have this problem, I deeply accept myself" (3x)</p>
                            <p><strong>Points to Tap:</strong> While acknowledging the issue:</p>
                            <p>‚Ä¢ <strong>Top of Head</strong> - Crown area</p>
                            <p>‚Ä¢ <strong>Eyebrow</strong> - Inner edge of eyebrow</p>
                            <p>‚Ä¢ <strong>Side of Eye</strong> - Outer edge of eye socket</p>
                            <p>‚Ä¢ <strong>Under Eye</strong> - On the bone under eye</p>
                            <p>‚Ä¢ <strong>Under Nose</strong> - Between nose and upper lip</p>
                            <p>‚Ä¢ <strong>Chin</strong> - Crease under lower lip</p>
                            <p>‚Ä¢ <strong>Collarbone</strong> - Just below collarbone</p>
                            <p>‚Ä¢ <strong>Under Arm</strong> - 4 inches below armpit</p>
                        </div>
                        <p class="text-green-300 mt-4">Take a deep breath and check intensity. Repeat if needed until you feel relief.</p>
                    </div>
                `;
            }
        };

        window.startLovingKindnessMeditation = function() {
            console.log('üíù Loving-Kindness Meditation (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Loving-Kindness Meditation';
            if (subtitle) subtitle.textContent = 'Cultivate compassion and self-acceptance';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Send Loving Wishes:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>1. For Yourself:</strong> "May I be happy, healthy, safe, and at peace"</p>
                            <p><strong>2. For a Loved One:</strong> "May you be happy, healthy, safe, and at peace"</p>
                            <p><strong>3. For a Neutral Person:</strong> "May you be happy, healthy, safe, and at peace"</p>
                            <p><strong>4. For a Difficult Person:</strong> "May you be happy, healthy, safe, and at peace"</p>
                            <p><strong>5. For All Beings:</strong> "May all beings be happy, healthy, safe, and at peace"</p>
                            <p><strong>6. Return to Self:</strong> "May I be happy, healthy, safe, and at peace"</p>
                        </div>
                        <p class="text-green-300 mt-4">You are worthy of love and kindness. This practice frees your heart from resentment.</p>
                    </div>
                `;
            }
        };

        window.startTraumaInformedYoga = function() {
            console.log('üßò‚Äç‚ôÄÔ∏è Trauma-Informed Yoga (Emergency Version)');
            const session = document.getElementById('grounding-session');
            const title = document.getElementById('grounding-title');
            const subtitle = document.getElementById('grounding-subtitle'); 
            const content = document.getElementById('grounding-content');
            
            if (session) session.classList.remove('hidden');
            if (title) title.textContent = 'Trauma-Informed Yoga';
            if (subtitle) subtitle.textContent = 'Gentle yoga poses for trauma recovery';
            if (content) {
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-lg font-semibold text-blue-300">Gentle Trauma-Informed Movement:</p>
                        <div class="space-y-3 text-left">
                            <p><strong>Remember:</strong> You have complete choice. Stop anytime, modify anything.</p>
                            <p><strong>1. Mountain Pose:</strong> Stand grounded, feel connection to earth</p>
                            <p><strong>2. Shoulder Rolls:</strong> Release tension gently in both directions</p>
                            <p><strong>3. Gentle Neck Movements:</strong> Turn side to side, nod yes and no</p>
                            <p><strong>4. Heart Opening:</strong> Open arms wide only as much as feels safe</p>
                            <p><strong>5. Gentle Twist:</strong> Turn torso slowly left and right</p>
                            <p><strong>6. Rest Position:</strong> Fold forward gently or rest as needed</p>
                            <p><strong>7. Gratitude:</strong> Thank your body for its wisdom and resilience</p>
                        </div>
                        <p class="text-green-300 mt-4">Listen to your body. Move slowly. You are in complete control of every movement.</p>
                    </div>
                `;
            }
        };

        // Emergency stop function
        window.stopGroundingSession = function() {
            console.log('üõë Stopping grounding session (Emergency Version)');
            const session = document.getElementById('grounding-session');
            if (session) {
                session.classList.add('hidden');
            }
        };

        // ===== DIARY/JOURNAL FUNCTIONS =====
        
        let journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
        
        window.showNewEntryForm = function() {
            console.log('üìù Opening new journal entry form');
            document.getElementById('new-entry-form').classList.remove('hidden');
            document.getElementById('journal-prompts').classList.add('hidden');
            document.getElementById('journal-entries-view').classList.add('hidden');
            
            // Set today's date by default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entry-date').value = today;
        };
        
        window.showJournalPrompts = function() {
            console.log('üí° Showing journal prompts');
            document.getElementById('journal-prompts').classList.remove('hidden');
            document.getElementById('new-entry-form').classList.add('hidden');
            document.getElementById('journal-entries-view').classList.add('hidden');
        };
        
        window.hideJournalPrompts = function() {
            document.getElementById('journal-prompts').classList.add('hidden');
        };
        
        window.usePrompt = function(promptText) {
            console.log('üñäÔ∏è Using prompt:', promptText);
            // Clean up the prompt text (remove bullet point)
            const cleanPrompt = promptText.replace('‚Ä¢ ', '');
            
            // Show new entry form and populate with prompt
            showNewEntryForm();
            document.getElementById('entry-content').value = cleanPrompt + '\n\n';
            document.getElementById('entry-content').focus();
            
            // Hide prompts
            hideJournalPrompts();
        };
        
        window.saveJournalEntry = function(event) {
            event.preventDefault();
            console.log('üíæ Saving journal entry');
            
            const date = document.getElementById('entry-date').value;
            const mood = document.getElementById('entry-mood').value;
            const title = document.getElementById('entry-title').value || 'Journal Entry';
            const content = document.getElementById('entry-content').value;
            const gratitude = document.getElementById('entry-gratitude').value;
            const tags = document.getElementById('entry-tags').value;
            
            if (!date || !content) {
                alert('Please fill in the date and content fields.');
                return;
            }
            
            const entry = {
                id: Date.now().toString(),
                date: date,
                mood: parseInt(mood) || null,
                title: title,
                content: content,
                gratitude: gratitude,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: new Date().toISOString(),
                wordCount: content.split(' ').length
            };
            
            journalEntries.unshift(entry);
            localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
            
            // Reset form
            document.getElementById('new-entry-form').classList.add('hidden');
            document.querySelector('#new-entry-form form').reset();
            
            // Update stats
            updateJournalStats();
            
            alert('‚úÖ Journal entry saved successfully!');
        };
        
        window.cancelNewEntry = function() {
            document.getElementById('new-entry-form').classList.add('hidden');
            document.querySelector('#new-entry-form form').reset();
        };
        
        window.viewJournalEntries = function() {
            console.log('üìñ Viewing journal entries');
            document.getElementById('journal-entries-view').classList.remove('hidden');
            document.getElementById('new-entry-form').classList.add('hidden');
            document.getElementById('journal-prompts').classList.add('hidden');
            displayJournalEntries();
        };
        
        window.hideJournalEntries = function() {
            document.getElementById('journal-entries-view').classList.add('hidden');
        };
        
        window.displayJournalEntries = function(filter = '') {
            const container = document.getElementById('entries-container');
            let entries = [...journalEntries];
            
            // Apply search filter
            if (filter) {
                entries = entries.filter(entry => 
                    entry.title.toLowerCase().includes(filter.toLowerCase()) ||
                    entry.content.toLowerCase().includes(filter.toLowerCase()) ||
                    entry.tags.some(tag => tag.toLowerCase().includes(filter.toLowerCase()))
                );
            }
            
            if (entries.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-8">No journal entries found. Start writing your first entry!</p>';
                return;
            }
            
            container.innerHTML = entries.map(entry => `
                <div class="bg-slate-700/50 rounded-lg p-6 border border-slate-600">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-100">${entry.title}</h3>
                            <p class="text-slate-400 text-sm">${new Date(entry.date).toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${entry.mood ? `<span class="bg-blue-500 text-white px-2 py-1 rounded text-sm">Mood: ${entry.mood}/10</span>` : ''}
                            <button onclick="deleteJournalEntry('${entry.id}')" class="text-red-400 hover:text-red-300 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-slate-200 mb-4 whitespace-pre-wrap">${entry.content}</div>
                    ${entry.gratitude ? `<div class="bg-green-900/30 border-l-4 border-green-500 p-3 mb-4">
                        <p class="text-green-300 font-medium mb-1">Gratitude:</p>
                        <p class="text-green-200 whitespace-pre-wrap">${entry.gratitude}</p>
                    </div>` : ''}
                    <div class="flex justify-between items-center text-sm text-slate-400">
                        <div>
                            ${entry.tags.length > 0 ? `<span>Tags: ${entry.tags.map(tag => `<span class="bg-slate-600 px-2 py-1 rounded">${tag}</span>`).join(' ')}</span>` : ''}
                        </div>
                        <div>${entry.wordCount} words</div>
                    </div>
                </div>
            `).join('');
        };
        
        window.deleteJournalEntry = function(entryId) {
            if (confirm('Are you sure you want to delete this journal entry?')) {
                journalEntries = journalEntries.filter(entry => entry.id !== entryId);
                localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
                displayJournalEntries();
                updateJournalStats();
            }
        };
        
        window.exportJournal = function() {
            console.log('üì§ Exporting journal');
            if (journalEntries.length === 0) {
                alert('No journal entries to export.');
                return;
            }
            
            const exportData = journalEntries.map(entry => 
                `Date: ${entry.date}\nTitle: ${entry.title}\nMood: ${entry.mood || 'Not specified'}\n\n${entry.content}\n\nGratitude:\n${entry.gratitude || 'None specified'}\n\nTags: ${entry.tags.join(', ')}\n\n${'='.repeat(50)}\n\n`
            ).join('');
            
            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `journal-export-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        window.updateJournalStats = function() {
            const totalEl = document.getElementById('total-entries');
            const streakEl = document.getElementById('current-streak');
            const avgMoodEl = document.getElementById('avg-mood');
            
            if (totalEl) totalEl.textContent = journalEntries.length;
            
            // Calculate streak
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < journalEntries.length; i++) {
                const entryDate = new Date(journalEntries[i].date);
                entryDate.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === i) {
                    streak++;
                } else {
                    break;
                }
            }
            
            if (streakEl) streakEl.textContent = streak;
            
            // Calculate average mood
            const moodEntries = journalEntries.filter(entry => entry.mood);
            if (moodEntries.length > 0) {
                const avgMood = (moodEntries.reduce((sum, entry) => sum + entry.mood, 0) / moodEntries.length).toFixed(1);
                if (avgMoodEl) avgMoodEl.textContent = avgMood;
            }
        };

        // ===== BOOKING SYSTEM FUNCTIONS =====
        
        let bookings = JSON.parse(localStorage.getItem('sessionBookings') || '[]');
        let selectedCoach = '';
        
        window.selectCoach = function(coachId) {
            console.log('üë®‚Äç‚öïÔ∏è Selecting coach:', coachId);
            selectedCoach = coachId;
            
            // Update UI to show selection
            document.querySelectorAll('.coach-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
            event.target.closest('.coach-card').classList.add('ring-2', 'ring-blue-500');
            
            // Show booking form
            document.getElementById('booking-form').classList.remove('hidden');
            
            // Populate coach name
            const coachNames = {
                'david': 'Coach David (Voice Therapy)',
                'elena': 'Coach Elena (Trauma Recovery)',
                'sarah': 'Coach Sarah (Anxiety & Stress)'
            };
            
            document.getElementById('selected-coach').value = coachNames[coachId] || coachId;
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('session-date').min = today;
            document.getElementById('session-date').value = today;
        };
        
        window.bookSession = function(event) {
            event.preventDefault();
            console.log('üìÖ Booking session');
            
            const coach = document.getElementById('selected-coach').value;
            const sessionType = document.getElementById('session-type').value;
            const date = document.getElementById('session-date').value;
            const time = document.getElementById('session-time').value;
            const goals = document.getElementById('session-goals').value;
            const concerns = document.getElementById('current-concerns').value;
            
            if (!coach || !sessionType || !date || !time) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const booking = {
                id: Date.now().toString(),
                coach: coach,
                coachId: selectedCoach,
                sessionType: sessionType,
                date: date,
                time: time,
                goals: goals,
                concerns: concerns,
                status: 'confirmed',
                createdAt: new Date().toISOString()
            };
            
            bookings.push(booking);
            localStorage.setItem('sessionBookings', JSON.stringify(bookings));
            
            // Reset form
            document.getElementById('booking-form').classList.add('hidden');
            document.querySelector('#booking-form form').reset();
            selectedCoach = '';
            document.querySelectorAll('.coach-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
            
            // Update upcoming sessions
            displayUpcomingSessions();
            
            alert('‚úÖ Session booked successfully! You will receive a confirmation shortly.');
        };
        
        window.cancelBooking = function() {
            document.getElementById('booking-form').classList.add('hidden');
            document.querySelector('#booking-form form').reset();
            selectedCoach = '';
            document.querySelectorAll('.coach-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
        };
        
        window.displayUpcomingSessions = function() {
            const container = document.getElementById('upcoming-sessions');
            
            // Filter future bookings
            const today = new Date();
            const upcomingSessions = bookings.filter(booking => {
                const sessionDate = new Date(booking.date + 'T' + booking.time);
                return sessionDate >= today;
            }).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            
            if (upcomingSessions.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center py-8">No upcoming sessions. Book your first session above!</p>';
                return;
            }
            
            container.innerHTML = upcomingSessions.map(booking => {
                const sessionDate = new Date(booking.date + 'T' + booking.time);
                const formattedDate = sessionDate.toLocaleDateString();
                const formattedTime = sessionDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="bg-slate-700/50 rounded-lg p-6 border border-slate-600 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-100">${booking.coach}</h3>
                            <p class="text-slate-300">${booking.sessionType}</p>
                            <p class="text-slate-400 text-sm">${formattedDate} at ${formattedTime}</p>
                            ${booking.goals ? `<p class="text-slate-400 text-sm mt-1">Focus: ${booking.goals}</p>` : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="joinSession('${booking.id}')" class="btn-primary">
                                <i class="fas fa-video mr-2"></i>Join
                            </button>
                            <button onclick="cancelSession('${booking.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        window.joinSession = function(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (booking) {
                alert(`üéØ Joining session with ${booking.coach}!\n\nThis would normally launch the therapeutic session interface. For now, this redirects to the coaches section.`);
                
                // Redirect based on coach
                if (booking.coachId === 'david') {
                    // Launch voice therapy
                    if (typeof window.launchCoachDavidWidget === 'function') {
                        window.launchCoachDavidWidget();
                    } else {
                        navigateToSection('coaches');
                    }
                } else {
                    // Launch chat with other coaches
                    navigateToSection('coaches');
                    setTimeout(() => {
                        if (typeof window.startChatWithCoach === 'function') {
                            window.startChatWithCoach(booking.coachId);
                        }
                    }, 1000);
                }
            }
        };
        
        window.cancelSession = function(bookingId) {
            if (confirm('Are you sure you want to cancel this session?')) {
                bookings = bookings.filter(booking => booking.id !== bookingId);
                localStorage.setItem('sessionBookings', JSON.stringify(bookings));
                displayUpcomingSessions();
            }
        };

        // ===== ASSESSMENT EXIT FUNCTION =====
        
        window.exitAssessment = function() {
            console.log('üö™ Exiting assessment');
            if (confirm('Are you sure you want to exit the assessment? Your progress will be lost.')) {
                // Clear any assessment data
                if (typeof window.currentAssessment !== 'undefined') {
                    window.currentAssessment = null;
                }
                
                // Reset progress bar
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) progressBar.style.width = '12.5%';
                
                const progressText = document.getElementById('progress-text');
                if (progressText) progressText.textContent = 'Question 1 of 8';
                
                // Navigate back to home
                navigateToSection('home');
            }
        };

        // ===== STRIPE PAYMENT FUNCTIONS =====
        
        window.startFreeTrial = function() {
            console.log('üÜì Starting free trial');
            alert('üéâ Welcome to Root Cause Power!\n\nYour free trial has been activated. You now have access to:\n\n‚Ä¢ 1 Assessment per month\n‚Ä¢ 1 Coach session\n‚Ä¢ Basic platform features\n\nNo credit card required. Upgrade anytime to unlock premium features!');
            
            // Set free trial in localStorage
            localStorage.setItem('userPlan', JSON.stringify({
                plan: 'free',
                credits: 5,
                startDate: new Date().toISOString(),
                status: 'active'
            }));
            
            // Navigate to assessment or coaches
            navigateToSection('assessment');
        };
        
        window.showCreditPurchase = function(packageType, credits, amount) {
            console.log(`üí≥ Showing credit purchase: ${packageType}`, { credits, amount });
            
            const packageNames = {
                'starter': 'Professional Starter',
                'professional': 'Professional Pack', 
                'enterprise': 'Enterprise Pack'
            };
            
            const packageName = packageNames[packageType] || packageType;
            const pricePerCredit = (amount / credits).toFixed(3);
            
            // Use existing buyCredits function if available, otherwise use direct checkout
            if (typeof window.buyCredits === 'function') {
                buyCredits(credits, amount);
            } else {
                // Fallback to direct Stripe checkout
                if (confirm(`üíé Purchase ${credits} Credits?\n\nPackage: ${packageName}\nTotal: ¬£${amount}\nPrice per credit: ¬£${pricePerCredit}\n\nProceed to checkout?`)) {
                    // Use variable price ID for credit packages
                    const VARIABLE_PRICE_ID = 'price_1S5lj2C5Ez9YOIaylK1qkQ8m';
                    directStripeCheckout(VARIABLE_PRICE_ID, 'payment', `${packageName} - ${credits} Credits for ¬£${amount}`, credits, amount);
                }
            }
        };

        // ===== ENTERPRISE CALCULATOR FUNCTIONS =====
        
        window.showEnterpriseCalculator = function(planType, basePrice, maxUsers) {
            console.log(`üè¢ Opening enterprise calculator: ${planType}`, { basePrice, maxUsers });
            
            // Create calculator modal
            const modal = document.createElement('div');
            modal.id = 'enterprise-calculator-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75';
            
            const planNames = {
                'basic': 'Enterprise Basic',
                'premium': 'Enterprise Premium', 
                'elite': 'Enterprise Elite'
            };
            
            const planFeatures = {
                'basic': ['Admin dashboard', 'Usage analytics', 'API access', 'Basic integrations', 'Email support'],
                'premium': ['Everything in Basic', 'White-label options', 'Advanced analytics', 'Priority support', 'Custom integrations'],
                'elite': ['Everything in Premium', 'Dedicated support team', 'Advanced employee management', '99.9% SLA guarantees', 'Custom reporting & insights']
            };
            
            const stripeLinks = {
                'basic': 'https://buy.stripe.com/6oUbJ0gQ35Yhd6N7WY0VO04',
                'premium': 'https://buy.stripe.com/fZu6oG1V94UdfeVgtu0VO05', 
                'elite': 'https://buy.stripe.com/14AbJ09nBdqJ2s9dhi0VO06'
            };
            
            const planName = planNames[planType] || planType;
            const features = planFeatures[planType] || [];
            const stripeLink = stripeLinks[planType];
            
            modal.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-8 max-w-2xl mx-4 w-full border border-slate-600 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-100">${planName} Calculator</h2>
                        <button onclick="closeEnterpriseCalculator()" class="text-slate-400 hover:text-white text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Calculator Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-slate-200 mb-4">üìä Calculate Your Cost</h3>
                            
                            <div class="mb-6">
                                <label class="block text-slate-300 font-medium mb-2">Number of Employees</label>
                                <div class="flex items-center space-x-2">
                                    <button onclick="adjustEmployeeCount(-1)" class="bg-slate-600 hover:bg-slate-700 text-white w-10 h-10 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" id="employee-count" value="1" min="1" max="${maxUsers}" 
                                           class="flex-1 bg-slate-600 border border-slate-500 rounded-lg px-4 py-3 text-slate-100 text-center focus:border-blue-500 focus:outline-none"
                                           onchange="updateEnterprisePrice()" oninput="updateEnterprisePrice()">
                                    <button onclick="adjustEmployeeCount(1)" class="bg-slate-600 hover:bg-slate-700 text-white w-10 h-10 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <p class="text-sm text-slate-400 mt-1">Base price: ¬£${basePrice}/employee/month</p>
                            </div>
                            
                            <div class="bg-slate-700/50 rounded-lg p-6 mb-6">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-blue-400 mb-2" id="total-monthly-cost">¬£${basePrice}</div>
                                    <div class="text-slate-300">Total Monthly Cost</div>
                                    <div class="text-sm text-slate-400 mt-2" id="cost-breakdown">¬£${basePrice} √ó 1 employee</div>
                                </div>
                            </div>
                            
                            <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-4 mb-6">
                                <h4 class="text-green-300 font-semibold mb-2">üí∞ Annual Savings</h4>
                                <p class="text-green-200 text-sm">Save 2 months when you pay annually!</p>
                                <div class="text-lg font-bold text-green-400" id="annual-savings">Save ¬£${Math.round(basePrice * 2)}/year</div>
                            </div>
                            
                            <div class="bg-orange-900/30 border border-orange-500/30 rounded-lg p-4 mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-orange-400 mr-3 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <h4 class="text-orange-300 font-semibold mb-1">üìã Payment Instructions</h4>
                                        <p class="text-orange-200 text-sm">
                                            On the Stripe payment page, please <strong>manually enter ¬£<span id="checkout-amount">${basePrice}</span></strong> 
                                            in the amount field to complete your purchase.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="proceedToEnterpriseCheckout('${planType}', '${stripeLink}')" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors">
                                <i class="fas fa-credit-card mr-2"></i>Buy Now - Secure Checkout
                            </button>
                        </div>
                        
                        <!-- Plan Features -->
                        <div>
                            <h3 class="text-lg font-semibold text-slate-200 mb-4">‚ú® Plan Features</h3>
                            <ul class="space-y-3">
                                ${features.map(feature => `
                                    <li class="flex items-start">
                                        <i class="fas fa-check text-green-400 mr-3 mt-1 flex-shrink-0"></i>
                                        <span class="text-slate-300">${feature}</span>
                                    </li>
                                `).join('')}
                            </ul>
                            
                            <div class="mt-6 p-4 bg-blue-900/30 border border-blue-500/30 rounded-lg">
                                <h4 class="text-blue-300 font-semibold mb-2">üöÄ What You Get</h4>
                                <ul class="text-sm text-blue-200 space-y-1">
                                    <li>‚Ä¢ Instant access after payment</li>
                                    <li>‚Ä¢ 30-day money-back guarantee</li>
                                    <li>‚Ä¢ Free onboarding & training</li>
                                    <li>‚Ä¢ 24/7 technical support</li>
                                    <li>‚Ä¢ Monthly usage reports</li>
                                </ul>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <p class="text-sm text-slate-400 mb-2">Need help choosing?</p>
                                <button onclick="requestEnterpriseDemo()" class="text-blue-400 hover:text-blue-300 text-sm underline">
                                    Schedule a Demo Call
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store current plan data
            window.currentEnterprisePlan = {
                type: planType,
                basePrice: basePrice,
                maxUsers: maxUsers,
                stripeLink: stripeLink
            };
            
            // Update initial price
            updateEnterprisePrice();
        };
        
        window.closeEnterpriseCalculator = function() {
            const modal = document.getElementById('enterprise-calculator-modal');
            if (modal) {
                modal.remove();
            }
            window.currentEnterprisePlan = null;
        };
        
        window.adjustEmployeeCount = function(change) {
            const input = document.getElementById('employee-count');
            if (input) {
                const currentValue = parseInt(input.value) || 1;
                const newValue = Math.max(1, Math.min(window.currentEnterprisePlan.maxUsers, currentValue + change));
                input.value = newValue;
                updateEnterprisePrice();
            }
        };
        
        window.updateEnterprisePrice = function() {
            if (!window.currentEnterprisePlan) return;
            
            const employeeCount = parseInt(document.getElementById('employee-count')?.value) || 1;
            const basePrice = window.currentEnterprisePlan.basePrice;
            const monthlyTotal = basePrice * employeeCount;
            const annualSavings = Math.round(monthlyTotal * 2); // 2 months free annually
            
            // Update display
            const totalCostEl = document.getElementById('total-monthly-cost');
            const breakdownEl = document.getElementById('cost-breakdown');
            const savingsEl = document.getElementById('annual-savings');
            const checkoutAmountEl = document.getElementById('checkout-amount');
            
            if (totalCostEl) totalCostEl.textContent = `¬£${monthlyTotal}`;
            if (breakdownEl) breakdownEl.textContent = `¬£${basePrice} √ó ${employeeCount} employee${employeeCount > 1 ? 's' : ''}`;
            if (savingsEl) savingsEl.textContent = `Save ¬£${annualSavings}/year`;
            if (checkoutAmountEl) checkoutAmountEl.textContent = `${monthlyTotal}`;
        };
        
        window.proceedToEnterpriseCheckout = function(planType, stripeLink) {
            const employeeCount = parseInt(document.getElementById('employee-count')?.value) || 1;
            const monthlyTotal = window.currentEnterprisePlan.basePrice * employeeCount;
            
            console.log(`üè¢ Proceeding to enterprise checkout:`, { planType, employeeCount, monthlyTotal });
            
            // Confirm purchase with detailed instructions
            const confirmMessage = `üè¢ Confirm Enterprise Purchase\n\nPlan: ${window.currentEnterprisePlan.type.toUpperCase()}\nEmployees: ${employeeCount}\nMonthly Cost: ¬£${monthlyTotal}\n\nüìã IMPORTANT: On the Stripe payment page, please enter ¬£${monthlyTotal} in the amount field.\n\nProceed to secure checkout?`;
            
            if (confirm(confirmMessage)) {
                // Close calculator
                closeEnterpriseCalculator();
                
                // Open embedded payment instead of new tab
                openEmbeddedStripeCheckout(stripeLink, planType, employeeCount, monthlyTotal);
            }
        };
        
        window.openEmbeddedStripeCheckout = function(stripeLink, planType, employeeCount, monthlyTotal) {
            console.log('üí≥ Opening Stripe checkout - detecting best method:', stripeLink);
            
            // Create modal that will attempt embedding first, then fallback
            const paymentModal = document.createElement('div');
            paymentModal.id = 'embedded-payment-modal';
            paymentModal.className = 'fixed inset-0 z-50 bg-black bg-opacity-90';
            
            paymentModal.innerHTML = `
                <div class="min-h-screen flex flex-col">
                    <!-- Header -->
                    <div class="bg-slate-800 border-b border-slate-600 p-4">
                        <div class="max-w-6xl mx-auto flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-credit-card text-white text-sm"></i>
                                </div>
                                <div>
                                    <h2 class="text-lg font-bold text-slate-100">Secure Checkout - Root Cause Power</h2>
                                    <p class="text-sm text-slate-400">${planType} ‚Ä¢ ${employeeCount} Employee${employeeCount > 1 ? 's' : ''} ‚Ä¢ ¬£${monthlyTotal}/month</p>
                                </div>
                            </div>
                            <button onclick="closeEmbeddedPayment()" class="text-slate-400 hover:text-white text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Payment Instructions -->
                    <div class="bg-gradient-to-r from-orange-600/20 to-red-600/20 border-b border-orange-500/30 p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-orange-400 mr-3 text-xl"></i>
                                <div>
                                    <p class="text-orange-100 font-semibold">üí° Payment Instruction</p>
                                    <p class="text-orange-200 text-sm">Please enter <strong>¬£${monthlyTotal}</strong> in the amount field on the Stripe payment form</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detection State -->
                    <div id="payment-detection" class="flex-1 flex items-center justify-center bg-slate-900">
                        <div class="text-center">
                            <div class="animate-pulse w-12 h-12 bg-blue-400 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <i class="fas fa-search text-white"></i>
                            </div>
                            <p class="text-slate-300 mb-4">Connecting to secure payment system...</p>
                            <div class="text-sm text-slate-400">
                                <p>Detecting best payment method for your browser</p>
                                <p class="mt-2">This will only take a moment</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Embedded Method -->
                    <div id="payment-embedded" class="flex-1 hidden">
                        <iframe id="stripe-checkout-frame" 
                                src="" 
                                class="w-full h-full border-0"
                                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-popups-to-escape-sandbox">
                        </iframe>
                    </div>
                    
                    <!-- Redirect Method -->
                    <div id="payment-redirect" class="flex-1 flex items-center justify-center bg-slate-900 hidden">
                        <div class="text-center max-w-md">
                            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-shield-alt text-white text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-100 mb-2">Secure Payment Ready</h3>
                            <p class="text-slate-300 mb-4">For maximum security, we'll open Stripe's secure checkout in a new window.</p>
                            <p class="text-slate-400 text-sm mb-6">Remember to enter <strong>¬£${monthlyTotal}</strong> in the amount field.</p>
                            
                            <div class="space-y-3">
                                <button onclick="proceedToSecureCheckout('${stripeLink}')" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-lg transition-colors text-lg font-semibold">
                                    <i class="fas fa-lock mr-2"></i>Open Secure Checkout
                                </button>
                                <button onclick="closeEmbeddedPayment()" class="w-full bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </button>
                            </div>
                            
                            <div class="mt-4 text-xs text-slate-500">
                                <p>üîí This opens Stripe's official secure payment page</p>
                                <p>‚úÖ Your payment information is never stored on our servers</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-slate-800 border-t border-slate-600 p-4">
                        <div class="max-w-6xl mx-auto flex items-center justify-between text-sm text-slate-400">
                            <div class="flex items-center space-x-4">
                                <span>üîí Secured by Stripe</span>
                                <span>‚Ä¢</span>
                                <span>SSL Encrypted</span>
                                <span>‚Ä¢</span>
                                <span>PCI Compliant</span>
                            </div>
                            <button onclick="closeEmbeddedPayment()" class="text-slate-400 hover:text-white">
                                Return to Platform
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(paymentModal);
            
            // Disable body scroll
            document.body.style.overflow = 'hidden';
            
            // Attempt to detect if embedding is possible
            detectStripeEmbedSupport(stripeLink);
        };
        
        window.detectStripeEmbedSupport = function(stripeLink) {
            console.log('üîç Detecting Stripe embed support...');
            
            // Create a hidden test iframe to check if embedding is blocked
            const testFrame = document.createElement('iframe');
            testFrame.style.display = 'none';
            testFrame.style.position = 'absolute';
            testFrame.style.width = '1px';
            testFrame.style.height = '1px';
            testFrame.src = stripeLink;
            
            let embedSupported = false;
            
            testFrame.onload = function() {
                try {
                    // Try to access the iframe content to see if it loaded properly
                    const doc = testFrame.contentDocument || testFrame.contentWindow.document;
                    if (doc) {
                        console.log('‚úÖ Embed test successful - using embedded method');
                        embedSupported = true;
                        useEmbeddedMethod(stripeLink);
                    }
                } catch (e) {
                    console.log('‚ùå Embed blocked by X-Frame-Options - using redirect method');
                    useRedirectMethod();
                }
                
                // Clean up test frame
                if (testFrame.parentNode) {
                    testFrame.parentNode.removeChild(testFrame);
                }
            };
            
            testFrame.onerror = function() {
                console.log('‚ùå Embed test failed - using redirect method');
                useRedirectMethod();
                
                // Clean up test frame
                if (testFrame.parentNode) {
                    testFrame.parentNode.removeChild(testFrame);
                }
            };
            
            document.body.appendChild(testFrame);
            
            // Fallback timeout - if test doesn't complete in 3 seconds, use redirect
            setTimeout(() => {
                if (!embedSupported) {
                    console.log('‚è∞ Embed test timeout - defaulting to redirect method');
                    useRedirectMethod();
                    
                    // Clean up test frame
                    if (testFrame.parentNode) {
                        testFrame.parentNode.removeChild(testFrame);
                    }
                }
            }, 3000);
        };
        
        window.useEmbeddedMethod = function(stripeLink) {
            const detection = document.getElementById('payment-detection');
            const embedded = document.getElementById('payment-embedded');
            const iframe = document.getElementById('stripe-checkout-frame');
            
            if (detection) detection.classList.add('hidden');
            if (embedded) embedded.classList.remove('hidden');
            if (iframe) iframe.src = stripeLink;
        };
        
        window.useRedirectMethod = function() {
            const detection = document.getElementById('payment-detection');
            const redirect = document.getElementById('payment-redirect');
            
            if (detection) detection.classList.add('hidden');
            if (redirect) redirect.classList.remove('hidden');
        };
        
        window.proceedToSecureCheckout = function(stripeLink) {
            console.log('üîê Opening Stripe secure checkout in new window');
            
            // Close the modal
            closeEmbeddedPayment();
            
            // Open Stripe in new window
            const newWindow = window.open(stripeLink, '_blank', 'width=800,height=900,scrollbars=yes,resizable=yes');
            
            if (!newWindow) {
                alert('Please allow popups for this site to complete your secure payment, then click the payment button again.');
            }
        };
        

        
        window.closeEmbeddedPayment = function() {
            console.log('üö™ Closing payment modal');
            
            const modal = document.getElementById('embedded-payment-modal');
            if (modal) {
                modal.remove();
            }
            
            // Re-enable body scroll
            document.body.style.overflow = '';
        };
        
        window.requestEnterpriseDemo = function() {
            alert('üìû Demo Request\n\nThank you for your interest! Our enterprise team will contact you within 24 hours to schedule a personalized demo.\n\nIn the meantime, feel free to explore our platform with a free trial.');
        };

        // Make Stripe functions globally accessible  
        window.directStripeCheckout = window.directStripeCheckout || function(priceId, mode, planName, credits, amount) {
            console.log('üîÑ Stripe checkout redirect:', { priceId, mode, planName, credits, amount });
            alert(`üöÄ Redirecting to Stripe Checkout\n\nPlan: ${planName}\nPrice ID: ${priceId}\nMode: ${mode}\n\nThis will open Stripe's secure payment page.`);
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateJournalStats();
            displayUpcomingSessions();
        });

        // Add search functionality
        document.addEventListener('input', function(event) {
            if (event.target.id === 'search-entries') {
                displayJournalEntries(event.target.value);
            }
        });
        
        console.log('‚úÖ Emergency PTSD functions loaded successfully!');
        console.log('üîç Available functions:', {
            start54321Technique: typeof window.start54321Technique,
            startBoxBreathing: typeof window.startBoxBreathing, 
            startPhysicalGrounding: typeof window.startPhysicalGrounding,
            showEMDRTools: typeof window.showEMDRTools,
            startProgressiveMuscleRelaxation: typeof window.startProgressiveMuscleRelaxation,
            startMindfulnessMeditation: typeof window.startMindfulnessMeditation,
            startSafePlaceVisualization: typeof window.startSafePlaceVisualization,
            startCognitiveRestructuring: typeof window.startCognitiveRestructuring,
            startBilateralStimulation: typeof window.startBilateralStimulation,
            startResourceInstallation: typeof window.startResourceInstallation,
            startContainmentExercise: typeof window.startContainmentExercise,
            startBodyScanRelaxation: typeof window.startBodyScanRelaxation,
            startEFTTapping: typeof window.startEFTTapping,
            startLovingKindnessMeditation: typeof window.startLovingKindnessMeditation,
            startTraumaInformedYoga: typeof window.startTraumaInformedYoga,
            startChatWithCoach: typeof window.startChatWithCoach,
            showNewEntryForm: typeof window.showNewEntryForm,
            saveJournalEntry: typeof window.saveJournalEntry,
            viewJournalEntries: typeof window.viewJournalEntries,
            selectCoach: typeof window.selectCoach,
            bookSession: typeof window.bookSession,
            exitAssessment: typeof window.exitAssessment,
            startFreeTrial: typeof window.startFreeTrial,
            showCreditPurchase: typeof window.showCreditPurchase,
            directStripeCheckout: typeof window.directStripeCheckout,
            showEnterpriseCalculator: typeof window.showEnterpriseCalculator,
            updateEnterprisePrice: typeof window.updateEnterprisePrice,
            proceedToEnterpriseCheckout: typeof window.proceedToEnterpriseCheckout,
            openEmbeddedStripeCheckout: typeof window.openEmbeddedStripeCheckout,
            closeEmbeddedPayment: typeof window.closeEmbeddedPayment,
            detectStripeEmbedSupport: typeof window.detectStripeEmbedSupport,
            useEmbeddedMethod: typeof window.useEmbeddedMethod,
            useRedirectMethod: typeof window.useRedirectMethod,
            proceedToSecureCheckout: typeof window.proceedToSecureCheckout
        });
    </script>
    
    <!-- EMERGENCY COACH FIX - GUARANTEED TO WORK -->
    <script>
        console.log('üö® EMERGENCY: Defining sendTextChatMessage function...');
        
        // Real coach function with API - FIXED
        window.sendTextChatMessage = async function() {
            console.log('üí¨ sendTextChatMessage called');
            const input = document.getElementById('text-chat-input');
            const message = input ? input.value.trim() : '';
            
            console.log('üìù Message:', message);
            console.log('üë®‚Äç‚öïÔ∏è Current coach:', window.currentChatCoach);
            
            if (!message) {
                console.log('‚ùå No message');
                return;
            }
            
            // Get coach info (fallback if currentChatCoach not set)
            let coachName = 'Coach Marcus';
            let coachSpecialty = 'Addiction Recovery Specialist';
            if (window.currentChatCoach) {
                coachName = window.currentChatCoach.name;
                coachSpecialty = window.currentChatCoach.specialty;
            }
            
            // Clear input
            input.value = '';
            
            console.log('üîÑ About to add message to chat...');
            
            // Add user message to chat
            const chatHistory = document.getElementById('text-chat-history');
            if (chatHistory) {
                chatHistory.innerHTML += '<div class="flex justify-end mb-4"><div class="mr-3 p-3 bg-blue-600 rounded-lg max-w-xs"><p class="text-sm text-white">' + message + '</p></div></div>';
                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Show thinking indicator
                const thinkingId = 'thinking-' + Date.now();
                chatHistory.innerHTML += '<div id="' + thinkingId + '" class="flex mb-4"><div class="ml-3 p-3 bg-slate-700 rounded-lg"><div class="animate-pulse text-slate-400">Thinking...</div></div></div>';
                
                try {
                    console.log('üìû Calling Groq API...');
                    console.log('üîë Using API key:', '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'.substring(0, 10) + '...');
                    
                    // Call Groq API
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer 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',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'llama-3.1-8b-instant',
                            messages: [{
                                role: 'system',
                                content: 'You are ' + coachName + ', a ' + coachSpecialty + '. Provide empathetic, professional therapeutic responses. Keep responses concise but supportive.'
                            }, {
                                role: 'user',
                                content: message
                            }],
                            max_tokens: 300,
                            temperature: 0.7
                        })
                    });
                    
                    console.log('üì® Response status:', response.status);
                    console.log('üì® Response OK:', response.ok);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå API Error:', response.status, errorText);
                        throw new Error('API returned status ' + response.status);
                    }
                    
                    const data = await response.json();
                    console.log('üìã Full API response:', data);
                    
                    let aiResponse = 'I apologize, but I encountered an issue processing your message.';
                    if (data && data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                        aiResponse = data.choices[0].message.content;
                        console.log('‚úÖ Got AI response:', aiResponse);
                    } else {
                        console.error('‚ùå Invalid response structure:', data);
                    }
                    
                    // Remove thinking and add AI response
                    const thinkingElement = document.getElementById(thinkingId);
                    if (thinkingElement) thinkingElement.remove();
                    
                    chatHistory.innerHTML += '<div class="flex mb-4"><div class="ml-3 p-3 bg-slate-700 rounded-lg max-w-xs"><p class="text-sm text-slate-100">' + aiResponse + '</p></div></div>';
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    
                } catch (error) {
                    console.error('Chat error:', error);
                    const thinkingElement = document.getElementById(thinkingId);
                    if (thinkingElement) thinkingElement.remove();
                    
                    chatHistory.innerHTML += '<div class="flex mb-4"><div class="ml-3 p-3 bg-slate-700 rounded-lg max-w-xs"><p class="text-sm text-slate-100">I apologize, but I am having trouble connecting right now. Please try again in a moment.</p></div></div>';
                }
            }
        };
        
        // Add missing handleTextChatKeypress function
        window.handleTextChatKeypress = function(event) {
            if (event.key === 'Enter') {
                window.sendTextChatMessage();
            }
        };
        
        // Ensure functions are available
        console.log('‚úÖ sendTextChatMessage function defined:', typeof window.sendTextChatMessage);
        console.log('‚úÖ handleTextChatKeypress function defined:', typeof window.handleTextChatKeypress);
        
        // ===== INTELLIGENT ASSESSMENT SYSTEM =====
        
        // Load Intelligent Assessment
        window.loadIntelligentAssessment = function() {
            console.log('üß† Loading Intelligent Assessment System...');
            
            // Show legal disclaimer first
            showHealthDisclaimer(() => {
                // After user accepts disclaimer, load assessment
                const assessmentSection = document.getElementById('assessment');
                if (assessmentSection) {
                    assessmentSection.innerHTML = getIntelligentAssessmentHTML();
                    initializeIntelligentAssessment();
                }
            });
        };
        
        // Health Disclaimer Modal
        function showHealthDisclaimer(onAccept) {
            const disclaimerHTML = `
                <div id="health-disclaimer-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-slate-800 rounded-2xl max-w-4xl max-h-[90vh] overflow-y-auto border border-slate-600">
                        <div class="p-8">
                            <div class="text-center mb-6">
                                <div class="w-20 h-20 bg-gradient-to-br from-yellow-500 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-slate-100 mb-2">Important Health Disclaimer</h2>
                                <p class="text-slate-300">Please read carefully before proceeding with your health assessment</p>
                            </div>
                            
                            <div class="space-y-6 text-slate-200 text-sm leading-relaxed">
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-blue-500">
                                    <h3 class="text-lg font-semibold text-blue-300 mb-3"><i class="fas fa-users mr-2"></i>Health Advocacy Service</h3>
                                    <p class="mb-3"><strong>Root Cause Power provides health advocacy and wellness coaching services.</strong> We are <strong>NOT medical professionals</strong> and do not provide medical diagnosis, treatment, or medical advice.</p>
                                    <p>Our coaches are trained health advocates who provide:</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1 text-slate-300">
                                        <li>Emotional support and guidance</li>
                                        <li>Wellness strategy development</li>
                                        <li>Lifestyle modification coaching</li>
                                        <li>Stress management techniques</li>
                                        <li>Referrals to appropriate healthcare professionals</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-red-500">
                                    <h3 class="text-lg font-semibold text-red-300 mb-3"><i class="fas fa-stethoscope mr-2"></i>Medical Advice Limitations</h3>
                                    <p class="mb-3"><strong>This platform does NOT replace professional medical care.</strong></p>
                                    <p>You should:</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1 text-slate-300">
                                        <li><strong>Always consult licensed healthcare providers</strong> for medical diagnosis and treatment</li>
                                        <li><strong>Continue all prescribed medications</strong> unless advised otherwise by your doctor</li>
                                        <li><strong>Seek immediate medical attention</strong> for any serious health concerns</li>
                                        <li><strong>Not use this service</strong> as a substitute for professional medical advice</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-purple-500">
                                    <h3 class="text-lg font-semibold text-purple-300 mb-3"><i class="fas fa-exclamation-circle mr-2"></i>Crisis Situations</h3>
                                    <p class="mb-3"><strong>If you are experiencing a medical or mental health emergency:</strong></p>
                                    <div class="bg-red-900/50 rounded-lg p-4 mb-3">
                                        <p class="text-red-200 font-semibold mb-2">EMERGENCY CONTACTS:</p>
                                        <ul class="text-red-100 space-y-1">
                                            <li><strong>Emergency Services:</strong> 911 (US) / 999 (UK) / 112 (EU)</li>
                                            <li><strong>Crisis Text Line:</strong> Text HOME to 741741</li>
                                            <li><strong>National Suicide Prevention:</strong> 988 (US) / 116 123 (UK)</li>
                                            <li><strong>Mental Health Crisis:</strong> Contact your local emergency room</li>
                                        </ul>
                                    </div>
                                    <p class="text-slate-300">Our platform includes crisis detection protocols, but immediate professional help is always recommended for emergency situations.</p>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-green-500">
                                    <h3 class="text-lg font-semibold text-green-300 mb-3"><i class="fas fa-shield-alt mr-2"></i>Privacy & Data Protection</h3>
                                    <ul class="list-disc list-inside space-y-1 text-slate-300">
                                        <li>Your assessment data is stored securely and used only for providing personalized recommendations</li>
                                        <li>We comply with applicable privacy laws including GDPR and CCPA</li>
                                        <li>Your information is never shared with third parties without explicit consent</li>
                                        <li>You can request deletion of your data at any time</li>
                                        <li>All communications with coaches are confidential within legal limits</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-yellow-500">
                                    <h3 class="text-lg font-semibold text-yellow-300 mb-3"><i class="fas fa-birthday-cake mr-2"></i>Age Requirements & Consent</h3>
                                    <p class="mb-3">By using this service, you confirm that you are:</p>
                                    <ul class="list-disc list-inside space-y-1 text-slate-300">
                                        <li><strong>18+ years old</strong> OR have parental/guardian consent if under 18</li>
                                        <li><strong>Legally able to consent</strong> to receive health advocacy services</li>
                                        <li><strong>Understanding</strong> that this is not medical treatment</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-slate-700/50 rounded-lg p-6 border-l-4 border-indigo-500">
                                    <h3 class="text-lg font-semibold text-indigo-300 mb-3"><i class="fas fa-balance-scale mr-2"></i>Limitations of Liability</h3>
                                    <p class="text-slate-300">Root Cause Power, its coaches, and affiliates are not liable for:</p>
                                    <ul class="list-disc list-inside mt-2 space-y-1 text-slate-300">
                                        <li>Medical outcomes or health decisions based on our recommendations</li>
                                        <li>Delays in seeking professional medical care</li>
                                        <li>Misinterpretation of health advocacy guidance</li>
                                        <li>Technical issues affecting service availability</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mt-8 p-6 bg-gradient-to-r from-emerald-900/50 to-blue-900/50 rounded-lg border border-emerald-500/30">
                                <h3 class="text-lg font-semibold text-emerald-300 mb-3"><i class="fas fa-handshake mr-2"></i>Your Commitment</h3>
                                <p class="text-slate-200 mb-4">By proceeding, you acknowledge that you have read, understood, and agree to these terms. You commit to using this platform responsibly as a complement to, not a replacement for, professional healthcare.</p>
                                
                                <div class="flex items-center mb-4">
                                    <input type="checkbox" id="disclaimer-consent" class="mr-3 w-5 h-5 text-emerald-500 bg-slate-700 border-slate-500 rounded focus:ring-emerald-400">
                                    <label for="disclaimer-consent" class="text-slate-200 cursor-pointer">I have read and agree to all terms and conditions above</label>
                                </div>
                                
                                <div class="flex justify-between">
                                    <button onclick="closeDisclaimer()" class="bg-slate-600 hover:bg-slate-700 px-6 py-3 rounded-xl text-white font-medium transition-all">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </button>
                                    <button onclick="acceptDisclaimer()" id="accept-disclaimer-btn" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-6 py-3 rounded-xl text-white font-medium transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <i class="fas fa-check mr-2"></i>Accept & Continue to Assessment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', disclaimerHTML);
            
            // Enable accept button when checkbox is checked
            const checkbox = document.getElementById('disclaimer-consent');
            const acceptBtn = document.getElementById('accept-disclaimer-btn');
            
            checkbox.addEventListener('change', function() {
                acceptBtn.disabled = !this.checked;
            });
            
            window.acceptDisclaimer = function() {
                if (checkbox.checked) {
                    document.getElementById('health-disclaimer-modal').remove();
                    onAccept();
                }
            };
            
            window.closeDisclaimer = function() {
                document.getElementById('health-disclaimer-modal').remove();
            };
        }
        
        // Get Intelligent Assessment HTML
        function getIntelligentAssessmentHTML() {
            return `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-brain text-white text-3xl"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-slate-100 mb-2">Intelligent Health Assessment</h1>
                        <p class="text-xl text-slate-300">AI-powered personalized evaluation covering physical health, mental wellness, and life impact</p>
                        <div class="mt-4 bg-gradient-to-r from-emerald-900/30 to-blue-900/30 rounded-lg p-4 border border-emerald-500/30">
                            <p class="text-emerald-300 text-sm"><i class="fas fa-magic mr-2"></i>This assessment adapts based on your responses and creates a personalized recovery roadmap</p>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-slate-400">Assessment Progress</span>
                            <span id="intelligent-progress-text" class="text-sm text-emerald-400">Question 1</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div id="intelligent-progress-bar" class="bg-gradient-to-r from-emerald-500 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Assessment Container -->
                    <div id="intelligent-assessment-container">
                        <!-- Questions will be dynamically inserted here -->
                    </div>

                    <!-- Results Section -->
                    <div id="intelligent-results-section" class="hidden">
                        <div class="bg-gradient-to-r from-emerald-900/30 to-blue-900/30 rounded-2xl p-8 border border-emerald-500/30">
                            <div class="text-center mb-8">
                                <div class="w-24 h-24 bg-gradient-to-br from-emerald-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-chart-line text-white text-3xl"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-slate-100 mb-2">Your Personalized Health Profile</h2>
                                <p class="text-slate-300">Based on your responses, here's your tailored recovery roadmap</p>
                            </div>

                            <!-- Health Summary Cards -->
                            <div id="intelligent-health-summary" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <!-- Dynamically populated -->
                            </div>

                            <!-- Recovery Roadmap -->
                            <div id="intelligent-recovery-roadmap" class="mb-8">
                                <h3 class="text-2xl font-bold text-slate-100 mb-4">üöÄ Your Recovery Roadmap</h3>
                                <div id="intelligent-roadmap-steps" class="space-y-4">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>

                            <!-- Recommended Coach -->
                            <div id="intelligent-coach-recommendation" class="mb-8">
                                <h3 class="text-2xl font-bold text-slate-100 mb-4">üë®‚Äç‚öïÔ∏è Your Recommended Coach</h3>
                                <div id="intelligent-recommended-coach-card" class="bg-slate-700/50 rounded-xl p-6">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <button onclick="startRecommendedCoachSession()" class="bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                                    <i class="fas fa-comments mr-2"></i>Start Coach Session
                                </button>
                                <button onclick="viewIntelligentDashboard()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg hover:shadow-xl">
                                    <i class="fas fa-dashboard mr-2"></i>View Dashboard
                                </button>
                                <button onclick="retakeIntelligentAssessment()" class="bg-slate-600 hover:bg-slate-700 px-8 py-4 rounded-xl text-white font-semibold text-lg transition-all">
                                    <i class="fas fa-redo mr-2"></i>Retake Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
    
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"980ef2773f407719","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.8.0","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
