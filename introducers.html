// ==========================================
// STATE MANAGEMENT
// ==========================================
const state = {
    userId: 'USER_' + Math.random().toString(36).substr(2, 9).toUpperCase(),
    referralCode: '',
    referralLink: '',
    stats: {
        activeReferrals: 0,
        monthlyIncome: 0,
        totalEarned: 0,
        projection: 0
    }
};

// ==========================================
// INITIALIZATION
// ==========================================
function init() {
    // Generate or retrieve referral code
    generateReferralCode();
    
    // Display referral info
    document.getElementById('referral-code').textContent = state.referralCode;
    document.getElementById('referral-link').textContent = state.referralLink;

    // Update stats (in production, this would fetch from backend)
    updateStats();

    // Initialize calculator
    updateCalculator();

    // Initialize chart
    initChart();

    // Replace [YOUR LINK] in all templates
    replacePlaceholders();
}

// ==========================================
// REFERRAL CODE GENERATION
// ==========================================
function generateReferralCode() {
    // Check if user already has a referral code in localStorage
    let existingCode = localStorage.getItem('introducerReferralCode');
    
    if (existingCode) {
        state.referralCode = existingCode;
    } else {
        // Generate new code: First name initial + last name initial + 6 random chars
        // In production, this would be generated by backend based on user account
        const randomPart = Math.random().toString(36).substr(2, 6).toUpperCase();
        state.referralCode = 'INTRO_' + randomPart;
        localStorage.setItem('introducerReferralCode', state.referralCode);
    }
    
    state.referralLink = `https://roothealth.app/?ref=${state.referralCode}`;
}

// ==========================================
// STATS UPDATE
// ==========================================
function updateStats() {
    // In production, this would fetch from backend API
    // For now, using localStorage simulation
    const mockStats = JSON.parse(localStorage.getItem('introducerStats') || '{"activeReferrals":0,"monthlyIncome":0,"totalEarned":0}');
    
    state.stats.activeReferrals = mockStats.activeReferrals;
    state.stats.monthlyIncome = mockStats.monthlyIncome;
    state.stats.totalEarned = mockStats.totalEarned;
    state.stats.projection = mockStats.activeReferrals * 5.85 * 120; // 10 years

    document.getElementById('stat-active-referrals').textContent = state.stats.activeReferrals;
    document.getElementById('stat-monthly-income').textContent = `£${state.stats.monthlyIncome.toFixed(2)}`;
    document.getElementById('stat-total-earned').textContent = `£${state.stats.totalEarned.toFixed(2)}`;
    document.getElementById('stat-projection').textContent = `£${state.stats.projection.toLocaleString()}`;
}

// ==========================================
// INITIALIZE ON PAGE LOAD
// ==========================================
document.addEventListener('DOMContentLoaded', init);
